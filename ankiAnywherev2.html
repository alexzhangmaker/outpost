<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>泰语单词闪卡学习</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=Noto+Sans+Thai+Looped:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            width: 100%;
            max-width: 600px;
            height:90vh;
            background-color: white;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            padding: 20px;

            display: flex;
            flex-direction: column;

        }
        
        header {
            text-align: center;
            margin-bottom: 15px;
        }
        
        h1 {
            color: #2c3e50;
            font-weight: 700;
            font-size: 1.8rem;
            margin-bottom: 10px;
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 5px;
            background: #f8f9fa;
            padding: 5px;
            border-radius: 10px;
            font-size: 14px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-weight: 700;
            color: #3498db;
            font-size: 16px;
        }
        
        .flashcard-container {
            perspective: 1000px;
            margin-bottom: 5px;
            height: 80%/*580px*/;
        }
        
        .flashcard {
            position: relative;
            width: 100%;
            height: 100%;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            cursor: pointer;
        }
        
        .flashcard.flipped {
            transform: rotateY(180deg);
        }
        
        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .card-front {
            background: linear-gradient(145deg, #3498db, #2c3e50);
            color: white;
        }
        
        .card-back {
            background: white;
            color: #333;
            transform: rotateY(180deg);
            overflow-y: auto;
            justify-content: flex-start;
        }
        
        .thai-word {
            font-family: 'Noto Sans Thai Looped', sans-serif;
            font-size: 3.2rem;
            font-weight: 600;
            text-align: center;
            margin-bottom: 10px;
        }
        
        .pronunciation {
            font-size: 1.4rem;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 5px;
        }
        
        .hint {
            margin-top: 15px;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .definition {
            margin-bottom: 12px;
            text-align: center;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 8px;
            width: 100%;
        }
        
        .definition-en {
            font-weight: 500;
            color: #2c3e50;
            margin-bottom: 3px;
            font-size: 0.95rem;
            text-align:start ;
        }
        
        .definition-zh {
            color: #7f8c8d;
            font-size: 0.9rem;
            text-align:start ;

        }
        
        .synonyms, .antonyms, .phrases {
            width: 100%;
            margin-bottom: 2px;
        }
        
        .section-title {
            font-weight: 600;
            color: #3498db;
            margin-bottom: 2px;
            font-size: 0.6rem;
        }
        
        .synonym, .antonym {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            margin: 3px;
            font-family: 'Noto Sans Thai Looped', sans-serif;
            font-size: 0.9rem;
        }
        
        .synonym {
            background: #e3f2fd;
            color: #0d47a1;
        }
        
        .antonym {
            background: #ffebee;
            color: #b71c1c;
        }
        
        .phrase {
            margin-bottom: 6px;
            padding: 5px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .thai-phrase {
            font-family: 'Noto Sans Thai Looped', sans-serif;
            font-weight: 500;
            font-size: 0.95rem;
        }
        
        .phrase-translation {
            color: #7f8c8d;
            font-size: 0.85rem;
        }
        
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 5px;
        }
        
        .rating-container {
            display: flex;
            justify-content: space-between;
            width: 100%;
            gap: 5px;
        }
        
        .rating-btn {
            flex: 1;
            padding: 5px 3px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.6rem;
            min-width: 0;
        }
        
        .rating-1 {
            background: #e74c3c;
            color: white;
        }
        
        .rating-2 {
            background: #e67e22;
            color: white;
        }
        
        .rating-3 {
            background: #f1c40f;
            color: white;
        }
        
        .rating-4 {
            background: #2ecc71;
            color: white;
        }
        
        .rating-5 {
            background: #27ae60;
            color: white;
        }
        
        .rating-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
        }
        
        .progress-bar {
            width: 100%;
            background: #ecf0f1;
            height: 8px;
            border-radius: 4px;
            margin-top: 15px;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            border-radius: 4px;
            transition: width 0.3s;
        }
        
        .completion-message {
            text-align: center;
            padding: 30px;
            display: none;
        }
        
        .completion-message h2 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .completion-message p {
            margin-bottom: 20px;
            color: #7f8c8d;
        }
        
        .reset-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            background: #3498db;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .reset-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        .desktopOnly{
            display: block;
        }
        @media (max-width: 768px) {

            .desktopOnly{
                display: none;
            }
            
            .container {
                padding: 15px;
            }
            
            .thai-word {
                font-size: 2.6rem;
            }
            
            .flashcard-container {
                height: 580px;
            }
            
            .rating-btn {
                padding: 8px 2px;
                font-size: 0.8rem;
            }
            
            .stats {
                flex-direction: column;
                gap: 8px;
            }
        }
        
        @media (max-width: 480px) {
            .desktopOnly{
                display: none;
            }

            h1 {
                font-size: 1.6rem;
            }
            
            .thai-word {
                font-size: 2.2rem;
            }
            
            .pronunciation {
                font-size: 1.1rem;
            }
            
            .flashcard-container {
                height: 580px;
            }
            
            .rating-container {
                flex-wrap: wrap;
            }
            
            .rating-btn {
                flex: 1;
                min-width: 55px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="desktopOnly">
            <h3>泰语单词闪卡学习</h3>
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-label">进度</div>
                    <div class="stat-value" id="progress-count">1/5</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">已学单词</div>
                    <div class="stat-value" id="learned-count">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">掌握程度</div>
                    <div class="stat-value" id="mastery-level">0%</div>
                </div>
            </div>
        </header>
        
        <div class="flashcard-container" id="flashcard-container">
            <div class="flashcard" id="flashcard">
                <div class="card-front">
                    <div class="thai-word" id="thai-word">ช่วยเหลือ</div>
                    <div class="pronunciation" id="pronunciation">chûay-lĕua</div>
                    <div class="hint">点击卡片查看释义</div>
                </div>
                <div class="card-back">
                    <div class="definition">
                        <div class="definition-en" id="definition-en">to help, assist, or aid someone</div>
                        <div class="definition-zh" id="definition-zh">帮助，援助，协助</div>
                    </div>
                    
                    <div class="synonyms">
                        <div class="section-title">同义词</div>
                        <div id="synonyms-container">
                            <span class="synonym">สนับสนุน</span>
                            <span class="synonym">เอื้อเฟื้อ</span>
                            <span class="synonym">อุปถัมภ์</span>
                        </div>
                    </div>
                    
                    <div class="antonyms">
                        <div class="section-title">反义词</div>
                        <div id="antonyms-container">
                            <span class="antonym">ขัดขวาง</span>
                            <span class="antonym">เป็นอุปสรรค</span>
                        </div>
                    </div>
                    
                    <div class="phrases">
                        <div class="section-title">常用短语</div>
                        <div id="phrases-container">
                            <div class="phrase">
                                <div class="thai-phrase">ช่วยเหลือตัวเอง</div>
                                <div class="phrase-translation">自助</div>
                            </div>
                            <div class="phrase">
                                <div class="thai-phrase">ช่วยเหลือซึ่งกันและกัน</div>
                                <div class="phrase-translation">互相帮助</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="button-group">
            <div class="rating-container" id="rating-container">
                <button class="rating-btn rating-1" data-rating="1">1<br><span>不认识</span></button>
                <button class="rating-btn rating-2" data-rating="2">2<br><span>有点印象</span></button>
                <button class="rating-btn rating-3" data-rating="3">3<br><span>一般熟悉</span></button>
                <button class="rating-btn rating-4" data-rating="4">4<br><span>比较熟悉</span></button>
                <button class="rating-btn rating-5" data-rating="5">5<br><span>完全掌握</span></button>
            </div>
        </div>
        
        <div class="progress-bar">
            <div class="progress" id="progress-bar"></div>
        </div>
        
        <div class="completion-message" id="completion-message">
            <h2>恭喜！您已完成所有单词的学习</h2>
            <p>您已经学习了 <span id="total-learned">0</span> 个单词，掌握程度为 <span id="final-mastery">0%</span></p>
            <button class="reset-btn" id="reset-btn">重新开始</button>
        </div>
    </div>

    <script>
        let gWordSetKey = 'B1_Work_Social' ;
        let tWordSetURL = `https://outpost-dictionary-116208.asia-southeast1.firebasedatabase.app/thaiWordList/${gWordSetKey}.json` ;


        // 示例单词数据
        const wordList = [];

        // 应用状态
        let currentIndex = 0;
        let learnedWords = [];
        
        // 从localStorage加载已学习数据
        function loadProgress() {
            const savedProgress = localStorage.getItem(`thaiFlashcardProgress_${gWordSetKey}`);
            if (savedProgress) {
                learnedWords = JSON.parse(savedProgress);
                // 找到第一个未学习的单词
                const learnedIndices = learnedWords.map(w => w.index);
                for (let i = 0; i < wordList.length; i++) {
                    if (!learnedIndices.includes(i)) {
                        currentIndex = i;
                        break;
                    }
                }
            }
            updateStats();
        }
        
        // 保存进度到localStorage
        function saveProgress() {
            localStorage.setItem(`thaiFlashcardProgress_${gWordSetKey}`, JSON.stringify(learnedWords));
            updateStats();
        }
        
        // 更新统计信息
        function updateStats() {
            const progressText = `${currentIndex + 1}/${wordList.length}`;
            const learnedCount = learnedWords.length;
            const masteryLevel = learnedWords.length > 0 ? 
                Math.round((learnedWords.reduce((sum, word) => sum + word.rating, 0) / (learnedWords.length * 5)) * 100) : 0;
            
            document.getElementById('progress-count').textContent = progressText;
            document.getElementById('learned-count').textContent = learnedCount;
            document.getElementById('mastery-level').textContent = `${masteryLevel}%`;
            
            // 更新进度条
            const progressPercent = (currentIndex / wordList.length) * 100;
            document.getElementById('progress-bar').style.width = `${progressPercent}%`;
            
            // 检查是否已完成所有单词
            if (learnedWords.length >= wordList.length) {
                showCompletionMessage();
            }
        }
        
        // 显示完成消息
        async function showCompletionMessage() {
            document.querySelector('.flashcard-container').style.display = 'none';
            document.getElementById('rating-container').style.display = 'none';
            document.getElementById('progress-bar').style.display = 'none';
            
            const learnedCount = learnedWords.length;
            const masteryLevel = learnedWords.length > 0 ? 
                Math.round((learnedWords.reduce((sum, word) => sum + word.rating, 0) / (learnedWords.length * 5)) * 100) : 0;
            
            document.getElementById('total-learned').textContent = learnedCount;
            document.getElementById('final-mastery').textContent = `${masteryLevel}%`;
            document.getElementById('completion-message').style.display = 'block';

            //await uploadAnkiRecord() ;
        }
        

        // Supermemo SM2 algorithm implementation (as SM18 is proprietary, using SM2 as a base which is inspired by Ebbinghaus and Supermemo principles)
        function supermemo(item, grade) {
            let { interval, repetition, efactor } = item;
            if (grade >= 3) { // Pass
                if (repetition === 0) {
                    interval = 1;
                } else if (repetition === 1) {
                    interval = 6;
                } else {
                    interval = Math.round(interval * efactor);
                }
                repetition += 1;
                efactor += (0.1 - (5 - grade) * (0.08 + (5 - grade) * 0.02));
                if (efactor < 1.3) efactor = 1.3;
            } else { // Fail
                repetition = 0;
                interval = 1;
                efactor = Math.max(1.3, efactor - 0.2); // Optional decay on fail
            }
            return { interval, repetition, efactor };
        }

        let bUploaded = false ;
        async function uploadAnkiRecord(){
            if(bUploaded == true) return ;

            let cDate = new Date() ;
            let nextDate = new Date() ;

            console.log(learnedWords) ;
            for(let i=0;i<learnedWords.length;i++){
                let encodeWord = encodeURIComponent(learnedWords[i].word) ;
                let sm2RecordURL = `https://outpost-dictionary-116208.asia-southeast1.firebasedatabase.app/thaiAnki/SM2Records/${encodeWord}.json` ;
                let response = await fetch(sm2RecordURL) ;
                let jsonResult = await response.json() ;

                let jsonSM2 = {
                    "efactor": 2.5,
                    "interval": 0,
                    "repetition": 0
                };
                let jsonRecord={
                    "efactor": 2.5,
                    "interval": 0,
                    "repetition": 0,
                    "id": learnedWords[i].word,
                    "next_review": cDate.toDateString(),
                };

                console.log(jsonResult) ;
                if(jsonResult==null){
                    jsonSM2= supermemo(jsonSM2,learnedWords[i].rating) ;
                    console.log(jsonSM2)  ;
                    nextDate.setDate(cDate.getDate()+jsonSM2.interval) ;
                    jsonRecord.next_review = nextDate.toDateString() ;
                    jsonRecord.efactor = jsonSM2.efactor ;
                    jsonRecord.interval = jsonSM2.interval ;
                    jsonRecord.repetition = jsonSM2.repetition ;
                    
                }else{
                    jsonSM2= supermemo(jsonResult,learnedWords[i].rating) ;
                    console.log(jsonSM2)  ;

                    nextDate.setDate(cDate.getDate()+jsonSM2.interval) ;
                    jsonRecord.next_review = nextDate.toDateString() ;
                    jsonRecord.interval = jsonSM2.interval ;
                    jsonRecord.repetition = jsonSM2.repetition ;
                }
                console.log(jsonRecord) ;
                await fetch(sm2RecordURL, {
                    method: "PUT", // Use PATCH to update specific fields
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(jsonRecord),
                }) ;
            }
            bUploaded = true ;
        }


        // 显示当前单词
        function showCurrentWord() {
            const word = wordList[currentIndex];
            
            // 更新卡片正面
            document.getElementById('thai-word').textContent = word.thai;
            document.getElementById('pronunciation').textContent = word.pronunciation;
            
            // 更新卡片背面
            let en= word.definitions[0].hasOwnProperty("en")?word.definitions[0].en:word.definitions[0].english ;
            let zh= word.definitions[0].hasOwnProperty("zh")?word.definitions[0].zh:word.definitions[0].chinese ;
            document.getElementById('definition-en').textContent = en;
            document.getElementById('definition-zh').textContent = zh;
            
            // 更新同义词
            const synonymsContainer = document.getElementById('synonyms-container');
            synonymsContainer.innerHTML = '';
            word.synonyms.slice(0, 3).forEach(synonym => {
                const span = document.createElement('span');
                span.className = 'synonym';
                span.textContent = synonym;
                synonymsContainer.appendChild(span);
            });
            
            // 更新反义词
            if(word.hasOwnProperty("antonyms")==true && word.antonyms!=undefined){
                const antonymsContainer = document.getElementById('antonyms-container');
                antonymsContainer.innerHTML = '';
                word.antonyms.slice(0, 2).forEach(antonym => {
                    const span = document.createElement('span');
                    span.className = 'antonym';
                    span.textContent = antonym;
                    antonymsContainer.appendChild(span);
                });
            }
            
            
            // 更新常用短语
            const phrasesContainer = document.getElementById('phrases-container');
            phrasesContainer.innerHTML = '';
            word.common_phrases.slice(0, 2).forEach(phrase => {
                const div = document.createElement('div');
                div.className = 'phrase';
                div.innerHTML = `
                    <div class="thai-phrase">${phrase.phrase}</div>
                    <div class="phrase-translation">${phrase.translation}</div>
                `;
                phrasesContainer.appendChild(div);
            });
            
            // 重置卡片状态
            document.getElementById('flashcard').classList.remove('flipped');
            
            // 检查是否已经评分
            const existingRating = learnedWords.findIndex(w => w.index === currentIndex);
            if (existingRating !== -1) {
                document.querySelectorAll('.rating-btn').forEach(btn => {
                    btn.disabled = true;
                });
            } else {
                document.querySelectorAll('.rating-btn').forEach(btn => {
                    btn.disabled = false;
                });
            }
            
            updateStats();
        }
        
        // 前进到下一个单词
        async function nextWord() {
            // 找到下一个未学习的单词
            const learnedIndices = learnedWords.map(w => w.index);
            for (let i = currentIndex + 1; i < wordList.length; i++) {
                if (!learnedIndices.includes(i)) {
                    currentIndex = i;
                    showCurrentWord();
                    return;
                }
            }
            
            // 如果后面没有未学习的单词，从开头找
            for (let i = 0; i < currentIndex; i++) {
                if (!learnedIndices.includes(i)) {
                    currentIndex = i;
                    showCurrentWord();
                    return;
                }
            }
            
            // 如果所有单词都已学习，显示完成消息
            showCompletionMessage();
            await uploadAnkiRecord() ;
        }
        
        // 重置应用
        function resetApp() {
            learnedWords = [];
            currentIndex = 0;
            localStorage.removeItem('thaiFlashcardProgress');
            
            document.getElementById('flashcard-container').style.display = 'block';
            document.getElementById('rating-container').style.display = 'flex';
            document.getElementById('progress-bar').style.display = 'block';
            document.getElementById('completion-message').style.display = 'none';
            
            showCurrentWord();
        }
        

        // 初始化应用
        async function initApp() {
            //?wordSet=
            //?reviewSet=
            const queryString = window.location.search; // "?color=purple&size=M&size=L"
            const urlParams = new URLSearchParams(queryString);
            let wordSetKey = urlParams.get('wordSet'); // "purple"
            let reviewSetKey = urlParams.get('reviewSet'); // "purple"
            let cDate = new Date() ;

            if(wordSetKey!=null){
                console.log(wordSetKey) ;
                let keyEncode = encodeURIComponent(wordSetKey) ;
                gWordSetKey = wordSetKey ;
                tWordSetURL = `https://outpost-dictionary-116208.asia-southeast1.firebasedatabase.app/thaiWordList/${keyEncode}.json` ;
            }else if(reviewSetKey!=null){
                //let keyEncode = encodeURIComponent(formatDateToYYYYMMDD(cDate)) ;
                gWordSetKey = reviewSetKey ;
                let keyEncode = encodeURIComponent(reviewSetKey) ;
                tWordSetURL = `https://outpost-dictionary-116208.asia-southeast1.firebasedatabase.app/thaiAnki/reviewSets/${keyEncode}.json` ;
                let respo = await fetch(tWordSetURL) ;
                let jsonReviewSet = await respo.json() ;
                console.log(jsonReviewSet) ;
                tWordSetURL = jsonReviewSet.wordSetURL ;
                gWordSetKey = jsonReviewSet.wordSetID ;
            }else{
                reviewSetKey = `DailyAnki.${formatDateToYYYYMMDD(cDate)}` ;
                let keyEncode = encodeURIComponent(reviewSetKey) ;
                gWordSetKey = reviewSetKey ;
                tWordSetURL = `https://outpost-dictionary-116208.asia-southeast1.firebasedatabase.app/thaiAnki/DailyReview/${keyEncode}.json` ;
            }


            await _loadFireBaseWordSet(tWordSetURL) ;

            loadProgress();
            showCurrentWord();
            
            // 添加事件监听器
            document.getElementById('flashcard').addEventListener('click', function() {
                this.classList.toggle('flipped');
            });
            
            // 评分按钮事件
            document.querySelectorAll('.rating-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const rating = parseInt(this.getAttribute('data-rating'));
                    
                    // 检查是否已经评分
                    const existingIndex = learnedWords.findIndex(w => w.index === currentIndex);
                    if (existingIndex !== -1) {
                        learnedWords[existingIndex].rating = rating;
                    } else {
                        learnedWords.push({
                            index: currentIndex,
                            word: wordList[currentIndex].thai,
                            rating: rating,
                            timestamp: new Date().toISOString()
                        });
                    }
                    
                    // 保存进度
                    saveProgress();
                    
                    // 禁用评分按钮
                    document.querySelectorAll('.rating-btn').forEach(btn => {
                        btn.disabled = true;
                    });
                    
                    // 自动前进到下一个单词
                    setTimeout(nextWord, 500);
                });
            });
            
            // 重置按钮事件
            document.getElementById('reset-btn').addEventListener('click', resetApp);
        }
        
        function formatDateToYYYYMMDD(date) {
            // Ensure input is a Date object
            const d = new Date(date);
            
            // Validate date
            if (isNaN(d)) {
                throw new Error('Invalid date input');
            }
            
            // Get year, month, and day
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0'); // Months are 0-based
            const day = String(d.getDate()).padStart(2, '0');
            
            // Return formatted string
            return `${year}${month}${day}`;
        }

        async function _loadFireBaseWordSet(url){
            let response = await fetch(url) ;
            let jsonWordSet = await response.json() ;
            console.log(jsonWordSet) ;
            if(jsonWordSet==null)return ;

            
            for(let i=0;i<jsonWordSet.words.length;i++){
                let word = jsonWordSet.words[i] ;
                console.log(word) ;
                wordURL = `https://outpost-dictionary-116208.asia-southeast1.firebasedatabase.app/thaiDictionary/${word}.json` ;
                console.log(wordURL) ;
                response = await fetch(wordURL) ;
                let jsonWord = await response.json() ;
                console.log(jsonWord) ;
                if(jsonWord==null){
                    console.log(`${word} not in DB,something wrong`) ;
                    continue ;
                }
                let ankiWord={
                    thai:jsonWord.thai.word,
                    pronunciation:jsonWord.thai.pronunciation,
                    definitions:jsonWord.definitions,
                    synonyms:jsonWord.synonyms,
                    antonyms:jsonWord.antonyms,
                    common_phrases:jsonWord.common_phrases
                };
                wordList.push(ankiWord) ;
            }
        }

        
        // 启动应用
        initApp();
    </script>
</body>
</html>
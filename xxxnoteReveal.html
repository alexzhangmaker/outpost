<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½å­¦ä¹ ç³»ç»Ÿ - ç¬”è®°å¤ä¹ æµè§ˆå™¨</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script> 
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@4.3.1/dist/reveal.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reveal.js@4.3.1/dist/theme/white.css">
    
    <style>
        /* æ•´ä½“å¸ƒå±€ */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            padding: 0; 
            background: #f5f7fa; 
            height: 100vh;
            overflow: hidden;
        }
        
        .container { 
            display: flex; 
            height: 100vh; 
        }
        
        /* ä¾§è¾¹æ æ ·å¼ */
        .sidebar { 
            width: 320px; 
            background: white; 
            border-right: 1px solid #e1e5e9; 
            display: flex; 
            flex-direction: column; 
            transition: transform 0.3s ease;
        }
        
        .sidebar-header { 
            background: #2c3e50; 
            color: white; 
            padding: 15px 20px; 
            font-weight: 600; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        
        .sidebar-content { 
            flex: 1; 
            overflow-y: auto; 
            padding: 10px; 
        }

        /* æ–‡ä»¶å¤¹åˆ†ç»„æ ·å¼ */
        .folder-group { 
            margin-bottom: 8px; 
            border: 1px solid #e1e5e9; 
            border-radius: 6px; 
            overflow: hidden; 
            background: #fff; 
        }
        
        .folder-header { 
            padding: 12px 15px; 
            background: #f8f9fa; 
            cursor: pointer; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            font-weight: 600; 
            color: #2c3e50; 
            transition: background 0.2s; 
            border-bottom: 1px solid transparent; 
        }
        
        .folder-header:hover { 
            background: #e9ecef; 
        }
        
        .folder-header.active { 
            background: #e3f2fd; 
            color: #1976d2; 
            border-bottom: 1px solid #e1e5e9; 
        }
        
        .folder-count { 
            font-size: 12px; 
            background: #dee2e6; 
            color: #495057; 
            padding: 2px 8px; 
            border-radius: 10px; 
        }
        
        .folder-content { 
            display: none; 
            background: white; 
        }
        
        .folder-content.show { 
            display: block; 
        }

        /* ç¬”è®°åˆ—è¡¨é¡¹æ ·å¼ */
        .document-item { 
            padding: 10px 15px 10px 30px; 
            border-bottom: 1px solid #f1f3f5; 
            cursor: pointer; 
            transition: all 0.2s; 
        }
        
        .document-item:last-child { 
            border-bottom: none; 
        }
        
        .document-item:hover { 
            background: #f8f9fa; 
            color: #3498db; 
        }
        
        .document-item.active { 
            background: #e3f2fd; 
            border-left: 4px solid #3498db; 
            padding-left: 26px; 
        }
        
        .document-title { 
            font-size: 14px; 
            font-weight: 500; 
            margin-bottom: 4px; 
            color: #333; 
        }
        
        .document-meta { 
            font-size: 11px; 
            color: #95a5a6; 
            display: flex; 
            justify-content: space-between; 
        }

        /* å¹»ç¯ç‰‡åŒºåŸŸ */
        .slides-panel { 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            background: white; 
            position: relative;
        }
        
        .panel-header { 
            background: #34495e; 
            color: white; 
            padding: 15px 20px; 
            font-weight: 600; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        
        .user-info { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            font-size: 14px; 
        }
        
        .user-avatar { 
            width: 32px; 
            height: 32px; 
            border-radius: 50%; 
            background: #3498db; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: white; 
            font-weight: bold; 
            font-size: 14px; 
        }
        
        .slides-container { 
            flex: 1; 
            overflow: hidden;
            position: relative;
        }

        /* æ§åˆ¶æ  */
        .controls { 
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex; 
            gap: 10px; 
            z-index: 100;
        }
        
        button { 
            padding: 8px 16px; 
            background: rgba(52, 73, 94, 0.8); 
            color: white; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 14px; 
            transition: background 0.3s; 
            backdrop-filter: blur(5px);
        }
        
        button:hover { 
            background: rgba(41, 128, 185, 0.9); 
        }
        
        button.secondary { 
            background: rgba(149, 165, 166, 0.8); 
        }
        
        button.secondary:hover { 
            background: rgba(127, 140, 141, 0.9); 
        }
        
        button.success { 
            background: rgba(39, 174, 96, 0.8); 
        }
        
        button.success:hover { 
            background: rgba(33, 150, 83, 0.9); 
        }
        
        /* å…¨å±æ¨¡å¼ */
        .fullscreen-mode .sidebar {
            transform: translateX(-100%);
        }
        
        .fullscreen-mode .toggle-sidebar {
            display: block;
        }
        
        .toggle-sidebar {
            display: none;
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 100;
            background: rgba(52, 73, 94, 0.8);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
        }

        /* åŠ è½½é®ç½©å±‚ */
        .loading-overlay { 
            position: absolute; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background: rgba(255,255,255,0.8); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            z-index: 10; 
            font-weight: bold; 
            color: #2c3e50; 
        }
        
        /* è®¤è¯ç•Œé¢ */
        .auth-container { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0, 0, 0, 0.7); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            z-index: 2000; 
        }
        
        .auth-box { 
            background: white; 
            padding: 30px; 
            border-radius: 10px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
            width: 90%; 
            max-width: 400px; 
            text-align: center; 
        }
        
        .auth-btn { 
            padding: 12px 24px; 
            background: #3498db; 
            color: white; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 16px; 
            margin: 10px; 
        }
        
        .auth-btn.google { 
            background: #db4437; 
        }

        /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
        .status { 
            padding: 10px 15px; 
            border-radius: 4px; 
            margin-top: 10px; 
            font-size: 14px; 
        }
        
        .status.success { 
            background: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb; 
        }
        
        .status.error { 
            background: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb; 
        }
        
        .status.info { 
            background: #d1ecf1; 
            color: #0c5460; 
            border: 1px solid #bee5eb; 
        }

        /* Reveal.js è‡ªå®šä¹‰ */
        .reveal { 
            height: 100%; 
            width: 100%;
        }
        
        .reveal .slides { 
            text-align: left; 
            font-size: 28px; 
        }
        
        /* å“åº”å¼ */
        @media (max-width: 1024px) {
            .container { 
                flex-direction: column; 
            }
            
            .sidebar { 
                width: 100%; 
                height: 250px; 
            }
            
            .controls {
                bottom: 10px;
                right: 10px;
            }
        }
    </style>
</head>
<body>
    <div id="auth-container" class="auth-container" style="display: none;">
        <div class="auth-box">
            <h2 style="margin-bottom: 20px; color: #2c3e50;">ç™»å½•ç¬”è®°ç³»ç»Ÿ</h2>
            <button id="google-login-btn" class="auth-btn google">ä½¿ç”¨ Google ç™»å½•</button>
            <div id="auth-error" class="status error" style="display: none; margin-top: 15px;"></div>
        </div>
    </div>

    <div class="container">
        <div class="sidebar">
            <div class="sidebar-header">
                è¯¾ç¨‹ç¬”è®°åˆ—è¡¨
                <button id="refresh-docs-btn" class="auth-btn" style="padding: 4px 8px; font-size: 12px; background: rgba(255,255,255,0.2);">åˆ·æ–°</button>
            </div>
            <div class="sidebar-content">
                <div id="documents-list"></div>
                <div id="documents-status" class="status info" style="display: none;"></div>
            </div>
        </div>

        <div class="slides-panel">
            <div class="panel-header">
                <span>å¹»ç¯ç‰‡å¤ä¹ æ¨¡å¼</span>
                <div class="user-info" id="user-info" style="display: none;">
                    <div class="user-avatar" id="user-avatar">U</div>
                    <span id="user-name">ç”¨æˆ·</span>
                    <button id="user-logout-btn" class="auth-btn secondary" style="padding: 4px 8px; font-size: 12px;">é€€å‡º</button>
                </div>
                <button id="login-display-btn" class="auth-btn" style="padding: 4px 8px; font-size: 12px;">ç™»å½•</button>
            </div>
            
            <div class="slides-container">
                <div id="editor-loading" class="loading-overlay" style="display: none;">
                    åŠ è½½ä¸­...
                </div>
                
                <div class="reveal">
                    <div class="slides" id="slides-container">
                        <section>
                            <h2>æ¬¢è¿ä½¿ç”¨ç¬”è®°å¤ä¹ ç³»ç»Ÿ</h2>
                            <p>è¯·ä»å·¦ä¾§é€‰æ‹©ç¬”è®°å¼€å§‹å¤ä¹ </p>
                        </section>
                    </div>
                </div>
                
                <button class="toggle-sidebar" id="toggle-sidebar">æ˜¾ç¤ºä¾§è¾¹æ </button>
                
                <div class="controls">
                    <button id="fullscreen-btn" class="success">å…¨å±æ¨¡å¼</button>
                    <button id="prev-slide" class="secondary">ä¸Šä¸€é¡µ</button>
                    <button id="next-slide" class="secondary">ä¸‹ä¸€é¡µ</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/reveal.js@4.3.1/dist/reveal.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <script>
        // Firebaseé…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyA6MZ_p5lVuy8TMAqiuV6IRx9fggV44lQs",
            authDomain: "outpost-8d74e.firebaseapp.com",
            databaseURL: "https://outpost-otes-86b07.asia-southeast1.firebasedatabase.app/",
            projectId: "outpost-8d74e",
            storageBucket: "outpost-8d74e.firebasestorage.app",
            messagingSenderId: "724993324937",
            appId: "1:724993324937:web:ce6c7e6b06489331c79358",
            measurementId: "G-QPHWRTH6BH"
        };

        // Markdownåˆ°Reveal.jsè½¬æ¢å™¨ - ä¿®å¤ç‰ˆæœ¬
        class MarkdownToReveal {
            constructor() {
                this.slideSeparator = '---';
                marked.setOptions({ 
                    breaks: true, 
                    gfm: true,
                    sanitize: false  // ç¦ç”¨sanitizeä»¥å…è®¸HTML
                });
            }

            convertToSlides(enhancedMarkdown) {
                try {
                    const slides = enhancedMarkdown.split(this.slideSeparator);
                    let revealContent = '';
                    
                    slides.forEach((slideContent, index) => {
                        if (slideContent.trim()) {
                            const revealSlide = this.processForReveal(slideContent, index);
                            revealContent += `<section data-markdown><textarea data-template>\n${revealSlide}\n</textarea></section>\n\n`;
                        }
                    });
                    
                    return revealContent;
                } catch (error) {
                    throw new Error(`è½¬æ¢å¤±è´¥: ${error.message}`);
                }
            }

            processForReveal(content, slideIndex) {
                // ç§»é™¤å…ƒæ•°æ®å—
                let processed = content.replace(/:::meta[\s\S]*?:::/g, '');
                
                // å¤„ç†å…³é”®ç‚¹å—
                processed = processed.replace(/:::key-point\s*\n([\s\S]*?)\s*:::/g, 
                    '<div style="background:#fff3cd;padding:15px;border-left:4px solid #ffc107;border-radius:4px;margin:10px 0;"><strong>ğŸ’¡ å…³é”®ç‚¹:</strong><br>$1</div>');
                
                // å¦‚æœæ²¡æœ‰æ ‡é¢˜ï¼Œä¸ºç¬¬ä¸€é¡µæ·»åŠ é»˜è®¤æ ‡é¢˜
                if (slideIndex === 0 && !processed.includes('# ')) {
                    processed = '# ç¬”è®°å†…å®¹\n\n' + processed;
                }
                
                return processed;
            }
        }

        // Firebase ç®¡ç†å™¨
        class FirebaseManager {
            constructor() {
                this.auth = null;
                this.database = null;
                this.storage = null;
                this.user = null;
                this.currentNoteData = null;
                this.currentNoteKey = null;
                this.init();
            }

            init() {
                firebase.initializeApp(firebaseConfig);
                this.auth = firebase.auth();
                this.database = firebase.database();
                this.storage = firebase.storage();

                this.auth.onAuthStateChanged((user) => {
                    this.user = user;
                    if (user) {
                        this.updateUIForLogin(user);
                        this.loadDocuments();
                    } else {
                        this.updateUIForLogout();
                    }
                });
            }

            updateUIForLogin(user) {
                document.getElementById('user-info').style.display = 'flex';
                document.getElementById('login-display-btn').style.display = 'none';
                document.getElementById('user-name').textContent = user.displayName || user.email;
                document.getElementById('user-avatar').textContent = (user.displayName || user.email).charAt(0).toUpperCase();
                document.getElementById('auth-container').style.display = 'none';
            }

            updateUIForLogout() {
                document.getElementById('user-info').style.display = 'none';
                document.getElementById('login-display-btn').style.display = 'block';
                document.getElementById('auth-container').style.display = 'flex';
                document.getElementById('documents-list').innerHTML = '';
            }

            async signInWithGoogle() {
                try {
                    await this.auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
                } catch (error) {
                    document.getElementById('auth-error').textContent = `ç™»å½•å¤±è´¥: ${error.message}`;
                    document.getElementById('auth-error').style.display = 'block';
                }
            }

            async signOut() {
                await this.auth.signOut();
                this.currentNoteData = null;
                window.slideApp.resetSlides();
            }

            async loadDocuments() {
                if (!this.user) return;
                const statusEl = document.getElementById('documents-status');
                statusEl.textContent = 'åŠ è½½ä¸­...'; 
                statusEl.style.display = 'block';

                try {
                    const [foldersSnap, notesSnap] = await Promise.all([
                        this.database.ref('noteFolders').once('value'),
                        this.database.ref('mdNotes').once('value')
                    ]);
                    
                    this.renderSidebar(foldersSnap.val() || {}, notesSnap.val() || {});
                    statusEl.style.display = 'none';
                } catch (error) {
                    statusEl.textContent = `åŠ è½½å¤±è´¥: ${error.message}`;
                    statusEl.className = 'status error';
                }
            }

            renderSidebar(folders, notes) {
                const container = document.getElementById('documents-list');
                container.innerHTML = '';
                
                // ç»„ç»‡æ•°æ®
                const organized = { 'uncategorized': { info: {courseCode:'å…¶ä»–', course:'æœªåˆ†ç±»'}, notes: [] } };
                Object.keys(folders).forEach(k => organized[k] = { info: folders[k], notes: [] });

                Object.entries(notes).forEach(([key, note]) => {
                    const folderId = Object.keys(folders).find(fid => folders[fid].courseCode === note.subject?.courseCode);
                    const target = folderId ? organized[folderId] : organized['uncategorized'];
                    target.notes.push({ ...note, key: key });
                });

                // æ¸²æŸ“ UI
                Object.values(organized).forEach(group => {
                    if (group.notes.length === 0) return;
                    
                    const groupDiv = document.createElement('div');
                    groupDiv.className = 'folder-group';
                    
                    const header = document.createElement('div');
                    header.className = 'folder-header';
                    header.innerHTML = `<span>ğŸ“‚ ${group.info.courseCode} ${group.info.course}</span><span class="folder-count">${group.notes.length}</span>`;
                    
                    const content = document.createElement('div');
                    content.className = 'folder-content';
                    
                    header.onclick = () => {
                        content.classList.toggle('show');
                        header.classList.toggle('active');
                    };

                    group.notes.sort((a,b) => new Date(b.updatedAt) - new Date(a.updatedAt)).forEach(note => {
                        const item = document.createElement('div');
                        item.className = 'document-item';
                        item.innerHTML = `<div class="document-title">ğŸ“„ ${note.title}</div><div class="document-meta">${new Date(note.updatedAt).toLocaleDateString()}</div>`;
                        item.onclick = (e) => {
                            e.stopPropagation();
                            this.selectDocument(note, item);
                        };
                        content.appendChild(item);
                    });

                    groupDiv.append(header, content);
                    container.appendChild(groupDiv);
                });
            }

            async selectDocument(note, domElement) {
                document.querySelectorAll('.document-item').forEach(el => el.classList.remove('active'));
                domElement.classList.add('active');
                
                this.currentNoteKey = note.key;
                this.currentNoteData = note;

                document.getElementById('editor-loading').style.display = 'flex';

                try {
                    const res = await fetch(note.mdNote);
                    if (!res.ok) throw new Error('ä¸‹è½½å¤±è´¥');
                    const text = await res.text();
                    window.slideApp.loadSlides(text);
                } catch (e) {
                    alert('åŠ è½½ç¬”è®°å†…å®¹å¤±è´¥: ' + e.message);
                    window.slideApp.resetSlides();
                } finally {
                    document.getElementById('editor-loading').style.display = 'none';
                }
            }
        }

        // åº”ç”¨ä¸»ç±»
        class SlideApp {
            constructor() {
                this.converter = new MarkdownToReveal();
                this.firebaseManager = new FirebaseManager();
                this.revealInitialized = false;
                this.init();
            }

            init() {
                // åˆå§‹åŒ–Reveal.js
                this.initializeReveal();
                
                // ç»‘å®šæŒ‰é’®äº‹ä»¶
                document.getElementById('refresh-docs-btn').onclick = () => this.firebaseManager.loadDocuments();
                document.getElementById('google-login-btn').onclick = () => this.firebaseManager.signInWithGoogle();
                document.getElementById('login-display-btn').onclick = () => document.getElementById('auth-container').style.display = 'flex';
                document.getElementById('user-logout-btn').onclick = () => this.firebaseManager.signOut();
                
                document.getElementById('fullscreen-btn').onclick = () => this.toggleFullscreen();
                document.getElementById('toggle-sidebar').onclick = () => this.toggleSidebar();
                document.getElementById('prev-slide').onclick = () => Reveal.prev();
                document.getElementById('next-slide').onclick = () => Reveal.next();

                // ç‚¹å‡»é®ç½©å…³é—­
                document.getElementById('auth-container').onclick = (e) => {
                    if (e.target.id === 'auth-container') e.target.style.display = 'none';
                };
                
                // é”®ç›˜å¿«æ·é”®
                document.addEventListener('keydown', (e) => {
                    // ç©ºæ ¼é”®æˆ–å³ç®­å¤´é”®ç¿»é¡µ
                    if (e.code === 'Space' || e.code === 'ArrowRight') {
                        Reveal.next();
                        e.preventDefault();
                    }
                    // å·¦ç®­å¤´é”®è¿”å›ä¸Šä¸€é¡µ
                    else if (e.code === 'ArrowLeft') {
                        Reveal.prev();
                        e.preventDefault();
                    }
                    // Fé”®åˆ‡æ¢å…¨å±
                    else if (e.code === 'KeyF') {
                        this.toggleFullscreen();
                        e.preventDefault();
                    }
                    // ESCé”®é€€å‡ºå…¨å±æˆ–æ˜¾ç¤ºä¾§è¾¹æ 
                    else if (e.code === 'Escape') {
                        if (document.fullscreenElement) {
                            document.exitFullscreen();
                        } else if (document.body.classList.contains('fullscreen-mode')) {
                            this.toggleSidebar();
                        }
                    }
                });
            }
            
            initializeReveal() {
                if (!this.revealInitialized) {
                    Reveal.initialize({
                        hash: true,
                        slideNumber: 'c/t',
                        embedded: true,
                        transition: 'slide',
                        controls: false,
                        progress: false,
                        markdown: {
                            smartypants: true
                        }
                    });
                    this.revealInitialized = true;
                }
            }

            loadSlides(markdownContent) {
                try {
                    const slidesHTML = this.converter.convertToSlides(markdownContent);
                    const container = document.getElementById('slides-container');
                    
                    // å®Œå…¨æ›¿æ¢slideså†…å®¹
                    container.innerHTML = slidesHTML;
                    
                    // é”€æ¯å¹¶é‡æ–°åˆå§‹åŒ–Reveal.js
                    if (this.revealInitialized) {
                        Reveal.destroy();
                        this.revealInitialized = false;
                    }
                    
                    // é‡æ–°åˆå§‹åŒ–
                    Reveal.initialize({
                        hash: true,
                        slideNumber: 'c/t',
                        embedded: true,
                        transition: 'slide',
                        controls: false,
                        progress: false,
                        markdown: {
                            smartypants: true
                        }
                    }).then(() => {
                        // å¯ç”¨Markdownå¤„ç†
                        Reveal.markdown = marked;
                        // å¼ºåˆ¶é‡æ–°æ¸²æŸ“Markdown
                        Reveal.slide(0, 0, 0);
                        this.revealInitialized = true;
                    });
                    
                } catch (e) {
                    console.error('å¹»ç¯ç‰‡åŠ è½½å¤±è´¥:', e);
                    this.resetSlides();
                }
            }
            
            resetSlides() {
                const container = document.getElementById('slides-container');
                container.innerHTML = `
                    <section>
                        <h2>æ¬¢è¿ä½¿ç”¨ç¬”è®°å¤ä¹ ç³»ç»Ÿ</h2>
                        <p>è¯·ä»å·¦ä¾§é€‰æ‹©ç¬”è®°å¼€å§‹å¤ä¹ </p>
                    </section>
                `;
                
                if (this.revealInitialized) {
                    Reveal.destroy();
                    this.revealInitialized = false;
                }
                this.initializeReveal();
            }
            
            toggleFullscreen() {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen();
                    document.body.classList.add('fullscreen-mode');
                } else {
                    document.exitFullscreen();
                    document.body.classList.remove('fullscreen-mode');
                }
            }
            
            toggleSidebar() {
                document.body.classList.toggle('fullscreen-mode');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            window.slideApp = new SlideApp();
        });
        
        // ç›‘å¬å…¨å±å˜åŒ–
        document.addEventListener('fullscreenchange', () => {
            if (!document.fullscreenElement) {
                document.body.classList.remove('fullscreen-mode');
            }
        });
    </script>
</body>
</html>
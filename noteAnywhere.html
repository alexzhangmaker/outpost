<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown文档编辑器</title>
    <!-- TUI Editor 依赖 -->
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css">
    <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor-viewer.min.css">
    <!-- Firebase 依赖 -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <!-- Bootstrap 用于样式 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome 图标 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --sidebar-width: 80px;
            --doclist-width: 250px;
            --topbar-height: 60px;
        }
        
        body {
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        #top-bar {
            height: var(--topbar-height);
            background-color: #2c3e50;
            color: white;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            display: flex;
            align-items: center;
            padding: 0 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        #left-toolbar {
            position: fixed;
            left: 0;
            top: var(--topbar-height);
            width: var(--sidebar-width);
            height: calc(100vh - var(--topbar-height));
            background-color: #34495e;
            color: white;
            z-index: 900;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 20px;
        }
        
        #documents-panel {
            position: fixed;
            left: var(--sidebar-width);
            top: var(--topbar-height);
            width: var(--doclist-width);
            height: calc(100vh - var(--topbar-height));
            background-color: #ecf0f1;
            z-index: 800;
            transition: transform 0.3s ease;
            overflow-y: auto;
            padding: 15px;
            border-right: 1px solid #ddd;
        }
        
        #editor-container {
            position: fixed;
            left: calc(var(--sidebar-width) + var(--doclist-width));
            top: var(--topbar-height);
            width: calc(100vw - var(--sidebar-width) - var(--doclist-width));
            height: calc(100vh - var(--topbar-height));
            padding: 20px;
            overflow-y: auto;
            background-color: #fff;
        }
        
        .tool-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #2c3e50;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }
        
        .tool-btn:hover {
            background-color: #1abc9c;
            transform: scale(1.1);
        }
        
        .accordion-button:not(.collapsed) {
            background-color: #1abc9c;
            color: white;
        }
        
        .document-item {
            /*padding: 8px 12px;*/
            padding-left: 2px;
            border-radius: 4px;
            margin-bottom: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .document-item:hover {
            background-color: #d6dbdf;
        }
        
        .editor-toolbar {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
        }
        
        .editor-mode-btn {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f8f9fa;
            cursor: pointer;
        }
        
        .editor-mode-btn.active {
            background-color: #1abc9c;
            color: white;
            border-color: #1abc9c;
        }
        
        #save-modal input, #save-modal select {
            margin-bottom: 15px;
        }
        
        .hidden {
            transform: translateX(-100%);
        }
        
        /* 打印样式 */
        @media print {
            body * {
                visibility: hidden;
            }
            #print-area, #print-area * {
                visibility: visible;
            }
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- 顶部工具栏 -->
    <div id="top-bar">
        <div class="d-flex align-items-center">
            <i class="fas fa-file-alt fa-2x me-3"></i>
            <h4 class="mb-0">Markdown文档编辑器</h4>
        </div>
        <div class="ms-auto">
            <button class="btn btn-outline-light btn-sm me-2" id="config-btn">
                <i class="fas fa-cog"></i> 配置
            </button>
            <button class="btn btn-outline-light btn-sm">
                <i class="fas fa-user"></i> 登录
            </button>
        </div>
    </div>

    <!-- 左侧工具栏 -->
    <div id="left-toolbar">
        <button class="tool-btn" id="toggle-doclist" title="文档列表">
            <i class="fas fa-folder"></i>
        </button>
        <button class="tool-btn" id="new-doc" title="新建文档">
            <i class="fas fa-plus"></i>
        </button>
        <button class="tool-btn" id="save-doc" title="保存文档">
            <i class="fas fa-save"></i>
        </button>
        <button class="tool-btn" id="print-doc" title="打印文档">
            <i class="fas fa-print"></i>
        </button>
    </div>

    <!-- 文档列表区域 -->
    <div id="documents-panel">
        <h5>文档列表</h5>
        <div class="accordion mt-3" id="categories-accordion">
            <!-- 这里将通过JS动态生成文档分类和列表 -->
        </div>
    </div>

    <!-- 编辑器区域 -->
    <div id="editor-container">
        <div class="editor-toolbar">
            <button class="editor-mode-btn active" data-mode="edit">编辑模式</button>
            <button class="editor-mode-btn" data-mode="preview">预览模式</button>
            <button class="editor-mode-btn" data-mode="split">分屏模式</button>
            <div class="ms-auto">
                <span id="save-status" class="text-muted">已保存</span>
            </div>
        </div>
        <div id="editor"></div>
    </div>

    <!-- 保存文档的模态框 -->
    <div class="modal fade" id="save-modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">保存文档</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="doc-title" class="form-label">文档标题</label>
                        <input type="text" class="form-control" id="doc-title">
                    </div>
                    <div class="mb-3">
                        <label for="doc-path" class="form-label">保存路径</label>
                        <select class="form-select" id="doc-path">
                            <!-- 动态生成路径选项 -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="doc-tags" class="form-label">标签（用逗号分隔）</label>
                        <input type="text" class="form-control" id="doc-tags">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="confirm-save">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 打印区域（隐藏） -->
    <div id="print-area" style="display: none;"></div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- TUI Editor JS -->
    <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
    
    <script>
        // Firebase配置（请替换为您的实际配置）
        const firebaseConfig = {
            apiKey: "AIzaSyA6MZ_p5lVuy8TMAqiuV6IRx9fggV44lQs",
            authDomain: "outpost-8d74e.firebaseapp.com",
            databaseURL: "https://outpost-medium-20250810.asia-southeast1.firebasedatabase.app/",
            projectId: "outpost-8d74e",
            storageBucket: "outpost-8d74e.firebasestorage.app",
            messagingSenderId: "724993324937",
            appId: "1:724993324937:web:ce6c7e6b06489331c79358",
            measurementId: "G-QPHWRTH6BH"
        };


        // 初始化Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // 初始化TUI Editor
        const editor = new toastui.Editor({
            el: document.querySelector('#editor'),
            height: 'calc(100vh - 150px)',
            initialEditType: 'markdown',
            previewStyle: 'vertical',
            usageStatistics: false,
            hooks: {
                // 添加内容变化监听以实现自动保存提示
                addImageBlobHook: (blob, callback) => {
                    // 处理图片上传
                    alert('图片上传功能需要额外实现');
                }
            }
        });

        // 全局变量
        let currentDocId = null;
        let isDocumentChanged = false;
        let autoSaveTimer = null;
        let documentStructure = [];

        // DOM加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化文档列表
            loadDocumentStructure();
            
            // 绑定事件
            document.getElementById('toggle-doclist').addEventListener('click', toggleDocList);
            document.getElementById('new-doc').addEventListener('click', createNewDocument);
            document.getElementById('save-doc').addEventListener('click', showSaveModal);
            document.getElementById('print-doc').addEventListener('click', printDocument);
            document.getElementById('confirm-save').addEventListener('click', saveDocumentToFirebase);
            
            // 编辑器模式切换
            document.querySelectorAll('.editor-mode-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    changeEditorMode(this.dataset.mode);
                });
            });
            
            // 监听编辑器内容变化
            editor.on('change', function() {
                isDocumentChanged = true;
                document.getElementById('save-status').textContent = '未保存';
                
                // 设置自动保存提示
                clearTimeout(autoSaveTimer);
                autoSaveTimer = setTimeout(() => {
                    autoSaveToLocal();
                }, 2000);
            });
            
            // 监听页面离开事件
            window.addEventListener('beforeunload', function(e) {
                if (isDocumentChanged) {
                    e.preventDefault();
                    e.returnValue = '您有未保存的更改，确定要离开吗？';
                }
            });
        });

        // 切换文档列表显示/隐藏
        function toggleDocList() {
            const docPanel = document.getElementById('documents-panel');
            docPanel.classList.toggle('hidden');
            
            // 调整编辑器宽度
            const editorContainer = document.getElementById('editor-container');
            if (docPanel.classList.contains('hidden')) {
                editorContainer.style.left = '60px';
                editorContainer.style.width = 'calc(100vw - 60px)';
            } else {
                editorContainer.style.left = 'calc(60px + 250px)';
                editorContainer.style.width = 'calc(100vw - 310px)';
            }
        }

        // 从Firebase加载文档结构
        function loadDocumentStructure() {
            const docPath = 'documents/structure'; // 根据您的Firebase路径调整

            
            database.ref(docPath).once('value')
                .then((snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        documentStructure = data;
                        console.log(documentStructure) ;
                        renderDocumentStructure(data);
                    } else {
                        console.log('没有找到文档结构数据');
                    }
                })
                .catch((error) => {
                    console.error('加载文档结构失败:', error);
                });
        }

        // 渲染文档结构
        function renderDocumentStructure(structure) {
            const accordionContainer = document.getElementById('categories-accordion');
            accordionContainer.innerHTML = '';
            
            // 为保存模态框生成路径选项
            const pathSelect = document.getElementById('doc-path');
            pathSelect.innerHTML = '<option value="/">根目录</option>';
            
            // 递归渲染文档结构
            function renderItems(items, parentId, level = 0) {
                let html = '';
                
                items.forEach((item, index) => {
                    const itemId = `${parentId}-${index}`;
                    
                    if (item.isFolder) {
                        if(item.children){
                            // 这是一个分类/文件夹
                            html += `
                                <div class="accordion-item">
                                    <h4 class="accordion-header" id="heading-${itemId}">
                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                                data-bs-target="#collapse-${itemId}" aria-expanded="false" 
                                                aria-controls="collapse-${itemId}">
                                            ${item.name}
                                        </button>
                                    </h4>
                                    <div id="collapse-${itemId}" class="accordion-collapse collapse" 
                                        aria-labelledby="heading-${itemId}" data-bs-parent="#categories-accordion">
                                        <div class="accordion-body">
                                            ${renderItems(item.children, itemId, level + 1)}
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                        
                        
                        // 为保存模态框添加选项
                        const indent = '— '.repeat(level + 1);
                        pathSelect.innerHTML += `<option value="${item.id}">${indent}${item.name}</option>`;
                    } else {
                        // 这是一个文档
                        html += `
                            <div class="document-item" data-id="${item.id}">
                                <i class="fas fa-file-alt me-2"></i> ${item.title}
                            </div>
                        `;
                    }
                });
                
                return html;
            }
            
            accordionContainer.innerHTML = renderItems(structure, 'root');
            
            // 添加文档点击事件
            document.querySelectorAll('.document-item').forEach(item => {
                item.addEventListener('click', function() {
                    loadDocumentFromFirebase(this.dataset.id);
                });
            });
        }

        // 从Firebase加载文档内容
        function loadDocumentFromFirebase(docId) {
            // 检查当前文档是否有未保存的更改
            if (isDocumentChanged && !confirm('当前文档有未保存的更改，确定要加载新文档吗？')) {
                return;
            }
            
            const docPath = `documents/content/${docId}`;
            
            database.ref(docPath).once('value')
                .then((snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        editor.setMarkdown(data.content);
                        currentDocId = docId;
                        isDocumentChanged = false;
                        document.getElementById('save-status').textContent = '已加载';
                    } else {
                        console.log('没有找到文档内容');
                    }
                })
                .catch((error) => {
                    console.error('加载文档失败:', error);
                });
        }

        // 创建新文档
        function createNewDocument() {
            // 检查当前文档是否有未保存的更改
            if (isDocumentChanged && !confirm('当前文档有未保存的更改，确定要创建新文档吗？')) {
                return;
            }
            
            editor.setMarkdown('# 新文档\n\n开始编写您的内容...');
            currentDocId = null;
            isDocumentChanged = false;
            document.getElementById('save-status').textContent = '新文档';
        }

        // 显示保存模态框
        function showSaveModal() {
            // 如果没有更改，无需保存
            if (!isDocumentChanged && currentDocId) {
                alert('文档没有更改，无需保存');
                return;
            }
            
            const modal = new bootstrap.Modal(document.getElementById('save-modal'));
            modal.show();
        }

        // 保存文档到Firebase
        function saveDocumentToFirebase() {
            const title = document.getElementById('doc-title').value;
            const path = document.getElementById('doc-path').value;
            const tags = document.getElementById('doc-tags').value.split(',').map(tag => tag.trim());
            const content = editor.getMarkdown();
            
            if (!title) {
                alert('请输入文档标题');
                return;
            }
            
            // 生成文档ID（如果是新文档）
            const docId = currentDocId || generateId();
            
            // 保存文档内容
            database.ref(`documents/content/${docId}`).set({
                title: title,
                content: content,
                tags: tags,
                path: path,
                updatedAt: firebase.database.ServerValue.TIMESTAMP
            })
            .then(() => {
                // 如果文档结构需要更新
                if (!currentDocId) {
                    updateDocumentStructure(docId, title, path);
                }
                
                // 更新状态
                currentDocId = docId;
                isDocumentChanged = false;
                document.getElementById('save-status').textContent = '已保存';
                
                // 关闭模态框
                bootstrap.Modal.getInstance(document.getElementById('save-modal')).hide();
                
                // 重新加载文档结构
                loadDocumentStructure();
            })
            .catch((error) => {
                console.error('保存文档失败:', error);
                alert('保存失败，请重试');
            });
        }

        function _locateFolder(folder,id){
            if(folder.id == id)return folder ;
            if(folder.hasOwnProperty("isFolder")==false)return null ;
            if(folder.isFolder==false)return null ;

            for(let i=0;i<folder.children.length;i++){
                let targetFolder = _locateFolder(folder.children[i],id) ;
                if(targetFolder !=null) return targetFolder ;
            }
            return null ;
        }

        // 更新文档结构
        function updateDocumentStructure(docId, title, path) {
            // 这里需要根据路径找到正确的位置添加文档引用
            // 这是一个简化的示例，实际实现可能需要递归查找路径
            console.log(documentStructure);
            if (path === '/') {
                // 添加到根目录
                documentStructure.push({
                    id: docId,
                    title: title
                });
                // 更新Firebase中的文档结构
                database.ref('documents/structure').set(documentStructure);
            } else {
                // 需要根据路径找到正确的位置
                // 这里简化处理，实际需要递归查找
                //using path which is actually id of the folder
                console.log('需要实现根据路径添加文档到结构');
                for(let i=0;i<documentStructure.length;i++){
                    let jsonFolder = _locateFolder(documentStructure[i],path) ;
                    if(jsonFolder!=null){
                        if(jsonFolder.children){
                            jsonFolder.children.push({
                                id: docId,
                                title: title
                            }) ;
                        }else{
                            jsonFolder.children=[{
                                id: docId,
                                title: title
                            }] ;
                        }
                        database.ref(`documents/structure/${jsonFolder.path}/children`).set(jsonFolder.children);
                        break ;
                    }
                }

            }
            
            
        }

        // 自动保存到本地存储
        function autoSaveToLocal() {
            if (!isDocumentChanged) return;
            
            const content = editor.getMarkdown();
            localStorage.setItem('md_autosave', content);
            document.getElementById('save-status').textContent = '已自动保存到本地';
        }

        // 从本地存储恢复自动保存的内容
        function restoreFromLocal() {
            const content = localStorage.getItem('md_autosave');
            if (content) {
                if (confirm('检测到自动保存的内容，是否恢复？')) {
                    editor.setMarkdown(content);
                    isDocumentChanged = true;
                    document.getElementById('save-status').textContent = '已从本地恢复';
                }
            }
        }

        // 切换编辑器模式
        function changeEditorMode(mode) {
            // 移除所有活动状态
            document.querySelectorAll('.editor-mode-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // 设置当前活动状态
            document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
            
            // 更改编辑器模式
            switch(mode) {
                case 'edit':
                    editor.changePreviewStyle('vertical');
                    break;
                case 'preview':
                    editor.changePreviewStyle('tab');
                    break;
                case 'split':
                    editor.changePreviewStyle('vertical');
                    break;
            }
        }

        // 打印文档
        function printDocument() {
            const content = editor.getHTML();
            const printArea = document.getElementById('print-area');
            
            // 创建打印友好的HTML
            printArea.innerHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>打印文档</title>
                    <style>
                        body { font-family: Arial, sans-serif; line-height: 1.6; padding: 20px; }
                        h1, h2, h3 { color: #333; }
                        pre { background: #f4f4f4; padding: 10px; border-radius: 5px; }
                        blockquote { border-left: 4px solid #ddd; padding-left: 15px; color: #666; }
                        table { border-collapse: collapse; width: 100%; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                    </style>
                </head>
                <body>
                    ${content}
                </body>
                </html>
            `;
            
            // 触发打印
            window.print();
        }

        // 生成唯一ID
        function generateId() {
            return 'doc-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        }

        // 初始化时尝试从本地存储恢复
        window.addEventListener('load', function() {
            setTimeout(restoreFromLocal, 500);
        });
    </script>
    
</body>
</html>
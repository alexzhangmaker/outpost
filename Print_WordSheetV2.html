<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Thai Word Practice Sheet</title>
  <!-- Tailwind CSS via CDN (v3.4+) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3b82f6',
          }
        }
      }
    }
  </script>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>
  <style>
    /* A4ÊâìÂç∞‰∏ìÁî®Ê†∑Âºè */
    @media print {
      @page {
        size: A4 portrait;
        margin: 15mm;
      }
      
      body {
        margin: 0;
        padding: 0;
        background: white;
        width: 210mm;
        height: 297mm;
      }
      
      .no-print {
        display: none !important;
      }
      
      .print-page {
        width: 210mm;
        height: 297mm;
        page-break-after: always;
        position: relative;
        overflow: hidden;
      }
      
      .print-page:last-child {
        page-break-after: auto;
      }
      
      .page-content {
        padding: 15mm;
        height: 100%;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
      }
      
      .words-grid {
        flex: 1;
        display: grid;
        gap: 4mm;
        page-break-inside: avoid;
      }
      
      .word-cell {
        border: 1px solid #000;
        page-break-inside: avoid;
        break-inside: avoid;
      }
      
      .manual-page-break {
        border-top: 2px dashed #999;
        margin: 10mm 0;
        text-align: center;
        color: #666;
        font-style: italic;
        page-break-after: always;
      }
    }
    
    /* Â±èÂπïÈ¢ÑËßàÊ†∑Âºè */
    @media screen {
      .a4-preview {
        width: 210mm;
        min-height: 297mm;
        margin: 20px auto;
        background: white;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
      }
      
      .page-break {
        border-top: 2px dashed #ccc;
        margin: 20px 0;
        padding: 10px 0;
      }
      
      .manual-page-break {
        border-top: 2px dashed #f00;
        margin: 10mm 0;
        padding: 5mm 0;
        text-align: center;
        color: #f00;
        font-style: italic;
        background-color: #fff0f0;
        position: relative;
      }
      
      .remove-break-btn {
        position: absolute;
        top: 50%;
        right: 10px;
        transform: translateY(-50%);
        background: #f00;
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .add-break-btn {
        display: block;
        width: 100%;
        padding: 5px;
        margin: 5px 0;
        background: #4CAF50;
        color: white;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
      }
      
      .add-break-btn:hover {
        background: #45a049;
      }
    }
  </style>
</head>
<body class="bg-gray-50 font-sans">
  <!-- Login Splash -->
  <div id="login-splash" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center p-4 hidden">
    <div class="text-center max-w-md">
      <h1 class="text-2xl font-bold text-gray-800 mb-6">Sign in to Print</h1>
      <button id="btn-google-login" 
              class="flex items-center justify-center gap-2 bg-red-500 hover:bg-red-600 text-white font-medium px-6 py-3 rounded-lg shadow-md transition">
        <svg class="w-5 h-5" viewBox="0 0 24 24">
          <path fill="currentColor" d="M12.24 10.285V14.4h6.806c-.275 1.765-2.056 5.174-6.806 5.174-4.095 0-7.439-3.389-7.439-7.574s3.344-7.574 7.439-7.574c2.328 0 3.891.989 4.785 1.849l3.254-3.138C18.189 1.186 15.479 0 12.24 0c-6.635 0-12 5.365-12 12s5.365 12 12 12c6.926 0 11.52-4.869 11.52-11.726 0-.788-.085-1.39-.189-1.989H12.24z"/>
        </svg>
        Sign in with Google
      </button>
      <div class="mt-6">
        <button id="btn-guest-mode" class="text-blue-600 hover:underline text-sm">
          ‚Ü™Ô∏è Continue as Guest (for testing)
        </button>
      </div>
    </div>
  </div>

  <!-- Main App -->
  <div id="app-container" class="hidden">
    <!-- Top Bar -->
    <header class="bg-white shadow no-print">
      <div class="px-4 py-3 flex justify-between items-center">
        <h1 class="text-xl font-semibold text-gray-800">Thai Word Practice Sheet</h1>
        <div>
          <span id="user-display" class="text-sm text-gray-600 mr-4"></span>
          <button id="btn-logout" class="text-sm text-blue-600 hover:underline">Logout</button>
        </div>
      </div>
    </header>

    <div class="flex flex-col md:flex-row h-[calc(100vh-64px)]">
      <!-- Parameter Panel -->
      <div id="param-panel" class="w-full md:w-80 bg-white p-4 border-r overflow-y-auto no-print">
        <h2 class="font-bold text-gray-700 mb-4">üñ®Ô∏è Print Settings</h2>

        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-600">Worksheet Title</label>
            <input type="text" id="param-title" value="Thai Word Practice" 
                   class="mt-1 block w-full rounded border-gray-300 px-3 py-2 text-sm shadow-sm focus:ring-blue-500 focus:border-blue-500"/>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-600">Instructions</label>
            <textarea id="param-instructions" rows="3" class="mt-1 block w-full rounded border-gray-300 px-3 py-2 text-sm shadow-sm focus:ring-blue-500 focus:border-blue-500">Write the meaning and part of speech for each Thai word.</textarea>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-600">Font Size</label>
            <select id="param-font-size" class="mt-1 block w-full rounded border-gray-300 px-3 py-2 text-sm">
              <option value="text-sm">Small</option>
              <option value="text-base" selected>Medium</option>
              <option value="text-lg">Large</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-600">Columns</label>
            <select id="param-columns" class="mt-1 block w-full rounded border-gray-300 px-3 py-2 text-sm">
              <option value="2" selected>2 Columns</option>
              <option value="3">3 Columns</option>
              <option value="4">4 Columns</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-600">Rows per Page</label>
            <select id="param-rows" class="mt-1 block w-full rounded border-gray-300 px-3 py-2 text-sm">
              <option value="6">6 Rows</option>
              <option value="8" selected>8 Rows</option>
              <option value="10">10 Rows</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-600">Cell Height</label>
            <select id="param-cell-height" class="mt-1 block w-full rounded border-gray-300 px-3 py-2 text-sm">
              <option value="30">Small (30mm)</option>
              <option value="35" selected>Medium (35mm)</option>
              <option value="40">Large (40mm)</option>
            </select>
          </div>

          <div class="flex items-center">
            <input type="checkbox" id="param-show-header" checked 
                   class="h-4 w-4 text-blue-600 rounded focus:ring-blue-500"/>
            <label class="ml-2 block text-sm font-medium text-gray-600">Show Header</label>
          </div>

          <div class="flex items-center">
            <input type="checkbox" id="param-show-footer" checked 
                   class="h-4 w-4 text-blue-600 rounded focus:ring-blue-500"/>
            <label class="ml-2 block text-sm font-medium text-gray-600">Show Page Numbers</label>
          </div>

          <div class="flex items-center">
            <input type="checkbox" id="param-enable-manual-breaks" checked 
                   class="h-4 w-4 text-blue-600 rounded focus:ring-blue-500"/>
            <label class="ml-2 block text-sm font-medium text-gray-600">Enable Manual Page Breaks</label>
          </div>

          <button id="btn-apply" 
                  class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded transition">
            üîÑ Apply & Preview
          </button>

          <button id="btn-print" 
                  class="w-full bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded transition mt-2">
            üñ®Ô∏è Print Now
          </button>
          
          <div class="text-xs text-gray-500 mt-4">
            <p>üí° Tips for best printing:</p>
            <ul class="list-disc list-inside mt-1">
              <li>Use A4 paper</li>
              <li>Set margins to "Default" or "Minimum"</li>
              <li>Check "Background graphics" in print settings</li>
            </ul>
            <p class="mt-2">üìù Manual Page Breaks:</p>
            <ul class="list-disc list-inside mt-1">
              <li>Click "Add Page Break" buttons to insert manual breaks</li>
              <li>Click "√ó" to remove a break</li>
              <li>Breaks are saved in URL for sharing</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Print Content Preview -->
      <div class="flex-1 p-4 overflow-auto bg-gray-100">
        <div id="print-content" class="a4-preview">
          <!-- Rendered here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-20 flex items-center justify-center z-40 hidden">
    <div class="bg-white px-6 py-4 rounded-lg shadow-lg flex items-center">
      <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
      </svg>
      Loading data...
    </div>
  </div>

  <!-- Script Section -->
  <script>
    // Firebase Config
    const firebaseConfig = {
        apiKey: "AIzaSyA6MZ_p5lVuy8TMAqiuV6IRx9fggV44lQs",
        authDomain: "outpost-8d74e.firebaseapp.com",
        databaseURL: "https://outpost-dictionary-116208.asia-southeast1.firebasedatabase.app/",
        projectId: "outpost-8d74e",
        storageBucket: "outpost-8d74e.firebasestorage.app",
        messagingSenderId: "724993324937",
        appId: "1:724993324937:web:ce6c7e6b06489331c79358",
        measurementId: "G-QPHWRTH6BH"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // Mock Data
    const MOCK_DATA = {
      classification: "a2RWBCvyLbQHVom4eGDoNt",
      createdAt: "2025-11-26",
      words: ["‡∏õ‡∏£‡∏∞‡πÄ‡∏û‡∏ì‡∏µ", "‡πÄ‡∏≠‡∏Å‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå", "‡∏†‡∏π‡∏°‡∏¥‡∏õ‡∏±‡∏ç‡∏ç‡∏≤", "‡∏ä‡∏∏‡∏°‡∏ä‡∏ô", "‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏£‡∏£‡∏°", "‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå", "‡∏û‡∏¥‡∏ò‡∏µ‡∏Å‡∏£‡∏£‡∏°", "‡∏™‡∏∑‡∏ö‡∏ó‡∏≠‡∏î", "‡∏ß‡∏±‡∏í‡∏ô‡∏ò‡∏£‡∏£‡∏°", "‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏Å‡∏≤‡∏®", "‡∏≠‡∏ô‡∏∏‡∏£‡∏±‡∏Å‡∏©‡πå", "‡∏®‡∏¥‡∏•‡∏õ‡∏∞", "‡∏ó‡∏≠‡∏ú‡πâ‡∏≤", "‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô", "‡∏õ‡∏£‡∏∞‡πÄ‡∏û‡∏ì‡∏µ", "‡πÄ‡∏≠‡∏Å‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå", "‡∏†‡∏π‡∏°‡∏¥‡∏õ‡∏±‡∏ç‡∏ç‡∏≤", "‡∏ä‡∏∏‡∏°‡∏ä‡∏ô", "‡∏´‡∏±‡∏ï‡∏ñ‡∏Å‡∏£‡∏£‡∏°", "‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå", "‡∏û‡∏¥‡∏ò‡∏µ‡∏Å‡∏£‡∏£‡∏°", "‡∏™‡∏∑‡∏ö‡∏ó‡∏≠‡∏î", "‡∏ß‡∏±‡∏í‡∏ô‡∏ò‡∏£‡∏£‡∏°", "‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏Å‡∏≤‡∏®", "‡∏≠‡∏ô‡∏∏‡∏£‡∏±‡∏Å‡∏©‡πå", "‡∏®‡∏¥‡∏•‡∏õ‡∏∞", "‡∏ó‡∏≠‡∏ú‡πâ‡∏≤", "‡∏ó‡πâ‡∏≠‡∏á‡∏ñ‡∏¥‡πà‡∏ô"],
      "ÂàÜÁ±ªtitle": "Reading.20251126"
    };

    // DOM Elements
    const elLoginSplash = document.getElementById('login-splash');
    const elAppContainer = document.getElementById('app-container');
    const elUserDisplay = document.getElementById('user-display');
    const elPrintContent = document.getElementById('print-content');
    const elLoading = document.getElementById('loading-overlay');

    // Global variables
    let currentUser = null;
    let currentData = null;
    let manualPageBreaks = new Set(); // Store indices where manual breaks are inserted

    // Utility Functions
    function showLoading(show = true) {
      elLoading.classList.toggle('hidden', !show);
    }

    function getUrlParam(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }

    // Parse manual breaks from URL
    function parseManualBreaksFromURL() {
      const breaksParam = getUrlParam('breaks');
      if (breaksParam) {
        return new Set(breaksParam.split(',').map(Number));
      }
      return new Set();
    }

    // Update URL with manual breaks
    function updateURLWithBreaks() {
      const url = new URL(window.location);
      if (manualPageBreaks.size > 0) {
        url.searchParams.set('breaks', Array.from(manualPageBreaks).join(','));
      } else {
        url.searchParams.delete('breaks');
      }
      window.history.replaceState({}, '', url);
    }

    // Safe DOM element getter with null checking
    function getElementSafe(id) {
      const element = document.getElementById(id);
      if (!element) {
        console.error(`Element with id '${id}' not found`);
        return null;
      }
      return element;
    }

    // Data Fetching
    async function fetchData(wordsetID) {
      showLoading(true);
      try {
        if (currentUser && wordsetID && wordsetID !== 'default') {
          const snapshot = await db.ref(`thaiWordList/${wordsetID}`).once('value');
          const data = snapshot.val();
          if (!data) throw new Error('No data found for wordsetID: ' + wordsetID);
          return data;
        } else {
          console.warn('[GUEST MODE] Using mock data');
          return MOCK_DATA;
        }
      } catch (error) {
        console.error('Error fetching data:', error);
        // Fallback to mock data if there's an error
        return MOCK_DATA;
      } finally {
        showLoading(false);
      }
    }

    // Content Rendering with proper pagination and manual breaks
    function renderPrintContent(params, data) {
      const {
        title = data["ÂàÜÁ±ªtitle"] || "Thai Word Practice",
        instructions = "Write the meaning and part of speech for each Thai word.",
        fontSize = "text-base",
        showHeader = true,
        showFooter = true,
        columns = 2,
        rowsPerPage = 8,
        cellHeight = 35,
        enableManualBreaks = true
      } = params;

      const words = data.words || [];
      
      // If manual breaks are enabled and we have breaks, use them for pagination
      let pages = [];
      if (enableManualBreaks && manualPageBreaks.size > 0) {
        pages = createPagesWithManualBreaks(words, columns, rowsPerPage);
      } else {
        // Use automatic pagination
        const wordsPerPage = columns * rowsPerPage;
        const totalPages = Math.ceil(words.length / wordsPerPage);
        
        for (let page = 0; page < totalPages; page++) {
          const startIndex = page * wordsPerPage;
          const endIndex = Math.min(startIndex + wordsPerPage, words.length);
          pages.push(words.slice(startIndex, endIndex));
        }
      }
      
      let pagesHTML = '';
      
      pages.forEach((pageWords, pageIndex) => {
        // Calculate grid layout
        const rows = Math.ceil(pageWords.length / columns);
        const gridTemplateColumns = `repeat(${columns}, 1fr)`;
        const gridTemplateRows = `repeat(${rows}, ${cellHeight}mm)`;
        
        // Header
        let headerHTML = '';
        if (showHeader) {
          headerHTML = `
            <div class="border-b border-gray-300 pb-3 mb-4">
              <h1 class="text-2xl font-bold text-center text-gray-800 mb-2">${title}</h1>
              <p class="text-sm text-gray-600 text-center mb-2">${instructions}</p>
              <div class="flex justify-between text-xs text-gray-500">
                <span>Name: ___________________</span>
                <span>Class: ___________________</span>
                <span>Date: ___________________</span>
              </div>
            </div>
          `;
        }
        
        // Words grid
        let gridHTML = '';
        pageWords.forEach((word, wordIndex) => {
          gridHTML += `
            <div class="word-cell border border-gray-400 p-3 break-inside-avoid">
              <div class="flex flex-col h-full">
                <div class="font-bold text-lg mb-2 text-center text-gray-800 border-b border-gray-200 pb-1">
                  ${word}
                </div>
                <div class="flex-1">
                  <div class="mb-2">
                    <div class="text-xs text-gray-500 mb-1">Meaning:</div>
                    <div class="h-5 border-b border-gray-300"></div>
                  </div>
                  <div class="mb-2">
                    <div class="text-xs text-gray-500 mb-1">Part of Speech:</div>
                    <div class="h-5 border-b border-gray-300"></div>
                  </div>
                  <div>
                    <div class="text-xs text-gray-500 mb-1">Example Sentence:</div>
                    <div class="h-8 border-b border-gray-300"></div>
                  </div>
                </div>
              </div>
              ${enableManualBreaks ? `
                <button class="add-break-btn no-print" data-word-index="${getGlobalWordIndex(words, pageWords, pageIndex, wordIndex)}">
                  Add Page Break After This Word
                </button>
              ` : ''}
            </div>
          `;
        });
        
        // Fill empty cells if needed
        const totalCells = rows * columns;
        const emptyCells = totalCells - pageWords.length;
        for (let i = 0; i < emptyCells; i++) {
          gridHTML += `
            <div class="word-cell border border-gray-400 p-3 break-inside-avoid">
              <div class="flex flex-col h-full">
                <div class="font-bold text-lg mb-2 text-center text-gray-300 border-b border-gray-200 pb-1">
                  &nbsp;
                </div>
                <div class="flex-1">
                  <div class="mb-2">
                    <div class="text-xs text-gray-300 mb-1">Meaning:</div>
                    <div class="h-5 border-b border-gray-200"></div>
                  </div>
                  <div class="mb-2">
                    <div class="text-xs text-gray-300 mb-1">Part of Speech:</div>
                    <div class="h-5 border-b border-gray-200"></div>
                  </div>
                  <div>
                    <div class="text-xs text-gray-300 mb-1">Example Sentence:</div>
                    <div class="h-8 border-b border-gray-200"></div>
                  </div>
                </div>
              </div>
            </div>
          `;
        }
        
        // Footer
        let footerHTML = '';
        if (showFooter) {
          footerHTML = `
            <div class="mt-4 pt-3 border-t border-gray-300 text-center text-xs text-gray-500">
              Page ${pageIndex + 1} of ${pages.length}
            </div>
          `;
        }
        
        // Assemble page
        pagesHTML += `
          <div class="print-page">
            <div class="page-content">
              ${headerHTML}
              <div class="words-grid" style="grid-template-columns: ${gridTemplateColumns}; grid-template-rows: ${gridTemplateRows}; gap: 4mm;">
                ${gridHTML}
              </div>
              ${footerHTML}
            </div>
          </div>
        `;
        
        // Add manual page break indicator if this isn't the last page
        if (pageIndex < pages.length - 1 && enableManualBreaks) {
          pagesHTML += `
            <div class="manual-page-break no-print" data-break-index="${pageIndex}">
              Manual Page Break
              <button class="remove-break-btn" data-break-index="${pageIndex}">√ó</button>
            </div>
          `;
        }
      });

      // Final assembly
      elPrintContent.innerHTML = pagesHTML;

      // Add event listeners for manual break buttons
      if (enableManualBreaks) {
        document.querySelectorAll('.add-break-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const wordIndex = parseInt(this.getAttribute('data-word-index'));
            addManualBreak(wordIndex);
          });
        });
        
        document.querySelectorAll('.remove-break-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const breakIndex = parseInt(this.getAttribute('data-break-index'));
            removeManualBreak(breakIndex);
          });
        });
      }

      // Print styles
      const style = document.getElementById('print-style');
      if (style) style.remove();
      
      const printStyle = document.createElement('style');
      printStyle.id = 'print-style';
      printStyle.textContent = `
        @media print {
          @page {
            size: A4 portrait;
            margin: 15mm;
          }
          
          body, html {
            margin: 0;
            padding: 0;
            width: 210mm;
            height: 297mm;
          }
          
          .no-print {
            display: none !important;
          }
          
          .print-page {
            width: 210mm;
            height: 297mm;
            page-break-after: always;
            position: relative;
            overflow: hidden;
          }
          
          .print-page:last-child {
            page-break-after: auto;
          }
          
          .page-content {
            padding: 15mm;
            height: 100%;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
          }
          
          .words-grid {
            flex: 1;
            display: grid;
            gap: 4mm;
            page-break-inside: avoid;
          }
          
          .word-cell {
            border: 1px solid #000;
            page-break-inside: avoid;
            break-inside: avoid;
          }
          
          .manual-page-break {
            border-top: 2px dashed #999;
            margin: 10mm 0;
            text-align: center;
            color: #666;
            font-style: italic;
            page-break-after: always;
          }
        }
        
        @media screen {
          .a4-preview {
            width: 210mm;
            min-height: 297mm;
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
          }
          
          .print-page {
            margin-bottom: 20px;
            border: 1px solid #ccc;
          }
          
          .page-content {
            padding: 15mm;
            min-height: 297mm;
          }
        }
      `;
      document.head.appendChild(printStyle);
    }

    // Helper function to get global word index
    function getGlobalWordIndex(allWords, pageWords, pageIndex, wordIndex) {
      // This is a simplified implementation
      // In a real scenario, you'd need to track the actual global index
      let globalIndex = 0;
      for (let i = 0; i < pageIndex; i++) {
        // This would need to be calculated based on your pagination logic
        globalIndex += Math.ceil(allWords.length / (allWords.length / pageWords.length));
      }
      return globalIndex + wordIndex;
    }

    // Create pages with manual breaks
    function createPagesWithManualBreaks(words, columns, rowsPerPage) {
      const pages = [];
      let currentPage = [];
      const maxWordsPerPage = columns * rowsPerPage;
      
      words.forEach((word, index) => {
        currentPage.push(word);
        
        // Check if we need to break page
        if (manualPageBreaks.has(index) || currentPage.length >= maxWordsPerPage) {
          pages.push([...currentPage]);
          currentPage = [];
        }
      });
      
      // Add any remaining words
      if (currentPage.length > 0) {
        pages.push(currentPage);
      }
      
      return pages;
    }

    // Add a manual page break
    function addManualBreak(wordIndex) {
      manualPageBreaks.add(wordIndex);
      updateURLWithBreaks();
      applyParams(); // Re-render with the new break
    }

    // Remove a manual page break
    function removeManualBreak(breakIndex) {
      // This is a simplified implementation
      // In a real scenario, you'd need to map break indices to word indices
      const breaksArray = Array.from(manualPageBreaks);
      if (breakIndex < breaksArray.length) {
        manualPageBreaks.delete(breaksArray[breakIndex]);
        updateURLWithBreaks();
        applyParams(); // Re-render without the break
      }
    }

    // Parameter Application with safe element access
    function applyParams() {
      try {
        const titleElement = getElementSafe('param-title');
        const instructionsElement = getElementSafe('param-instructions');
        const fontSizeElement = getElementSafe('param-font-size');
        const showHeaderElement = getElementSafe('param-show-header');
        const showFooterElement = getElementSafe('param-show-footer');
        const columnsElement = getElementSafe('param-columns');
        const rowsElement = getElementSafe('param-rows');
        const cellHeightElement = getElementSafe('param-cell-height');
        const enableManualBreaksElement = getElementSafe('param-enable-manual-breaks');

        // If any required element is missing, use defaults
        if (!titleElement || !instructionsElement) {
          console.warn('Some form elements not found, using default values');
        }

        const params = {
          title: titleElement ? titleElement.value : "Thai Word Practice",
          instructions: instructionsElement ? instructionsElement.value : "Write the meaning and part of speech for each Thai word.",
          fontSize: fontSizeElement ? fontSizeElement.value : "text-base",
          showHeader: showHeaderElement ? showHeaderElement.checked : true,
          showFooter: showFooterElement ? showFooterElement.checked : true,
          columns: columnsElement ? parseInt(columnsElement.value) : 2,
          rowsPerPage: rowsElement ? parseInt(rowsElement.value) : 8,
          cellHeight: cellHeightElement ? parseInt(cellHeightElement.value) : 35,
          enableManualBreaks: enableManualBreaksElement ? enableManualBreaksElement.checked : true
        };
        
        if (currentData) {
          renderPrintContent(params, currentData);
        }
      } catch (error) {
        console.error('Error applying parameters:', error);
        // Fallback to default rendering if there's an error
        if (currentData) {
          renderPrintContent({}, currentData);
        }
      }
    }

    // Event Handlers
    document.getElementById('btn-google-login').addEventListener('click', () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      provider.addScope('profile');
      provider.addScope('email');
      auth.signInWithPopup(provider)
        .catch(err => alert('Login failed: ' + err.message));
    });

    document.getElementById('btn-guest-mode').addEventListener('click', async () => {
      currentUser = { isGuest: true, displayName: 'Guest', email: 'guest@example.com' };
      elLoginSplash.classList.add('hidden');
      elAppContainer.classList.remove('hidden');
      elUserDisplay.textContent = 'Guest (testing)';
      await initializeApp();
    });

    document.getElementById('btn-logout').addEventListener('click', () => {
      auth.signOut().then(() => {
        currentUser = null;
        elAppContainer.classList.add('hidden');
        elLoginSplash.classList.remove('hidden');
      });
    });

    document.getElementById('btn-apply').addEventListener('click', applyParams);
    document.getElementById('btn-print').addEventListener('click', () => {
      window.print();
    });

    // App Initialization
    async function initializeApp() {
      showLoading(true);
      try {
        const wordsetID = getUrlParam('wordsetID');
        console.log('Fetching data for wordsetID:', wordsetID);
        currentData = await fetchData(wordsetID);
        console.log('Data loaded:', currentData);
        
        // Load manual breaks from URL
        manualPageBreaks = parseManualBreaksFromURL();
        
        applyParams();
      } catch (err) {
        console.error('Error initializing app:', err);
        alert('‚ö†Ô∏è Failed to load data:\n' + err.message);
      } finally {
        showLoading(false);
      }
    }

    // Auth state observer
    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        elUserDisplay.textContent = user.displayName || user.email;
        elLoginSplash.classList.add('hidden');
        elAppContainer.classList.remove('hidden');
        initializeApp();
      } else if (!currentUser?.isGuest) {
        elLoginSplash.classList.remove('hidden');
        elAppContainer.classList.add('hidden');
      }
    });

    // Auto guest mode
    if (getUrlParam('guest') === '1') {
      document.getElementById('btn-guest-mode').click();
    }

    // Initialize app if already authenticated
    document.addEventListener('DOMContentLoaded', function() {
      // Check if user is already signed in
      auth.onAuthStateChanged(function(user) {
        if (user) {
          currentUser = user;
          elUserDisplay.textContent = user.displayName || user.email;
          elLoginSplash.classList.add('hidden');
          elAppContainer.classList.remove('hidden');
          initializeApp();
        }
      });
    });
  </script>
</body>
</html>
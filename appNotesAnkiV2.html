<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ³°è¯­è¯­æ³• Anki æ™ºèƒ½äº‘ç«¯ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+Thai:wght@100..900&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: "Noto Serif Thai", serif;
            background-color: #f8fafc;
        }

        .thai-text {
            font-family: 'Kanit', sans-serif;
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #login-splash {
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
        }
    </style>
</head>

<body class="min-h-screen flex flex-col">

    <div id="login-splash" class="fixed inset-0 z-50 flex items-center justify-center text-white">
        <div class="text-center p-8 bg-white/10 backdrop-blur-md rounded-3xl border border-white/20 shadow-2xl">
            <h1 class="text-3xl font-bold mb-6">Thai Grammar Pro</h1>
            <p class="mb-8 text-white/80">è¯·ç™»å½•ä»¥åŒæ­¥æ‚¨çš„å­¦ä¹ è¿›åº¦</p>
            <button id="btn-login"
                class="bg-white text-indigo-600 font-bold py-3 px-8 rounded-full shadow-lg hover:bg-slate-50 transition-all flex items-center gap-2 mx-auto">
                <img src="https://www.google.com/favicon.ico" class="w-4 h-4" alt="G">
                ä½¿ç”¨ Google è´¦å·ç™»å½•
            </button>
            <div id="login-loading" class="hidden mt-4 text-sm animate-pulse">æ­£åœ¨éªŒè¯èº«ä»½å¹¶åŒæ­¥æ•°æ®...</div>
        </div>
    </div>

    <div id="main-app" class="hidden flex-grow flex flex-col">
        <header class="bg-white border-b border-slate-200 py-4 px-6 sticky top-0 z-10">
            <div class="max-w-2xl mx-auto flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <img id="user-photo" class="w-8 h-8 rounded-full border border-slate-200" src="" alt="">
                    <h1 class="font-bold text-indigo-600 text-sm md:text-lg">Thai Pro</h1>
                </div>
                <div id="stats" class="text-[10px] md:text-xs text-slate-500 space-x-2">
                    <span id="due-count" class="bg-orange-100 text-orange-700 px-2 py-1 rounded">å¾…å¤ä¹ : --</span>
                    <button onclick="handleLogout()" class="underline">é€€å‡º</button>
                </div>
            </div>
        </header>

        <main class="flex-grow flex items-center justify-center p-4">
            <div id="app-container" class="w-full max-w-2xl">

                <div id="view-summary"
                    class="bg-white rounded-2xl shadow-sm border border-slate-200 p-8 text-center animate-fade-in">
                    <h2 id="deck-title" class="text-2xl font-bold text-slate-800 mb-2 italic">è¯»å–ä¸­...</h2>
                    <p id="deck-desc" class="text-slate-500 mb-6 text-sm"></p>
                    <button id="btn-start" onclick="startSession()"
                        class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-4 px-8 rounded-2xl transition-all shadow-lg">
                        å¼€å§‹å¤ä¹ 
                    </button>
                </div>

                <div id="view-review" class="hidden space-y-4 animate-fade-in">
                    <div id="card-body"
                        class="bg-white rounded-3xl shadow-xl border border-slate-100 min-h-[450px] flex flex-col p-8 relative">
                        <div id="review-front" class="flex-grow flex flex-col justify-center text-center">
                            <h3 id="review-title" class="text-indigo-400 text-sm font-bold mb-6"></h3>
                            <div id="review-main-content"
                                class="text-2xl font-bold text-slate-800 leading-relaxed italic"></div>
                        </div>
                        <div id="review-back" class="hidden border-t border-slate-100 mt-6 pt-6 space-y-6">
                            <section>
                                <p id="back-explanation" class="text-slate-700 text-sm"></p>
                            </section>
                            <section class="bg-indigo-50 rounded-2xl p-5">
                                <p id="back-thai" class="thai-text text-xl text-slate-800 mb-1"></p>
                                <p id="back-trans" class="text-sm text-slate-600"></p>
                            </section>
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <button id="btn-toggle-back" onclick="showBack()"
                            class="flex-1 bg-slate-800 text-white py-4 rounded-2xl font-bold shadow-lg">æ˜¾ç¤ºç­”æ¡ˆè§£æ</button>
                        <button id="btn-go-test" onclick="startTestUnit()"
                            class="hidden flex-1 bg-indigo-600 text-white py-4 rounded-2xl font-bold">è¿›å…¥è‡ªæˆ‘æµ‹è¯•</button>
                    </div>
                </div>

                <div id="view-test" class="hidden space-y-4 animate-fade-in">
                    <div class="bg-white rounded-3xl shadow-xl border border-slate-100 p-8 min-h-[400px] flex flex-col">
                        <p id="test-progress" class="text-xs text-slate-400 mb-4"></p>
                        <p id="test-question" class="text-lg font-bold text-slate-800 mb-8 leading-relaxed"></p>
                        <div id="test-options" class="grid grid-cols-1 gap-3"></div>
                    </div>
                    <button id="btn-next-q" onclick="nextQuestion()"
                        class="hidden w-full bg-slate-800 text-white py-4 rounded-2xl font-bold">ä¸‹ä¸€é¢˜</button>
                </div>

                <div id="view-result" class="hidden animate-fade-in">
                    <div class="bg-white rounded-3xl shadow-xl p-10 text-center">
                        <div class="text-6xl mb-4">ğŸ†</div>
                        <h2 class="text-2xl font-bold mb-2">æµ‹è¯•å®Œæˆ</h2>
                        <p id="result-score" class="text-slate-500 mb-8"></p>
                        <button id="btn-save-finish" onclick="saveProgressAndFinish()"
                            class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold">åŒæ­¥è¿›åº¦å¹¶é€€å‡º</button>
                        <div id="save-loader" class="hidden mt-4 text-xs text-indigo-400 animate-pulse">æ­£åœ¨ä¿å­˜è‡³äº‘ç«¯...</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, get, set, update, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // --- 1. é…ç½®ä¸åˆå§‹åŒ– ---
        const firebaseConfig = {
            apiKey: "AIzaSyA6MZ_p5lVuy8TMAqiuV6IRx9fggV44lQs",
            authDomain: "outpost-8d74e.firebaseapp.com",
            databaseURL: "https://outpost-otes-86b07.asia-southeast1.firebasedatabase.app/",
            projectId: "outpost-8d74e",
            storageBucket: "outpost-8d74e.firebasestorage.app",
            messagingSenderId: "724993324937",
            appId: "1:724993324937:web:ce6c7e6b06489331c79358",
            measurementId: "G-QPHWRTH6BH"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const provider = new GoogleAuthProvider();

        // --- 2. çŠ¶æ€å˜é‡ ---
        let deckData = null;
        let deckID = new URLSearchParams(window.location.search).get('deckID');
        let currentUser = null;
        let sessionResults = []; // å­˜å‚¨æœ¬æ¬¡å¤ä¹ çš„å„å¡ç‰‡æˆç»©
        let currentCardIndex = 0;
        let testState = { currentIndex: 0, correctCount: 0, questions: [] };

        // --- 3. è®¤è¯é€»è¾‘ ---
        document.getElementById('btn-login').onclick = () => {
            signInWithPopup(auth, provider).catch(err => alert("ç™»å½•å¤±è´¥: " + err.message));
        };

        window.handleLogout = () => signOut(auth).then(() => location.reload());

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('login-splash').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                document.getElementById('user-photo').src = user.photoURL;
                loadDeckContent();
            } else {
                document.getElementById('login-splash').classList.remove('hidden');
                document.getElementById('main-app').classList.add('hidden');
            }
        });

        // --- 4. æ•°æ®åŠ è½½é€»è¾‘ ---
        async function loadDeckContent() {
            if (!deckID) {
                document.getElementById('deck-title').innerText = "æ— æ•ˆçš„ Deck ID";
                return;
            }

            try {
                const snapshot = await get(ref(db, `ankiNotes/${deckID}`));
                if (snapshot.exists()) {
                    const fullData = snapshot.val();
                    deckData = fullData.ankiJSON; // è·å–æ ¸å¿ƒJSON

                    document.getElementById('deck-title').innerText = deckData.deck_info.deck_name;
                    document.getElementById('deck-desc').innerText = deckData.deck_info.deck_description;
                    document.getElementById('due-count').innerText = `å¡ç‰‡æ€»æ•°: ${deckData.cards.length}`;
                } else {
                    alert("æ‰¾ä¸åˆ°æŒ‡å®šçš„ç‰Œç»„æ•°æ®");
                }
            } catch (err) {
                console.error(err);
                alert("åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ");
            }
        }

        // --- 5. å¤ä¹ ä¸æµ‹è¯• UI é€»è¾‘ ---
        window.startSession = () => {
            currentCardIndex = 0;
            sessionResults = [];
            showNextCardInSession();
        };

        function showNextCardInSession() {
            if (currentCardIndex >= deckData.cards.length) {
                showFinalSummary();
                return;
            }
            const card = deckData.cards[currentCardIndex];
            switchView('view-review');
            document.getElementById('review-front').classList.remove('hidden');
            document.getElementById('review-back').classList.add('hidden');
            document.getElementById('btn-toggle-back').classList.remove('hidden');
            document.getElementById('btn-go-test').classList.add('hidden');

            document.getElementById('review-title').innerText = card.card_title;
            document.getElementById('review-main-content').innerText = card.front.main_content;

            document.getElementById('back-explanation').innerText = card.back.detailed_explanation;
            document.getElementById('back-thai').innerText = card.examples[0].thai;
            document.getElementById('back-trans').innerText = card.examples[0].translation;
        }

        window.showBack = () => {
            document.getElementById('review-back').classList.remove('hidden');
            document.getElementById('btn-toggle-back').classList.add('hidden');
            document.getElementById('btn-go-test').classList.remove('hidden');
        };

        window.startTestUnit = () => {
            const card = deckData.cards[currentCardIndex];

            // Check if exercises exist
            if (!card.multiple_choice_exercises || card.multiple_choice_exercises.length === 0) {
                console.warn(`Card "${card.card_title}" has no exercises. Skipping test.`);

                // If no tests, default to a high quality score (5) or calculate based on review?
                // Here we'll push a dummy "passed" result and move to next card
                sessionResults.push({
                    cardID: card.card_id,
                    quality: 5,
                    index: currentCardIndex,
                    score_detail: {
                        correct: 0,
                        total: 0,
                        accuracy: 1.0
                    }
                });

                currentCardIndex++;
                showNextCardInSession();
                return;
            }

            testState = {
                currentIndex: 0,
                correctCount: 0,
                questions: card.multiple_choice_exercises
            };
            switchView('view-test');
            renderTestQuestion();
        };

        function renderTestQuestion() {
            const q = testState.questions[testState.currentIndex];
            document.getElementById('test-progress').innerText = `é—®é¢˜ ${testState.currentIndex + 1} / ${testState.questions.length}`;
            document.getElementById('test-question').innerText = q.question;
            const container = document.getElementById('test-options');
            container.innerHTML = '';
            document.getElementById('btn-next-q').classList.add('hidden');

            q.options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "text-left p-4 border-2 border-slate-100 rounded-xl hover:bg-slate-50 transition-all text-sm";
                btn.innerText = opt.content;
                btn.onclick = () => {
                    document.querySelectorAll('#test-options button').forEach(b => b.disabled = true);
                    if (opt.is_correct) {
                        btn.classList.add('border-green-500', 'bg-green-50');
                        testState.correctCount++;
                    } else {
                        btn.classList.add('border-red-500', 'bg-red-50');
                    }
                    document.getElementById('btn-next-q').classList.remove('hidden');
                };
                container.appendChild(btn);
            });
        }

        /*
        window.nextQuestion = () => {
            testState.currentIndex++;
            if (testState.currentIndex < testState.questions.length) {
                renderTestQuestion();
            } else {
                // è®¡ç®—è¯¥å¡ç‰‡çš„SM2è¯„åˆ†å¹¶å­˜å…¥ sessionResults
                const accuracy = testState.correctCount / testState.questions.length;
                let quality = accuracy === 1 ? 5 : (accuracy >= 0.8 ? 4 : (accuracy >= 0.6 ? 3 : 1));
                
                sessionResults.push({
                    cardID: deckData.cards[currentCardIndex].card_id,
                    quality: quality,
                    index: currentCardIndex
                });

                currentCardIndex++;
                showNextCardInSession();
            }
        };
        */
        // åœ¨ script æ ‡ç­¾å†…çš„ nextQuestion å‡½æ•°ä¸­ä¿®æ”¹
        window.nextQuestion = () => {
            testState.currentIndex++;
            if (testState.currentIndex < testState.questions.length) {
                renderTestQuestion();
            } else {
                const totalQuestions = testState.questions.length;
                const correctCount = testState.correctCount;

                // Robustness: handle 0 questions to avoid NaN
                const accuracyVal = totalQuestions > 0 ? (correctCount / totalQuestions) : 1.0;
                const accuracy = accuracyVal.toFixed(2);

                // æ˜ å°„ SM2 è´¨é‡è¯„åˆ†
                let quality = accuracy >= 1 ? 5 : (accuracy >= 0.8 ? 4 : (accuracy >= 0.6 ? 3 : 1));

                // å­˜å‚¨åŒ…å«å¾—åˆ†çš„æ•°æ®
                sessionResults.push({
                    cardID: deckData.cards[currentCardIndex].card_id,
                    quality: quality,
                    index: currentCardIndex,
                    score_detail: {
                        correct: correctCount,
                        total: totalQuestions,
                        accuracy: parseFloat(accuracy)
                    }
                });

                currentCardIndex++;
                showNextCardInSession();
            }
        };

        function showFinalSummary() {
            switchView('view-result');
            const totalCorrect = sessionResults.filter(r => r.quality >= 3).length;
            document.getElementById('result-score').innerText = `å¤ä¹ å®Œæˆï¼é€šè¿‡ç‡: ${totalCorrect} / ${sessionResults.length}`;
        }

        // --- 6. SM2 è®¡ç®—ä¸äº‘ç«¯ä¿å­˜ ---
        /*
        window.saveProgressAndFinish = async () => {
            document.getElementById('btn-save-finish').disabled = true;
            document.getElementById('save-loader').classList.remove('hidden');

            const updates = {};
            const today = new Date();

            sessionResults.forEach(res => {
                // ç®€åŒ–çš„ SM2 é€»è¾‘
                let interval = 1;
                let eFactor = 2.5;
                
                if (res.quality >= 3) {
                    interval = res.quality === 5 ? 4 : 2; // åˆæ¬¡ç»ƒä¹ çš„ç®€å•æ¨¡æ‹Ÿ
                    eFactor = 2.5 + (0.1 - (5 - res.quality) * (0.08 + (5 - res.quality) * 0.02));
                }

                const nextDate = new Date(today);
                nextDate.setDate(today.getDate() + interval);

                updates[`${res.cardID}`] = {
                    SM2_Interval: interval,
                    SM2_EFactor: parseFloat(eFactor.toFixed(2)),
                    SM2_NextSchedule: nextDate.toISOString().split('T')[0],
                    cardIndex: res.index,
                    lastReview: today.toISOString().split('T')[0]
                };
            });

            try {
                // ä¿å­˜åˆ° ankiNotesReview/{deckID}
                await update(ref(db, `ankiNotesReview/${deckID}`), updates);
                alert("åŒæ­¥æˆåŠŸï¼");
                location.reload();
            } catch (err) {
                alert("ä¿å­˜å¤±è´¥: " + err.message);
            }
        };
        */
        // ä¿®æ”¹ saveProgressAndFinish å‡½æ•°
        window.saveProgressAndFinish = async () => {
            if (!deckID || sessionResults.length === 0) {
                alert("æ— æ•ˆçš„ç‰Œç»„ ID æˆ–æ²¡æœ‰å¤ä¹ è®°å½•ã€‚");
                return;
            }

            document.getElementById('btn-save-finish').disabled = true;
            document.getElementById('save-loader').classList.remove('hidden');

            const updates = {};
            const today = new Date();

            console.log("Preparing to sync sessionResults:", sessionResults);

            sessionResults.forEach(res => {
                // SM2 ç®—æ³•è®¡ç®—
                let interval = 1;
                let eFactor = 2.5;

                if (res.quality >= 3) {
                    // ç®€å•çš„ SM2 æ˜ å°„
                    interval = res.quality === 5 ? 4 : (res.quality === 4 ? 2 : 1);
                    eFactor = 2.5 + (0.1 - (5 - res.quality) * (0.08 + (5 - res.quality) * 0.02));
                }

                const nextDate = new Date(today);
                nextDate.setDate(today.getDate() + interval);

                // æ„å»ºå†™å…¥æ•°æ®åº“çš„å¯¹è±¡ï¼ŒåŒ…å«æµ‹è¯•å¾—åˆ†
                updates[`${res.cardID}`] = {
                    SM2_Interval: interval,
                    SM2_EFactor: parseFloat(eFactor.toFixed(2)),
                    SM2_NextSchedule: nextDate.toISOString().split('T')[0],
                    cardIndex: res.index,
                    lastReview: today.toISOString().split('T')[0],
                    Test_Score: {
                        correct_count: res.score_detail.correct,
                        total_questions: res.score_detail.total,
                        accuracy: res.score_detail.accuracy
                    },
                    SM2_Quality: res.quality
                };
            });

            console.log("Submitting updates to Firebase:", updates);

            try {
                // æ‰§è¡Œ Firebase å†™å…¥
                await update(ref(db, `ankiNotesReview/${deckID}`), updates);
                console.log("Firebase sync successful.");
                alert("å¤ä¹ ç»“æœä¸å¾—åˆ†å·²æˆåŠŸåŒæ­¥è‡³äº‘ç«¯ï¼");
                location.reload();
            } catch (err) {
                console.error("Firebase Save Error:", err);
                alert("ä¿å­˜å¤±è´¥: " + err.message + "\nè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–æƒé™ã€‚");
                document.getElementById('btn-save-finish').disabled = false;
                document.getElementById('save-loader').classList.add('hidden');
            }
        };

        function switchView(viewId) {
            ['view-summary', 'view-review', 'view-test', 'view-result'].forEach(id => {
                document.getElementById(id).classList.toggle('hidden', id !== viewId);
            });
        }
    </script>
</body>

</html>
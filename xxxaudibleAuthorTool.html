<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WaveSurfer Transcript Authoring</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom scrollbar for transcript list */
        .custom-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        /* Region styling overrides */
        .wavesurfer-region {
            border: 1px solid rgba(59, 130, 246, 0.5) !important;
            background-color: rgba(59, 130, 246, 0.1) !important;
            z-index: 10;
        }
        .wavesurfer-region:hover {
            background-color: rgba(59, 130, 246, 0.2) !important;
            z-index: 11;
        }
        .wavesurfer-region.active-region {
            background-color: rgba(16, 185, 129, 0.2) !important;
            border-color: rgba(16, 185, 129, 0.8) !important;
        }
        .region-handle {
            width: 4px !important;
            background-color: #3b82f6 !important;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen flex flex-col overflow-hidden font-sans">

    <!-- Header -->
    <header class="bg-white border-b border-slate-200 p-4 flex items-center justify-between shadow-sm z-20">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 p-2 rounded-lg text-white">
                <i data-lucide="waves" class="w-6 h-6"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg leading-tight">Transcript Authoring Tool</h1>
                <p class="text-xs text-slate-500">Generate JSON segments from audio</p>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <label class="cursor-pointer bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-lg transition flex items-center gap-2 text-sm font-medium">
                <i data-lucide="upload" class="w-4 h-4"></i>
                Select Audio
                <input type="file" id="file-input" accept="audio/*" class="hidden">
            </label>
            
            <div class="flex items-center border-l border-slate-300 ml-2 pl-4 gap-2">
                <label class="cursor-pointer bg-slate-50 hover:bg-slate-100 text-slate-700 px-3 py-2 rounded-lg transition flex items-center gap-2 text-sm font-medium border border-slate-200">
                    <i data-lucide="file-text" class="w-4 h-4"></i>
                    Import Transcript
                    <input type="file" id="transcript-input" accept=".txt" class="hidden">
                </label>
                
                <!-- New Translation Button -->
                <button id="import-translation-btn" class="cursor-pointer bg-slate-50 hover:bg-slate-100 text-slate-700 px-3 py-2 rounded-lg transition flex items-center gap-2 text-sm font-medium border border-slate-200">
                    <i data-lucide="languages" class="w-4 h-4"></i>
                    Import Translation
                </button>
            </div>

            <button id="export-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition flex items-center gap-2 text-sm font-medium shadow-sm opacity-50 cursor-not-allowed" disabled>
                <i data-lucide="download" class="w-4 h-4"></i>
                Export JSON
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col overflow-hidden relative">
        
        <!-- Waveform Container -->
        <div class="bg-white border-b border-slate-200 p-4 relative shrink-0 z-10 shadow-sm">
            
            <!-- Controls -->
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-2">
                    <button id="play-pause-btn" class="w-10 h-10 rounded-full bg-blue-600 hover:bg-blue-700 text-white flex items-center justify-center transition shadow-sm disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        <i data-lucide="play" class="w-5 h-5 fill-current"></i>
                    </button>
                    <div class="bg-slate-100 rounded px-3 py-1 text-sm font-mono text-slate-600 border border-slate-200">
                        <span id="current-time">00:00.000</span> / <span id="total-duration">00:00.000</span>
                    </div>
                </div>

                <div class="flex items-center gap-4">
                    <!-- Speed Control -->
                    <div class="flex items-center gap-2 text-sm text-slate-600 bg-slate-50 px-2 py-1 rounded border border-slate-200">
                        <i data-lucide="gauge" class="w-4 h-4"></i>
                        <select id="playback-rate" class="bg-transparent border-none focus:ring-0 text-slate-700 text-sm font-medium cursor-pointer disabled:opacity-50" disabled>
                            <option value="0.5">0.5x</option>
                            <option value="0.7">0.7x</option>
                            <option value="0.85">0.85x</option>
                            <option value="1.0" selected>1.0x</option>
                            <option value="1.15">1.15x</option>
                            <option value="1.25">1.25x</option>
                            <option value="1.5">1.5x</option>
                            <option value="2.0">2.0x</option>
                        </select>
                    </div>

                    <div class="h-6 w-px bg-slate-200"></div>

                    <div class="flex items-center gap-2 text-sm text-slate-600">
                        <i data-lucide="zoom-in" class="w-4 h-4"></i>
                        <input type="range" id="zoom-slider" min="10" max="500" value="50" class="w-32 accent-blue-600 h-1 bg-slate-200 rounded-lg appearance-none cursor-pointer disabled:opacity-50" disabled>
                    </div>
                    <button id="add-region-btn" class="text-sm bg-emerald-50 text-emerald-600 border border-emerald-200 hover:bg-emerald-100 px-3 py-1.5 rounded-md transition flex items-center gap-2 disabled:opacity-50" disabled>
                        <i data-lucide="plus" class="w-4 h-4"></i>
                        Add Region
                    </button>
                </div>
            </div>

            <!-- The Waveform -->
            <div id="waveform" class="w-full h-32 bg-slate-50 rounded-lg border border-slate-200 relative overflow-hidden">
                <div id="loading-spinner" class="absolute inset-0 flex items-center justify-center hidden z-20 bg-white/80">
                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                </div>
                <div id="empty-state" class="absolute inset-0 flex flex-col items-center justify-center text-slate-400 pointer-events-none z-10">
                    <i data-lucide="music" class="w-10 h-10 mb-2 opacity-20"></i>
                    <p class="text-sm font-medium opacity-60">No audio loaded</p>
                </div>
            </div>
            <!-- Timeline -->
            <div id="wave-timeline" class="w-full h-5 mt-1"></div>
            
            <div class="mt-2 flex justify-between text-xs text-slate-400">
                <p>Hint: Click empty space to add region (0.5s). Drag to create custom. Click region to play.</p>
            </div>
        </div>

        <!-- Transcript List Editor -->
        <div class="flex-1 bg-slate-50 p-4 overflow-hidden flex flex-col">
            <div class="flex items-center justify-between mb-2 px-2">
                <h2 class="text-sm font-bold text-slate-700 uppercase tracking-wide">Transcript Segments</h2>
                <span id="segment-count" class="text-xs font-medium bg-slate-200 text-slate-600 px-2 py-0.5 rounded-full">0 segments</span>
            </div>
            
            <!-- List Header -->
            <div class="grid grid-cols-12 gap-4 px-4 py-2 bg-slate-200 rounded-t-lg text-xs font-semibold text-slate-600 border border-slate-300">
                <div class="col-span-1 text-center">#</div>
                <div class="col-span-2">Start</div>
                <div class="col-span-2">End</div>
                <div class="col-span-6">Content / Translation</div>
                <div class="col-span-1 text-right">Actions</div>
            </div>

            <!-- Segments Container -->
            <div id="segments-container" class="flex-1 overflow-y-auto custom-scroll bg-white border-x border-b border-slate-200 rounded-b-lg shadow-inner p-1 space-y-1">
                <!-- Segments will be injected here -->
                <div class="h-full flex flex-col items-center justify-center text-slate-400 p-8 text-center">
                    <p>No regions created.</p>
                    <p class="text-xs mt-1">Click on the waveform or drag to start transcribing.</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Translation Modal -->
    <div id="translation-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden opacity-0 transition-opacity duration-200">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl flex flex-col max-h-[80vh]">
            <div class="p-4 border-b border-slate-200 flex justify-between items-center">
                <h3 class="font-bold text-lg text-slate-800">Import Translation</h3>
                <button id="close-modal-btn" class="text-slate-400 hover:text-slate-600">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="p-4 flex-1 overflow-hidden flex flex-col">
                <p class="text-sm text-slate-600 mb-2">Paste your translation text below. The tool will match lines to existing regions based on timestamps.</p>
                <textarea id="translation-text-input" class="w-full flex-1 border border-slate-300 rounded-md p-3 font-mono text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none resize-none" placeholder="[359.81s -> 373.81s] Actually, we've been doing..."></textarea>
            </div>
            <div class="p-4 border-t border-slate-200 flex justify-end gap-2 bg-slate-50 rounded-b-lg">
                <button id="cancel-modal-btn" class="px-4 py-2 text-slate-600 hover:bg-slate-200 rounded-lg text-sm font-medium transition">Cancel</button>
                <button id="confirm-import-btn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition shadow-sm">Import Translation</button>
            </div>
        </div>
    </div>

    <!-- Template for a Transcript Row -->
    <template id="segment-template">
        <div class="segment-row grid grid-cols-12 gap-4 px-4 py-3 bg-white border border-slate-100 rounded-md hover:shadow-sm hover:border-blue-200 transition items-start group" data-id="">
            <div class="col-span-1 flex items-center justify-center mt-2">
                <button class="play-segment-btn w-6 h-6 rounded-full bg-slate-100 hover:bg-blue-100 hover:text-blue-600 text-slate-500 flex items-center justify-center transition">
                    <i data-lucide="play" class="w-3 h-3 fill-current"></i>
                </button>
            </div>
            <div class="col-span-2">
                <input type="number" step="0.1" class="start-input w-full text-sm bg-slate-50 border border-slate-200 rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent font-mono text-slate-600">
            </div>
            <div class="col-span-2">
                <input type="number" step="0.1" class="end-input w-full text-sm bg-slate-50 border border-slate-200 rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent font-mono text-slate-600">
            </div>
            <div class="col-span-6 flex flex-col gap-2">
                <textarea class="content-input w-full text-sm bg-slate-50 border border-slate-200 rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none" rows="2" placeholder="Transcript..."></textarea>
                <textarea class="translation-input w-full text-sm bg-slate-50 border border-slate-200 rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none text-slate-600 italic" rows="2" placeholder="Translation..."></textarea>
            </div>
            <div class="col-span-1 flex justify-end mt-1">
                <button class="delete-btn text-slate-400 hover:text-red-500 transition p-1 rounded hover:bg-red-50">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
    </template>

    <script type="module">
        import WaveSurfer from 'https://unpkg.com/wavesurfer.js@7/dist/wavesurfer.esm.js'
        import RegionsPlugin from 'https://unpkg.com/wavesurfer.js@7/dist/plugins/regions.esm.js'
        import TimelinePlugin from 'https://unpkg.com/wavesurfer.js@7/dist/plugins/timeline.esm.js'

        lucide.createIcons();

        // State
        let wavesurfer;
        let wsRegions;
        let activeRegionId = null;
        let isRegionPlaying = false; 

        // DOM Elements
        const fileInput = document.getElementById('file-input');
        const transcriptInput = document.getElementById('transcript-input');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const zoomSlider = document.getElementById('zoom-slider');
        const playbackRateSelect = document.getElementById('playback-rate');
        const exportBtn = document.getElementById('export-btn');
        const addRegionBtn = document.getElementById('add-region-btn');
        const segmentsContainer = document.getElementById('segments-container');
        const template = document.getElementById('segment-template');
        const emptyState = document.getElementById('empty-state');
        const loadingSpinner = document.getElementById('loading-spinner');
        const timeDisplay = document.getElementById('current-time');
        const durationDisplay = document.getElementById('total-duration');
        const segmentCountLabel = document.getElementById('segment-count');

        // Modal Elements
        const importTranslationBtn = document.getElementById('import-translation-btn');
        const translationModal = document.getElementById('translation-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const cancelModalBtn = document.getElementById('cancel-modal-btn');
        const confirmImportBtn = document.getElementById('confirm-import-btn');
        const translationTextInput = document.getElementById('translation-text-input');

        // --- Initialization ---

        function initWaveSurfer() {
            if (wavesurfer) {
                try {
                    wavesurfer.destroy();
                } catch(e) {
                    console.warn('Error destroying wavesurfer', e);
                }
            }

            wavesurfer = WaveSurfer.create({
                container: '#waveform',
                waveColor: '#cbd5e1',
                progressColor: '#3b82f6',
                height: 128,
                barWidth: 2,
                barGap: 3,
                barRadius: 3,
                cursorColor: '#ef4444',
                cursorWidth: 2,
                normalize: true,
                minPxPerSec: 50,
                autoCenter: true, 
                plugins: [
                    TimelinePlugin.create({
                        container: '#wave-timeline',
                        formatTimeCallback: formatTime,
                        primaryLabelInterval: 5,
                        secondaryLabelInterval: 1,
                    })
                ]
            });

            // Initialize Regions Plugin
            wsRegions = wavesurfer.registerPlugin(RegionsPlugin.create({
                dragSelection: true, 
                color: 'rgba(59, 130, 246, 0.1)',
            }));

            // Events
            wavesurfer.on('ready', () => {
                const duration = wavesurfer.getDuration();
                durationDisplay.textContent = formatTime(duration);
                
                enableControls();
                wavesurfer.setPlaybackRate(parseFloat(playbackRateSelect.value));
                
                loadingSpinner.classList.add('hidden');
                wsRegions.enableDragSelection({
                    color: 'rgba(59, 130, 246, 0.1)',
                });
            });

            wavesurfer.on('audioprocess', () => {
                timeDisplay.textContent = formatTime(wavesurfer.getCurrentTime());
                highlightActiveRegion();
            });

            wavesurfer.on('seek', () => {
                timeDisplay.textContent = formatTime(wavesurfer.getCurrentTime());
            });

            wavesurfer.on('interaction', () => {
                isRegionPlaying = false;
            });

            // --- Click to Create Logic ---
            wavesurfer.on('click', () => {
                if (!wsRegions) return;
                isRegionPlaying = false;

                const currentTime = wavesurfer.getCurrentTime();
                const duration = wavesurfer.getDuration();
                const regions = wsRegions.getRegions();

                const clickedOnRegion = regions.some(r => currentTime >= r.start && currentTime <= r.end);
                
                if (clickedOnRegion) return; 

                const defaultDuration = 0.5; 
                let endTime = currentTime + defaultDuration;

                const nextRegion = regions
                    .filter(r => r.start > currentTime)
                    .sort((a, b) => a.start - b.start)[0];

                if (nextRegion) {
                    if (endTime > nextRegion.start) {
                        endTime = nextRegion.start;
                    }
                }

                if (endTime > duration) endTime = duration;

                if (endTime > currentTime + 0.01) {
                    const newRegion = wsRegions.addRegion({
                        start: currentTime,
                        end: endTime,
                        content: '',
                        color: getRandomColor()
                    });
                    
                    activeRegionId = newRegion.id;
                    highlightRow(newRegion.id);
                }
            });

            wsRegions.on('region-created', (region) => {
                addSegmentToDOM(region);
                updateSegmentCount();
            });

            wsRegions.on('region-updated', (region) => {
                updateDOMFromRegion(region);
            });

            wsRegions.on('region-clicked', (region, e) => {
                e.stopPropagation();
                activeRegionId = region.id;
                highlightRow(region.id);
                isRegionPlaying = true;
                region.play(); 
            });

            wsRegions.on('region-out', (region) => {
                if (isRegionPlaying && activeRegionId === region.id) {
                    wavesurfer.pause();
                    isRegionPlaying = false;
                }
            });
        }

        // --- File Handling ---

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            segmentsContainer.innerHTML = '';
            segmentCountLabel.textContent = '0 segments'; 
            
            emptyState.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');
            
            initWaveSurfer();
            
            const url = URL.createObjectURL(file);
            wavesurfer.load(url);
        });

        // --- Transcript Import Logic ---
        
        transcriptInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            if (!wsRegions) {
                alert("Please load an audio file first before importing a transcript.");
                transcriptInput.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = (event) => {
                const text = event.target.result;
                parseAndLoadTranscript(text);
            };
            reader.readAsText(file);
            
            transcriptInput.value = '';
        });

        function parseAndLoadTranscript(text) {
            const regex = /\[\s*([\d\.]+)\s*s\s*->\s*([\d\.]+)\s*s\s*\]\s*(.*)/;
            const lines = text.split(/\r?\n/);
            
            let addedCount = 0;
            wsRegions.clearRegions();
            segmentsContainer.innerHTML = '';

            lines.forEach(line => {
                const match = line.match(regex);
                if (match) {
                    const start = parseFloat(match[1]);
                    const end = parseFloat(match[2]);
                    const content = match[3].trim();

                    if (!isNaN(start) && !isNaN(end) && end > start) {
                        const region = wsRegions.addRegion({
                            start: start,
                            end: end,
                            content: '', 
                            color: getRandomColor(),
                        });
                        region.transcript = content;
                        region.translation = ''; // Init empty translation
                        
                        // Sync to DOM
                        const row = document.getElementById(`row-${region.id}`);
                        if(row) {
                            const contentArea = row.querySelector('.content-input');
                            if(contentArea) contentArea.value = content;
                        }
                        
                        addedCount++;
                    }
                }
            });

            if (addedCount > 0) {
                updateSegmentCount();
            } else {
                alert("No valid segments found in transcript file.");
            }
        }

        // --- Translation Import Logic ---

        function openModal() {
            translationModal.classList.remove('hidden');
            // Small delay to allow display block to apply before opacity transition
            setTimeout(() => translationModal.classList.remove('opacity-0'), 10);
            translationTextInput.value = '';
            translationTextInput.focus();
        }

        function closeModal() {
            translationModal.classList.add('opacity-0');
            setTimeout(() => translationModal.classList.add('hidden'), 200);
        }

        importTranslationBtn.addEventListener('click', () => {
            if (!wsRegions || wsRegions.getRegions().length === 0) {
                alert("Please create or import transcript regions first.");
                return;
            }
            openModal();
        });

        closeModalBtn.addEventListener('click', closeModal);
        cancelModalBtn.addEventListener('click', closeModal);

        confirmImportBtn.addEventListener('click', () => {
            const text = translationTextInput.value;
            if (!text.trim()) {
                closeModal();
                return;
            }
            parseAndMatchTranslation(text);
            closeModal();
        });

        function parseAndMatchTranslation(text) {
            const regex = /\[\s*([\d\.]+)\s*s\s*->\s*([\d\.]+)\s*s\s*\]\s*(.*)/;
            const lines = text.split(/\r?\n/);
            const regions = wsRegions.getRegions();
            let matchedCount = 0;

            lines.forEach(line => {
                const match = line.match(regex);
                if (match) {
                    const start = parseFloat(match[1]);
                    const end = parseFloat(match[2]);
                    const translationText = match[3].trim();

                    // Find matching region with small tolerance (0.05s)
                    const tolerance = 0.05;
                    const region = regions.find(r => 
                        Math.abs(r.start - start) < tolerance && 
                        Math.abs(r.end - end) < tolerance
                    );

                    if (region) {
                        region.translation = translationText;
                        
                        // Update DOM
                        const row = document.getElementById(`row-${region.id}`);
                        if (row) {
                            const transArea = row.querySelector('.translation-input');
                            if (transArea) transArea.value = translationText;
                        }
                        matchedCount++;
                    }
                }
            });

            if (matchedCount > 0) {
                // Optional: show success message
                // alert(`Successfully matched ${matchedCount} translation lines.`);
            } else {
                alert("No matching regions found for the provided timestamps. Please ensure timestamps align with existing segments.");
            }
        }


        // --- UI Interaction Functions ---

        playPauseBtn.addEventListener('click', () => {
            isRegionPlaying = false;
            wavesurfer.playPause();
            updatePlayButton();
        });

        wavesurfer && wavesurfer.on('play', updatePlayButton);
        wavesurfer && wavesurfer.on('pause', updatePlayButton);

        function updatePlayButton() {
            if (wavesurfer.isPlaying()) {
                playPauseBtn.innerHTML = `<i data-lucide="pause" class="w-5 h-5 fill-current"></i>`;
            } else {
                playPauseBtn.innerHTML = `<i data-lucide="play" class="w-5 h-5 fill-current"></i>`;
            }
            lucide.createIcons();
        }

        zoomSlider.addEventListener('input', (e) => {
            const zoomLevel = Number(e.target.value);
            wavesurfer.zoom(zoomLevel);
        });

        playbackRateSelect.addEventListener('change', (e) => {
            if(wavesurfer) {
                wavesurfer.setPlaybackRate(parseFloat(e.target.value));
            }
        });

        addRegionBtn.addEventListener('click', () => {
            const currentTime = wavesurfer.getCurrentTime();
            const newRegion = wsRegions.addRegion({
                start: currentTime,
                end: currentTime + 0.5, 
                content: '',
                color: getRandomColor()
            });
            activeRegionId = newRegion.id;
            highlightRow(newRegion.id);
        });

        // --- Sync Logic (The Core) ---

        function addSegmentToDOM(region) {
            if (segmentsContainer.children.length > 0 && segmentsContainer.firstElementChild.classList.contains('text-center')) {
                segmentsContainer.innerHTML = '';
            }

            const clone = template.content.cloneNode(true);
            const row = clone.querySelector('.segment-row');
            
            row.dataset.id = region.id;
            row.id = `row-${region.id}`;

            const startInput = row.querySelector('.start-input');
            const endInput = row.querySelector('.end-input');
            const contentInput = row.querySelector('.content-input');
            const translationInput = row.querySelector('.translation-input');
            const deleteBtn = row.querySelector('.delete-btn');
            const playBtn = row.querySelector('.play-segment-btn');

            // Initial Values
            startInput.value = region.start.toFixed(2);
            endInput.value = region.end.toFixed(2);
            region.transcript = region.transcript || ''; 
            region.translation = region.translation || ''; 

            // Listeners
            startInput.addEventListener('change', () => region.setOptions({ start: parseFloat(startInput.value) }));
            endInput.addEventListener('change', () => region.setOptions({ end: parseFloat(endInput.value) }));
            contentInput.addEventListener('input', () => region.transcript = contentInput.value);
            translationInput.addEventListener('input', () => region.translation = translationInput.value);
            
            deleteBtn.addEventListener('click', () => {
                region.remove();
                row.remove();
                updateSegmentCount();
                checkEmptyState();
            });

            playBtn.addEventListener('click', (e) => {
                e.stopPropagation(); 
                activeRegionId = region.id;
                highlightRow(region.id);
                isRegionPlaying = true;
                region.play();
            });

            row.addEventListener('click', () => {
                activeRegionId = region.id;
                highlightRow(region.id);
                wavesurfer.setTime(region.start);
                isRegionPlaying = false;
            });

            insertRowSorted(row, region.start);
            
            lucide.createIcons();
        }

        function insertRowSorted(row, startTime) {
            const rows = Array.from(segmentsContainer.children);
            const nextRow = rows.find(r => {
                const rStart = parseFloat(r.querySelector('.start-input').value);
                return rStart > startTime;
            });

            if (nextRow) {
                segmentsContainer.insertBefore(row, nextRow);
            } else {
                segmentsContainer.appendChild(row);
            }
        }

        function updateDOMFromRegion(region) {
            const row = document.getElementById(`row-${region.id}`);
            if (!row) return;

            const startInput = row.querySelector('.start-input');
            const endInput = row.querySelector('.end-input');

            if (document.activeElement !== startInput) startInput.value = region.start.toFixed(2);
            if (document.activeElement !== endInput) endInput.value = region.end.toFixed(2);
        }

        function highlightRow(id) {
            document.querySelectorAll('.segment-row').forEach(r => {
                r.classList.remove('border-blue-500', 'ring-1', 'ring-blue-500', 'bg-blue-50');
                r.classList.add('bg-white');
            });
            
            const row = document.getElementById(`row-${id}`);
            if (row) {
                row.classList.remove('bg-white');
                row.classList.add('border-blue-500', 'ring-1', 'ring-blue-500', 'bg-blue-50'); 
                row.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function highlightActiveRegion() {
            const currentTime = wavesurfer.getCurrentTime();
            const regions = wsRegions.getRegions();
            const active = regions.find(r => currentTime >= r.start && currentTime <= r.end);
            
            if (active && active.id !== activeRegionId) {
                activeRegionId = active.id;
                highlightRow(active.id);
            }
        }

        // --- Export Logic ---

        exportBtn.addEventListener('click', () => {
            const regions = wsRegions.getRegions();
            regions.sort((a, b) => a.start - b.start);

            const output = regions.map((r, index) => ({
                id: index + 1,
                start: parseFloat(r.start.toFixed(3)),
                end: parseFloat(r.end.toFixed(3)),
                duration: parseFloat((r.end - r.start).toFixed(3)),
                content: r.transcript || "",
                translation: r.translation || ""
            }));

            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(output, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "transcript_" + new Date().toISOString().slice(0,10) + ".json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        });

        // --- Utilities ---

        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secondsRemainder = Math.floor(seconds % 60);
            const milliseconds = Math.floor((seconds % 1) * 1000);
            const pad = (num) => num.toString().padStart(2, '0');
            const padMs = (num) => num.toString().padStart(3, '0');
            return `${pad(minutes)}:${pad(secondsRemainder)}.${padMs(milliseconds)}`;
        }

        function enableControls() {
            playPauseBtn.disabled = false;
            zoomSlider.disabled = false;
            playbackRateSelect.disabled = false; 
            addRegionBtn.disabled = false;
            exportBtn.disabled = false;
            exportBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }

        function updateSegmentCount() {
            if (!wsRegions) {
                segmentCountLabel.textContent = '0 segments';
                return;
            }
            const count = wsRegions.getRegions().length;
            segmentCountLabel.textContent = `${count} segment${count !== 1 ? 's' : ''}`;
        }

        function checkEmptyState() {
            if (wsRegions && wsRegions.getRegions().length === 0) {
                segmentsContainer.innerHTML = `
                <div class="h-full flex flex-col items-center justify-center text-slate-400 p-8 text-center">
                    <p>No regions created.</p>
                    <p class="text-xs mt-1">Click on the waveform or drag to start transcribing.</p>
                </div>`;
            }
        }

        function getRandomColor() {
            return `rgba(${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, 0.2)`;
        }

        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                e.preventDefault();
                if(wavesurfer) {
                    isRegionPlaying = false; 
                    wavesurfer.playPause();
                }
                updatePlayButton();
            }
        });

    </script>
</body>
</html>
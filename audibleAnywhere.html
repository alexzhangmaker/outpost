<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ³°è¯­å­¦ä¹ éŸ³é¢‘åº”ç”¨</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <!-- Wavesurfer -->
    <script src="https://unpkg.com/wavesurfer.js@7"></script>
    <script src="https://unpkg.com/wavesurfer.js@7/dist/plugins/regions.min.js"></script>

    <!-- Icons -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&icon_names=enable" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&icon_names=install_desktop" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&icon_names=arrow_back" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&icon_names=arrow_right_alt" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f5f7fa;
            color: #333;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        
        /* å·¦ä¾§å¯¼èˆªåŒº */
        .sidebar {
            width: 350px;
            background-color: #2c3e50;
            color: white;
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            overflow-y: auto;
            transition: all 0.3s ease;
        }
        
        .sidebar.noShow {
            display: none;
        }

        .app-title {
            font-size: 24px;
            font-weight: 500;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
        }
        
        .app-title::before {
            content: "ğŸµ";
            margin-right: 10px;
        }
        
        .nav-section {
            margin-bottom: 25px;
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .nav-header {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 10px;
            color: #ecf0f1;
            display: flex;
            align-items: center;
        }
        
        /* æœç´¢æ æ ·å¼ */
        .search-box {
            margin-bottom: 10px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .search-input {
            width: 100%;
            padding: 8px;
            border-radius: 4px;
            border: none;
            background-color: #34495e;
            color: white;
            outline: none;
            font-size: 14px;
        }

        .search-input::placeholder {
            color: #95a5a6;
        }

        .search-input:focus {
            background-color: #3d566e;
        }

        /* è¯¾ç¨‹åˆ—è¡¨æ ·å¼ (Accordion) */
        .course-list-container {
            overflow-y: auto;
            flex: 1;
        }

        .course-folder {
            margin-bottom: 5px;
        }

        .course-header-btn {
            width: 100%;
            text-align: left;
            padding: 10px;
            background-color: #34495e;
            color: #ecf0f1;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 15px;
            transition: background-color 0.2s;
        }

        .course-header-btn:hover {
            background-color: #3d566e;
        }

        .course-header-btn .folder-icon {
            margin-right: 8px;
        }

        .course-header-btn .arrow-icon {
            transition: transform 0.2s;
        }

        .course-folder.active .arrow-icon {
            transform: rotate(90deg);
        }

        .course-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            background-color: #253342;
            border-radius: 0 0 4px 4px;
        }

        .course-folder.active .course-content {
            max-height: 1000px; /* Approximate max height */
            transition: max-height 0.5s ease-in;
        }

        .lesson-list {
            list-style: none;
            padding: 5px 0;
        }
        
        .lesson-item {
            padding: 8px 10px 8px 35px; /* Indent for folder structure */
            margin-bottom: 2px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            color: #bdc3c7;
            display: flex;
            flex-direction: column;
        }
        
        .lesson-item:hover {
            background-color: #2c3e50;
            color: white;
        }
        
        .lesson-item.active {
            background-color: #2980b9;
            color: white;
            font-weight: 500;
        }

        .lesson-tags-display {
            font-size: 11px;
            color: #7f8c8d;
            margin-top: 2px;
        }

        .lesson-item.active .lesson-tags-display {
            color: #a9cce3;
        }
        
        /* å³ä¾§å†…å®¹åŒº */
        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* æ’­æ”¾å™¨åŒºåŸŸ */
        .player-section {
            padding: 25px;
            background-color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            z-index: 10;
        }
        
        .top-toolbar {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .toolbar-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .meta-edit-row {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
        }
        
        /* Title Input Styling */
        #currentLessonTitleInput {
            font-size: 20px;
            font-weight: 500;
            color: #2c3e50;
            border: 1px solid transparent;
            border-radius: 4px;
            padding: 5px;
            flex: 1;
            transition: border 0.2s;
            background: transparent;
        }

        #currentLessonTitleInput:hover, #currentLessonTitleInput:focus {
            border: 1px solid #bdc3c7;
            background-color: #f8f9fa;
            outline: none;
        }

        /* Tag Edit Input Styling */
        .tag-edit-container {
            display: flex;
            align-items: center;
            flex: 1;
        }

        .tag-label {
            font-size: 14px;
            color: #7f8c8d;
            margin-right: 8px;
            font-weight: 500;
        }

        #currentLessonTagsInput {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            color: #555;
        }

        #currentLessonTagsInput:focus {
            border-color: #3498db;
            outline: none;
        }

        #waveform {
            width: 100%;
            height: 180px;
            margin-bottom: 20px;
            background-color: #f8f9fa;
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .player-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .btnOutpost {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 15px;
            background-color: transparent;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            color: #555;
            transition: all 0.2s;
            text-decoration: none;
            gap: 5px;
        }

        .btnOutpost:hover {
            background-color: #f5f5f5;
            border-color: #bbb;
            color: #333;
        }

        .btnOutpost[disabled] {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background-color: #3498db;
            color: white;
            border: none;
        }
        .btn-primary:hover {
            background-color: #2980b9;
            color: white;
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }
        
        /* æ—¶é—´æˆ³åŒºåŸŸ */
        .timestamps-section {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
            background-color: #f8f9fa;
        }
        
        .table-container {
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background-color: #f8f9fa;
            font-weight: 500;
            color: #7f8c8d;
            font-size: 14px;
        }
        
        tr {
            transition: background-color 0.2s;
        }
        
        tr:hover {
            background-color: #f5f7fa;
        }
        
        tr.active {
            background-color: #e1f0fa;
        }
        
        .time-input {
            width: 70px;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }
        
        .thai-text {
            font-size: 18px;
            width: 40%;
            color: #2c3e50;
        }
        
        .translation {
            color: #7f8c8d;
            font-style: italic;
            font-size: 14px;
        }
        
        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            margin: 0 5px;
            opacity: 0.7;
        }
        
        .action-btn:hover {
            opacity: 1;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 900px) {
            body {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                max-height: 40vh;
            }
            
            .content-area {
                height: 60vh;
            }
        }
    </style>
</head>
<body>
    <!-- å·¦ä¾§å¯¼èˆªåŒº -->
    <div class="sidebar">
        <div class="app-title">
            <span>æ³°è¯­å­¦ä¹ éŸ³é¢‘åº”ç”¨</span>
        </div>
        
        <div class="nav-section">
            <div class="nav-header">éŸ³é¢‘è¯¾ä»¶</div>
            
            <!-- æœç´¢å’Œè¿‡æ»¤åŒºåŸŸ -->
            <div class="search-box">
                <input type="text" id="searchInput" class="search-input" placeholder="æœç´¢æ ‡é¢˜...">
                <input type="text" id="tagFilterInput" class="search-input" placeholder="æŒ‰æ ‡ç­¾ç­›é€‰ (ä¾‹å¦‚: beginner)">
            </div>

            <!-- Accordion åˆ—è¡¨å®¹å™¨ -->
            <div class="course-list-container" id="courseListContainer">
                <div class="loading" style="padding: 10px; font-size: 14px;">æ­£åœ¨åŠ è½½è¯¾ç¨‹...</div>
            </div>
        </div>
        
        <div style="margin-top: auto; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
            <div class="nav-header">å­¦ä¹ è¿›åº¦</div>
            <div style="padding: 10px; background: #34495e; border-radius: 6px; font-size: 14px;">
                <div style="margin-bottom: 8px;">å·²å®Œæˆ: <span id="completedLessons">0</span>/<span id="totalLessons">0</span></div>
                <div style="height: 6px; background: #2c3e50; border-radius: 3px; overflow: hidden;">
                    <div style="height: 100%; width: 30%; background: #3498db;"></div>
                </div>
            </div>
            
            <div style="margin-top: 15px; padding: 0 10px;">
                <label style="font-size: 14px; display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="autoPlayNext" style="margin-right: 8px;"> è‡ªåŠ¨æ’­æ”¾ä¸‹ä¸€å¥
                </label>
            </div>
        </div>
    </div>
    
    <!-- å³ä¾§å†…å®¹åŒº -->
    <div class="content-area">
        <!-- æ’­æ”¾å™¨åŒºåŸŸ -->
        <div class="player-section">
            <div class="top-toolbar">
                <div class="toolbar-row">
                    <svg id="idBTNSignIn" xmlns="http://www.w3.org/2000/svg" width="24" height="24" class="btnOutpost" viewBox="0 0 16 16" fill="#000000" style="border:none; padding:0;"><g fill="#000000"><path d="M12.5 16a3.5 3.5 0 1 0 0-7a3.5 3.5 0 0 0 0 7Zm1.679-4.493l-1.335 2.226a.75.75 0 0 1-1.174.144l-.774-.773a.5.5 0 0 1 .708-.708l.547.548l1.17-1.951a.5.5 0 1 1 .858.514ZM11 5a3 3 0 1 1-6 0a3 3 0 0 1 6 0ZM8 7a2 2 0 1 0 0-4a2 2 0 0 0 0 4Z"/><path d="M8.256 14a4.474 4.474 0 0 1-.229-1.004H3c.001-.246.154-.986.832-1.664C4.484 10.68 5.711 10 8 10c.26 0 .507.009.74.025c.226-.341.496-.65.804-.918C9.077 9.038 8.564 9 8 9c-5 0-6 3-6 4s1 1 1 1h5.256Z"/></g></svg>

                    <a id="idBTNToggleNavBar" class="btnOutpost" style="border:none; padding:5px;">
                        <svg xmlns="http://www.w3.org/2000/svg"  width="24" height="24" viewBox="0 0 24 24"><path fill="none" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 5h18M3 12h18M3 19h18"/></svg>            
                    </a>
                    
                    <!-- å¯ç¼–è¾‘çš„æ ‡é¢˜ -->
                    <input type="text" id="currentLessonTitleInput" value="é€‰æ‹©å·¦ä¾§éŸ³é¢‘è¯¾ä»¶å¼€å§‹å­¦ä¹ " placeholder="è¯¾ä»¶æ ‡é¢˜">
                </div>

                <!-- Tags ç¼–è¾‘è¡Œ -->
                <div class="meta-edit-row">
                    <div class="tag-edit-container">
                        <span class="tag-label">Tags:</span>
                        <input type="text" id="currentLessonTagsInput" placeholder="è¾“å…¥æ ‡ç­¾ï¼Œç”¨é€—å·åˆ†éš” (ä¾‹å¦‚: easy, travel)">
                    </div>
                </div>
            </div>

            <div id="waveform"></div>
            
            <div class="player-controls">
                <a id="playPauseBtn" class="btnOutpost" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M22 17.5L18.5 20v-5l3.5 2.5ZM2 5h18M2 11h18M2 17h12"/></svg> 
                    æ’­æ”¾/æš‚åœ
                </a>
                <div class="nav-buttons">
                    <a id="prevRegionBtn" class="btnOutpost" disabled><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"><path fill="none" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 12H3m0 0l8.5-8.5M3 12l8.5 8.5"/></svg>ä¸Šä¸€å¥</a>
                    <a id="nextRegionBtn" class="btnOutpost" disabled>ä¸‹ä¸€å¥<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"><path fill="none" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 12h18m0 0l-8.5-8.5M21 12l-8.5 8.5"/></svg></a>
                </div>
                <a id="idSaveChange" class="btnOutpost btn-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                    ä¿å­˜ä¿®æ”¹
                </a>
            </div>
        </div>
        
        <!-- æ—¶é—´æˆ³åŒºåŸŸ -->
        <div class="timestamps-section">
            <div class="section-title" style="font-size: 16px; font-weight: 500; margin-bottom: 15px; color: #2c3e50;">æ—¶é—´æˆ³å¥å­</div>
            <div class="table-container">
                <table id="timestampsTable">
                    <thead>
                        <tr>
                            <th width="90">å¼€å§‹</th>
                            <th width="90">ç»“æŸ</th>
                            <th width="35%">æ³°è¯­å¥å­</th>
                            <th>è‹±æ–‡ç¿»è¯‘</th>
                            <th width="100">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="timestampsBody">
                        <tr>
                            <td colspan="5" class="loading">é€‰æ‹©éŸ³é¢‘è¯¾ä»¶åæ—¶é—´æˆ³å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Firebaseé…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyA6MZ_p5lVuy8TMAqiuV6IRx9fggV44lQs",
            authDomain: "outpost-8d74e.firebaseapp.com",
            databaseURL: "https://outpost-audible-8d74e-6ba9c.asia-southeast1.firebasedatabase.app/",
            projectId: "outpost-8d74e",
            storageBucket: "outpost-8d74e.firebasestorage.app",
            messagingSenderId: "724993324937",
            appId: "1:724993324937:web:ce6c7e6b06489331c79358",
            measurementId: "G-QPHWRTH6BH"
        };
        
        // åˆå§‹åŒ–Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const auth = firebase.auth();
        const database = firebase.database();
        const provider = new firebase.auth.GoogleAuthProvider();
        
        // Wavesurferå®ä¾‹å’Œå…¨å±€å˜é‡
        let wavesurfer = null;
        let regionsPlugin = WaveSurfer.Regions.create();
        let currentRegions = [];
        let currentLesson = null;
        let currentRegionIndex = -1;
        let activeRegion = null;
        let activeLesson = null; // å½“å‰åŠ è½½çš„lessonå®Œæ•´å¯¹è±¡

        // æ•°æ®ç¼“å­˜
        let globalCourses = {}; // å­˜å‚¨è¯¾ç¨‹æ–‡ä»¶å¤¹å…ƒæ•°æ®
        let globalLessons = []; // å­˜å‚¨æ‰€æœ‰lessonæ•°æ®
        
        // DOMå…ƒç´ 
        const courseListContainer = document.getElementById('courseListContainer');
        const currentLessonTitleInput = document.getElementById('currentLessonTitleInput');
        const currentLessonTagsInput = document.getElementById('currentLessonTagsInput');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const prevRegionBtn = document.getElementById('prevRegionBtn');
        const nextRegionBtn = document.getElementById('nextRegionBtn');
        const timestampsBody = document.getElementById('timestampsBody');
        const autoPlayNext = document.getElementById('autoPlayNext');
        const btnToggleNav = document.getElementById('idBTNToggleNavBar');
        const btnSaveChange = document.querySelector("#idSaveChange");
        const searchInput = document.getElementById('searchInput');
        const tagFilterInput = document.getElementById('tagFilterInput');

        // ---------------------------------------------------------
        // æ•°æ®åŠ è½½ä¸å¤„ç† Logic
        // ---------------------------------------------------------

        // åˆå§‹åŒ–åŠ è½½
        function loadData() {
            // 1. è·å– Courses
            database.ref('audibleCourses').once('value')
                .then(snapshot => {
                    const coursesData = snapshot.val() || {};
                    // è§„èŒƒåŒ– Courses æ•°æ®
                    globalCourses = coursesData;
                    console.log("Loaded Courses:", globalCourses);
                    
                    // 2. è·å– Lessons
                    startLessonsListener();
                })
                .catch(error => {
                    console.error("Error loading courses:", error);
                    courseListContainer.innerHTML = '<div class="loading">åŠ è½½è¯¾ç¨‹æ•°æ®å¤±è´¥</div>';
                });
        }

        function startLessonsListener() {
            const lessonsRef = database.ref('audibles');
            lessonsRef.on('value', (snapshot) => {
                const lessonsMap = snapshot.val() || {};
                
                // å°† Object è½¬æ¢ä¸º Array å¹¶ä¿ç•™ key
                globalLessons = Object.keys(lessonsMap).map(key => {
                    return {
                        ...lessonsMap[key],
                        key: key
                    };
                });

                // æ›´æ–°æ€»æ•°æ˜¾ç¤º
                document.getElementById('totalLessons').textContent = globalLessons.length;

                // æ¸²æŸ“åˆ—è¡¨ (åº”ç”¨å½“å‰çš„æœç´¢æ¡ä»¶)
                renderCourseList();
            }, (error) => {
                console.error('åŠ è½½Lessonåˆ—è¡¨å¤±è´¥:', error);
                courseListContainer.innerHTML = '<div class="loading">åŠ è½½Lessonåˆ—è¡¨å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
            });
        }

        // æ ¸å¿ƒæ¸²æŸ“é€»è¾‘ï¼šæŒ‰ Course åˆ†ç»„å¹¶æ¸²æŸ“ Accordion
        function renderCourseList() {
            const searchText = searchInput.value.toLowerCase().trim();
            const searchTag = tagFilterInput.value.toLowerCase().trim();

            // 1. ç­›é€‰ Lesson
            const filteredLessons = globalLessons.filter(lesson => {
                const titleMatch = (lesson.title || "").toLowerCase().includes(searchText);
                
                let tagMatch = true;
                if (searchTag) {
                    // å‡è®¾ lesson.tags æ˜¯å­—ç¬¦ä¸² "tag1, tag2" æˆ–æ•°ç»„
                    const tagsStr = Array.isArray(lesson.tags) ? lesson.tags.join(',') : (lesson.tags || "");
                    tagMatch = tagsStr.toLowerCase().includes(searchTag);
                }
                
                return titleMatch && tagMatch;
            });

            // 2. æŒ‰ courseCode åˆ†ç»„
            const grouped = {};
            const unclassifiedKey = "Unclassified";

            // åˆå§‹åŒ–å·²çŸ¥è¯¾ç¨‹ç»„
            Object.keys(globalCourses).forEach(courseCode => {
                grouped[courseCode] = {
                    info: globalCourses[courseCode],
                    lessons: []
                };
            });
            grouped[unclassifiedKey] = {
                info: { course: "æœªåˆ†ç±» / å…¶ä»–", courseCode: unclassifiedKey },
                lessons: []
            };

            // åˆ†é… Lesson åˆ°ç»„
            filteredLessons.forEach(lesson => {
                const code = lesson.courseCode;
                if (code && grouped[code]) {
                    grouped[code].lessons.push(lesson);
                } else {
                    grouped[unclassifiedKey].lessons.push(lesson);
                }
            });

            // 3. æ¸²æŸ“ HTML
            courseListContainer.innerHTML = '';

            // æ’åºè¾…åŠ©å‡½æ•°
            const sortByTitle = (arr) => arr.sort((a, b) => (a.title || "").localeCompare(b.title || ""));

            // éå†æ‰€æœ‰ç»„è¿›è¡Œæ¸²æŸ“
            Object.keys(grouped).forEach(groupKey => {
                const group = grouped[groupKey];
                if (group.lessons.length === 0) return; // å¦‚æœè¯¥ç»„æ²¡æœ‰åŒ¹é…çš„è¯¾ç¨‹ï¼Œä¸”ä¸åœ¨æœç´¢ä¸­ï¼Œåˆ™éšè—

                // æ’åºç»„å†…è¯¾ç¨‹
                const sortedGroupLessons = sortByTitle(group.lessons);

                // åˆ›å»ºæ–‡ä»¶å¤¹å®¹å™¨
                const folderDiv = document.createElement('div');
                folderDiv.className = 'course-folder';

                // æ–‡ä»¶å¤¹å¤´éƒ¨
                const headerBtn = document.createElement('button');
                headerBtn.className = 'course-header-btn';
                headerBtn.innerHTML = `
                    <span style="display:flex; align-items:center;">
                        <span class="folder-icon">ğŸ“</span>
                        <b>${group.info.course || groupKey}</b> 
                        <span style="font-size:12px; margin-left:8px; opacity:0.7;">(${sortedGroupLessons.length})</span>
                    </span>
                    <span class="material-symbols-outlined arrow-icon" style="font-size: 18px;">arrow_right_alt</span>
                `;
                
                // ç‚¹å‡»åˆ‡æ¢æŠ˜å /å±•å¼€
                headerBtn.onclick = () => {
                    folderDiv.classList.toggle('active');
                };

                // è¯¾ç¨‹åˆ—è¡¨å®¹å™¨
                const contentDiv = document.createElement('div');
                contentDiv.className = 'course-content';
                
                const ul = document.createElement('ul');
                ul.className = 'lesson-list';

                sortedGroupLessons.forEach(lesson => {
                    const li = document.createElement('li');
                    li.className = 'lesson-item';
                    
                    // å¤„ç† Tags æ˜¾ç¤º
                    let tagsDisplay = '';
                    if (lesson.tags) {
                        tagsDisplay = `<div class="lesson-tags-display">ğŸ·ï¸ ${lesson.tags}</div>`;
                    }

                    li.innerHTML = `
                        <div style="font-weight:500;">${lesson.title}</div>
                        ${tagsDisplay}
                    `;
                    
                    li.dataset.key = lesson.key;
                    
                    // é«˜äº®å½“å‰é€‰ä¸­çš„è¯¾ç¨‹
                    if (activeLesson && activeLesson.key === lesson.key) {
                        li.classList.add('active');
                        folderDiv.classList.add('active'); // è‡ªåŠ¨å±•å¼€åŒ…å«å½“å‰è¯¾ç¨‹çš„æ–‡ä»¶å¤¹
                    }

                    li.addEventListener('click', (e) => {
                        e.stopPropagation(); // é˜²æ­¢è§¦å‘æ–‡ä»¶å¤¹æŠ˜å 
                        loadLesson(lesson);
                    });

                    ul.appendChild(li);
                });

                contentDiv.appendChild(ul);
                folderDiv.appendChild(headerBtn);
                folderDiv.appendChild(contentDiv);
                courseListContainer.appendChild(folderDiv);
            });

            // å¦‚æœæœç´¢ä¸­ï¼Œä¸”ç»“æœè¾ƒå°‘ï¼Œé»˜è®¤å±•å¼€æ‰€æœ‰
            if (searchText || searchTag) {
                document.querySelectorAll('.course-folder').forEach(el => el.classList.add('active'));
            }
        }

        // ---------------------------------------------------------
        // æ’­æ”¾å™¨ä¸é€»è¾‘ Logic
        // ---------------------------------------------------------

        const random = (min, max) => Math.random() * (max - min) + min;
        const randomColor = () => `rgba(${random(0, 255)}, ${random(0, 255)}, ${random(0, 255)}, 0.3)`;

        function loadLesson(lesson) {
            // æ·±æ‹·è´ï¼Œé˜²æ­¢ç›´æ¥ä¿®æ”¹ global æ•°æ®å¯¼è‡´æ¸²æŸ“é—®é¢˜
            activeLesson = JSON.parse(JSON.stringify(lesson));
            // activeLesson.key = lesson.key; // key is already inside from globalLessons map
            
            currentLesson = activeLesson;
            currentRegionIndex = -1;
            
            // æ›´æ–°UIé«˜äº®
            document.querySelectorAll('.lesson-item').forEach(item => item.classList.remove('active'));
            const activeItem = document.querySelector(`.lesson-item[data-key="${lesson.key}"]`);
            if (activeItem) activeItem.classList.add('active');
            
            // å¡«å……ç¼–è¾‘æ¡†
            currentLessonTitleInput.value = activeLesson.title || "";
            currentLessonTagsInput.value = activeLesson.tags || "";
            
            // å¯ç”¨æŒ‰é’®
            playPauseBtn.removeAttribute('disabled');
            
            // åˆå§‹åŒ–æˆ–é‡ç½®wavesurfer
            if (wavesurfer) {
                wavesurfer.destroy();
                regionsPlugin.clearRegions();
            }
            
            // é‡å»º Wavesurfer
            wavesurfer = WaveSurfer.create({
                container: '#waveform',
                waveColor: '#3498db',
                progressColor: '#2980b9',
                cursorColor: '#e74c3c',
                barWidth: 2,
                barGap: 3,
                barRadius: 3,
                height: 120,
                normalize: true,
                minPxPerSec: 50, // Zoom level
                plugins: [regionsPlugin]
            });
            
            // åŠ è½½éŸ³é¢‘
            if (activeLesson.audioURL) {
                wavesurfer.load(activeLesson.audioURL);
            } else {
                alert("æ­¤è¯¾ç¨‹æ²¡æœ‰éŸ³é¢‘é“¾æ¥");
            }
            
            // äº‹ä»¶ç›‘å¬
            wavesurfer.on('ready', () => {
                prevRegionBtn.removeAttribute('disabled');
                nextRegionBtn.removeAttribute('disabled');
                
                currentRegions = [];
                
                // åˆ›å»ºåŒºåŸŸ
                if (activeLesson.timeStamps && activeLesson.timeStamps.length > 0) {
                    // æ’åº timestamps
                    activeLesson.timeStamps.sort((a, b) => a.start - b.start);

                    activeLesson.timeStamps.forEach((stamp, index) => {
                        const region = regionsPlugin.addRegion({
                            start: stamp.start,
                            end: stamp.end,
                            color: 'rgba(52, 152, 219, 0.1)',
                            drag: true,
                            resize: true
                        });
                        
                        region.id = index; // Use index as ID for mapping back to array
                        currentRegions.push(region);
                        
                        // åŒºåŸŸç‚¹å‡»
                        region.on('click', () => playRegion(index));
                        // åŒºåŸŸæ›´æ–°
                        region.on('update-end', () => {
                            updateTimestampTable(index, region.start, region.end);
                        });
                    });
                }
                
                generateTimestampsTable(activeLesson.timeStamps);
            });
            
            wavesurfer.on('play', () => playPauseBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><rect x="6" y="4" width="4" height="16" fill="#000000"/><rect x="14" y="4" width="4" height="16" fill="#000000"/></svg> æš‚åœ`);
            wavesurfer.on('pause', () => playPauseBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M22 17.5L18.5 20v-5l3.5 2.5ZM2 5h18M2 11h18M2 17h12"/></svg> æ’­æ”¾`);
            wavesurfer.on('finish', () => playPauseBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M22 17.5L18.5 20v-5l3.5 2.5ZM2 5h18M2 11h18M2 17h12"/></svg> æ’­æ”¾`);

            regionsPlugin.on('region-out', (region) => {
                if (activeRegion === region) {
                    if (autoPlayNext.checked) {
                       playNextRegion();
                    } else {
                        activeRegion = null;
                    }
                }
            });
            
            wavesurfer.on('interaction', () => activeRegion = null);

            // Remove old listeners to avoid duplicates if loadLesson is called multiple times
            const newPlayBtn = playPauseBtn.cloneNode(true);
            playPauseBtn.parentNode.replaceChild(newPlayBtn, playPauseBtn);
            newPlayBtn.addEventListener('click', () => wavesurfer.isPlaying() ? wavesurfer.pause() : wavesurfer.play());
            
            // Re-attach global button vars
            // (Note: better practice is to define listeners once outside, but for this structure we refresh them)
            document.getElementById('playPauseBtn').addEventListener('click', () => {
                 wavesurfer.isPlaying() ? wavesurfer.pause() : wavesurfer.play();
            });
        }

        // ç”Ÿæˆæ—¶é—´æˆ³è¡¨æ ¼
        function generateTimestampsTable(timeStamps) {
            timestampsBody.innerHTML = '';
            
            if (!timeStamps || timeStamps.length === 0) {
                timestampsBody.innerHTML = '<tr><td colspan="5" class="loading">æ­¤è¯¾ä»¶æ²¡æœ‰æ—¶é—´æˆ³æ•°æ®</td></tr>';
                return;
            }
            
            timeStamps.forEach((stamp, index) => {
                const row = document.createElement('tr');
                row.dataset.index = index;
                
                row.innerHTML = `
                    <td><input type="number" class="time-input start-time" value="${stamp.start.toFixed(2)}" step="0.1"></td>
                    <td><input type="number" class="time-input end-time" value="${stamp.end.toFixed(2)}" step="0.1"></td>
                    <td class="thai-text" contenteditable="true">${stamp.thai_text || ''}</td>
                    <td class="translation" contenteditable="true">${stamp.english_translation || ''}</td>
                    <td>
                        <button class="action-btn play-row" title="æ’­æ”¾">â–¶ï¸</button>
                        <button class="action-btn delete-row" title="åˆ é™¤">âŒ</button>
                    </td>
                `;
                
                timestampsBody.appendChild(row);
                
                // äº‹ä»¶ç»‘å®š
                row.querySelector('.play-row').addEventListener('click', (e) => { e.stopPropagation(); playRegion(index); });
                row.querySelector('.delete-row').addEventListener('click', (e) => { e.stopPropagation(); deleteRegion(index); });
                
                // ç›‘å¬æ—¶é—´è¾“å…¥ä¿®æ”¹ region
                row.querySelector('.start-time').addEventListener('change', (e) => {
                    const val = parseFloat(e.target.value);
                    if(!isNaN(val) && currentRegions[index]) {
                        currentRegions[index].setOptions({ start: val });
                    }
                });
                row.querySelector('.end-time').addEventListener('change', (e) => {
                    const val = parseFloat(e.target.value);
                    if(!isNaN(val) && currentRegions[index]) {
                        currentRegions[index].setOptions({ end: val });
                    }
                });
                
                // ç›‘å¬æ–‡æœ¬å†…å®¹ä¿®æ”¹ (å®æ—¶æ›´æ–° activeLesson å¯¹è±¡ï¼Œä½†éœ€è¦ä¿å­˜æ‰æäº¤åˆ°firebase)
                row.querySelector('.thai-text').addEventListener('input', (e) => {
                    activeLesson.timeStamps[index].thai_text = e.target.innerText;
                });
                row.querySelector('.translation').addEventListener('input', (e) => {
                    activeLesson.timeStamps[index].english_translation = e.target.innerText;
                });
            });
        }

        function playRegion(index) {
            if (!currentRegions[index]) return;
            
            const region = currentRegions[index];
            activeRegion = region;
            region.play();
            
            // Highlight row
            document.querySelectorAll('#timestampsBody tr').forEach(row => row.classList.remove('active'));
            const row = document.querySelector(`#timestampsBody tr[data-index="${index}"]`);
            if(row) {
                row.classList.add('active');
                row.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            
            currentRegionIndex = index;
        }
        
        function playNextRegion() {
            if (currentRegions.length === 0) return;
            let newIndex = currentRegionIndex + 1;
            if (newIndex >= currentRegions.length) newIndex = 0; // Loop back or stop? Let's loop.
            playRegion(newIndex);
        }

        function updateTimestampTable(index, start, end) {
            const row = document.querySelector(`#timestampsBody tr[data-index="${index}"]`);
            if (row) {
                row.querySelector('.start-time').value = start.toFixed(2);
                row.querySelector('.end-time').value = end.toFixed(2);
                // åŒæ—¶æ›´æ–° activeLesson æ•°æ®
                if(activeLesson.timeStamps[index]) {
                    activeLesson.timeStamps[index].start = start;
                    activeLesson.timeStamps[index].end = end;
                }
            }
        }

        function deleteRegion(index) {
            if(!confirm("ç¡®å®šè¦åˆ é™¤è¿™å¥è¯å—?")) return;
            
            currentRegions[index].remove();
            currentRegions.splice(index, 1);
            activeLesson.timeStamps.splice(index, 1);
            
            // é‡å»ºç´¢å¼•å’Œè¡¨æ ¼
            // ç®€å•èµ·è§ï¼Œé‡æ–°ç”Ÿæˆ
            // éœ€è¦é‡æ–°æ˜ å°„ regions å¯¹åº”çš„ ID
            generateTimestampsTable(activeLesson.timeStamps);
            // Note: region objects in wavesurfer might need full reload to re-sync indices perfectly or complex mapping.
            // For simplicity here, reloading the wavesurfer regions might be safer but let's just refresh table.
        }

        // ---------------------------------------------------------
        // ä¿å­˜ä¸äº‹ä»¶ç›‘å¬ Logic
        // ---------------------------------------------------------

        // ä¿å­˜æ›´æ”¹åˆ° Firebase
        btnSaveChange.addEventListener('click', async () => {
            if (!activeLesson) return;

            // 1. åŒæ­¥ Region æ•°æ®åˆ° activeLesson
            // æ³¨æ„ï¼šæˆ‘ä»¬åœ¨ updateTimestampTable å’Œ input listener ä¸­å·²ç»éƒ¨åˆ†åŒæ­¥
            // ä½†ä¸ºäº†ç¡®ä¿å‡†ç¡®æ€§ï¼Œä» regions å†æ¬¡è¯»å– start/end
            currentRegions.forEach((region, idx) => {
                if (activeLesson.timeStamps[idx]) {
                    activeLesson.timeStamps[idx].start = region.start;
                    activeLesson.timeStamps[idx].end = region.end;
                }
            });

            // 2. è·å–æ ‡é¢˜å’Œæ ‡ç­¾ä¿®æ”¹
            const newTitle = currentLessonTitleInput.value.trim();
            const newTags = currentLessonTagsInput.value.trim();

            if (newTitle) activeLesson.title = newTitle;
            activeLesson.tags = newTags; // å­˜ä¸ºå­—ç¬¦ä¸²å³å¯ï¼Œæˆ–è€… split(',') å­˜æ•°ç»„ï¼Œè¿™é‡Œä¿æŒå­—ç¬¦ä¸²ä»¥ä¾¿ç¼–è¾‘

            // 3. å‡†å¤‡ä¿å­˜
            const key = activeLesson.key;
            const dataToSave = JSON.parse(JSON.stringify(activeLesson));
            delete dataToSave.key; // ä¸è¦æŠŠ key å­˜è¿›æ•°æ®å­—æ®µé‡Œ

            btnSaveChange.textContent = "ä¿å­˜ä¸­...";
            
            database.ref(`audibles/${key}`).set(dataToSave)
                .then(() => {
                    console.log("Data saved successfully!");
                    btnSaveChange.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                        ä¿å­˜æˆåŠŸ
                    `;
                    setTimeout(() => {
                        btnSaveChange.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                        ä¿å­˜ä¿®æ”¹`;
                    }, 2000);
                })
                .catch((error) => {
                    console.error("Error writing data: ", error);
                    alert("ä¿å­˜å¤±è´¥: " + error.message);
                    btnSaveChange.textContent = "ä¿å­˜å¤±è´¥";
                });
        });

        // ä¾§è¾¹æ æœç´¢/ç­›é€‰ç›‘å¬
        searchInput.addEventListener('input', renderCourseList);
        tagFilterInput.addEventListener('input', renderCourseList);

        // ä¾§è¾¹æ åˆ‡æ¢
        btnToggleNav.addEventListener('click', () => {
            document.querySelector('.sidebar').classList.toggle('noShow');
        });

        // ç™»å½•
        const btnUserLogin = document.querySelector('#idBTNSignIn');
        btnUserLogin.addEventListener('click', () => {
            auth.signInWithPopup(provider).then((result) => {
                console.log("User signed in:", result.user);
            }).catch((error) => {
                console.error("Sign-in error:", error);
            });
        });

        // ä¸Šä¸€å¥ / ä¸‹ä¸€å¥ æŒ‰é’®ç»‘å®š
        prevRegionBtn.addEventListener('click', () => {
            if (currentRegions.length === 0) return;
            let newIndex = currentRegionIndex - 1;
            if (newIndex < 0) newIndex = currentRegions.length - 1;
            playRegion(newIndex);
        });
        
        nextRegionBtn.addEventListener('click', playNextRegion);

        // å¯åŠ¨
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
        });

    </script>
</body>
</html>
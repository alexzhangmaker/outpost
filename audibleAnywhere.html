<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ³°è¯­å­¦ä¹ éŸ³é¢‘åº”ç”¨</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>


    <script src="https://unpkg.com/wavesurfer.js@7"></script>
    <script src="https://unpkg.com/wavesurfer.js@7/dist/plugins/regions.min.js"></script>


    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&icon_names=enable" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&icon_names=install_desktop" />
    
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&icon_names=arrow_back" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,0,0&icon_names=arrow_right_alt" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f5f7fa;
            color: #333;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        
        /* å·¦ä¾§å¯¼èˆªåŒº */
        .sidebar {
            width: 320px;
            background-color: #2c3e50;
            color: white;
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            overflow-y: auto;
        }
        
        .app-title {
            font-size: 24px;
            font-weight: 500;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
        }
        
        .app-title::before {
            content: "ğŸµ";
            margin-right: 10px;
        }
        
        .nav-section {
            margin-bottom: 25px;
        }
        
        .nav-header {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 15px;
            color: #ecf0f1;
            display: flex;
            align-items: center;
        }
        
        .nav-header::before {
            content: "â€¢";
            margin-right: 8px;
            color: #3498db;
        }
        
        .lesson-list {
            list-style: none;
        }
        
        .lesson-item {
            padding: 8px 10px;
            margin-bottom: 8px;
            background-color: #34495e;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;

            font-size: 16px;
        }
        
        .lesson-item:hover {
            background-color: #3d566e;
            transform: translateX(5px);
        }
        
        .lesson-item.active {
            background-color: #3498db;
            font-weight: 500;
        }
        
        /* å³ä¾§å†…å®¹åŒº */
        .content-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* æ’­æ”¾å™¨åŒºåŸŸ */
        .player-section {
            padding: 25px;
            background-color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            z-index: 10;
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 500;
            margin-bottom: 20px;
            color: #2c3e50;
        }
        
        #waveform {
            width: 100%;
            height: 180px;
            margin-bottom: 20px;
            background-color: #f8f9fa;
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .player-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .btn {
            padding: 10px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
        
        .btn:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        
        .nav-buttons {
            display: flex;
            gap: 10px;
        }
        
        /* æ—¶é—´æˆ³åŒºåŸŸ */
        .timestamps-section {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
            background-color: #f8f9fa;
        }
        
        .table-container {
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background-color: #f8f9fa;
            font-weight: 500;
            color: #7f8c8d;
        }
        
        tr {
            transition: background-color 0.2s;
        }
        
        tr:hover {
            background-color: #f5f7fa;
        }
        
        tr.active {
            background-color: #e1f0fa;
        }
        
        .time-input {
            width: 70px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
        }
        
        .thai-text {
            /*font-family: 'Noto Sans Thai', sans-serif;*/
            font-size: 22px;
            width:50%;
        }
        
        .translation {
            color: #7f8c8d;
            font-style: italic;
            font-size:14px;
        }
        
        .action-btn {
            background: none;
            border: none;
            color: #3498db;
            cursor: pointer;
            font-size: 18px;
            margin: 0 5px;
        }
        
        .action-btn:hover {
            color: #2980b9;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 900px) {
            body {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                max-height: 40vh;
            }
            
            .content-area {
                height: 60vh;
            }
        }
    </style>
    <style>
        .noShow{
            display: none;
        }

        .btnOutpost{
            font-size: 18px;
        }

        .btnOutpost:hover{
            cursor: pointer;
        }
    </style>

</head>
<body>
    <!-- å·¦ä¾§å¯¼èˆªåŒº -->
    <div class="sidebar">
        <div class="app-title">
            
            <span style="font-size:24px;">æ³°è¯­å­¦ä¹ éŸ³é¢‘åº”ç”¨</span>

        </div>
        
        
        <div class="nav-section">
            <div class="nav-header">éŸ³é¢‘è¯¾ä»¶</div>
            <ul class="lesson-list" id="lessonList">
                <li class="lesson-item">åŠ è½½ä¸­...</li>
            </ul>
        </div>
        
        <div class="nav-section">
            <div class="nav-header">å­¦ä¹ è¿›åº¦</div>
            <div style="padding: 10px; background: #34495e; border-radius: 6px;">
                <div style="margin-bottom: 8px;">å·²å®Œæˆ: <span id="completedLessons">0</span>/<span id="totalLessons">0</span></div>
                <div style="height: 8px; background: #2c3e50; border-radius: 4px; overflow: hidden;">
                    <div style="height: 100%; width: 30%; background: #3498db;"></div>
                </div>
            </div>
        </div>
        
        <div class="nav-section">
            <div class="nav-header">è®¾ç½®</div>
            <div style="padding: 10px;">
                <label>
                    <input type="checkbox" id="autoPlayNext"> è‡ªåŠ¨æ’­æ”¾ä¸‹ä¸€å¥
                </label>
            </div>
        </div>
    </div>
    
    <!-- å³ä¾§å†…å®¹åŒº -->
    <div class="content-area">
        <!-- æ’­æ”¾å™¨åŒºåŸŸ -->
        <div class="player-section">
            <div class="section-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" class="btnOutpost" id="idBTNSignIn" viewBox="0 0 16 16" fill="#000000"><g fill="#000000"><path d="M12.5 16a3.5 3.5 0 1 0 0-7a3.5 3.5 0 0 0 0 7Zm1.679-4.493l-1.335 2.226a.75.75 0 0 1-1.174.144l-.774-.773a.5.5 0 0 1 .708-.708l.547.548l1.17-1.951a.5.5 0 1 1 .858.514ZM11 5a3 3 0 1 1-6 0a3 3 0 0 1 6 0ZM8 7a2 2 0 1 0 0-4a2 2 0 0 0 0 4Z"/><path d="M8.256 14a4.474 4.474 0 0 1-.229-1.004H3c.001-.246.154-.986.832-1.664C4.484 10.68 5.711 10 8 10c.26 0 .507.009.74.025c.226-.341.496-.65.804-.918C9.077 9.038 8.564 9 8 9c-5 0-6 3-6 4s1 1 1 1h5.256Z"/></g></svg>

                <a id="idBTNToggleNavBar" class="btnOutpost">
                    <svg xmlns="http://www.w3.org/2000/svg"  width="24" height="24" viewBox="0 0 24 24"><path fill="none" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 5h18M3 12h18M3 19h18"/></svg>            
                </a>
                <span id="currentLessonTitle">é€‰æ‹©å·¦ä¾§éŸ³é¢‘è¯¾ä»¶å¼€å§‹å­¦ä¹ </span>
            </div> 
            <div id="waveform"></div>
            <div class="player-controls">
                <a id="playPauseBtn" class="btnOutpost"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M22 17.5L18.5 20v-5l3.5 2.5ZM2 5h18M2 11h18M2 17h12"/></svg></a>
                <div class="nav-buttons">
                    <a id="prevRegionBtn" class="btnOutpost"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 12H3m0 0l8.5-8.5M3 12l8.5 8.5"/></svg>ä¸Šä¸€å¥</a>
                    <a id="nextRegionBtn" class="btnOutpost" disabled><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path fill="none" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 12h18m0 0l-8.5-8.5M21 12l-8.5 8.5"/></svg>ä¸‹ä¸€å¥</a>
                </div>
                <a id="idSaveChange" class="btnOutpost"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="#000000"><g fill="none" stroke="#000000" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"><path d="m14 19l3 3l5-5M4 6v6s0 3 7 3s7-3 7-3V6"/><path d="M11 3c7 0 7 3 7 3s0 3-7 3s-7-3-7-3s0-3 7-3Zm0 18c-7 0-7-3-7-3v-6"/></g></svg>ä¿å­˜</a>
            </div>
        </div>
        
        <!-- æ—¶é—´æˆ³åŒºåŸŸ -->
        <div class="timestamps-section">
            <div class="section-title">æ—¶é—´æˆ³å¥å­</div>
            <div class="table-container">
                <table id="timestampsTable">
                    <thead>
                        <tr>
                            <th width="100" style="font-size: 18px;">å¼€å§‹</th>
                            <th width="100" style="font-size: 18px;">ç»“æŸ</th>
                            <th width="35%" style="font-size: 18px;">æ³°è¯­å¥å­</th>
                            <th style="font-size: 18px;">è‹±æ–‡ç¿»è¯‘</th>
                            <th width="100" style="font-size: 18px;">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="timestampsBody">
                        <tr>
                            <td colspan="5" class="loading">é€‰æ‹©éŸ³é¢‘è¯¾ä»¶åæ—¶é—´æˆ³å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Firebaseé…ç½® - éœ€è¦æ›¿æ¢ä¸ºå®é™…é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyA6MZ_p5lVuy8TMAqiuV6IRx9fggV44lQs",
            authDomain: "outpost-8d74e.firebaseapp.com",
            databaseURL: "https://outpost-audible-8d74e-6ba9c.asia-southeast1.firebasedatabase.app/",
            projectId: "outpost-8d74e",
            storageBucket: "outpost-8d74e.firebasestorage.app",
            messagingSenderId: "724993324937",
            appId: "1:724993324937:web:ce6c7e6b06489331c79358",
            measurementId: "G-QPHWRTH6BH"
        };
        
        // åˆå§‹åŒ–Firebase
        // Correct v8 code
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(); // Correct: auth() is the function
        const database = firebase.database();
        const provider = new firebase.auth.GoogleAuthProvider();
        

        // Wavesurferå®ä¾‹
        let wavesurfer = null;
        let currentRegions = [];
        let currentLesson = null;
        let currentRegionIndex = -1;
        let regionsPlugin = WaveSurfer.Regions.create() ;
        //let regions = RegionsPlugin.create() ;

        
        let activeRegion = null ;

        let activeLesson  ;
        

        // DOMå…ƒç´ 
        const lessonList = document.getElementById('lessonList');
        const currentLessonTitle = document.getElementById('currentLessonTitle');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const prevRegionBtn = document.getElementById('prevRegionBtn');
        const nextRegionBtn = document.getElementById('nextRegionBtn');
        const timestampsBody = document.getElementById('timestampsBody');
        const autoPlayNext = document.getElementById('autoPlayNext');
        const btnToggleNav = document.getElementById('idBTNToggleNavBar') ;
        const btnSaveChange = document.querySelector("#idSaveChange") ;

        // ä»Firebaseè·å–è¯¾ä»¶åˆ—è¡¨
        function loadLessons() {
            const lessonsRef = database.ref('audibles');
            
            lessonsRef.on('value', (snapshot) => {
                const lessons = snapshot.val();
                console.log(lessons) ;
                lessonList.innerHTML = '';
                
                if (lessons) {

                    /*
                    Object.keys(lessons).forEach(key => {
                        const lesson = lessons[key];
                        const li = document.createElement('li');
                        li.className = 'lesson-item';
                        li.textContent = lesson.title;
                        li.dataset.key = key;
                        li.addEventListener('click', () => {
                            loadLesson(lesson) ;
                            activeLesson = lesson ;
                            activeLesson.key = key ;
                        });
                        lessonList.appendChild(li);
                    });
                    */
                    let keys = Object.keys(lessons) ;
                    let jsonLessons=[] ;
                    for(let i=0;i<keys.length;i++){
                        let jsonLesson = lessons[keys[i]] ;
                        jsonLesson.key = keys[i] ;
                        jsonLessons.push(jsonLesson) ;
                    }
                    function sortByTitle(arr) {
                        return arr.slice().sort((a, b) => {
                            const titleA = a.title.toLowerCase();
                            const titleB = b.title.toLowerCase();
                            return titleA.localeCompare(titleB);
                        });
                    }
                    const orderedLessons = sortByTitle(jsonLessons) ;
                    orderedLessons.forEach(lesson=>{
                        const li = document.createElement('li');
                        li.className = 'lesson-item';
                        li.textContent = lesson.title;
                        li.dataset.key = lesson.key;
                        li.addEventListener('click', () => {
                            loadLesson(lesson) ;
                            activeLesson = lesson ;
                            activeLesson.key = key ;
                        });
                        lessonList.appendChild(li);
                    }) ;
                    
                    document.getElementById('totalLessons').textContent = Object.keys(lessons).length;
                } else {
                    const li = document.createElement('li');
                    li.className = 'lesson-item';
                    li.textContent = 'æ²¡æœ‰æ‰¾åˆ°éŸ³é¢‘è¯¾ä»¶';
                    lessonList.appendChild(li);
                }
            }, (error) => {
                console.error('åŠ è½½è¯¾ä»¶åˆ—è¡¨å¤±è´¥:', error);
                lessonList.innerHTML = '<li class="lesson-item">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</li>';
            });
        }
        


        // Give regions a random color when they are created
        const random = (min, max) => Math.random() * (max - min) + min
        const randomColor = () => `rgba(${random(0, 255)}, ${random(0, 255)}, ${random(0, 255)}, 0.5)`

        // åŠ è½½é€‰å®šçš„è¯¾ä»¶
        function loadLesson(lesson) {
            currentLesson = lesson;
            currentRegionIndex = -1;
            
            // æ›´æ–°UI
            document.querySelectorAll('.lesson-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.key === lesson.key) {
                    item.classList.add('active');
                }
            });
            
            currentLessonTitle.textContent = lesson.title;
            
            // åˆå§‹åŒ–æˆ–é‡ç½®wavesurfer
            if (wavesurfer) {
                wavesurfer.destroy();
                regionsPlugin.clearRegions();
            }
            
            wavesurfer = WaveSurfer.create({
                container: '#waveform',
                waveColor: '#3498db',
                progressColor: '#2980b9',
                cursorColor: '#2c3e50',
                barWidth: 3,
                barRadius: 3,
                barGap: 2,
                height: 180,
                normalize: true,
                plugins: [regionsPlugin/*,TimelinePlugin.create()*/]
            });
            
            // åŠ è½½éŸ³é¢‘
            wavesurfer.load(lesson.audioURL);
            
            // è®¾ç½®äº‹ä»¶ç›‘å¬
            wavesurfer.on('ready', () => {
                playPauseBtn.disabled = false;
                prevRegionBtn.disabled = false;
                nextRegionBtn.disabled = false;
                
                // æ¸…é™¤ç°æœ‰åŒºåŸŸ
                currentRegions.forEach(region => region.remove());
                currentRegions = [];
                
                // åˆ›å»ºåŒºåŸŸ
                if (lesson.timeStamps && lesson.timeStamps.length > 0) {
                    lesson.timeStamps.forEach((stamp, index) => {
                        const region = regionsPlugin.addRegion({
                            start: stamp.start,
                            end: stamp.end,
                            color: `rgba(52, 152, 219, 0.3)`,
                            drag: true,
                            resize: true
                        });
                        
                        region.id = index;
                        currentRegions.push(region);
                        
                        // åŒºåŸŸç‚¹å‡»äº‹ä»¶
                        region.on('click', () => {
                            playRegion(index);
                        });
                        
                        // åŒºåŸŸæ›´æ–°äº‹ä»¶
                        region.on('update-end', () => {
                            updateTimestampTable(index, region.start, region.end);
                        });
                    });
                }
                
                // ç”Ÿæˆæ—¶é—´æˆ³è¡¨æ ¼
                generateTimestampsTable(lesson.timeStamps);
            });
            
            wavesurfer.on('play', () => {
                playPauseBtn.textContent = 'æš‚åœ';
            });
            
            wavesurfer.on('pause', () => {
                playPauseBtn.textContent = 'æ’­æ”¾';
            });
            
            wavesurfer.on('finish', () => {
                playPauseBtn.textContent = 'æ’­æ”¾';
            });

            regionsPlugin.on('region-in', (region) => {
                console.log('region-in', region)
                activeRegion = region
            })
            regionsPlugin.on('region-out', (region) => {
                console.log('region-out', region)
                if (activeRegion === region) {
                    if (autoPlayNext.checked) {
                        region.play()
                    } else {
                        activeRegion = null
                    }
                }
            })
            regionsPlugin.on('region-clicked', (region, e) => {
                e.stopPropagation() // prevent triggering a click on the waveform
                activeRegion = region
                region.play(true)
                region.setOptions({ color: randomColor() })
            })
            // Reset the active region when the user clicks anywhere in the waveform
            wavesurfer.on('interaction', () => {
                activeRegion = null
            }) ;
            
            // æ’­æ”¾/æš‚åœæŒ‰é’®äº‹ä»¶
            playPauseBtn.addEventListener('click', () => {
                if (wavesurfer.isPlaying()) {
                    wavesurfer.pause();
                } else {
                    wavesurfer.play();
                }
            });
            
            // ä¸Šä¸€å¥/ä¸‹ä¸€å¥æŒ‰é’®äº‹ä»¶
            prevRegionBtn.addEventListener('click', playPrevRegion);
            nextRegionBtn.addEventListener('click', playNextRegion);
        }
        
        // ç”Ÿæˆæ—¶é—´æˆ³è¡¨æ ¼
        function generateTimestampsTable(timeStamps) {
            timestampsBody.innerHTML = '';
            
            if (!timeStamps || timeStamps.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="5" class="loading">æ­¤è¯¾ä»¶æ²¡æœ‰æ—¶é—´æˆ³æ•°æ®</td>';
                timestampsBody.appendChild(row);
                return;
            }
            
            timeStamps.forEach((stamp, index) => {
                const row = document.createElement('tr');
                row.dataset.index = index;
                
                row.innerHTML = `
                    <td>
                        <input type="number" class="time-input start-time" value="${stamp.start.toFixed(2)}" step="0.1">
                    </td>
                    <td>
                        <input type="number" class="time-input end-time" value="${stamp.end.toFixed(2)}" step="0.1">
                    </td>
                    <td class="thai-text">${stamp.thai_text}</td>
                    <td class="translation">${stamp.english_translation}</td>
                    <td>
                        <button class="action-btn play-row">â–¶ï¸</button>
                        <button class="action-btn delete-row">âŒ</button>
                    </td>
                `;
                
                timestampsBody.appendChild(row);
                
                // æ’­æ”¾æŒ‰é’®äº‹ä»¶
                row.querySelector('.play-row').addEventListener('click', (e) => {
                    e.stopPropagation();
                    playRegion(index);
                });
                
                // åˆ é™¤æŒ‰é’®äº‹ä»¶
                row.querySelector('.delete-row').addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteRegion(index);
                });
                
                // å¼€å§‹æ—¶é—´è¾“å…¥äº‹ä»¶
                row.querySelector('.start-time').addEventListener('change', (e) => {
                    const newStart = parseFloat(e.target.value);
                    if (!isNaN(newStart) && newStart < currentRegions[index].end) {
                        currentRegions[index].setOptions({ start: newStart });
                        //currentRegions[index].start = newStart ;
                        updateTimestampTable(index, newStart, currentRegions[index].end);
                    } else {
                        e.target.value = currentRegions[index].start.toFixed(2);
                    }
                });
                
                // ç»“æŸæ—¶é—´è¾“å…¥äº‹ä»¶
                row.querySelector('.end-time').addEventListener('change', (e) => {
                    const newEnd = parseFloat(e.target.value);
                    if (!isNaN(newEnd) && newEnd > currentRegions[index].start) {
                        currentRegions[index].setOptions({ end: newEnd });
                        updateTimestampTable(index, currentRegions[index].start, newEnd);
                    } else {
                        e.target.value = currentRegions[index].end.toFixed(2);
                    }
                });
            });
        }
        
        // æ’­æ”¾æŒ‡å®šåŒºåŸŸ
        function playRegion(index) {
            if (index < 0 || index >= currentRegions.length) return;
            
            const region = currentRegions[index];
            wavesurfer.pause();
            //wavesurfer.setCurrentTime(region.start);
            region.play() ;
            //wavesurfer.play();
            
            //region.play();
            
            // é«˜äº®å½“å‰è¡Œ
            document.querySelectorAll('#timestampsBody tr').forEach(row => {
                row.classList.remove('active');
            });
            document.querySelector(`#timestampsBody tr[data-index="${index}"]`).classList.add('active');
            
            currentRegionIndex = index;
            
            // åŒºåŸŸæ’­æ”¾ç»“æŸäº‹ä»¶
            region.once('out', () => {
                if (autoPlayNext.checked) {
                    playNextRegion();
                }
            });
        }
        
        // æ’­æ”¾ä¸Šä¸€ä¸ªåŒºåŸŸ
        function playPrevRegion() {
            if (currentRegions.length === 0) return;
            
            let newIndex = currentRegionIndex - 1;
            if (newIndex < 0) newIndex = currentRegions.length - 1;
            
            playRegion(newIndex);
        }
        
        // æ’­æ”¾ä¸‹ä¸€ä¸ªåŒºåŸŸ
        function playNextRegion() {
            if (currentRegions.length === 0) return;
            
            let newIndex = currentRegionIndex + 1;
            if (newIndex >= currentRegions.length) newIndex = 0;
            
            playRegion(newIndex);
        }
        
        // æ›´æ–°æ—¶é—´æˆ³è¡¨æ ¼
        function updateTimestampTable(index, start, end) {
            const row = document.querySelector(`#timestampsBody tr[data-index="${index}"]`);
            if (row) {
                row.querySelector('.start-time').value = start.toFixed(2);
                row.querySelector('.end-time').value = end.toFixed(2);
            }
        }
        
        // åˆ é™¤åŒºåŸŸ
        function deleteRegion(index) {
            if (index < 0 || index >= currentRegions.length) return;
            
            currentRegions[index].remove();
            currentRegions.splice(index, 1);
            
            // é‡æ–°ç”Ÿæˆè¡¨æ ¼
            generateTimestampsTable(currentLesson.timeStamps);
        }
        
        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', () => {
            loadLessons();
        });
    </script>
    <script>

        btnSaveChange.addEventListener('click',async (event)=>{
            //alert("todo save")
            console.log(activeLesson);

            for(let i=0;i<currentRegions.length;i++){
                console.log(currentRegions[i]);
                activeLesson.timeStamps[i].start = currentRegions[i].start ;
                activeLesson.timeStamps[i].end = currentRegions[i].end ;
                console.log(activeLesson.timeStamps[i]) ;                
            }

            let key = activeLesson.key ;
            delete activeLesson.key ;
            database.ref(`audibles/${key}`).set(activeLesson)
                .then(() => {
                    console.log("Data written successfully!");
                    alert("Data written to Firebase!");
                })
                .catch((error) => {
                    console.error("Error writing data: ", error);
                    alert("Error writing data: " + error.message);
            });

        }) ;

        btnToggleNav.addEventListener('click',(event)=>{
            document.querySelector('.sidebar').classList.toggle('noShow') ;

        }) ;
    </script>
    <script>
        const btnUserLogin = document.querySelector('#idBTNSignIn') ;
        btnUserLogin.addEventListener('click',(event)=>{
            signInWithGoogle() ;
        }) ;
        // ç™»å½•å‡½æ•°
        // The correct way to call the function in V8
        function signInWithGoogle() {
            auth.signInWithPopup(provider).then((result) => {
                // User signed in successfully.
                const user = result.user;
                console.log("User:", user);
            }).catch((error) => {
                // Handle Errors here.
                console.error("Sign-in error:", error);
            });
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Outpost.控制台</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/gridjs/dist/theme/mermaid.min.css">

    <script src="https://unpkg.com/gridjs/dist/gridjs.umd.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #1e1e1e;
            color: #d4d4d4;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        
        /* 导航区样式 */
        .sidebar {
            width: 250px;
            background-color: #252526;
            border-right: 1px solid #3e3e42;
            padding: 20px 0;
            display: flex;
            flex-direction: column;
        }
        
        .logo {
            padding: 0 20px 20px;
            border-bottom: 1px solid #3e3e42;
            margin-bottom: 20px;
        }
        
        .logo h1 {
            font-size: 18px;
            color: #ffffff;
        }
        
        .nav-item {
            padding: 10px 20px;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .nav-item:hover {
            background-color: #2a2d2e;
        }
        
        .nav-item.active {
            background-color: #37373d;
        }
        
        .nav-item i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        /* 内容区样式 */
        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .header {
            padding: 15px 20px;
            background-color: #2d2d30;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h2 {
            font-size: 16px;
            font-weight: 500;
        }
        
        .main-content {
            flex: 1;
            padding: 20px;
            overflow: auto;
        }
        
        /* 表格样式 */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background-color: #252526;
            border: 1px solid #3e3e42;
        }
        
        .data-table th {
            background-color: #2d2d30;
            padding: 12px 15px;
            text-align: left;
            font-weight: 500;
            border-bottom: 1px solid #3e3e42;
        }
        
        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #3e3e42;
        }
        
        .data-table tr:last-child td {
            border-bottom: none;
        }
        
        .data-table tr:hover {
            background-color: #2a2d2e;
        }
        
        /* 操作图标样式 */
        .actions {
            display: flex;
            gap: 12px;
        }
        
        .action-icon {
            cursor: pointer;
            padding: 5px;
            border-radius: 3px;
            transition: background-color 0.2s;
        }
        
        .action-icon.delete:hover {
            color: #f85149;
            background-color: rgba(248, 81, 73, 0.1);
        }
        
        .action-icon.publish:hover {
            color: #3fb950;
            background-color: rgba(63, 185, 80, 0.1);
        }
        
        /* 按钮样式 */
        button {
            background-color: #0e639c;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background-color 0.2s;
        }
        
        button:hover {
            background-color: #1177bb;
        }
        
        button.secondary {
            background-color: #4f4f51;
        }
        
        button.secondary:hover {
            background-color: #5a5a5c;
        }
        
        /* 加载和错误状态 */
        .status-message {
            padding: 20px;
            text-align: center;
            color: #cccccc;
        }
        
        .error {
            color: #f85149;
        }
        
        /* 视图控制 */
        .view {
            display: none;
        }
        
        .view.active {
            display: block;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .sidebar {
                width: 60px;
            }
            
            .logo h1, .nav-item span {
                display: none;
            }
            
            .nav-item {
                justify-content: center;
            }
            
            .nav-item i {
                margin-right: 0;
            }
        }
    </style>
    <style>
        .gridjs-pagination .gridjs-pages{
            display:flex;
            float: right;
        }

        .gridjs-pages button{
            color: #1177bb;
        }
    </style>
</head>
<body>
    <!-- 导航区 -->
    <div class="sidebar">
        <div class="logo">
            <h1>Firebase 控制台</h1>
        </div>
        <div class="nav-item" data-view="wordSetView" id="idWordSetMan">
            <i class="fas fa-database"></i>
            <span>单词集管理</span>
        </div>
        <div class="nav-item" data-view="published-data" id="idAnkiDeckMan">
            <i class="fas fa-share-square"></i>
            <span>复习卡片盒</span>
        </div>
        <div class="nav-item" data-view="Dictionary-data" id="idDictionaryMan">
            <i class="fas fa-share-square"></i>
            <span>字典管理</span>
        </div>
        <div class="nav-item" data-view="wordQuiz-data" id="idQuizSetMan">
            <i class="fas fa-share-square"></i>
            <span>Quiz管理</span>
        </div>
        <div class="nav-item" data-view="article-data" id="idArticleMan">
            <i class="fas fa-share-square"></i>
            <span>阅读文章管理</span>
        </div>
        <div class="nav-item" data-view="tasks-data" id="idTasksMan">
            <i class="fas fa-share-square"></i>
            <span>任务数据管理</span>
        </div>
        <div class="nav-item" data-view="tasks-data" id="idPromptMan">
            <i class="fas fa-share-square"></i>
            <span>提词器管理</span>
        </div>
        <div class="nav-item" data-view="setting-data" id="idSettingMan">
            <i class="fas fa-cog"></i>
            <span>设置</span>
        </div>
        <div class="nav-item" data-view="help-data" id="idHelpMan">
            <i class="fas fa-question-circle"></i>
            <span>帮助</span>
        </div>
    </div>
    
    <!-- 内容区 -->
    <div class="content">
        <div class="header">
            <h2 id="view-title">数据管理</h2>
            <button id="refresh-btn" class="refresh-btn">
                <i class="fas fa-sync-alt"></i> 刷新数据
            </button>
        </div>
        
        <div class="main-content">
            <!-- 数据管理视图 -->
            <div id="WordSetManagement" class="view">
                <div id="status-message-WordSet" class="status-message">
                    正在加载数据...
                </div>
                
                <div id="idGridWordSet" style="display: none;"></div>
                <table id="dataTableWordSet" class="data-table" style="display: none;">
                    <thead>
                        <tr>
                            <th width="30%">键名</th>
                            <th width="50%">单词</th>
                            <th width="20%">操作</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableWordSetBody">
                        <!-- 数据将通过JavaScript动态填充 -->
                    </tbody>
                </table>
            </div>
            
            <!-- 已发布数据管理视图 -->
            <div id="AnkiDeckManagement" class="view">
                <div id="status-message-AnkiDeck" class="status-message">
                    正在加载已发布数据...
                </div>
                
                <table id="dataTableAnkiDeck" class="data-table" style="display: none;">
                    <thead>
                        <tr>
                            <th width="30%">键名</th>
                            <th width="50%">单词</th>
                            <th width="20%">操作</th>
                        </tr>
                    </thead>
                    <tbody id="dataTableAnkiDeckBody">
                        <!-- 数据将通过JavaScript动态填充 -->
                    </tbody>
                </table>
            </div>

            <!-- 已发布数据管理视图 -->
            <div id="DictManagement" class="view">
                <div id="status-message-Dictionary" class="status-message">
                    正在加载已发布数据...
                </div>
                
                <div id="dataGridDictionary" class="data-table" style="display: none;"></div>
            </div>


        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    
    <script>
        // Firebase配置 - 需要替换为您的实际配置
        const firebaseConfig = {
            apiKey: "AIzaSyA6MZ_p5lVuy8TMAqiuV6IRx9fggV44lQs",
            authDomain: "outpost-8d74e.firebaseapp.com",
            databaseURL: "https://outpost-dictionary-116208.asia-southeast1.firebasedatabase.app/",
            projectId: "outpost-8d74e",
            storageBucket: "outpost-8d74e.firebasestorage.app",
            messagingSenderId: "724993324937",
            appId: "1:724993324937:web:ce6c7e6b06489331c79358",
            measurementId: "G-QPHWRTH6BH"
        };
        
        // 初始化Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // 当前活动视图
        let currentView = "";//'WordSetManagement';
        
        // DOM元素
        const viewTitle = document.getElementById('view-title');
        const refreshBtn = document.getElementById('refresh-btn');
        const navItems = document.querySelectorAll('.nav-item');
        const views = document.querySelectorAll('.view');
        
        let gGridObj = new gridjs.Grid() ;
        let gRendered = false ;

        function renderAnyTabld(data,tagContainer){
            let rowKeys = Object.keys(data) ;
            console.log(rowKeys) ;
            let columnKeys = Object.keys(data[rowKeys[0]]) ;
            console.log(columnKeys) ;
            tagContainer.innerHTML=``;

            let tagTbl = document.createElement("table") ;
            tagContainer.appendChild(tagTbl) ;

            /*
            const grid = new Grid({
            columns: ['Name', 'Email', 'Phone Number'],
            pagination: true,
            data: [
                ['John', 'john@example.com', '(353) 01 222 3333'],
                ['Mark', 'mark@gmail.com',   '(01) 22 888 4444']
            ]
            });
            */
        }

        // 渲染数据表格
        function renderTable(data, tableBody,view) {
            tableBody.innerHTML = '';
            
            Object.entries(data).forEach(([key, value]) => {
                const row = document.createElement('tr');
                console.log(data) ;

                // 键名单元格
                const keyCell = document.createElement('td');
                keyCell.textContent = key;
                row.appendChild(keyCell);
                
                // 单词数组单元格
                const wordsCell = document.createElement('td');
                if (value.words && Array.isArray(value.words)) {
                    wordsCell.textContent = value.words.join(', ');
                } else {
                    wordsCell.textContent = '无数据';
                    wordsCell.style.color = '#888';
                }
                row.appendChild(wordsCell);
                
                // 操作图标单元格
                const actionsCell = document.createElement('td');
                actionsCell.innerHTML = `
                    <div class="actions">
                        <i class="fas fa-trash action-icon delete" data-key="${key}" data-view="${view}"></i>
                        ${view === 'wordSetView' ? 
                          `<i class="fas fa-share action-icon publish" data-key="${key}" data-view="${view}"></i>` : 
                          `<i class="fas fa-undo action-icon unpublish" data-key="${key}" data-view="${view}"></i>`}
                    </div>
                `;
                row.appendChild(actionsCell);
                tableBody.appendChild(row);
            });
            
            
        }
        
        
        
        // 处理发布操作
        // 处理发布操作
        async function handlePublish(event) {
            const key = event.target.getAttribute('data-key');
            let keyEncode =encodeURIComponent(key) ;

            let cDate = new Date() ;
            let urlReviewSet = `https://outpost-dictionary-116208.asia-southeast1.firebasedatabase.app/thaiAnki/reviewSets/${keyEncode}.json`;
            let urlWordSet = `https://outpost-dictionary-116208.asia-southeast1.firebasedatabase.app/thaiWordList/${keyEncode}.json` ;
            let jsonReviewSet={
                "createdAt":cDate.toDateString(),
                "nextReview":cDate.toDateString(),
                "wordSetID":key,
                "title":key,
                "wordSetURL":urlWordSet
            };
            // 在实际应用中，这里应该调用Firebase的发布API
            console.log(`发布项目: ${key}`);
            await fetch(urlReviewSet, {
                method: "PUT", // Use PATCH to update specific fields
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(jsonReviewSet),
            }) ;
            alert(`已发布: ${key}`);
        }
        
        // 处理取消发布操作
        function handleUnpublish(event) {
            const key = event.target.getAttribute('data-key');
            // 在实际应用中，这里应该调用Firebase的取消发布API
            console.log(`取消发布项目: ${key}`);
            let urlAnki = `http://localhost:3010/ankiAnywhereV2.html?wordSet=${key}` ;
            window.open(urlAnki, '_blank');
            //alert(`已取消发布: ${key}`);
            // 刷新当前视图
            //fetchData(currentView);
        }
        
        
        
        
        
        
        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', () => {
            //initEventListeners();
            //fetchData(currentView);
        });
    </script>
    <script>
        document.querySelector('#idWordSetMan').addEventListener('click',(event)=>{
            if(currentView == "WordSetManagement")return ;

            //currentView
            if(currentView!=""){
                let tagCurrentView = document.querySelector(`#${currentView}`) ;
                tagCurrentView.style.display="none" ;
                tagCurrentView.classList.remove("active") ;
                let tagActiveNavItem = document.querySelector(".nav-item.active") ;
                tagActiveNavItem.classList.remove("active");
            }

            document.querySelector("#idWordSetMan").classList.add("active") ;
            currentView = "WordSetManagement" ;
            document.querySelector(`#WordSetManagement`).style.display='block' ;
            fetchWordSetData() ;
        }) ;

        function renderWordSetTbl(data){
            //let tagTblBody = document.querySelector("#dataTableWordSetBody");
            //renderTable(data,tagTblBody,"WordSetManagement") ;

            
            let gridColumns = ["单词集","分类","level","words"] ;
            let gridData=[] ;
            
            let setEntries = Object.entries(data) ;
            for(let i=0;i<setEntries.length;i++){
                let gridRow=[
                    setEntries[i][0],
                    setEntries[i][1].category,
                    setEntries[i][1].level,
                    JSON.stringify(setEntries[i][1].words)
                ] ;
                gridData.push(gridRow) ;
            }

            gGridObj.updateConfig({
                columns: gridColumns,

                pagination: true,
                //pagination: {limit: 10},
                //search: true,
                //sort: true,
                resizable: true,
                fixedHeader: true,
                /*height: '800px',*/
                data: gridData/*,
                style: {
                    td: {
                        border: '1px solid #ccc',
                        'padding-top':'5px',
                        'padding-bottom':'5px',
                        //'text-align': 'right'
                    },
                    table: {
                        'font-size': '18px',
                        'font-family': "Fira Sans Condensed",
                        'font-weight': '400',
                        'font-style': 'normal'
                    }
                }*/
            });

            let tagGrid = document.getElementById("idGridWordSet") ;
            tagGrid.innerHTML = '' ;
            gGridObj.render(tagGrid);  

        }

        function fetchWordSetData() {
            const statusMessage = document.getElementById(`status-message-WordSet`);
            const dataTable = document.getElementById(`idGridWordSet`);
            
            statusMessage.textContent = "正在加载数据..." ;
            statusMessage.classList.remove('error');
            dataTable.style.display = 'none';
            statusMessage.style.display = 'block';
            
            // 根据视图选择不同的数据库路径
            const dbPath = '/thaiWordList';
            const dbRef = database.ref(dbPath);
            
            dbRef.once('value')
                .then((snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        renderWordSetTbl(data);
                        statusMessage.style.display = 'none';
                        dataTable.style.display = 'table';
                        dataTable.closest(".view").classList.add("active");

                    } else {
                        statusMessage.textContent = "没有找到数据";
                        statusMessage.style.display = 'block';
                    }
                })
                .catch((error) => {
                    console.error("获取数据出错:", error);
                    statusMessage.textContent = "获取数据出错: " + error.message;
                    statusMessage.classList.add('error');
                    statusMessage.style.display = 'block';
                });
        }
        
    </script>
    <script>
        document.querySelector('#idAnkiDeckMan').addEventListener('click',(event)=>{
            if(currentView == "AnkiDeckManagement")return ;

            //currentView
            if(currentView!=""){
                let tagCurrentView = document.querySelector(`#${currentView}`) ;
                tagCurrentView.style.display="none" ;
                tagCurrentView.classList.remove("active") ;

                let tagActiveNavItem = document.querySelector(".nav-item.active") ;
                tagActiveNavItem.classList.remove("active");
            }

            document.querySelector(`#idAnkiDeckMan`).classList.add("active") ;
            currentView = "AnkiDeckManagement" ;
            document.querySelector(`#AnkiDeckManagement`).style.display='block' ;

            fetchAnkiDeckData() ;
        }) ;

        function renderAnkiDeckTbl(data){
            let tagTblBody = document.querySelector("#dataTableAnkiDeckBody");
            renderTable(data,tagTblBody,"AnkiDeckManagement") ;
        }

        function fetchAnkiDeckData() {
            const statusMessage = document.getElementById(`status-message-AnkiDeck`);
            const dataTable = document.getElementById(`dataTableAnkiDeck`);
            
            statusMessage.textContent = "正在加载数据..." ;
            statusMessage.classList.remove('error');
            dataTable.style.display = 'none';
            statusMessage.style.display = 'block';
            
            // 根据视图选择不同的数据库路径
            const dbPath = '/thaiAnki/reviewSets';
            const dbRef = database.ref(dbPath);
            
            dbRef.once('value')
                .then((snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        renderAnkiDeckTbl(data);
                        statusMessage.style.display = 'none';
                        dataTable.style.display = 'table';
                        dataTable.closest(".view").classList.add("active");
                    } else {
                        statusMessage.textContent = "没有找到数据";
                        statusMessage.style.display = 'block';
                    }
                })
                .catch((error) => {
                    console.error("获取数据出错:", error);
                    statusMessage.textContent = "获取数据出错: " + error.message;
                    statusMessage.classList.add('error');
                    statusMessage.style.display = 'block';
                });
        }
        
    </script>
    <script>

        //DictManagement
        document.querySelector('#idDictionaryMan').addEventListener('click',(event)=>{
            if(currentView == "DictManagement")return ;

            //currentView
            if(currentView!=""){
                let tagCurrentView = document.querySelector(`#${currentView}`) ;
                tagCurrentView.style.display="none" ;
                tagCurrentView.classList.remove("active") ;
                let tagActiveNavItem = document.querySelector(".nav-item.active") ;
                tagActiveNavItem.classList.remove("active");
            }

            document.querySelector(`#idDictionaryMan`).classList.add("active") ;
            currentView = "DictManagement" ;
            document.querySelector(`#DictManagement`).style.display='block' ;

            fetchDictionaryData() ;
        }) ;

        function renderDictionaryGrid(data){
            let rowKeys = Object.keys(data) ;
            console.log(rowKeys) ;
            let columnKeys = Object.keys(data[rowKeys[0]]) ;
            console.log(columnKeys) ;

            //(12) ['antonyms', 'common_phrases', 'conjugations', 'definitions', 'grammar_notes', 'level', 'pos', 'synonyms', 'tags', 'thai', 'topic', 'word_id']
            //let gridColumns=columnKeys;//[] ;
            let gridColumns = ["thai","definitions","pos","synonyms","antonyms"] ;
            let gridData=[] ;
            
            let dictEntries = Object.entries(data) ;
            for(let i=0;i<dictEntries.length;i++){
                //console.log(dictEntries[i][1]) ;
                let gridRow=[
                    dictEntries[i][0],
                    JSON.stringify(dictEntries[i][1].definitions[0].en),
                    dictEntries[i][1].pos,
                    JSON.stringify(dictEntries[i][1].synonyms),
                    JSON.stringify(dictEntries[i][1].antonyms)
                ] ;

                gridData.push(gridRow) ;
            }
            

            gGridObj.updateConfig({
                columns: gridColumns,

                pagination: true,
                //pagination: {limit: 10},
                //search: true,
                //sort: true,
                resizable: true,
                fixedHeader: true,
                /*height: '800px',*/
                data: gridData/*,
                style: {
                    td: {
                        border: '1px solid #ccc',
                        'padding-top':'5px',
                        'padding-bottom':'5px',
                        //'text-align': 'right'
                    },
                    table: {
                        'font-size': '18px',
                        'font-family': "Fira Sans Condensed",
                        'font-weight': '400',
                        'font-style': 'normal'
                    }
                }*/
            });

            let tagGrid = document.getElementById("dataGridDictionary") ;
            tagGrid.innerHTML = '' ;
            gGridObj.render(tagGrid);   


        }

        function fetchDictionaryData() {
            const statusMessage = document.getElementById(`status-message-Dictionary`);
            const dataTable = document.getElementById(`dataGridDictionary`);
            
            statusMessage.textContent = "正在加载数据..." ;
            statusMessage.classList.remove('error');
            dataTable.style.display = 'none';
            statusMessage.style.display = 'block';
            
            //https://outpost-dictionary-116208.asia-southeast1.firebasedatabase.app/thaiDictionary
            // 根据视图选择不同的数据库路径
            const dbPath = '/thaiDictionary';
            const dbRef = database.ref(dbPath);
            
            dbRef.once('value')
                .then((snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        renderDictionaryGrid(data);
                        statusMessage.style.display = 'none';
                        dataTable.style.display = 'block';
                        dataTable.closest(".view").classList.add("active");
                    } else {
                        statusMessage.textContent = "没有找到数据";
                        statusMessage.style.display = 'block';
                    }
                })
                .catch((error) => {
                    console.error("获取数据出错:", error);
                    statusMessage.textContent = "获取数据出错: " + error.message;
                    statusMessage.classList.add('error');
                    statusMessage.style.display = 'block';
                });
        }
    </script>
</body>
</html>
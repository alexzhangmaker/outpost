<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>即时搜索演示</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            width: 100%;
            max-width: 800px;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            padding: 30px;
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1rem;
        }
        
        .search-container {
            position: relative;
            margin-bottom: 30px;
        }
        
        .search-box {
            width: 100%;
            padding: 18px 50px 18px 20px;
            font-size: 18px;
            border: 2px solid #e0e0e0;
            border-radius: 50px;
            outline: none;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .search-box:focus {
            border-color: #6a11cb;
            box-shadow: 0 5px 15px rgba(106, 17, 203, 0.2);
        }
        
        .search-icon {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
            font-size: 22px;
        }
        
        .clear-btn {
            position: absolute;
            right: 55px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #999;
            font-size: 20px;
            cursor: pointer;
            display: none;
        }
        
        .clear-btn:hover {
            color: #6a11cb;
        }
        
        .results-count {
            margin-bottom: 15px;
            color: #666;
            font-size: 16px;
        }
        
        .results-container {
            max-height: 400px;
            overflow-y: auto;
            border-radius: 10px;
            background-color: #f9f9f9;
            padding: 10px;
        }
        
        .result-item {
            padding: 15px;
            margin-bottom: 10px;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease;
            cursor: pointer;
            border-left: 4px solid transparent;
        }
        
        .result-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-left-color: #6a11cb;
        }
        
        .result-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .no-results {
            text-align: center;
            padding: 30px;
            color: #999;
            font-style: italic;
        }
        
        .highlight {
            background-color: #fff9c4;
            padding: 2px 4px;
            border-radius: 4px;
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .search-box {
                padding: 15px 45px 15px 15px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>即时搜索演示</h1>
        <p class="subtitle">输入关键词，实时查看搜索结果</p>
        
        <div class="search-container">
            <input type="text" class="search-box" id="searchInput" placeholder="输入标题关键词进行搜索...">
            <button class="clear-btn" id="clearBtn">×</button>
            <div class="search-icon">🔍</div>
        </div>
        
        <div class="results-count" id="resultsCount">找到 10 个结果</div>
        
        <div class="results-container" id="resultsContainer">
            <!-- 搜索结果将在这里显示 -->
        </div>
    </div>
    <script src="./jsResource/localforage.min.js"></script>

    <script>
        // 示例数据 - 包含title字段的对象数组


        // 获取DOM元素
        const searchInput = document.getElementById('searchInput');
        const clearBtn = document.getElementById('clearBtn');
        const resultsContainer = document.getElementById('resultsContainer');
        const resultsCount = document.getElementById('resultsCount');

        // 初始显示所有数据
        //displayResults(data);

        
        // 监听输入事件
        searchInput.addEventListener('input', function() {
            const searchTerm = this.value.trim().toLowerCase();

            // 显示或隐藏清除按钮
            clearBtn.style.display = searchTerm ? 'block' : 'none';
            
            let filteredData = filterDiction(searchTerm) ;
            
            //const filteredData = filterChildrenByString(jsonDictCache,searchTerm) ;
            console.log(filteredData) ;
            // 显示结果
            displayResults(filteredData, searchTerm);
        });

        // 清除搜索内容
        clearBtn.addEventListener('click', function() {
            searchInput.value = '';
            searchInput.focus();
            clearBtn.style.display = 'none';
            displayResults(data);
        });

        // 显示结果的函数
        function displayResults(results, searchTerm = '') {
            // 更新结果计数
            resultsCount.textContent = `找到 ${results.length} 个结果`;
            
            // 清空结果容器
            resultsContainer.innerHTML = '';
            
            if (results.length === 0) {
                resultsContainer.innerHTML = '<div class="no-results">没有找到匹配的结果</div>';
                return;
            }
            
            // 创建并添加结果项
            results.forEach(jsonWord => {
                const resultItem = document.createElement('div');
                resultItem.className = 'result-item';
                
                // 高亮匹配的文本
                let title = jsonWord.word;
                if (searchTerm) {
                    const regex = new RegExp(`(${searchTerm})`, 'gi');
                    title = title.replace(regex, '<span class="highlight">$1</span>');
                }
                
                resultItem.innerHTML = `
                    <div class="result-title">${title}</div>
                    <div class="result-id">ID: ${jsonWord.dictEntry.word_id}</div>
                `;
                
                resultsContainer.appendChild(resultItem);
            });
        }
    </script>
    <script>
        
        let jsonDictCache = {} ;
        let dictEntries=[] ;

        function filterDiction(searchTerm){
            const filteredData = dictEntries.filter(dictEntry => 
                dictEntry.word.toLowerCase().includes(searchTerm)
            );
            return filteredData ;
        }

        async function prepareLocalDiction(){
            const gDictCacheKey = "outpostDictCache" ;
            const gDictLocalKey ="outpostDictLocal" ;

            dictEntries = await localforage.getItem(gDictLocalKey);
            if(dictEntries==null){
                jsonDictCache = await localforage.getItem(gDictCacheKey);
                console.log(jsonDictCache);
                let keys = Object.keys(jsonDictCache) ;
                console.log('length of keys:'+keys.length) ;
                console.log(jsonDictCache[keys[keys.length-2]])
                keys.forEach(key=>{
                    //if(key==null || key ==undefined)continue ;

                    let jsonEntry = {
                        word:key,
                        dictEntry:jsonDictCache[key]
                    } ;
                    dictEntries.push(jsonEntry) ;
                    //console.log(jsonEntry) ;
                }) ;
                console.log(dictEntries) ;
                await localforage.setItem(gDictLocalKey,dictEntries);
            }
        }


        function sortThaiWordsByConsonant(words) {
    // 泰语辅音字母传统顺序
    const THAI_CONSONANTS = [
        'ก', 'ข', 'ฃ', 'ค', 'ฅ', 'ฆ', 'ง', 
        'จ', 'ฉ', 'ช', 'ซ', 'ฌ', 'ญ', 
        'ฎ', 'ฏ', 'ฐ', 'ฑ', 'ฒ', 'ณ', 
        'ด', 'ต', 'ถ', 'ท', 'ธ', 'น', 
        'บ', 'ป', 'ผ', 'ฝ', 'พ', 'ฟ', 'ภ', 'ม', 
        'ย', 'ร', 'ล', 'ว', 
        'ศ', 'ษ', 'ส', 'ห', 'ฬ', 'อ', 'ฮ'
    ];

    // 泰语前置元音和特殊字符（不是首辅音）
    const THAI_PREFIX_VOWELS = ['เ', 'แ', 'โ', 'ใ', 'ไ'];
    const THAI_TONE_MARKS = ['่', '้', '๊', '๋'];
    const THAI_ABOVE_VOWELS = ['ิ', 'ี', 'ึ', 'ื', 'ุ', 'ู', 'ั'];
    const THAI_BELOW_VOWELS = ['็', '์', 'ฺ'];
    const THAI_OTHER_SYMBOLS = ['ํ', 'ๅ', 'ฯ'];

    // 元音类型优先级
    const VOWEL_ORDER = {
        'implicit': 0,      // 无显式元音
        'sara_a': 1,        // -ะ, -ั 类短元音
        'sara_aa': 2,       // -า 类长元音
        'sara_am': 3,       // ำ
        'sara_i': 4,        // -ิ, -ี
        'sara_ue': 5,       // -ึ, -ื
        'sara_u': 6,        // -ุ, -ู
        'sara_e': 7,        // เ-
        'sara_ae': 8,       // แ-
        'sara_o': 9,        // โ-
        'sara_ai': 10,      // ใ-, ไ-
        'sara_ao': 11,      // เ-า
        'other': 12         // 其他复合元音
    };

    // 声调优先级
    const TONE_ORDER = {
        'none': 0,      // 无声调
        'mai_ek': 1,    // -่
        'mai_tho': 2,   // -้
        'mai_tri': 3,   // -๊
        'mai_chattawa': 4 // -๋
    };

    // 尾辅音优先级
    const FINAL_CONSONANT_ORDER = {
        'none': 0,  // 无尾辅音
        'ง': 1, 'ญ': 2, 'ณ': 3, 'น': 4, 'ม': 5,
        'ย': 6, 'ร': 7, 'ล': 8, 'ว': 9,
        'ก': 10, 'ข': 11, 'ค': 12, 'ฆ': 13,
        'จ': 14, 'ฉ': 15, 'ช': 16, 'ซ': 17, 'ฌ': 18, 'ฎ': 19,
        'ฏ': 20, 'ฐ': 21, 'ฑ': 22, 'ฒ': 23, 'ด': 24,
        'ต': 25, 'ถ': 26, 'ท': 27, 'ธ': 28, 'บ': 29,
        'ป': 30, 'ผ': 31, 'ฝ': 32, 'พ': 33, 'ฟ': 34, 'ภ': 35
    };

    // 提取单词的真正首辅音（跳过前置元音和声调符号）
    function getInitialConsonant(word) {
        // 移除可能的引号
        const cleanWord = word.replace(/'/g, '');
        if (!cleanWord) return null;
        
        let index = 0;
        // 跳过前置元音、声调符号和其他非辅音字符
        while (index < cleanWord.length) {
            const char = cleanWord.charAt(index);
            
            // 如果是辅音字母，返回它
            if (THAI_CONSONANTS.includes(char)) {
                return char;
            }
            
            // 如果是前置元音、声调符号、上下元音或其他符号，继续检查下一个字符
            if (THAI_PREFIX_VOWELS.includes(char) || 
                THAI_TONE_MARKS.includes(char) ||
                THAI_ABOVE_VOWELS.includes(char) ||
                THAI_BELOW_VOWELS.includes(char) ||
                THAI_OTHER_SYMBOLS.includes(char)) {
                index++;
                continue;
            }
            
            // 其他字符（数字、英文、标点、中文等）
            return null;
        }
        
        return null;
    }

    // 分析单词结构用于排序
    function analyzeWord(word) {
        const cleanWord = word.replace(/'/g, '');
        const initialConsonant = getInitialConsonant(cleanWord);
        
        if (!initialConsonant) {
            return {
                initialConsonant: null,
                vowelType: 'other',
                tone: 'none',
                finalConsonant: 'none',
                originalWord: word
            };
        }

        // 检测声调
        let tone = 'none';
        for (let i = 0; i < cleanWord.length; i++) {
            const char = cleanWord.charAt(i);
            if (THAI_TONE_MARKS.includes(char)) {
                if (char === '่') tone = 'mai_ek';
                else if (char === '้') tone = 'mai_tho';
                else if (char === '๊') tone = 'mai_tri';
                else if (char === '๋') tone = 'mai_chattawa';
                break;
            }
        }

        // 检测元音类型
        let vowelType = 'implicit';
        
        // 检查复合元音和前置元音
        if (cleanWord.includes('เ') && cleanWord.includes('า')) {
            vowelType = 'sara_ao';
        } else if (cleanWord.includes('ใ') || cleanWord.includes('ไ')) {
            vowelType = 'sara_ai';
        } else if (cleanWord.includes('แ')) {
            vowelType = 'sara_ae';
        } else if (cleanWord.includes('โ')) {
            vowelType = 'sara_o';
        } else if (cleanWord.includes('เ')) {
            vowelType = 'sara_e';
        }
        // 检查基本元音
        else if (cleanWord.includes('ำ')) {
            vowelType = 'sara_am';
        } else if (cleanWord.includes('า')) {
            vowelType = 'sara_aa';
        } else if (cleanWord.includes('ะ') || cleanWord.includes('ั')) {
            vowelType = 'sara_a';
        } else if (cleanWord.includes('ิ') || cleanWord.includes('ี')) {
            vowelType = 'sara_i';
        } else if (cleanWord.includes('ึ') || cleanWord.includes('ื')) {
            vowelType = 'sara_ue';
        } else if (cleanWord.includes('ุ') || cleanWord.includes('ู')) {
            vowelType = 'sara_u';
        }

        // 检测尾辅音
        let finalConsonant = 'none';
        // 从后往前找第一个辅音字母
        for (let i = cleanWord.length - 1; i >= 0; i--) {
            const char = cleanWord.charAt(i);
            if (THAI_CONSONANTS.includes(char)) {
                // 检查这个辅音是否可能是首辅音（在单词开头位置）
                let isPotentialInitial = false;
                for (let j = 0; j <= i; j++) {
                    if (cleanWord.charAt(j) === char && 
                        !THAI_PREFIX_VOWELS.includes(cleanWord.charAt(j)) &&
                        !THAI_TONE_MARKS.includes(cleanWord.charAt(j)) &&
                        !THAI_ABOVE_VOWELS.includes(cleanWord.charAt(j)) &&
                        !THAI_BELOW_VOWELS.includes(cleanWord.charAt(j))) {
                        isPotentialInitial = true;
                        break;
                    }
                }
                
                // 如果这个辅音不是首辅音，那么它就是尾辅音
                if (char !== initialConsonant || !isPotentialInitial) {
                    finalConsonant = char;
                    break;
                }
            }
        }

        return {
            initialConsonant,
            vowelType,
            tone,
            finalConsonant,
            originalWord: word
        };
    }

    // 按泰语字典规则排序
    function compareThaiWords(a, b) {
        const analysisA = analyzeWord(a.word);
        const analysisB = analyzeWord(b.word);

        // 如果有一个单词无法识别辅音，放到最后
        if (!analysisA.initialConsonant && !analysisB.initialConsonant) {
            return a.word.localeCompare(b.word, 'th');
        }
        if (!analysisA.initialConsonant) return 1;
        if (!analysisB.initialConsonant) return -1;

        // 1. 按辅音字母顺序
        const consonantOrderA = THAI_CONSONANTS.indexOf(analysisA.initialConsonant);
        const consonantOrderB = THAI_CONSONANTS.indexOf(analysisB.initialConsonant);
        
        if (consonantOrderA !== consonantOrderB) {
            return consonantOrderA - consonantOrderB;
        }

        // 2. 按元音类型
        const vowelOrderA = VOWEL_ORDER[analysisA.vowelType] || VOWEL_ORDER.other;
        const vowelOrderB = VOWEL_ORDER[analysisB.vowelType] || VOWEL_ORDER.other;
        
        if (vowelOrderA !== vowelOrderB) {
            return vowelOrderA - vowelOrderB;
        }

        // 3. 按声调
        const toneOrderA = TONE_ORDER[analysisA.tone];
        const toneOrderB = TONE_ORDER[analysisB.tone];
        
        if (toneOrderA !== toneOrderB) {
            return toneOrderA - toneOrderB;
        }

        // 4. 按尾辅音
        const finalOrderA = FINAL_CONSONANT_ORDER[analysisA.finalConsonant] || FINAL_CONSONANT_ORDER.none;
        const finalOrderB = FINAL_CONSONANT_ORDER[analysisB.finalConsonant] || FINAL_CONSONANT_ORDER.none;
        
        if (finalOrderA !== finalOrderB) {
            return finalOrderA - finalOrderB;
        }

        // 5. 最后按字符串原始顺序
        return a.word.localeCompare(b.word, 'th');
    }

    // 主处理逻辑
    const sortedWords = [...words].sort(compareThaiWords);
    
    // 按辅音字母分组
    const groupedResult = {};
    
    sortedWords.forEach(item => {
        const consonant = getInitialConsonant(item.word);
        const groupKey = consonant || 'other';
        
        if (!groupedResult[groupKey]) {
            groupedResult[groupKey] = [];
        }
        
        groupedResult[groupKey].push(item);
    });

    // 按辅音字母顺序对分组进行排序
    const sortedGroupedResult = {};
    THAI_CONSONANTS.forEach(consonant => {
        if (groupedResult[consonant]) {
            sortedGroupedResult[consonant] = groupedResult[consonant];
        }
    });
    
    // 添加other分组（如果有）
    if (groupedResult['other'] && groupedResult['other'].length > 0) {
        sortedGroupedResult['other'] = groupedResult['other'];
    }

    return sortedGroupedResult;
}

// 测试函数
function testThaiSorting() {
    const testWords = [
        { "word": "เก็บ", "dictEntry": {} },
        { "word": "เกรงใจ", "dictEntry": {} },
        { "word": "เกษตรกร", "dictEntry": {} },
        { "word": "ใกล้", "dictEntry": {} },
        { "word": "เขา", "dictEntry": {} },
        { "word": "เข้าใจ", "dictEntry": {} },
        { "word": "เคย", "dictEntry": {} },
        { "word": "เครื่องดื่ม", "dictEntry": {} },
        { "word": "เจ็ด", "dictEntry": {} },
        { "word": "เจ็บ", "dictEntry": {} },
        { "word": "เด็กๆ", "dictEntry": {} },
        { "word": "เดิน", "dictEntry": {} },
        { "word": "เท่าไหร่", "dictEntry": {} },
        { "word": "เป็น", "dictEntry": {} },
        { "word": "เปลี่ยน", "dictEntry": {} },
        { "word": "ไม่", "dictEntry": {} },
        { "word": "เมือง", "dictEntry": {} },
        { "word": "不贵", "dictEntry": {} }, // 中文，应该归为other
        { "word": "ฯลฯ", "dictEntry": {} }  // 省略符号，应该归为other
    ];

    const result = sortThaiWordsByConsonant(testWords);
    console.log('分组结果:');
    Object.keys(result).forEach(consonant => {
        console.log(`辅音 ${consonant}:`, result[consonant].map(item => item.word));
    });
    
    return result;
}

// 执行测试
testThaiSorting();

        document.addEventListener('DOMContentLoaded', async (event)=>{

            await prepareLocalDiction() ;
            const result = sortThaiWordsByConsonant(dictEntries);
            console.log(result);
            let keys = Object.keys(result) ;
            console.log(keys) ;
            console.log(result['other']);
            let others = [] ;
            let entryOthers = result['other'];
            entryOthers.forEach(entry=>{
                others.push(entry.word) ;
            }) ;
            console.log(others) ;
        }) ;

    </script>
</body>
</html>
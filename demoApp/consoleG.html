<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase æ•°æ®ç®¡ç†æ§åˆ¶å°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://cdn.jsdelivr.net/npm/gridjs/dist/theme/mermaid.min.css" rel="stylesheet" />
    <style>
        body {
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
        }
        #sidebar {
            min-width: 280px;
            max-width: 280px;
            background: #f8f9fa;
            transition: all 0.3s;
        }
        #content {
            width: 100%;
            padding: 20px;
        }
    </style>
</head>
<body>

<nav id="sidebar" class="p-3">
    <h4><i class="bi bi-fire"></i> Firebase æ§åˆ¶å°</h4>
    <hr>
    <ul class="nav nav-pills flex-column mb-auto">
        <li class="nav-item">
            <a href="#" class="nav-link active" aria-current="page">
                <i class="bi bi-house-door-fill me-2"></i>ä¸»é¡µ
            </a>
        </li>
        <li>
            <a href="#" class="nav-link link-dark">
                <i class="bi bi-gear-fill me-2"></i>è®¾ç½®
            </a>
        </li>
    </ul>
    <hr>

    <div class="accordion" id="nav-accordion">
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingOne">
                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                    <i class="bi bi-journals me-2"></i> å†…å®¹ç®¡ç†
                </button>
            </h2>
            <div id="collapseOne" class="accordion-collapse collapse show" aria-labelledby="headingOne" data-bs-parent="#nav-accordion">
                <div class="accordion-body p-0">
                    <div class="list-group list-group-flush">
                        <a href="#" class="list-group-item list-group-item-action" data-path="thaiWordList" data-name="å•è¯é›†ç®¡ç†">å•è¯é›†ç®¡ç†</a>
                        <a href="#" class="list-group-item list-group-item-action" data-path="flashcard-boxes" data-name="å¤ä¹ å¡ç‰‡ç›’ç®¡ç†">å¤ä¹ å¡ç‰‡ç›’ç®¡ç†</a>
                        <a href="#" class="list-group-item list-group-item-action" data-path="dictionaries" data-name="å­—å…¸ç®¡ç†">å­—å…¸ç®¡ç†</a>
                    </div>
                </div>
            </div>
        </div>
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingTwo">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
                    <i class="bi bi-clipboard-data me-2"></i> åº”ç”¨æ•°æ®
                </button>
            </h2>
            <div id="collapseTwo" class="accordion-collapse collapse" aria-labelledby="headingTwo" data-bs-parent="#nav-accordion">
                 <div class="accordion-body p-0">
                    <div class="list-group list-group-flush">
                        <a href="#" class="list-group-item list-group-item-action" data-path="tests" data-name="æµ‹è¯•ç®¡ç†">æµ‹è¯•ç®¡ç†</a>
                        <a href="#" class="list-group-item list-group-item-action" data-path="reading-materials" data-name="é˜…è¯»ç®¡ç†">é˜…è¯»ç®¡ç†</a>
                        <a href="#" class="list-group-item list-group-item-action" data-path="tasks" data-name="ä»»åŠ¡æ•°æ®ç®¡ç†">ä»»åŠ¡æ•°æ®ç®¡ç†</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</nav>

<main id="content">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 id="content-title">æ¬¢è¿</h2>
        <button id="add-new-btn" class="btn btn-primary" style="display: none;">
            <i class="bi bi-plus-circle-fill me-1"></i> æ–°å¢
        </button>
    </div>
    <div id="grid-wrapper">
        <p>è¯·ä»å·¦ä¾§å¯¼èˆªæ é€‰æ‹©ä¸€ä¸ªæ•°æ®é›†åˆè¿›è¡Œç®¡ç†ã€‚</p>
    </div>
</main>

<div class="modal fade" id="dataModal" tabindex="-1" aria-labelledby="dataModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="dataModalLabel">æ•°æ®æ“ä½œ</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="dataForm">
            </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
        <button type="submit" form="dataForm" class="btn btn-primary">ä¿å­˜</button>
      </div>
    </div>
  </div>
</div>


<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gridjs/dist/gridjs.umd.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
    // --- 1. Firebase åˆå§‹åŒ– ---
    // è­¦å‘Šï¼šè¯·å°†æ­¤å¤„æ›¿æ¢ä¸ºæ‚¨è‡ªå·±çš„Firebaseé¡¹ç›®é…ç½®ï¼
    const firebaseConfig = {
            apiKey: "AIzaSyA6MZ_p5lVuy8TMAqiuV6IRx9fggV44lQs",
            authDomain: "outpost-8d74e.firebaseapp.com",
            databaseURL: "https://outpost-dictionary-116208.asia-southeast1.firebasedatabase.app/",
            projectId: "outpost-8d74e",
            storageBucket: "outpost-8d74e.firebasestorage.app",
            messagingSenderId: "724993324937",
            appId: "1:724993324937:web:ce6c7e6b06489331c79358",
            measurementId: "G-QPHWRTH6BH"
        };

    // åˆå§‹åŒ– Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // --- 2. å…¨å±€å˜é‡å’ŒDOMå…ƒç´  ---
    let currentGrid = null;
    let currentPath = '';
    let currentEditId = null;
    let columnDefs = []; // ç”¨äºå­˜å‚¨å½“å‰è¡¨æ ¼çš„åˆ—å®šä¹‰
    
    const gridWrapper = document.getElementById('grid-wrapper');
    const contentTitle = document.getElementById('content-title');
    const addNewBtn = document.getElementById('add-new-btn');
    const dataModalEl = document.getElementById('dataModal');
    const dataModal = new bootstrap.Modal(dataModalEl);
    const dataForm = document.getElementById('dataForm');
    const dataModalLabel = document.getElementById('dataModalLabel');

    // --- 3. å¯¼èˆªé€»è¾‘ ---
    const navLinks = document.querySelectorAll('.list-group-item-action');
    navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            
            // æ›´æ–°æ´»åŠ¨é“¾æ¥æ ·å¼
            navLinks.forEach(l => l.classList.remove('active'));
            link.classList.add('active');
            
            currentPath = e.target.dataset.path;
            const name = e.target.dataset.name;
            contentTitle.textContent = name;
            addNewBtn.style.display = 'block';
            loadGridData(currentPath);
        });
    });

    // --- 4. Grid.js æ•°æ®åŠ è½½ä¸æ¸²æŸ“ ---
    async function loadGridData(path) {
        gridWrapper.innerHTML = 'æ­£åœ¨åŠ è½½æ•°æ®...';
        
        const dataRef = database.ref(path);
        try {
            const snapshot = await dataRef.once('value');
            const data = snapshot.val();

            if (currentGrid) {
                currentGrid.destroy();
            }
            
            if (!data) {
                gridWrapper.innerHTML = '<div class="alert alert-warning">æ­¤è·¯å¾„ä¸‹æ²¡æœ‰æ•°æ®ã€‚</div>';
                columnDefs = []; // æ¸…ç©ºåˆ—å®šä¹‰
                return;
            }

            // å°†Firebaseå¯¹è±¡è½¬æ¢ä¸ºGrid.jsæ‰€éœ€çš„æ•°ç»„æ ¼å¼
            const transformedData = Object.keys(data).map(key => {
                return {
                    id: key,
                    ...data[key]
                };
            });
            
            // åŠ¨æ€ç”Ÿæˆåˆ—å®šä¹‰ (åªåœ¨ç¬¬ä¸€æ¬¡åŠ è½½æˆ–æ•°æ®ç»“æ„å˜åŒ–æ—¶)
            if (transformedData.length > 0) {
                 const firstItemKeys = Object.keys(transformedData[0]);
                 columnDefs = firstItemKeys.map(key => ({ id: key, name: key.charAt(0).toUpperCase() + key.slice(1) }));
            }
            
            // æ·»åŠ æ“ä½œåˆ—
            const displayColumns = [...columnDefs, {
                name: 'æ“ä½œ',
                formatter: (cell, row) => {
                    const id = row.cells[0].data; // å‡è®¾ç¬¬ä¸€åˆ—æ€»æ˜¯ID
                    return gridjs.h('div', { className: 'btn-group' }, [
                        gridjs.h('button', {
                            className: 'btn btn-sm btn-outline-primary btn-edit',
                            onClick: () => handleEdit(id)
                        }, gridjs.h('i', { className: 'bi bi-pencil-fill' })),
                        gridjs.h('button', {
                            className: 'btn btn-sm btn-outline-danger btn-delete',
                            onClick: () => handleDelete(id)
                        }, gridjs.h('i', { className: 'bi bi-trash-fill' }))
                    ]);
                }
            }];

            currentGrid = new gridjs.Grid({
                columns: displayColumns,
                data: transformedData,
                search: true,
                sort: true,
                pagination: {
                    enabled: true,
                    limit: 10
                },
                language: {
                    'search': {
                        'placeholder': 'ğŸ” æœç´¢...'
                    },
                    'pagination': {
                        'previous': 'ä¸Šä¸€é¡µ',
                        'next': 'ä¸‹ä¸€é¡µ',
                        'showing': 'æ˜¾ç¤º',
                        'results': () => 'æ¡è®°å½•',
                        'to': 'åˆ°',
                        'of': 'å…±'
                    }
                }
            }).render(gridWrapper);

        } catch (error) {
            console.error("ä»Firebaseè¯»å–æ•°æ®å¤±è´¥:", error);
            gridWrapper.innerHTML = `<div class="alert alert-danger">æ•°æ®åŠ è½½å¤±è´¥: ${error.message}</div>`;
        }
    }

    // --- 5. CRUD æ“ä½œå¤„ç† ---

    // å¤„ç†åˆ é™¤
    function handleDelete(id) {
        if (confirm(`ç¡®å®šè¦åˆ é™¤ ID ä¸º ${id} çš„è®°å½•å—ï¼Ÿ`)) {
            database.ref(`${currentPath}/${id}`).remove()
                .then(() => {
                    console.log("åˆ é™¤æˆåŠŸ!");
                    loadGridData(currentPath); // é‡æ–°åŠ è½½æ•°æ®
                })
                .catch(error => {
                    console.error("åˆ é™¤å¤±è´¥:", error);
                    alert(`åˆ é™¤å¤±è´¥: ${error.message}`);
                });
        }
    }

    // å¤„ç†ç¼–è¾‘ï¼ˆæ‰“å¼€æ¨¡æ€æ¡†ï¼‰
    async function handleEdit(id) {
        currentEditId = id;
        try {
            const snapshot = await database.ref(`${currentPath}/${id}`).once('value');
            const data = snapshot.val();
            openModal('edit', data);
        } catch (error) {
            console.error("è·å–å¾…ç¼–è¾‘æ•°æ®å¤±è´¥:", error);
            alert("åŠ è½½æ•°æ®å¤±è´¥ï¼Œæ— æ³•ç¼–è¾‘ã€‚");
        }
    }

    // å¤„ç†æ–°å¢ï¼ˆæ‰“å¼€æ¨¡æ€æ¡†ï¼‰
    addNewBtn.addEventListener('click', () => {
        currentEditId = null;
        openModal('add');
    });

    // æ‰“å¼€æ¨¡æ€æ¡†å¹¶åŠ¨æ€ç”Ÿæˆè¡¨å•
    function openModal(mode, data = {}) {
        dataModalLabel.textContent = mode === 'edit' ? `ä¿®æ”¹è®°å½• (ID: ${currentEditId})` : 'æ–°å¢è®°å½•';
        dataForm.innerHTML = ''; // æ¸…ç©ºæ—§è¡¨å•

        // ä½¿ç”¨ columnDefs ç”Ÿæˆè¡¨å•å­—æ®µï¼ˆä¸åŒ…æ‹¬IDå’Œæ“ä½œåˆ—ï¼‰
        const fields = columnDefs.filter(c => c.id !== 'id');
        
        fields.forEach(col => {
            const fieldName = col.id;
            const value = data[fieldName] || '';
            
            const formGroup = document.createElement('div');
            formGroup.className = 'mb-3';

            const label = document.createElement('label');
            label.htmlFor = `field-${fieldName}`;
            label.className = 'form-label';
            label.textContent = col.name;

            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'form-control';
            input.id = `field-${fieldName}`;
            input.name = fieldName;
            input.value = value;
            
            formGroup.appendChild(label);
            formGroup.appendChild(input);
            dataForm.appendChild(formGroup);
        });

        dataModal.show();
    }

    // å¤„ç†è¡¨å•æäº¤ï¼ˆæ–°å¢æˆ–æ›´æ–°ï¼‰
    dataForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(dataForm);
        const newData = {};
        for (let [key, value] of formData.entries()) {
            newData[key] = value;
        }

        let dbOperation;
        if (currentEditId) {
            // æ›´æ–°æ¨¡å¼
            dbOperation = database.ref(`${currentPath}/${currentEditId}`).update(newData);
        } else {
            // æ–°å¢æ¨¡å¼
            dbOperation = database.ref(currentPath).push(newData);
        }

        dbOperation
            .then(() => {
                console.log("æ•°æ®ä¿å­˜æˆåŠŸ!");
                dataModal.hide();
                loadGridData(currentPath);
            })
            .catch(error => {
                console.error("æ•°æ®ä¿å­˜å¤±è´¥:", error);
                alert(`ä¿å­˜å¤±è´¥: ${error.message}`);
            });
    });
    
    // æ¸…ç†æ¨¡æ€æ¡†çŠ¶æ€
    dataModalEl.addEventListener('hidden.bs.modal', function () {
        currentEditId = null;
        dataForm.reset();
    });
});
</script>

</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>泰语声调教学系统 - Tone Pronunciation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Sarabun:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800&display=swap"
        rel="stylesheet">
    <!-- LocalForage for Caching -->
    <script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>
    <style>
        /* 泰语字体设置 */
        .thai-text {
            font-family: 'Sarabun', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans Thai", sans-serif;
        }

        /* IPA 音标字体设置与回退机制 */
        .ipa-text {
            font-family: 'Charis SIL', 'Gentium Plus', 'Lucida Sans Unicode', 'Arial Unicode MS', 'DejaVu Sans', sans-serif;
            font-variant-numeric: tabular-nums;
        }

        /* 渐变与磨砂玻璃效果 */
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            cursor: pointer;
        }

        .glass-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        .glass-card:active {
            transform: translateY(0);
        }

        .tone-mid {
            border-top: 4px solid #94a3b8;
        }

        /* Gray */
        .tone-low {
            border-top: 4px solid #10b981;
        }

        /* Green */
        .tone-falling {
            border-top: 4px solid #f59e0b;
        }

        /* Orange */
        .tone-high {
            border-top: 4px solid #ef4444;
        }

        /* Red */
        .tone-rising {
            border-top: 4px solid #6366f1;
        }

        /* Indigo */

        .playing-state {
            animation: pulse-border 1.5s infinite;
        }

        @keyframes pulse-border {
            0% {
                box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4);
            }

            70% {
                box-shadow: 0 0 0 10px rgba(99, 102, 241, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(99, 102, 241, 0);
            }
        }
    </style>
</head>

<body class="bg-gray-50 min-h-screen py-8 px-4">
    <div class="max-w-6xl mx-auto">
        <header class="mb-12 text-center relative">
            <h1 id="app-title" class="text-4xl font-extrabold text-gray-900 mb-2">泰语五声调练习</h1>
            <p id="app-subtitle" class="text-gray-600 mb-4">点击卡片播放发音 • 自动缓存音频</p>
            <div class="flex flex-col items-center gap-2">
                <button onclick="clearAudioCache()"
                    class="text-xs text-gray-400 hover:text-red-500 transition-colors border border-gray-200 px-2 py-1 rounded">
                    清除本地缓存
                </button>
                <button onclick="toggleModal(true)"
                    class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-all text-sm font-bold shadow-sm">
                    添加练习组 (JSON)
                </button>
            </div>
            <div class="mt-6 flex justify-center gap-4">
                <button id="nav-tones" onclick="switchModule('/thaiIPA')"
                    class="px-4 py-2 rounded-full text-sm font-medium transition-all bg-indigo-100 text-indigo-700 border-2 border-indigo-200">
                    五声调对比
                </button>
                <button id="nav-consonants" onclick="switchModule('/thaiConsonantContrast')"
                    class="px-4 py-2 rounded-full text-sm font-medium transition-all bg-white text-gray-500 border-2 border-transparent hover:bg-gray-100">
                    辅音对比
                </button>
                <button id="nav-vowels" onclick="switchModule('/thaiVowelContrast')"
                    class="px-4 py-2 rounded-full text-sm font-medium transition-all bg-white text-gray-500 border-2 border-transparent hover:bg-gray-100">
                    元音对比
                </button>
            </div>
            <div id="vowel-focus-container" class="mt-4 hidden animate-in fade-in slide-in-from-top-4 duration-500">
                <div class="inline-block bg-indigo-50 border border-indigo-100 rounded-full px-4 py-1.5 shadow-sm">
                    <span class="text-xs font-bold text-indigo-400 uppercase tracking-widest mr-2">重点元音:</span>
                    <span id="vowel-focus-text" class="ipa-text text-sm font-bold text-indigo-600"></span>
                </div>
            </div>
            <div id="cache-status" class="text-[10px] text-gray-400 mt-1 h-4"></div>
        </header>

        <div id="tone-container" class="space-y-12">
            <!-- Loading state -->
            <div class="flex justify-center items-center h-64">
                <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-500"></div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getDatabase, ref as dbRef, onValue, get, update } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA6MZ_p5lVuy8TMAqiuV6IRx9fggV44lQs",
            authDomain: "outpost-8d74e.firebaseapp.com",
            databaseURL: "https://outpost-dictionary-116208.asia-southeast1.firebasedatabase.app/",
            projectId: "outpost-8d74e",
            storageBucket: "outpost-8d74e.firebasestorage.app",
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Initialize LocalForage
        const audioCache = localforage.createInstance({
            name: "thai_ipa_audio_cache"
        });

        let currentModulePath = '/thaiIPA';
        const toneKeys = ['midTone', 'lowTone', 'fallingTone', 'highTone', 'risingTone'];
        let currentAudio = null;

        /**
         * 切换练习模块
         */
        function switchModule(path) {
            currentModulePath = path;

            // UI Update
            const navIds = {
                '/thaiIPA': 'nav-tones',
                '/thaiConsonantContrast': 'nav-consonants',
                '/thaiVowelContrast': 'nav-vowels'
            };

            Object.keys(navIds).forEach(p => {
                const btn = document.getElementById(navIds[p]);
                if (!btn) return;
                const isActive = p === path;
                btn.className = isActive
                    ? "px-4 py-2 rounded-full text-sm font-medium transition-all bg-indigo-100 text-indigo-700 border-2 border-indigo-200"
                    : "px-4 py-2 rounded-full text-sm font-medium transition-all bg-white text-gray-500 border-2 border-transparent hover:bg-gray-100";
            });

            document.getElementById('tone-container').innerHTML = `
                <div class="flex justify-center items-center h-64">
                    <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-500"></div>
                </div>
            `;

            loadFirebaseData();
        }

        /**
         * 从 Firebase 获取数据并渲染
         */
        const loadFirebaseData = () => {
            onValue(dbRef(db, currentModulePath), (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    renderToneCards(data);
                } else {
                    document.getElementById('tone-container').innerHTML = '<div class="text-center text-gray-500">暂无数据</div>';
                }
            }, { onlyOnce: false });
        };

        /**
         * 渲染练习卡片列表
         */
        function renderToneCards(jsonData) {
            const container = document.getElementById('tone-container');
            const titleEl = document.getElementById('app-title');
            const focusContainer = document.getElementById('vowel-focus-container');
            const focusText = document.getElementById('vowel-focus-text');

            if (!jsonData || !jsonData.practices) {
                container.innerHTML = '<div class="text-center text-gray-500">暂无练习数据</div>';
                focusContainer.classList.add('hidden');
                return;
            }

            titleEl.textContent = jsonData.title || "泰语练习";

            if (jsonData.vowel_focus) {
                focusText.textContent = jsonData.vowel_focus;
                focusContainer.classList.remove('hidden');
            } else {
                focusContainer.classList.add('hidden');
            }

            container.innerHTML = '';

            const practicesData = jsonData.practices;
            const practiceKeys = Object.keys(practicesData);

            practiceKeys.forEach((pKey) => {
                const group = practicesData[pKey];
                const groupContainer = document.createElement('div');
                groupContainer.className = "p-6 rounded-2xl bg-white shadow-sm border border-gray-100 space-y-4";

                if (group.description) {
                    const desc = document.createElement('h3');
                    desc.className = "text-lg font-bold text-gray-700 border-l-4 border-indigo-500 pl-3 mb-2";
                    desc.textContent = group.description;
                    groupContainer.appendChild(desc);
                }

                const grid = document.createElement('div');
                // Use a flexible grid based on the number of columns
                grid.className = "grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-6 gap-4";

                // Handle both named keys (toneKey, col1) and generic items array
                let items = [];
                if (Array.isArray(group.items)) {
                    items = group.items.map((item, idx) => ({ data: item, key: `item-${idx}` }));
                } else {
                    const itemKeys = Object.keys(group).filter(k =>
                        group[k] && typeof group[k] === 'object' && group[k].thai_word
                    );
                    items = itemKeys.map(k => ({ data: group[k], key: k }));
                }

                items.forEach(item => {
                    const card = createToneCard(item.data, item.key, pKey);
                    grid.appendChild(card);
                });

                groupContainer.appendChild(grid);
                container.appendChild(groupContainer);
            });
        }

        /**
         * 创建单个卡片
         */
        function createToneCard(data, typeOrKey, pKey) {
            const card = document.createElement('div');

            // Map keys to border styles
            let borderClass = 'border-t-4 border-gray-200'; // Default
            const typeStr = typeOrKey.replace('Tone', '').toLowerCase();
            const toneClasses = {
                mid: 'tone-mid',
                low: 'tone-low',
                falling: 'tone-falling',
                high: 'tone-high',
                rising: 'tone-rising'
            };

            if (toneClasses[typeStr]) {
                borderClass = toneClasses[typeStr];
            } else if (typeOrKey.startsWith('col') || typeOrKey.startsWith('item-')) {
                // For col1, item-1, etc., use alternating colors
                const colColors = ['tone-mid', 'tone-low', 'tone-high', 'tone-falling', 'tone-rising'];
                const colIdx = parseInt(typeOrKey.replace('col', '').replace('item-', '')) || 0;
                borderClass = colColors[colIdx % colColors.length];
            }

            card.className = `glass-card p-5 rounded-xl flex flex-col items-center text-center ${borderClass}`;

            const safeIpa = (data.ipa || '').normalize('NFC');
            const safeThai = (data.thai_word || '').normalize('NFC');
            const safeMeaning = (data.meaning || '-').normalize('NFC');

            card.innerHTML = `
                <span class="text-xs font-semibold text-gray-400 uppercase tracking-widest mb-2">
                    ${data.tone_type_en || ''}
                </span>
                <div class="thai-text text-3xl font-bold text-gray-800 mb-2">${safeThai}</div>
                <div class="ipa-text text-lg text-indigo-600 font-medium mb-3">${safeIpa}</div>
                <div class="text-sm text-gray-500 leading-relaxed">${safeMeaning}</div>
                <div id="status-${pKey}-${typeOrKey}" class="mt-2 text-[10px] text-gray-300 italic min-h-[15px]"></div>
            `;

            card.onclick = () => handleAudioPlayback(data, typeOrKey, pKey);

            return card;
        }

        /**
         * 处理音频播放逻辑：缓存 -> 远程 -> TTS
         */
        async function handleAudioPlayback(toneData, toneKey, pKey) {
            const statusEl = document.getElementById(`status-${pKey}-${toneKey}`);
            const word = toneData.thai_word;
            // Use currentModulePath to disambiguate cache keys if word is the same
            const cacheKey = `audio_${currentModulePath}_${word}_${toneKey}`;

            try {
                // 1. 检查本地缓存
                const cachedBlob = await audioCache.getItem(cacheKey);
                if (cachedBlob) {
                    playBlob(cachedBlob);
                    return;
                }

                // 2. 检查是否有远程 URL
                if (toneData.audioURL) {
                    statusEl.textContent = "下载中...";
                    const response = await fetch(toneData.audioURL);
                    const blob = await response.blob();
                    await audioCache.setItem(cacheKey, blob);
                    playBlob(blob);
                    statusEl.textContent = "";
                    return;
                }

                // 3. 调用 TTS 生成音频
                statusEl.textContent = "生成音频中...";
                const cleanWord = word.split('/')[0].trim();

                // 将 pKey 和 toneKey 传给后端，由后端完成云端同步
                const audioBlob = await generateTTS(cleanWord, pKey, toneKey);

                // 先播放并存入本地缓存
                await audioCache.setItem(cacheKey, audioBlob);
                playBlob(audioBlob);
                statusEl.textContent = "已就绪";

                // 2秒后清除状态
                setTimeout(() => {
                    if (statusEl.textContent === "已就绪") statusEl.textContent = "";
                }, 2000);
                return;

            } catch (error) {
                console.error("Audio handle error:", error);
                statusEl.textContent = "播放失败";
            }
        }

        /**
         * 播放音频 Blob
         */
        function playBlob(blob) {
            if (currentAudio) currentAudio.pause();
            const url = URL.createObjectURL(blob);
            currentAudio = new Audio(url);
            currentAudio.play();
        }

        async function clearAudioCache() {
            try {
                await audioCache.clear();
                const statusEl = document.getElementById('cache-status');
                statusEl.textContent = "✔ 本地缓存已清除";
                setTimeout(() => statusEl.textContent = "", 3000);
                console.log("Audio cache cleared.");
                // 刷新页面以从头开始测试
                setTimeout(() => location.reload(), 1000);
            } catch (err) {
                console.error("Failed to clear cache:", err);
            }
        }

        // Google TTS Proxy (Forwarded via local GeminiAgent to bypass CORS)
        const LOCAL_TTS_PROXY = "http://localhost:6660/api/tts-proxy";
        /**
         * 使用 local GeminiAgent Proxy 生成音频 (绕过跨域限制，并可选触发云端同步)
         */
        async function generateTTS(text, pKey = null, toneKey = null) {
            let url = `${LOCAL_TTS_PROXY}?text=${encodeURIComponent(text)}`;
            if (pKey && toneKey) {
                const modulePath = currentModulePath.startsWith('/') ? currentModulePath.substring(1) : currentModulePath;
                url += `&sync=true&pKey=${encodeURIComponent(pKey)}&toneKey=${encodeURIComponent(toneKey)}&modulePath=${encodeURIComponent(modulePath)}`;
            }

            console.log("Fetching via Local Proxy:", url);
            const response = await fetch(url);

            if (!response.ok) {
                console.error("Local Proxy Fetch Failed:", response.status);
                throw new Error(`Local Proxy failed: ${response.status}`);
            }

            return await response.blob();
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            loadFirebaseData();
        });

        // 挂载到 window 方便调试和 HTML onclick 调用
        window.renderToneCards = renderToneCards;
        window.clearAudioCache = clearAudioCache;
        window.toggleModal = toggleModal;
        window.saveNewPractice = saveNewPractice;
        window.switchModule = switchModule;

        // --- Modal Logic ---
        function toggleModal(show) {
            const modal = document.getElementById('add-modal');
            modal.classList.toggle('hidden', !show);
            if (show) {
                document.getElementById('json-input').value = '';
                document.getElementById('modal-path').value = currentModulePath;
                document.getElementById('modal-status').classList.add('hidden');
                document.getElementById('modal-status').classList.remove('text-red-500', 'text-green-500');
            }
        }

        async function saveNewPractice() {
            const input = document.getElementById('json-input').value;
            const path = document.getElementById('modal-path').value;
            const statusEl = document.getElementById('modal-status');
            const saveBtn = document.getElementById('save-btn');

            statusEl.classList.remove('hidden', 'text-red-500', 'text-green-500');
            statusEl.textContent = "正在处理...";
            statusEl.classList.remove('hidden');

            try {
                if (!input.trim()) throw new Error("请输入 JSON 数据");
                const data = JSON.parse(input);

                saveBtn.disabled = true;
                // We send the path to the backend so it knows where to save
                const response = await fetch("http://localhost:6660/api/thai-ipa/practices", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        path: path,
                        data: data
                    })
                });

                if (!response.ok) {
                    const errData = await response.json().catch(() => ({}));
                    throw new Error(errData.error || "保存失败，请检查 Agent 是否运行");
                }

                statusEl.classList.add('text-green-500');
                statusEl.textContent = "保存成功！";

                setTimeout(() => {
                    toggleModal(false);
                    saveBtn.disabled = false;
                    switchModule(path); // Refresh to show new data
                }, 1000);

            } catch (err) {
                console.error(err);
                statusEl.classList.add('text-red-500');
                statusEl.textContent = "错误: " + err.message;
                saveBtn.disabled = false;
            }
        }
    </script>

    <!-- Modal Fragment -->
    <div id="add-modal"
        class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-3xl w-full max-w-2xl overflow-hidden shadow-2xl border border-gray-100">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                <h2 class="text-xl font-bold text-gray-800">添加新练习组 (JSON)</h2>
                <button onclick="toggleModal(false)" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">目标路径</label>
                    <select id="modal-path"
                        class="w-full p-2 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                        <option value="/thaiIPA">/thaiIPA (五声调对比)</option>
                        <option value="/thaiConsonantContrast">/thaiConsonantContrast (辅音对比)</option>
                        <option value="/thaiVowelContrast">/thaiVowelContrast (元音对比)</option>
                    </select>
                </div>
                <p class="text-sm text-gray-500 mb-2">粘贴练习组 JSON 数据。支持单个练习组或完整模块格式。</p>
                <textarea id="json-input"
                    class="w-full h-64 p-4 font-mono text-sm bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all placeholder:text-gray-400"
                    placeholder='{
  "midTone": { "thai_word": "คา", "ipa": "[kʰa:]", "meaning": "卡住 / 滞留" },
  "lowTone": { ... },
  ...
}'></textarea>
                <div id="modal-status" class="mt-3 text-sm hidden font-medium"></div>
            </div>
            <div class="p-6 border-t border-gray-100 bg-gray-50 flex justify-end gap-3">
                <button onclick="toggleModal(false)"
                    class="px-5 py-2.5 text-gray-600 font-medium hover:bg-gray-100 rounded-xl transition-all">取消</button>
                <button id="save-btn" onclick="saveNewPractice()"
                    class="px-6 py-2.5 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 shadow-md shadow-indigo-100 transition-all">保存到
                    Firebase</button>
            </div>
        </div>
    </div>
</body>

</html>
<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Console Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Console 风格滚动条 */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1e293b;
        }

        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }

        .font-mono-nums {
            font-variant-numeric: tabular-nums;
        }

        /* 选中态样式 */
        .nav-active {
            background-color: #334155;
            /* slate-700 */
            color: white;
            border-left-color: #a855f7;
            /* purple-500 */
        }

        /* Accordion 动画 */
        .accordion-content {
            transition: max-height 0.3s ease-in-out;
        }
    </style>
</head>

<body class="bg-gray-100 font-sans text-gray-800 h-screen overflow-hidden">

    <div id="login-screen"
        class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-slate-900 text-white transition-opacity duration-500">
        <div class="text-center space-y-6 p-10 bg-slate-800 rounded-xl shadow-2xl border border-slate-700 w-96">
            <h1 class="text-4xl font-bold tracking-wider text-purple-400">QUIZ CONSOLE</h1>
            <p class="text-slate-400">Quiz 数据管理系统</p>
            <button id="btn-login"
                class="w-full px-6 py-3 bg-purple-600 hover:bg-purple-500 text-white rounded-lg font-medium transition-all flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                    <path
                        d="M12.545,10.239v3.821h5.445c-0.712,2.315-2.647,3.972-5.445,3.972c-3.332,0-6.033-2.701-6.033-6.032s2.701-6.032,6.033-6.032c1.498,0,2.866,0.549,3.921,1.453l2.814-2.814C17.503,2.988,15.139,2,12.545,2C7.021,2,2.543,6.477,2.543,12s4.478,10,10.002,10c8.396,0,10.249-7.85,9.426-11.748L12.545,10.239z" />
                </svg>
                Sign in with Google
            </button>
            <p id="login-error" class="text-red-400 text-sm hidden"></p>
        </div>
    </div>

    <div id="create-modal"
        class="fixed inset-0 z-40 hidden flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl overflow-hidden flex flex-col max-h-[95vh]">
            <div class="bg-slate-800 px-6 py-4 flex justify-between items-center shrink-0">
                <h3 class="text-lg font-bold text-white">New Quiz Set</h3>
                <button onclick="closeCreateModal()" class="text-slate-400 hover:text-white">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <div class="p-6 overflow-y-auto space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Quiz Title</label>
                        <input type="text" id="new-quiz-title"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                            placeholder="e.g. Unit 1 Vocabulary Test">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Assign to Course</label>
                        <select id="new-quiz-course"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 bg-white">
                            <option value="">-- Select a Course --</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Target Classification</label>
                        <select id="new-quiz-class"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 bg-white">
                            <option value="wordset_Thai">wordset_Thai</option>
                            <option value="wordset_En">wordset_En</option>
                            <option value="note_Thai">note_Thai</option>
                            <option value="note_En">note_En</option>
                            <option value="note_Common">note_Common</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Target ID</label>
                        <input type="text" id="new-quiz-target-id" value="tbd"
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                            placeholder="UUID or Reference ID">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tags (comma separated)</label>
                    <input type="text" id="new-quiz-tags"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500"
                        placeholder="e.g. A1, Vocab, Final">
                </div>

                <div class="flex-1 flex flex-col">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Quizzes Data (JSON Array)</label>
                    <p class="text-xs text-gray-500 mb-2">Paste the JSON array of question objects here.</p>
                    <textarea id="new-quiz-json"
                        class="w-full h-40 px-3 py-2 font-mono text-xs border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500 bg-slate-50"
                        placeholder='[
  {
    "question": "Question text...",
    "correct_answer": "A",
    "options": [
       {"id": "A", "text": "Option A"},
       {"id": "B", "text": "Option B"}
    ]
  }
]'></textarea>
                </div>
            </div>

            <div class="bg-gray-50 px-6 py-4 flex justify-end gap-3 border-t border-gray-200 shrink-0">
                <button onclick="closeCreateModal()"
                    class="px-4 py-2 text-sm text-gray-600 hover:text-gray-800 font-medium">Cancel</button>
                <button onclick="saveNewQuiz()"
                    class="px-4 py-2 text-sm bg-purple-600 hover:bg-purple-700 text-white rounded font-medium shadow-sm flex items-center gap-2">
                    <span id="save-spinner"
                        class="hidden animate-spin h-3 w-3 border-2 border-white border-t-transparent rounded-full"></span>
                    Create Quiz Set
                </button>
            </div>
        </div>
    </div>

    <div id="app-container" class="flex h-screen w-full hidden">

        <aside class="w-72 bg-slate-900 text-slate-300 flex flex-col border-r border-slate-700 shrink-0">
            <div class="h-16 flex items-center justify-center border-b border-slate-800">
                <span class="text-xl font-bold text-white tracking-wider">QUIZ<span
                        class="text-purple-500">_MGR</span></span>
            </div>

            <div class="flex-1 overflow-y-auto">

                <div>
                    <button onclick="toggleAccordion('courses-drawer')"
                        class="w-full px-4 py-3 flex items-center justify-between bg-slate-800 text-slate-200 hover:bg-slate-700 transition-colors border-b border-slate-700">
                        <span class="font-semibold text-xs uppercase tracking-wider">Course Management</span>
                        <svg id="icon-courses-drawer" class="w-4 h-4 transform transition-transform" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7">
                            </path>
                        </svg>
                    </button>
                    <div id="courses-drawer" class="accordion-content">
                        <nav id="course-list" class="space-y-1 py-1">
                            <div class="text-center text-sm text-slate-500 py-4">Loading courses...</div>
                        </nav>
                    </div>
                </div>

                <div>
                    <button onclick="toggleAccordion('logs-drawer')"
                        class="w-full px-4 py-3 flex items-center justify-between bg-slate-800 text-slate-200 hover:bg-slate-700 transition-colors border-b border-slate-700">
                        <span class="font-semibold text-xs uppercase tracking-wider">Quiz Logs</span>
                        <svg id="icon-logs-drawer" class="w-4 h-4 transform -rotate-90 transition-transform" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7">
                            </path>
                        </svg>
                    </button>
                    <div id="logs-drawer" class="accordion-content hidden">
                        <nav id="logs-course-list" class="space-y-1 py-1">
                            <div class="text-center text-sm text-slate-500 py-4">Click to load logs</div>
                        </nav>
                    </div>
                </div>

            </div>

            <div class="p-4 border-t border-slate-800 mt-auto">
                <button onclick="openCreateModal()"
                    class="w-full mb-4 px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white text-sm font-medium rounded flex items-center justify-center gap-2 transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    New Quiz Set
                </button>

                <div class="flex items-center gap-3 mb-3">
                    <img id="user-avatar" class="w-8 h-8 rounded-full bg-slate-600" src="" alt="Avatar">
                    <div class="overflow-hidden">
                        <p id="user-name" class="text-sm font-medium text-white truncate">Loading...</p>
                        <p id="user-email" class="text-xs text-slate-500 truncate">...</p>
                    </div>
                </div>
                <button id="btn-logout"
                    class="w-full py-2 text-xs text-slate-400 hover:text-white border border-slate-700 hover:border-slate-500 rounded transition-colors">
                    退出登录
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col bg-slate-100 overflow-hidden">
            <header
                class="h-16 bg-white border-b border-gray-200 shadow-sm flex items-center justify-between px-8 shrink-0">
                <div class="flex items-center gap-4">
                    <h2 id="page-title" class="text-xl font-semibold text-slate-800">Dashboard</h2>
                    <span id="quiz-count-badge"
                        class="hidden px-2 py-0.5 rounded-full bg-purple-100 text-purple-800 text-xs font-bold">0</span>
                </div>
                <div class="text-sm text-slate-500 font-mono-nums" id="current-time"></div>
            </header>

            <div id="content-area" class="flex-1 overflow-auto p-8 relative">
                <div id="loading-spinner"
                    class="hidden absolute inset-0 flex items-center justify-center bg-white bg-opacity-70 z-10">
                    <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-purple-600"></div>
                </div>
                <div id="view-container">
                    <div class="h-full flex flex-col items-center justify-center text-slate-400">
                        <svg class="w-16 h-16 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                                d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253">
                            </path>
                        </svg>
                        <p>Select a course or log to view details.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, get, child, remove, push, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // 4. 配置信息 (主数据库)
        const firebaseConfigMain = {
            apiKey: "AIzaSyA6MZ_p5lVuy8TMAqiuV6IRx9fggV44lQs",
            authDomain: "outpost-8d74e.firebaseapp.com",
            databaseURL: "https://outpost-8d74e-uiz-d289c.asia-southeast1.firebasedatabase.app/",
            projectId: "outpost-8d74e",
            storageBucket: "outpost-8d74e.firebasestorage.app",
            messagingSenderId: "724993324937",
            appId: "1:724993324937:web:ce6c7e6b06489331c79358",
            measurementId: "G-QPHWRTH6BH"
        };

        const MESSAGE_DB_URL = "https://outpost-8d74e-4ec53.asia-southeast1.firebasedatabase.app/";

        // 初始化
        const app = initializeApp(firebaseConfigMain);
        const auth = getAuth(app);
        const dbMain = getDatabase(app);

        // UI 引用
        const loginScreen = document.getElementById('login-screen');
        const appContainer = document.getElementById('app-container');
        const viewContainer = document.getElementById('view-container');
        const pageTitle = document.getElementById('page-title');
        const loadingSpinner = document.getElementById('loading-spinner');
        const courseListEl = document.getElementById('course-list');
        const logsCourseListEl = document.getElementById('logs-course-list');
        const quizCountBadge = document.getElementById('quiz-count-badge');

        // Modal UI Refs
        const createModal = document.getElementById('create-modal');
        const newQuizTitle = document.getElementById('new-quiz-title');
        const newQuizCourse = document.getElementById('new-quiz-course');
        const newQuizClass = document.getElementById('new-quiz-class');
        const newQuizTargetId = document.getElementById('new-quiz-target-id');
        const newQuizTags = document.getElementById('new-quiz-tags');
        const newQuizJson = document.getElementById('new-quiz-json');
        const saveSpinner = document.getElementById('save-spinner');

        let currentCourseId = null;
        let availableCourses = []; // 缓存课程列表
        let allQuizzes = []; // Global storage for filtering
        let currentTagFilter = 'all';

        // ================= Accordion Logic =================
        window.toggleAccordion = (drawerId) => {
            const drawer = document.getElementById(drawerId);
            const icon = document.getElementById(`icon-${drawerId}`);

            if (drawer.classList.contains('hidden')) {
                drawer.classList.remove('hidden');
                icon.classList.remove('-rotate-90'); // Arrow Down
                // Load data specific to drawer if needed
                if (drawerId === 'logs-drawer') {
                    loadQuizLogsSidebar();
                }
            } else {
                drawer.classList.add('hidden');
                icon.classList.add('-rotate-90'); // Arrow Right
            }
        };

        // ================= 认证逻辑 =================
        onAuthStateChanged(auth, (user) => {
            if (user) {
                loginScreen.classList.add('opacity-0', 'pointer-events-none');
                setTimeout(() => loginScreen.classList.add('hidden'), 500);
                appContainer.classList.remove('hidden');

                document.getElementById('user-name').textContent = user.displayName;
                document.getElementById('user-email').textContent = user.email;
                document.getElementById('user-avatar').src = user.photoURL || 'https://via.placeholder.com/32';

                loadCoursesSidebar(); // Initial load of courses drawer
            } else {
                loginScreen.classList.remove('hidden', 'opacity-0', 'pointer-events-none');
                appContainer.classList.add('hidden');
            }
        });

        document.getElementById('btn-login').addEventListener('click', () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider).catch((error) => {
                const errEl = document.getElementById('login-error');
                errEl.textContent = error.message;
                errEl.classList.remove('hidden');
            });
        });

        document.getElementById('btn-logout').addEventListener('click', () => signOut(auth));

        // ================= 1. Course Management Drawer (Existing) =================
        async function loadCoursesSidebar() {
            try {
                const snapshot = await get(ref(dbMain, 'courseFolders'));
                if (snapshot.exists()) {
                    const courses = snapshot.val();
                    courseListEl.innerHTML = '';
                    availableCourses = [];

                    Object.keys(courses).sort().forEach(key => {
                        const course = courses[key];
                        // Cache for dropdown
                        availableCourses.push({
                            id: key,
                            code: course.courseCode,
                            name: course.course
                        });

                        const btn = document.createElement('button');
                        btn.className = `w-full text-left px-8 py-2 text-sm text-slate-400 hover:bg-slate-800 hover:text-white transition-colors border-l-4 border-transparent focus:outline-none block nav-item course-nav-item`;
                        btn.dataset.id = key;
                        btn.dataset.type = 'course'; // differentiate from logs

                        btn.innerHTML = `
                            <div class="font-bold">${course.courseCode}</div>
                            <div class="text-xs truncate opacity-75">${course.course}</div>
                        `;

                        btn.onclick = () => loadCourseData(key, course);
                        courseListEl.appendChild(btn);
                    });
                } else {
                    courseListEl.innerHTML = '<div class="p-4 text-sm text-slate-500">No courses found.</div>';
                }
            } catch (error) {
                console.error("Load courses failed", error);
                courseListEl.innerHTML = '<div class="p-4 text-sm text-red-400">Error loading courses.</div>';
            }
        }

        // ================= 2. Quiz Logs Drawer (New) =================
        async function loadQuizLogsSidebar() {
            logsCourseListEl.innerHTML = '<div class="text-center text-sm text-slate-500 py-4"><div class="animate-spin inline-block w-4 h-4 border-2 border-slate-500 border-t-transparent rounded-full"></div> Loading Logs...</div>';

            try {
                // 1. Fetch all Logs
                const logsSnap = await get(ref(dbMain, 'quizSetLogs'));
                if (!logsSnap.exists()) {
                    logsCourseListEl.innerHTML = '<div class="p-4 text-sm text-slate-500">No quiz logs found.</div>';
                    return;
                }
                const allLogs = logsSnap.val();

                // 2. Fetch all Quiz Sets (to lookup courseID)
                // Note: In a huge DB, fetching all might be heavy, but efficient for now.
                const quizSetsSnap = await get(ref(dbMain, 'quizSets'));
                const allQuizSets = quizSetsSnap.exists() ? quizSetsSnap.val() : {};

                // 3. Fetch Course Info (if not already cached, though loadCoursesSidebar runs first)
                const courseFoldersSnap = await get(ref(dbMain, 'courseFolders'));
                const allCourses = courseFoldersSnap.exists() ? courseFoldersSnap.val() : {};

                // 4. Group Logs by Course
                // Structure: { courseID: [log1, log2, ...] }
                const groupedLogs = {};

                Object.entries(allLogs).forEach(([logId, logData]) => {
                    const quizSetID = logData.quizSetID;
                    if (quizSetID && allQuizSets[quizSetID]) {
                        const courseID = allQuizSets[quizSetID].courseID; // Assuming field added in recent update
                        // Fallback: If quizSet doesn't have courseID directly, try finding it via courseFolders (reverse lookup) - expensive, assume quizSets has it based on new creation logic

                        if (courseID && allCourses[courseID]) {
                            if (!groupedLogs[courseID]) {
                                groupedLogs[courseID] = {
                                    info: allCourses[courseID],
                                    logs: []
                                };
                            }
                            // Attach quiz title for convenience
                            logData.quizTitleReal = allQuizSets[quizSetID].title || "Unknown Quiz";
                            groupedLogs[courseID].logs.push(logData);
                        }
                    }
                });

                // 5. Render Sidebar Items
                logsCourseListEl.innerHTML = '';
                const sortedCourseIds = Object.keys(groupedLogs).sort();

                if (sortedCourseIds.length === 0) {
                    logsCourseListEl.innerHTML = '<div class="p-4 text-sm text-slate-500">No logs associated with courses found.</div>';
                    return;
                }

                sortedCourseIds.forEach(cId => {
                    const group = groupedLogs[cId];
                    const btn = document.createElement('button');
                    btn.className = `w-full text-left px-8 py-2 text-sm text-slate-400 hover:bg-slate-800 hover:text-white transition-colors border-l-4 border-transparent focus:outline-none block nav-item log-nav-item`;
                    btn.dataset.id = cId;
                    btn.dataset.type = 'log';

                    btn.innerHTML = `
                        <div class="flex justify-between items-center">
                            <div class="font-bold">${group.info.courseCode}</div>
                            <span class="bg-slate-700 text-xs px-1.5 py-0.5 rounded text-slate-300">${group.logs.length}</span>
                        </div>
                        <div class="text-xs truncate opacity-75">${group.info.course}</div>
                    `;

                    btn.onclick = () => renderQuizLogTable(group.info, group.logs);
                    logsCourseListEl.appendChild(btn);
                });

            } catch (error) {
                console.error("Error loading logs sidebar:", error);
                logsCourseListEl.innerHTML = '<div class="p-4 text-sm text-red-400">Error loading logs.</div>';
            }
        }

        // ================= Content Area: Render Logs Table =================
        function renderQuizLogTable(courseInfo, logs) {
            // Update Active State
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('nav-active'));
            document.querySelector(`.log-nav-item[data-id="${courseInfo.courseCode || Object.keys(availableCourses).find(k => availableCourses[k].code === courseInfo.courseCode)}"]`)?.classList.add('nav-active');
            // Hacky selector above due to key/code mix, usually button exists directly
            // Better:
            const activeBtn = document.querySelector(`.log-nav-item[onclick*="${courseInfo.courseCode}"]`) || document.event?.target;
            if (activeBtn && activeBtn.classList) activeBtn.classList.add('nav-active');

            pageTitle.textContent = `Logs: ${courseInfo.courseCode} - ${courseInfo.course}`;
            quizCountBadge.textContent = logs.length;
            quizCountBadge.classList.remove('hidden');

            // Sort logs by date desc
            logs.sort((a, b) => (b.testedOn || 0) - (a.testedOn || 0));

            let html = `
                <div class="bg-white rounded-lg shadow overflow-hidden border border-gray-200">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quiz Title</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Score</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Result</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
            `;

            logs.forEach(log => {
                const total = log.questions || 0;
                const fails = log.fails || 0;
                const correct = total - fails;
                const percentage = total > 0 ? Math.round((correct / total) * 100) : 0;

                // Format Date (20251208 -> 2025-12-08)
                let dateStr = log.testedOn ? String(log.testedOn) : "-";
                if (dateStr.length === 8) {
                    dateStr = `${dateStr.substring(0, 4)}-${dateStr.substring(4, 6)}-${dateStr.substring(6, 8)}`;
                }

                // Color code score
                let scoreColor = "text-gray-900";
                if (percentage >= 80) scoreColor = "text-green-600";
                else if (percentage < 60) scoreColor = "text-red-600";

                html += `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">${dateStr}</td>
                        <td class="px-6 py-4">
                            <div class="text-sm font-medium text-gray-900">${log.quizTitleReal || 'Unknown Quiz'}</div>
                            <div class="text-xs text-gray-400 font-mono">${log.quizSetID}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-bold ${scoreColor}">
                            ${correct} / ${total} <span class="text-xs font-normal text-gray-400">(${percentage}%)</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${log.finished ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}">
                                ${log.finished ? 'Finished' : 'Incomplete'}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="alert('Failed Questions Detail View TBD')" class="text-blue-600 hover:text-blue-900 hover:bg-blue-50 px-2 py-1 rounded transition-colors">
                                View
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += `</tbody></table></div>`;
            viewContainer.innerHTML = html;
        }

        // ================= Modal Logic =================
        window.openCreateModal = () => {
            newQuizCourse.innerHTML = '<option value="">-- Select a Course --</option>';
            availableCourses.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = `${c.code} - ${c.name}`;
                if (currentCourseId && c.id === currentCourseId) {
                    opt.selected = true;
                }
                newQuizCourse.appendChild(opt);
            });

            newQuizTitle.value = '';
            newQuizClass.value = 'wordset_Thai';
            newQuizTargetId.value = 'tbd';
            newQuizTags.value = '';
            newQuizJson.value = '';

            createModal.classList.remove('hidden');
        };

        window.closeCreateModal = () => {
            createModal.classList.add('hidden');
        };

        window.saveNewQuiz = async () => {
            const title = newQuizTitle.value.trim();
            const courseId = newQuizCourse.value;
            const targetClass = newQuizClass.value;
            const targetId = newQuizTargetId.value.trim() || "tbd";
            const tagsStr = newQuizTags.value.trim();
            const jsonStr = newQuizJson.value.trim();

            if (!title) return alert("Please enter a title.");
            if (!courseId) return alert("Please select a course.");
            if (!jsonStr) return alert("Please enter quiz data.");

            let quizzesArray;
            try {
                quizzesArray = JSON.parse(jsonStr);
                if (!Array.isArray(quizzesArray)) throw new Error("Root must be an array");
            } catch (e) {
                return alert("Invalid JSON Format: " + e.message);
            }

            const tagsArray = tagsStr ? tagsStr.split(',').map(t => t.trim()).filter(t => t !== '') : [];
            saveSpinner.classList.remove('hidden');

            try {
                const now = getISODate(new Date());
                const newQuizData = {
                    createdAt: now,
                    lastTried: "",
                    title: title,
                    targetClass: targetClass,
                    targetID: targetId,
                    tags: tagsArray,
                    quizzes: quizzesArray,
                    courseID: courseId // Ensure this is saved for linkage!
                };

                const newQuizRef = await push(ref(dbMain, 'quizSets'), newQuizData);
                const newQuizKey = newQuizRef.key;

                const courseRef = ref(dbMain, `courseFolders/${courseId}`);
                const courseSnap = await get(courseRef);

                if (courseSnap.exists()) {
                    const courseData = courseSnap.val();
                    let currentSets = courseData.quizSets || [];
                    currentSets.push(newQuizKey);
                    await update(courseRef, { quizSets: currentSets });

                    alert("Quiz Set Created Successfully!");
                    closeCreateModal();

                    if (currentCourseId === courseId) {
                        const updatedSnap = await get(courseRef);
                        loadCourseData(courseId, updatedSnap.val());
                    }
                } else {
                    throw new Error("Target course not found");
                }

            } catch (err) {
                console.error(err);
                alert("Creation failed: " + err.message);
            } finally {
                saveSpinner.classList.add('hidden');
            }
        };


        // ================= 内容区逻辑 (Quiz Sets) =================
        window.loadCourseData = async (courseId, courseData) => {
            currentCourseId = courseId;

            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('nav-active'));
            // Use querySelectorAll and loop because course buttons are generated dynamically
            const activeBtns = document.querySelectorAll(`.course-nav-item`);
            activeBtns.forEach(btn => {
                if (btn.dataset.id === courseId) btn.classList.add('nav-active');
            });

            pageTitle.textContent = `${courseData.courseCode} - ${courseData.course}`;
            quizCountBadge.classList.add('hidden');
            viewContainer.innerHTML = '';
            showLoading(true);

            const quizSetKeys = courseData.quizSets || [];

            if (quizSetKeys.length === 0) {
                viewContainer.innerHTML = `<div class="bg-white p-10 rounded-lg shadow text-center text-gray-500">No quizzes assigned to this course.</div>`;
                showLoading(false);
                return;
            }

            try {
                const promises = quizSetKeys.map(key =>
                    get(child(ref(dbMain), `quizSets/${key}`))
                        .then(snap => snap.exists() ? { key, ...snap.val() } : null)
                );

                const results = await Promise.all(promises);
                const validQuizSets = results.filter(item => item !== null);

                // --- 修改：按照 Title 排序 ---
                validQuizSets.sort((a, b) => {
                    const titleA = a.title || 'Untitled';
                    const titleB = b.title || 'Untitled';
                    return titleA.localeCompare(titleB, 'zh-CN', { numeric: true });
                });

                allQuizzes = validQuizSets;
                currentTagFilter = 'all'; // Reset filter on course load

                // Extract unique tags
                const tagsSet = new Set(['all']);
                validQuizSets.forEach(qs => {
                    (qs.tags || []).forEach(t => tagsSet.add(t));
                });

                quizCountBadge.textContent = validQuizSets.length;
                quizCountBadge.classList.remove('hidden');

                if (validQuizSets.length > 0) {
                    renderQuizTable(validQuizSets, Array.from(tagsSet));
                } else {
                    viewContainer.innerHTML = `<div class="bg-white p-10 rounded-lg shadow text-center text-gray-500">Quiz sets referenced but not found in database.</div>`;
                }

            } catch (error) {
                console.error(error);
                viewContainer.innerHTML = `<div class="bg-red-50 p-4 rounded text-red-600">Error loading quiz details: ${error.message}</div>`;
            } finally {
                showLoading(false);
            }
        };

        window.filterByTag = (tag) => {
            currentTagFilter = tag;
            const filtered = tag === 'all'
                ? allQuizzes
                : allQuizzes.filter(q => (q.tags || []).includes(tag));

            // Re-extract tags to keep the dropdown consistent (or just pass the same ones)
            const tagsSet = new Set(['all']);
            allQuizzes.forEach(qs => {
                (qs.tags || []).forEach(t => tagsSet.add(t));
            });
            renderQuizTable(filtered, Array.from(tagsSet));
        };

        function renderQuizTable(quizSets, availableTags) {
            const tagOptions = availableTags.sort().map(t =>
                `<option value="${t}" ${currentTagFilter === t ? 'selected' : ''}>${t === 'all' ? 'All Tags' : t}</option>`
            ).join('');

            let html = `
                <div class="mb-4 flex items-center gap-2">
                    <label class="text-sm font-medium text-slate-600">Filter by Tag:</label>
                    <select onchange="filterByTag(this.value)" class="text-sm border border-slate-300 rounded px-2 py-1 bg-white focus:outline-none focus:ring-2 focus:ring-purple-500">
                        ${tagOptions}
                    </select>
                </div>
                <div class="bg-white rounded-lg shadow overflow-hidden border border-gray-200">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Title / Target</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Tried</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Questions</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tags</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
            `;

            quizSets.forEach(qs => {
                const questionCount = qs.quizzes ? qs.quizzes.length : 0;
                const tagsHtml = (qs.tags || []).map(t =>
                    `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800 mr-1">${t}</span>`
                ).join('');

                html += `
                    <tr id="row-${qs.key}" class="hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4">
                            <div class="text-sm font-medium text-gray-900 cursor-pointer hover:text-purple-600 transition-colors" onclick="startEditTitle('${qs.key}', this)">${qs.title || 'Untitled'}</div>
                            <div class="text-xs text-gray-500">
                                <span class="font-mono text-gray-400">${qs.targetClass || '-'}</span>
                                <span class="text-gray-300 mx-1">/</span>
                                <span class="font-mono text-gray-400" title="${qs.targetID}">${qs.targetID === 'tbd' ? 'TBD' : (qs.targetID?.substring(0, 8) + '...' || '-')}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">${qs.createdAt || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 font-mono">${qs.lastTried || '-'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-900 font-bold">${questionCount}</td>
                        <td class="px-6 py-4 text-sm text-gray-500 cursor-pointer hover:text-purple-600 transition-colors" onclick="startEditTags('${qs.key}', this)">${tagsHtml}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                            <button onclick="handleAssign('${qs.key}', '${qs.title}')" class="text-blue-600 hover:text-blue-900 hover:bg-blue-50 px-2 py-1 rounded transition-colors" title="Assign to Ray">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg>
                            </button>
                            <button onclick="handleDelete('${qs.key}')" class="text-red-600 hover:text-red-900 hover:bg-red-50 px-2 py-1 rounded transition-colors" title="Delete Quiz Set">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += `</tbody></table></div>`;
            viewContainer.innerHTML = html;
        }

        // ================= Inline Editing =================
        window.startEditTags = (key, el) => {
            if (el.querySelector('input')) return;

            const quizSet = allQuizzes.find(q => q.key === key);
            const originalTagsStr = (quizSet?.tags || []).join(', ');

            const input = document.createElement('input');
            input.type = 'text';
            input.value = originalTagsStr;
            input.className = 'w-full px-2 py-1 text-sm border border-purple-500 rounded focus:outline-none focus:ring-1 focus:ring-purple-500';

            input.onclick = (e) => e.stopPropagation();

            const handleFinish = async (save) => {
                const newTagsStr = input.value.trim();
                if (save && newTagsStr !== originalTagsStr) {
                    const newTagsArray = newTagsStr ? newTagsStr.split(',').map(t => t.trim()).filter(t => t !== '') : [];
                    try {
                        showLoading(true);
                        await update(ref(dbMain, `quizSets/${key}`), { tags: newTagsArray });

                        if (currentCourseId) {
                            const courseSnap = await get(ref(dbMain, `courseFolders/${currentCourseId}`));
                            if (courseSnap.exists()) {
                                loadCourseData(currentCourseId, courseSnap.val());
                            }
                        }
                    } catch (err) {
                        alert('Update failed: ' + err.message);
                        renderTags(el, quizSet?.tags || []);
                    } finally {
                        showLoading(false);
                    }
                } else {
                    renderTags(el, quizSet?.tags || []);
                }
            };

            function renderTags(element, tags) {
                element.innerHTML = tags.map(t =>
                    `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-purple-100 text-purple-800 mr-1">${t}</span>`
                ).join('');
            }

            input.onkeydown = (e) => {
                if (e.key === 'Enter') handleFinish(true);
                if (e.key === 'Escape') handleFinish(false);
            };
            input.onblur = () => handleFinish(false);

            el.innerHTML = '';
            el.appendChild(input);
            input.focus();
            input.select();
        };

        window.startEditTitle = (key, el) => {
            if (el.querySelector('input')) return; // Already editing

            const originalTitle = el.textContent;
            const input = document.createElement('input');
            input.type = 'text';
            input.value = originalTitle;
            input.className = 'w-full px-2 py-1 text-sm border border-purple-500 rounded focus:outline-none focus:ring-1 focus:ring-purple-500';

            // Prevent event propagation so clicking inside input doesn't trigger startEditTitle again
            input.onclick = (e) => e.stopPropagation();

            const handleFinish = async (save) => {
                const newTitle = input.value.trim();
                if (save && newTitle && newTitle !== originalTitle) {
                    try {
                        showLoading(true);
                        await update(ref(dbMain, `quizSets/${key}`), { title: newTitle });

                        // 修改：更新成功后重新拉取课程数据，以触发重新渲染和排序
                        if (currentCourseId) {
                            const courseSnap = await get(ref(dbMain, `courseFolders/${currentCourseId}`));
                            if (courseSnap.exists()) {
                                loadCourseData(currentCourseId, courseSnap.val());
                            }
                        } else {
                            el.textContent = newTitle;
                        }
                    } catch (err) {
                        alert('Update failed: ' + err.message);
                        el.textContent = originalTitle;
                    } finally {
                        showLoading(false);
                    }
                } else {
                    el.textContent = originalTitle;
                }
            };

            input.onkeydown = (e) => {
                if (e.key === 'Enter') handleFinish(true);
                if (e.key === 'Escape') handleFinish(false);
            };

            input.onblur = () => handleFinish(false); // Cancel on blur by default or save? Let's cancel to be safe

            el.innerHTML = '';
            el.appendChild(input);
            input.focus();
            input.select();
        };

        // ================= Action Operations =================

        window.handleDelete = async (key) => {
            if (!confirm('Are you sure you want to delete this Quiz Set? Data will be removed permanently.')) return;

            showLoading(true);
            try {
                await remove(ref(dbMain, `quizSets/${key}`));
                const row = document.getElementById(`row-${key}`);
                if (row) row.remove();

            } catch (error) {
                alert('Delete failed: ' + error.message);
            } finally {
                showLoading(false);
            }
        };

        window.handleAssign = async (key, title) => {
            if (!confirm(`Assign quiz "${title}" to Ray (rayzhang20030603@gmail.com)?`)) return;

            showLoading(true);
            try {
                const dbMessage = getDatabase(app, MESSAGE_DB_URL);

                const now = new Date();
                const expireDate = new Date();
                expireDate.setDate(now.getDate() + 2);

                const newMessage = {
                    attachment: `https://alexzhangmaker.github.io/outpost/quizAnywhereV3.html?quiz=quizSets/${key}/quizzes`,
                    classification: "quiz",
                    createdAt: getISODate(now),
                    expireAt: getISODate(expireDate),
                    message: `quiz ${title || 'Untitled'}`,
                    user: "rayzhang20030603@gmail.com"
                };

                await push(ref(dbMessage, 'userMessages'), newMessage);
                alert('Quiz assigned successfully!');
            } catch (error) {
                console.error(error);
                alert('Assign failed: ' + error.message);
            } finally {
                showLoading(false);
            }
        };

        // ================= Helpers =================
        function showLoading(show) {
            loadingSpinner.classList.toggle('hidden', !show);
        }

        function getISODate(dateObj) {
            const year = dateObj.getFullYear();
            const month = String(dateObj.getMonth() + 1).padStart(2, '0');
            const day = String(dateObj.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        setInterval(() => {
            document.getElementById('current-time').textContent = new Date().toLocaleString('zh-CN', { hour12: false });
        }, 1000);

    </script>
</body>

</html>
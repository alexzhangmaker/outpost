<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>泰语词汇集管理工具 V5</title>
    <!-- 引入LocalForage -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
    <!-- 引入ExcelJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
    <style>
        :root {
            --bg-color: #f8fafc;
            --sidebar-bg: #ffffff;
            --content-bg: #ffffff;
            --text-color: #334155;
            --text-light: #64748b;
            --accent-color: #3b82f6;
            --accent-hover: #2563eb;
            --border-color: #e2e8f0;
            --hover-color: #f1f5f9;
            --toolbar-height: 60px;
            --sidebar-width: 640px;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 8px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            overflow: hidden;
            line-height: 1.5;
        }

        /* 顶部工具条 */
        .toolbar {
            height: var(--toolbar-height);
            background-color: white;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 20px;
            justify-content: space-between;
            box-shadow: var(--shadow);
        }

        .toolbar-title {
            font-weight: 700;
            color: #1e293b;
            font-size: 18px;
        }

        .auth-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        #user-info {
            font-size: 14px;
            color: var(--text-light);
        }

        .auth-section button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .auth-section button:hover {
            background-color: var(--accent-hover);
            transform: translateY(-1px);
        }

        /* 主内容区 */
        .main-container {
            display: flex;
            height: calc(100vh - var(--toolbar-height));
        }

        /* 左侧导航区 */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .sidebar-header h3 {
            font-size: 16px;
            font-weight: 700;
            color: #1e293b;
            margin: 0;
        }


        .filter-section {
            margin-bottom: 20px;
            display: flex;
            align-items: flex-end;
            gap: 12px;
            flex-wrap: nowrap;
        }

        .filter-group {
            margin-bottom: 0px;
            flex: 1;
            min-width: 0;
        }

        .filter-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            color: var(--text-light);
            font-weight: 500;
        }

        .filter-input,
        .filter-select {
            width: 100%;
            padding: 10px 12px;
            background-color: white;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            border-radius: var(--radius);
            font-size: 14px;
            transition: border-color 0.2s ease;
        }

        .filter-input:focus,
        .filter-select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .filter-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .filter-actions button {
            flex: 1;
            padding: 10px;
            background-color: white;
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .filter-actions button:hover {
            background-color: var(--hover-color);
        }

        .filter-actions button.active {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .wordsets-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
        }

        .wordset-item {
            padding: 8px 12px;
            cursor: pointer;
            border-left: 4px solid transparent;
            border-bottom: 1px solid var(--border-color);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }

        .wordset-item-main {
            display: flex;
            align-items: center;
            gap: 16px;
            flex: 1;
            min-width: 0;
        }

        .wordset-name {
            font-weight: 600;
            color: #1e293b;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 300px;
        }

        .wordset-meta {
            font-size: 13px;
            color: var(--text-light);
            display: flex;
            gap: 12px;
            white-space: nowrap;
        }

        .wordset-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .wordset-actions button {
            background-color: white;
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 6px 12px;
            font-size: 12px;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .wordset-actions button:hover {
            background-color: var(--hover-color);
        }

        .wordset-actions button.delete {
            color: #ef4444;
            border-color: #fecaca;
        }

        .wordset-actions button.delete:hover {
            background-color: #fef2f2;
        }

        /* 右侧内容区 */
        .content {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            background-color: var(--content-bg);
        }

        /* 分类编辑区域 */
        .classification-editor {
            background-color: white;
            padding: 10px;
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            margin-bottom: 10px;
            box-shadow: var(--shadow);
        }

        .classification-form {
            display: grid;
            grid-template-columns: 80px 160px 1fr auto auto;
            gap: 10px;
            align-items: end;
        }

        .form-group {
            margin-bottom: 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            font-weight: 500;
            color: var(--text-light);
        }

        /* 词汇卡片样式 */
        .word-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 12px;
        }

        .word-card {
            background-color: white;
            border-radius: var(--radius);
            padding: 10px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }

        .word-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .word-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .word-thai {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
        }

        .lookup-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-light);
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .lookup-btn:hover {
            background-color: var(--hover-color);
            color: var(--accent-color);
        }

        .word-index {
            font-size: 14px;
            color: var(--text-light);
            margin-bottom: 4px;
        }

        /* 表单样式 */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 12px 16px;
            background-color: white;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            border-radius: var(--radius);
            font-size: 14px;
            transition: border-color 0.2s ease;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-actions {
            margin-top: 24px;
            display: flex;
            gap: 12px;
        }

        .form-actions button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .form-actions button:hover {
            background-color: var(--accent-hover);
        }

        .form-actions button.cancel {
            background-color: white;
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .form-actions button.cancel:hover {
            background-color: var(--hover-color);
        }

        /* 操作按钮组 */
        .action-buttons {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .action-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: white;
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 10px 16px;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .action-btn:hover {
            background-color: var(--hover-color);
            transform: translateY(-1px);
        }

        .action-btn.primary {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .action-btn.primary:hover {
            background-color: var(--accent-hover);
        }

        /* 状态消息 */
        .status-message {
            padding: 12px 16px;
            margin: 16px 0;
            border-radius: var(--radius);
            display: none;
            font-size: 14px;
        }

        .status-message.success {
            background-color: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #166534;
            display: block;
        }

        .status-message.error {
            background-color: #fef2f2;
            border: 1px solid #fecaca;
            color: #991b1b;
            display: block;
        }

        .status-message.info {
            background-color: #eff6ff;
            border: 1px solid #bfdbfe;
            color: #1e40af;
            display: block;
        }

        /* 模态对话框 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            border-radius: var(--radius);
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-light);
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .modal-close:hover {
            background-color: var(--hover-color);
        }

        .modal-body {
            padding: 24px;
        }

        .definition-section {
            margin-bottom: 20px;
        }

        .definition-section h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #1e293b;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .definition-item {
            margin-bottom: 8px;
            padding-left: 16px;
            position: relative;
        }

        .definition-item:before {
            content: "•";
            position: absolute;
            left: 0;
            color: var(--accent-color);
        }

        /* 加载指示器 */
        .loader {
            border: 3px solid #e2e8f0;
            border-top: 3px solid var(--accent-color);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* 进度条 */
        .progress-container {
            margin: 16px 0;
            background-color: #e2e8f0;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-bar {
            height: 8px;
            background-color: var(--accent-color);
            width: 0%;
            transition: width 0.3s ease;
        }

        /* 响应式调整 */
        @media (max-width: 1024px) {
            .word-cards {
                grid-template-columns: repeat(2, 1fr);
            }

            .classification-form {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: 40%;
            }

            .content {
                height: 60%;
            }

            .word-cards {
                grid-template-columns: 1fr;
            }

            .action-buttons {
                flex-wrap: wrap;
            }
        }

        /* Anki导出模态对话框样式 */
        .anki-modal .modal-content {
            max-width: 500px;
        }

        .anki-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .form-group {
            margin-bottom: 0;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .form-actions button {
            padding: 10px 20px;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .form-actions button.primary {
            background-color: var(--accent-color);
            color: white;
        }

        .form-actions button.primary:hover {
            background-color: var(--accent-hover);
        }

        .form-actions button.secondary {
            background-color: white;
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        .form-actions button.secondary:hover {
            background-color: var(--hover-color);
        }

        .already-published {
            background-color: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: var(--radius);
            padding: 16px;
            margin-bottom: 16px;
        }

        .already-published h4 {
            color: #0369a1;
            margin-bottom: 8px;
        }

        .already-published p {
            color: #0c4a6e;
            margin-bottom: 8px;
        }

        .review-set-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: var(--accent-color);
            text-decoration: none;
            font-weight: 500;
        }

        .review-set-link:hover {
            text-decoration: underline;
        }

        /* Quiz创建模态对话框样式 */
        .quiz-modal .modal-content {
            max-width: 500px;
        }

        .quiz-info {
            background-color: var(--hover-color);
            padding: 16px;
            border-radius: var(--radius);
            margin-bottom: 16px;
        }

        .quiz-info h4 {
            color: var(--accent-color);
            margin-bottom: 12px;
        }

        .quiz-words-preview {
            background-color: white;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            padding: 12px;
            max-height: 150px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.4;
            margin-bottom: 16px;
        }

        .copy-success {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #059669;
            background-color: #ecfdf5;
            border: 1px solid #a7f3d0;
            padding: 12px;
            border-radius: var(--radius);
            margin-bottom: 16px;
        }

        .copy-success svg {
            color: #10b981;
        }

        /* Excel导出模态对话框样式 */
        .excel-modal .modal-content {
            max-width: 500px;
        }

        .excel-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .excel-preview {
            background-color: var(--hover-color);
            padding: 16px;
            border-radius: var(--radius);
            margin-bottom: 16px;
        }

        .excel-preview h4 {
            color: var(--accent-color);
            margin-bottom: 12px;
        }

        .excel-preview-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 14px;
        }

        .excel-preview-info div {
            padding: 8px;
            background-color: white;
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }

        /* 单词管理区域（添加单词用） */
        .word-management-section {
            background-color: white;
            padding: 10px;
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            margin-bottom: 10px;
            box-shadow: var(--shadow);
        }

        .add-words-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .add-words-actions {
            display: flex;
            justify-content: flex-end;
        }

        /* 词汇卡片删除按钮 */
        .word-card-actions {
            display: flex;
            gap: 8px;
        }

        .delete-word-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #ef4444;
            /* 红色 */
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.6;
        }

        .delete-word-btn:hover {
            background-color: #fef2f2;
            opacity: 1;
        }

        /* --- 新增：标签样式 --- */
        .tags-editor {
            background-color: white;
            padding: 10px;
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            margin-bottom: 10px;
            box-shadow: var(--shadow);
        }

        .tag-chip {
            display: inline-flex;
            align-items: center;
            background-color: #e0f2fe;
            /* 浅蓝色背景 */
            color: #0369a1;
            /* 深蓝色文字 */
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
            margin-right: 6px;
            margin-bottom: 6px;
            border: 1px solid #bae6fd;
        }

        .tag-chip:hover {
            background-color: #bae6fd;
        }
    </style>
</head>

<body>
    <!-- 顶部工具条 -->
    <div class="toolbar">
        <div class="toolbar-title">泰语词汇集管理工具 V5 (Acron 集成版)</div>
        <div class="auth-section">
            <span id="user-info"></span>
            <button id="signin-btn">登录</button>
            <button id="signout-btn" style="display: none;">退出</button>
        </div>
    </div>

    <!-- 主内容区 -->
    <div class="main-container">
        <!-- 左侧导航区 -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h3>词汇集管理</h3>
            </div>

            <button id="new-wordset-btn"
                style="width: 100%; padding: 12px; background-color: var(--accent-color); color: white; border: none; border-radius: var(--radius); cursor: pointer; font-weight: 500; transition: background-color 0.2s ease;">新建词汇集</button>

            <!-- 过滤和搜索区域 -->
            <div class="filter-section">
                <div class="filter-group">
                    <label for="search-title">搜索标题</label>
                    <input type="text" id="search-title" class="filter-input" placeholder="关键词...">
                </div>

                <div class="filter-group">
                    <label for="filter-level">按级别过滤</label>
                    <select id="filter-level" class="filter-select">
                        <option value="">所有级别</option>
                        <option value="A1">A1</option>
                        <option value="A2">A2</option>
                        <option value="B1">B1</option>
                        <option value="B2">B2</option>
                        <option value="C1">C1</option>
                        <option value="C2">C2</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="filter-scenario">按厂家过滤</label>
                    <select id="filter-scenario" class="filter-select">
                        <option value="">所有厂家</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="filter-tag">按标签过滤</label>
                    <select id="filter-tag" class="filter-select">
                        <option value="">所有标签</option>
                    </select>
                </div>

                <div class="filter-actions">
                    <button id="apply-filters" class="active">应用过滤</button>
                    <button id="clear-filters">清除过滤</button>
                </div>
            </div>

            <div class="wordsets-container">
                <div id="wordsets-list"></div>
            </div>
        </div>

        <!-- 右侧内容区 -->
        <div class="content">
            <div id="status-message" class="status-message"></div>

            <!-- 词汇集详情视图 -->
            <div id="wordset-detail-view" style="display: none;">
                <div style="display: flex; flex-direction: row; align-items: center; gap: 12px; margin-bottom: 12px;">
                    <h2 id="wordset-title" style="color: #1e293b; cursor: pointer;" title="点击修改标题"></h2>
                    <input type="text" id="wordset-title-edit-input"
                        style="display: none; font-size: 1.5em; font-weight: bold; padding: 4px 8px; border: 2px solid var(--accent-color); border-radius: var(--radius); flex: 1; outline: none;">
                    <span id="idCopyWordSetKey" style="color: var(--text-light); font-size: 14px; cursor: pointer;"
                        title="点击查看ID">id...</span>
                </div>

                <!-- 分类与标签编辑区域 -->
                <div class="classification-editor">
                    <h3 style="margin-bottom: 8px; color: #1e293b;">分类与标签</h3>
                    <div class="classification-form">
                        <div class="form-group">
                            <label for="current-level">级别</label>
                            <select id="current-level" class="filter-select">
                                <option value="">级别</option>
                                <option value="A1">A1</option>
                                <option value="A2">A2</option>
                                <option value="B1">B1</option>
                                <option value="B2">B2</option>
                                <option value="C1">C1</option>
                                <option value="C2">C2</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="current-scenario">场景</label>
                            <select id="current-scenario" class="filter-select">
                                <option value="">请先选择级别</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="current-tags-input">标签 (逗号分隔)</label>
                            <input type="text" id="current-tags-input" placeholder="例如: 动词, 高频词" style="width: 100%;">
                        </div>

                        <div class="form-group">
                            <button id="update-classification-btn"
                                style="padding: 10px 16px; background-color: var(--accent-color); color: white; border: none; border-radius: var(--radius); cursor: pointer; font-weight: 500; transition: background-color 0.2s ease; white-space: nowrap;">更新分类</button>
                        </div>
                        <div class="form-group">
                            <button id="update-tags-btn"
                                style="padding: 10px 16px; background-color: var(--accent-color); color: white; border: none; border-radius: var(--radius); cursor: pointer; white-space: nowrap;">更新标签</button>
                        </div>
                    </div>
                    <div id="tags-preview-container" style="margin-top: 8px; min-height: 24px;"></div>
                </div>

                <div class="word-management-section">
                    <h3 style="margin-bottom: 8px; color: #1e293b;">管理词汇</h3>
                    <div class="add-words-container">
                        <textarea id="add-new-words-input" placeholder="在此输入要添加的新词汇 (支持批量，每行一个)"
                            style="min-height: 80px;"></textarea>
                        <div class="add-words-actions">
                            <button id="submit-new-words-btn"
                                style="padding: 8px 16px; background-color: var(--accent-color); color: white; border: none; border-radius: var(--radius); cursor: pointer; font-weight: 500;">
                                <span id="add-btn-text">添加新词汇</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 操作按钮组 -->
                <div class="action-buttons">
                    <button class="action-btn primary" id="export-anki-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        发布为Anki
                    </button>
                    <button class="action-btn" id="create-quiz-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="16"></line>
                            <line x1="8" y1="12" x2="16" y2="12"></line>
                        </svg>
                        创建Quiz
                    </button>
                    <button class="action-btn" id="export-excel-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <path d="M16 18H8"></path>
                            <path d="M16 14H8"></path>
                            <path d="M10 6H8"></path>
                        </svg>
                        导出为Excel
                    </button>
                    <button class="action-btn" id="print-output-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="6 9 6 2 18 2 18 9"></polyline>
                            <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
                            <rect x="6" y="14" width="12" height="8"></rect>
                        </svg>
                        打印输出
                    </button>
                </div>

                <!-- 词汇卡片容器 -->
                <div class="word-cards" id="word-cards-container">
                    <!-- 词汇卡片将通过JS动态填充 -->
                </div>
            </div>

            <!-- 新建词汇集表单 -->
            <div id="wordset-form-view" style="display: none;">
                <h2 style="margin-bottom: 20px; color: #1e293b;">新建词汇集</h2>
                <form id="wordset-form">
                    <div class="form-group">
                        <label for="wordset-title-input">词汇集标题</label>
                        <input type="text" id="wordset-title-input" required>
                    </div>

                    <div class="form-group">
                        <label for="wordset-level-select">级别</label>
                        <select id="wordset-level-select" required>
                            <option value="">请选择级别</option>
                            <option value="A1">A1</option>
                            <option value="A2">A2</option>
                            <option value="B1">B1</option>
                            <option value="B2">B2</option>
                            <option value="C1">C1</option>
                            <option value="C2">C2</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="wordset-scenario-select">场景</label>
                        <select id="wordset-scenario-select" required>
                            <option value="">请先选择级别</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="wordset-tags-input">标签 (可选，用逗号分隔)</label>
                        <input type="text" id="wordset-tags-input" placeholder="例如: 商务, 饮食, 曼谷 (支持中英文逗号)">
                    </div>
                    <div class="form-group">
                        <label for="wordset-words-textarea">词汇列表 (每行一个词汇)</label>
                        <textarea id="wordset-words-textarea" placeholder="请输入泰语词汇，每行一个" required></textarea>
                    </div>

                    <div class="form-actions">
                        <button type="submit">保存词汇集</button>
                        <button type="button" id="cancel-form-btn" class="cancel">取消</button>
                    </div>
                </form>
            </div>

            <!-- 初始提示信息 -->
            <div id="initial-message" style="text-align: center; padding: 60px 20px; color: var(--text-light);">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"
                    style="margin-bottom: 16px; opacity: 0.5;">
                    <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path>
                    <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path>
                </svg>
                <h3 style="margin-bottom: 8px; color: var(--text-color);">欢迎使用泰语词汇集管理工具</h3>
                <p>请从左侧选择一个词汇集查看详情，或点击"新建词汇集"创建新的词汇集。</p>
            </div>
        </div>
    </div>

    <!-- 字典查询模态对话框 -->
    <div id="dictionary-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="dictionary-modal-title">单词释义</h3>
                <button class="modal-close" id="dictionary-modal-close">&times;</button>
            </div>
            <div class="modal-body" id="dictionary-modal-body">
                <!-- 字典内容将通过JS动态填充 -->
            </div>
        </div>
    </div>

    <!-- Anki导出模态对话框 -->
    <div id="anki-export-modal" class="modal anki-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="anki-export-modal-title">发布到Anki</h3>
                <button class="modal-close" id="anki-export-modal-close">&times;</button>
            </div>
            <div class="modal-body" id="anki-export-modal-body">
                <!-- 内容将通过JS动态填充 -->
            </div>
        </div>
    </div>

    <!-- Quiz创建模态对话框 -->
    <div id="quiz-modal" class="modal quiz-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="quiz-modal-title">创建Quiz</h3>
                <button class="modal-close" id="quiz-modal-close">&times;</button>
            </div>
            <div class="modal-body" id="quiz-modal-body">
                <!-- 内容将通过JS动态填充 -->
            </div>
        </div>
    </div>

    <!-- Excel导出模态对话框 -->
    <div id="excel-export-modal" class="modal excel-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="excel-export-modal-title">导出为Excel</h3>
                <button class="modal-close" id="excel-export-modal-close">&times;</button>
            </div>
            <div class="modal-body" id="excel-export-modal-body">
                <!-- 内容将通过JS动态填充 -->
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <script>
        // Firebase配置
        const firebaseConfig = {
            apiKey: "AIzaSyA6MZ_p5lVuy8TMAqiuV6IRx9fggV44lQs",
            authDomain: "outpost-8d74e.firebaseapp.com",
            databaseURL: "https://outpost-dictionary-116208.asia-southeast1.firebasedatabase.app/",
            projectId: "outpost-8d74e",
            storageBucket: "outpost-8d74e.firebasestorage.app",
            messagingSenderId: "724993324937",
            appId: "1:724993324937:web:ce6c7e6b06489331c79358",
            measurementId: "G-QPHWRTH6BH"
        };

        // 初始化Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // 初始化LocalForage
        const dictionaryStorage = localforage.createInstance({
            name: 'thaiDictionaryCache',
            description: '泰语字典本地缓存'
        });

        // DOM元素
        const signinBtn = document.getElementById('signin-btn');
        const signoutBtn = document.getElementById('signout-btn');
        const userInfo = document.getElementById('user-info');
        const newWordsetBtn = document.getElementById('new-wordset-btn');
        const wordsetsList = document.getElementById('wordsets-list');
        const wordsetDetailView = document.getElementById('wordset-detail-view');
        const wordsetFormView = document.getElementById('wordset-form-view');
        const initialMessage = document.getElementById('initial-message');
        const wordsetForm = document.getElementById('wordset-form');
        const cancelFormBtn = document.getElementById('cancel-form-btn');
        const statusMessage = document.getElementById('status-message');
        const wordsetTitle = document.getElementById('wordset-title');
        const wordsetTitleEditInput = document.getElementById('wordset-title-edit-input');
        const wordCardsContainer = document.getElementById('word-cards-container');

        // 分类编辑元素
        const currentLevelSelect = document.getElementById('current-level');
        const currentScenarioSelect = document.getElementById('current-scenario');
        const updateClassificationBtn = document.getElementById('update-classification-btn');

        // 新建词汇集表单元素
        const wordsetLevelSelect = document.getElementById('wordset-level-select');
        const wordsetScenarioSelect = document.getElementById('wordset-scenario-select');

        // 操作按钮
        const exportAnkiBtn = document.getElementById('export-anki-btn');
        const createQuizBtn = document.getElementById('create-quiz-btn');
        const exportExcelBtn = document.getElementById('export-excel-btn');
        const printOutputBtn = document.getElementById('print-output-btn');

        // 模态对话框元素
        const dictionaryModal = document.getElementById('dictionary-modal');
        const dictionaryModalTitle = document.getElementById('dictionary-modal-title');
        const dictionaryModalBody = document.getElementById('dictionary-modal-body');
        const dictionaryModalClose = document.getElementById('dictionary-modal-close');

        // 过滤相关元素
        const searchTitleInput = document.getElementById('search-title');
        const filterLevelSelect = document.getElementById('filter-level');
        const filterScenarioSelect = document.getElementById('filter-scenario');
        const applyFiltersBtn = document.getElementById('apply-filters');
        const clearFiltersBtn = document.getElementById('clear-filters');
        // --- 新增：标签筛选 DOM ---
        const filterTagSelect = document.getElementById('filter-tag');

        // Anki导出模态对话框元素
        const ankiExportModal = document.getElementById('anki-export-modal');
        const ankiExportModalTitle = document.getElementById('anki-export-modal-title');
        const ankiExportModalBody = document.getElementById('anki-export-modal-body');
        const ankiExportModalClose = document.getElementById('anki-export-modal-close');

        // Quiz模态对话框元素
        const quizModal = document.getElementById('quiz-modal');
        const quizModalTitle = document.getElementById('quiz-modal-title');
        const quizModalBody = document.getElementById('quiz-modal-body');
        const quizModalClose = document.getElementById('quiz-modal-close');

        // Excel导出模态对话框元素
        const excelExportModal = document.getElementById('excel-export-modal');
        const excelExportModalTitle = document.getElementById('excel-export-modal-title');
        const excelExportModalBody = document.getElementById('excel-export-modal-body');
        const excelExportModalClose = document.getElementById('excel-export-modal-close');


        // --- 新增 DOM 元素引用 ---
        const addNewWordsInput = document.getElementById('add-new-words-input');
        const submitNewWordsBtn = document.getElementById('submit-new-words-btn');

        // --- 新增 DOM 元素引用 (Tags) ---
        const wordsetTagsInput = document.getElementById('wordset-tags-input'); // 新建时的输入框
        const currentTagsInput = document.getElementById('current-tags-input'); // 详情页的输入框
        const updateTagsBtn = document.getElementById('update-tags-btn');       // 更新按钮
        const tagsPreviewContainer = document.getElementById('tags-preview-container'); // 标签展示区

        // 当前选中的词汇集
        let currentWordsetId = null;
        let currentWordsetData = null;

        // 本地字典缓存
        let dictionaryCache = new Map();

        // 词汇集数据缓存
        let allWordsets = new Map();
        let filteredWordsets = new Map();

        // --- 新增：存储所有唯一标签 ---
        let allUniqueTags = new Set();

        // 分类数据缓存
        let classifications = new Map();
        let levelScenarios = new Map(); // 按级别组织的场景数据

        // 当前过滤条件
        let currentFilters = {
            searchTitle: '',
            level: '',
            scenario: ''
        };

        // API客户端
        class APIClient {
            constructor() {
                this.baseURL = 'http://localhost:3200';
            }

            async request(endpoint, options = {}) {
                const url = `${this.baseURL}${endpoint}`;
                const config = {
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    ...options
                };

                if (options.body && typeof options.body === 'object') {
                    config.body = JSON.stringify(options.body);
                }

                try {
                    const response = await fetch(url, config);

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    return data;
                } catch (error) {
                    console.error('API request failed:', error);
                    throw error;
                }
            }

            // 查询泰语单词
            async lookupThaiWord(word, service = 'gemini', userId = 'anonymous') {
                return this.request('/api/dictionary/lookup', {
                    method: 'POST',
                    body: { word, service, user_id: userId }
                });
            }

            // 查询泰语单词 V2 (针对 acron 服务，仅支持 Gemini)
            async lookupThaiWordV2(word, userId = 'anonymous') {
                const url = 'http://localhost:3334/api/dictionary/batch';
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ words: [word] }),
                    });

                    if (!response.ok) {
                        throw new Error(`Error: ${response.status} ${response.statusText}`);
                    }

                    const data = await response.json();
                    return data;
                } catch (error) {
                    console.error('Failed to query dictionary V2:', error);
                    throw error;
                }
            }
        }

        const apiClient = new APIClient();

        // 初始化应用
        document.addEventListener('DOMContentLoaded', function () {
            // 设置认证状态监听
            auth.onAuthStateChanged(handleAuthStateChange);

            // 绑定事件
            signinBtn.addEventListener('click', signIn);
            signoutBtn.addEventListener('click', signOut);
            newWordsetBtn.addEventListener('click', showWordsetForm);
            cancelFormBtn.addEventListener('click', hideWordsetForm);
            wordsetForm.addEventListener('submit', saveWordset);

            // 绑定分类编辑事件
            currentLevelSelect.addEventListener('change', updateScenarioOptions);
            wordsetLevelSelect.addEventListener('change', updateNewWordsetScenarioOptions);
            updateClassificationBtn.addEventListener('click', updateWordsetClassification);

            // 绑定操作按钮事件
            exportAnkiBtn.addEventListener('click', exportToAnki);
            createQuizBtn.addEventListener('click', createQuiz);
            exportExcelBtn.addEventListener('click', exportToExcel);
            printOutputBtn.addEventListener('click', printOutput);

            // 绑定模态对话框事件
            dictionaryModalClose.addEventListener('click', closeDictionaryModal);
            dictionaryModal.addEventListener('click', function (e) {
                if (e.target === dictionaryModal) {
                    closeDictionaryModal();
                }
            });

            // 绑定过滤事件
            applyFiltersBtn.addEventListener('click', applyFilters);
            clearFiltersBtn.addEventListener('click', clearFilters);
            searchTitleInput.addEventListener('input', debounce(applyFilters, 300));
            filterLevelSelect.addEventListener('change', updateFilterScenarioOptions);
            filterLevelSelect.addEventListener('change', applyFilters);
            filterScenarioSelect.addEventListener('change', applyFilters);
            // --- 新增 ---
            filterTagSelect.addEventListener('change', applyFilters);

            updateFilterScenarioOptions();
            applyFilters();
            ankiExportModalClose.addEventListener('click', closeAnkiExportModal);
            ankiExportModal.addEventListener('click', function (e) {
                if (e.target === ankiExportModal) {
                    closeAnkiExportModal();
                }
            });

            // 绑定Quiz模态对话框事件
            quizModalClose.addEventListener('click', closeQuizModal);
            quizModal.addEventListener('click', function (e) {
                if (e.target === quizModal) {
                    closeQuizModal();
                }
            });

            // 绑定Excel导出模态对话框事件
            excelExportModalClose.addEventListener('click', closeExcelExportModal);
            excelExportModal.addEventListener('click', function (e) {
                if (e.target === excelExportModal) {
                    closeExcelExportModal();
                }
            });

            // 标题编辑事件
            wordsetTitle.addEventListener('click', enterTitleEditMode);
            wordsetTitleEditInput.addEventListener('keydown', handleTitleEditKeydown);
            wordsetTitleEditInput.addEventListener('blur', function () {
                // 使用 setTimeout 延迟以允许 Enter 键保存先触发
                setTimeout(cancelTitleEdit, 200);
            });

            // 新增：绑定添加单词事件
            submitNewWordsBtn.addEventListener('click', addWordsToSet);

            // 绑定标签更新事件
            updateTagsBtn.addEventListener('click', updateWordsetTags);
        });

        // 处理认证状态变化
        function handleAuthStateChange(user) {
            if (user) {
                // 用户已登录
                signinBtn.style.display = 'none';
                signoutBtn.style.display = 'inline-block';
                userInfo.textContent = `欢迎, ${user.email}`;

                // 加载分类数据和词汇集
                loadClassifications();
                loadWordsets();
                initDictionaryCache();
            } else {
                // 用户未登录
                signinBtn.style.display = 'inline-block';
                signoutBtn.style.display = 'none';
                userInfo.textContent = '';
                wordsetsList.innerHTML = '';

                // 隐藏内容区
                hideWordsetDetail();
                hideWordsetForm();
                initialMessage.style.display = 'block';

                // 清空缓存
                /*
                dictionaryCache.clear();
                allWordsets.clear();
                filteredWordsets.clear();
                classifications.clear();
                levelScenarios.clear();
                */
            }
        }

        // 加载分类数据
        function loadClassifications() {
            database.ref('thaiWordList/metaWordList/classifications').once('value')
                .then((snapshot) => {
                    classifications.clear();
                    levelScenarios.clear();

                    if (snapshot.exists()) {
                        const classificationData = snapshot.val();
                        Object.keys(classificationData).forEach(classificationId => {
                            const classification = classificationData[classificationId];
                            classifications.set(classificationId, classification);

                            // 按级别组织场景数据
                            if (!levelScenarios.has(classification.level)) {
                                levelScenarios.set(classification.level, new Map());
                            }
                            levelScenarios.get(classification.level).set(classificationId, classification.scenario);
                        });

                        console.log(`已加载 ${classifications.size} 个分类`);

                        // 更新过滤器的场景选项
                        updateFilterScenarioOptions();
                    } else {
                        console.log('分类数据不存在');
                    }
                })
                .catch((error) => {
                    console.error('加载分类数据错误:', error);
                });
        }

        // 根据分类ID获取分类信息
        function getClassificationInfo(classificationId) {
            if (!classificationId || !classifications.has(classificationId)) {
                return {
                    level: '待定级',
                    scenario: '待分类'
                };
            }

            return classifications.get(classificationId);
        }

        // 根据级别和场景获取分类ID
        function getClassificationId(level, scenario) {
            for (const [id, classification] of classifications) {
                if (classification.level === level && classification.scenario === scenario) {
                    return id;
                }
            }
            return null;
        }

        // 更新过滤器的场景选项
        function updateFilterScenarioOptions() {
            const selectedLevel = filterLevelSelect.value;
            const currentScenario = filterScenarioSelect.value;

            filterScenarioSelect.innerHTML = '<option value="">所有场景</option>';

            if (selectedLevel && levelScenarios.has(selectedLevel)) {
                const scenarios = levelScenarios.get(selectedLevel);

                // 将场景Map转换为数组并按scenario字段排序
                const sortedScenarios = Array.from(scenarios.entries())
                    .sort((a, b) => a[1].localeCompare(b[1]));

                // 渲染排序后的选项
                sortedScenarios.forEach(([id, scenario]) => {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = scenario;
                    filterScenarioSelect.appendChild(option);
                });

                // 恢复之前选中的场景
                if (scenarios.has(currentScenario)) {
                    filterScenarioSelect.value = currentScenario;
                }
            }
        }

        // 更新场景选项（用于分类编辑）
        function updateScenarioOptions() {
            const selectedLevel = currentLevelSelect.value;
            const currentScenario = currentScenarioSelect.value;

            currentScenarioSelect.innerHTML = '<option value="">请选择场景</option>';

            if (selectedLevel && levelScenarios.has(selectedLevel)) {
                const scenarios = levelScenarios.get(selectedLevel);

                // 将场景Map转换为数组并按scenario字段排序
                const sortedScenarios = Array.from(scenarios.entries())
                    .sort((a, b) => a[1].localeCompare(b[1]));

                // 渲染排序后的选项
                sortedScenarios.forEach(([id, scenario]) => {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = scenario;
                    currentScenarioSelect.appendChild(option);
                });

                // 恢复之前选中的场景
                if (scenarios.has(currentScenario)) {
                    currentScenarioSelect.value = currentScenario;
                }
            }
        }

        // 更新新建词汇集的场景选项
        function updateNewWordsetScenarioOptions() {
            const selectedLevel = wordsetLevelSelect.value;

            wordsetScenarioSelect.innerHTML = '<option value="">请选择场景</option>';

            if (selectedLevel && levelScenarios.has(selectedLevel)) {
                const scenarios = levelScenarios.get(selectedLevel);

                // 将场景Map转换为数组并按scenario字段排序
                const sortedScenarios = Array.from(scenarios.entries())
                    .sort((a, b) => a[1].localeCompare(b[1]));

                // 渲染排序后的选项
                sortedScenarios.forEach(([id, scenario]) => {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = scenario;
                    wordsetScenarioSelect.appendChild(option);
                });
            }
        }

        // 获取今天的日期字符串（用于缓存键）
        function getTodayDateKey() {
            const today = new Date();
            return today.toISOString().split('T')[0]; // YYYY-MM-DD格式
        }

        // 初始化字典缓存
        async function initDictionaryCache() {
            console.log('[CACHE] 开始初始化字典缓存...');
            //const todayKey = getTodayDateKey();
            //const cacheKey = `dictionary_${todayKey}`;
            const cacheKey = 'dictionary_2025-12-03';

            try {
                console.log(`[CACHE] 检查本地存储缓存，键: ${cacheKey}`);

                // 首先检查本地存储中是否有今天的缓存
                const cachedData = await dictionaryStorage.getItem(cacheKey);

                if (cachedData) {
                    console.log('[CACHE] 从本地存储加载字典缓存');
                    dictionaryCache = new Map(Object.entries(cachedData));
                    console.log(`[CACHE] 字典缓存已加载，当前缓存 ${dictionaryCache.size} 个单词`);

                    // 设置增量监听
                    setupDictionaryListener();
                    return;
                }

                // 如果没有本地缓存，从Firebase加载
                console.log('[CACHE] 没有本地缓存，从Firebase加载字典数据...');
                const snapshot = await database.ref('thaiDictionary').once('value');

                if (snapshot.exists()) {
                    const dictionaryData = snapshot.val();
                    dictionaryCache.clear();

                    Object.keys(dictionaryData).forEach(word => {
                        dictionaryCache.set(word, dictionaryData[word]);
                    });

                    console.log(`[CACHE] 从Firebase加载了 ${dictionaryCache.size} 个单词`);

                    // 保存到本地存储
                    const cacheObject = Object.fromEntries(dictionaryCache);
                    await dictionaryStorage.setItem(cacheKey, cacheObject);

                    console.log(`[CACHE] 字典缓存已更新并保存到本地存储`);
                } else {
                    console.log('[CACHE] thaiDictionary路径下暂无数据');
                    // 初始化空缓存到本地存储
                    await dictionaryStorage.setItem(cacheKey, {});
                }

                // 设置增量监听
                setupDictionaryListener();

            } catch (error) {
                console.error('[CACHE] 初始化字典缓存错误:', error);
                console.error('[CACHE] 错误详情:', error.message, error.stack);
            }
        }

        // 设置字典数据实时监听
        function setupDictionaryListener() {
            console.log('设置字典数据实时监听...');

            // 监听新增的单词
            database.ref('thaiDictionary').on('child_added', (snapshot) => {
                const word = snapshot.key;
                const definition = snapshot.val();

                console.log(`[CACHE] 新增单词 "${word}" 添加到缓存`);
                dictionaryCache.set(word, definition);
                updateLocalStorageCache();
            });

            // 监听更新的单词
            database.ref('thaiDictionary').on('child_changed', (snapshot) => {
                const word = snapshot.key;
                const definition = snapshot.val();

                console.log(`[CACHE] 更新单词 "${word}" 的缓存`);
                dictionaryCache.set(word, definition);
                updateLocalStorageCache();
            });

            // 监听删除的单词
            database.ref('thaiDictionary').on('child_removed', (snapshot) => {
                const word = snapshot.key;

                console.log(`[CACHE] 删除单词 "${word}" 从缓存`);
                dictionaryCache.delete(word);
                updateLocalStorageCache();
            });

            console.log('字典数据实时监听已设置完成');
        }

        // 更新本地存储缓存（防抖处理）
        let storageUpdateTimeout;
        function updateLocalStorageCache() {
            clearTimeout(storageUpdateTimeout);
            storageUpdateTimeout = setTimeout(async () => {
                //const todayKey = getTodayDateKey();
                //const cacheKey = `dictionary_${todayKey}`;
                const cacheKey = 'dictionary_2025-12-03';
                const cacheObject = Object.fromEntries(dictionaryCache);

                try {
                    console.log(`[CACHE] 更新本地存储缓存，当前缓存 ${dictionaryCache.size} 个单词`);
                    await dictionaryStorage.setItem(cacheKey, cacheObject);
                    console.log(`[CACHE] 本地存储缓存更新完成`);
                } catch (error) {
                    console.error('[CACHE] 更新本地存储缓存错误:', error);
                }
            }, 2000); // 防抖延迟2秒
        }

        // 防抖函数
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // 应用过滤
        function applyFilters() {
            currentFilters = {
                searchTitle: searchTitleInput.value.toLowerCase(),
                level: filterLevelSelect.value,
                scenario: filterScenarioSelect.value,
                tag: filterTagSelect.value // --- 新增：获取标签筛选值 ---
            };

            filterWordsets();
        }

        // 清除过滤
        function clearFilters() {
            searchTitleInput.value = '';
            filterLevelSelect.value = '';
            filterScenarioSelect.value = '';
            filterTagSelect.value = ''; // --- 新增：清空标签筛选 ---

            currentFilters = {
                searchTitle: '',
                level: '',
                scenario: '',
                tag: '' // --- 新增 ---
            };

            filterWordsets();
        }

        // 过滤词汇集
        function filterWordsets() {
            filteredWordsets.clear();

            for (const [wordsetId, wordset] of allWordsets) {
                let matches = true;

                // 标题搜索过滤
                if (currentFilters.searchTitle) {
                    const title = wordset.分类title || '';
                    if (!title.toLowerCase().includes(currentFilters.searchTitle)) {
                        matches = false;
                    }
                }

                // 级别过滤
                if (currentFilters.level) {
                    const classificationInfo = getClassificationInfo(wordset.classification);
                    if (classificationInfo.level !== currentFilters.level) {
                        matches = false;
                    }
                }

                // 场景过滤
                if (currentFilters.scenario) {
                    if (wordset.classification !== currentFilters.scenario) {
                        matches = false;
                    }
                }

                // --- 新增：标签过滤逻辑 ---
                if (currentFilters.tag) {
                    // 如果词汇集没有标签，或者标签数组中不包含当前选中的标签
                    if (!wordset.tags || !Array.isArray(wordset.tags) || !wordset.tags.includes(currentFilters.tag)) {
                        matches = false;
                    }
                }

                if (matches) {
                    filteredWordsets.set(wordsetId, wordset);
                }
            }

            renderFilteredWordsets();
        }

        // 渲染过滤后的词汇集
        function renderFilteredWordsets() {
            wordsetsList.innerHTML = '';

            if (filteredWordsets.size === 0) {
                wordsetsList.innerHTML = '<div style="padding: 16px; text-align: center; color: var(--text-light);">没有找到匹配的词汇集</div>';
                return;
            }

            for (const [wordsetId, wordset] of filteredWordsets) {
                addWordsetToList(wordsetId, wordset);
            }
        }

        // 检查单词是否在字典中 (V5: 对接 acron 服务)
        async function checkAndFetchWordDefinition(word) {
            console.log(`[WORD CHECK] 开始检查单词 "${word}" (V5 - acron service)`);

            // 首先检查本地缓存
            if (dictionaryCache.has(word)) {
                console.log(`[WORD CHECK] 单词 "${word}" 已在字典缓存中`);
                return { exists: true, data: dictionaryCache.get(word) };
            }

            // 如果不在缓存中，通过 API V2 查询 (触发 acron 服务)
            console.log(`[WORD CHECK] 单词 "${word}" 不在字典中，通过 acron 服务查询...`);
            try {
                const currentUser = auth.currentUser;
                const userId = currentUser ? currentUser.uid : 'anonymous';

                console.log(`[API] 调用 acron 字典查询接口，单词: "${word}", 用户: ${userId}`);
                const result = await apiClient.lookupThaiWordV2(word, userId);

                // acron 服务的返回格式: { results: { "单词": { ... } }, stats: { ... } }
                if (result && result.results) {
                    console.log(`[API] 单词 "${word}" 已提交给 acron 服务`);

                    // acron 会异步或同步写入 Firebase，前端通过 setupDictionaryListener 自动同步。
                    // 这里我们提取 definition 如果它已经即时返回了。
                    const definition = result.results[word];

                    // 这里不再需要手动调用 database.ref(...).set(...) 或 dictionaryCache.set(...)
                    // 因为 setupDictionaryListener 会处理 Firebase 的实时推送。

                    return {
                        exists: !!definition,
                        data: definition || null,
                        newlyAdded: true
                    };
                } else {
                    console.warn(`[WORD CHECK] 单词 "${word}" acron 查询响应异常:`, result);
                    return { exists: false, data: null, error: 'acron 响应异常' };
                }
            } catch (error) {
                console.error(`[WORD CHECK] 单词 "${word}" acron 查询错误:`, error);
                return { exists: false, data: null, error: error.message };
            }
        }

        // 用户登录
        function signIn() {
            const provider = new firebase.auth.GoogleAuthProvider();
            provider.setCustomParameters({
                prompt: 'select_account'
            });

            auth.signInWithPopup(provider)
                .then((result) => {
                    showStatus('登录成功!', 'success');
                })
                .catch((error) => {
                    console.error('登录错误:', error);
                    showStatus('登录失败: ' + error.message, 'error');
                });
        }

        // 用户登出
        function signOut() {
            auth.signOut()
                .then(() => {
                    showStatus('已成功登出', 'success');
                })
                .catch((error) => {
                    console.error('登出错误:', error);
                });
        }

        // 加载词汇集列表
        function loadWordsets() {
            console.log('[LOAD] 开始加载词汇集列表...');
            wordsetsList.innerHTML = '<div style="padding: 20px; text-align: center;"><div class="loader"></div> 加载中...</div>';

            database.ref('thaiWordList').once('value')
                .then((snapshot) => {
                    console.log('[LOAD] Firebase数据加载完成');
                    allWordsets.clear();
                    filteredWordsets.clear();

                    if (!snapshot.exists()) {
                        console.log('[LOAD] 没有找到词汇集数据');
                        wordsetsList.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-light);">暂无词汇集</div>';
                        return;
                    }

                    const wordsets = snapshot.val();
                    console.log(`[LOAD] 从Firebase加载了 ${Object.keys(wordsets).length} 个词汇集`);

                    Object.keys(wordsets).forEach(wordsetId => {
                        // 跳过metaWordList路径
                        if (wordsetId === 'metaWordList') {
                            console.log('[LOAD] 跳过 metaWordList 路径');
                            return;
                        }

                        const wordset = wordsets[wordsetId];
                        console.log(`[LOAD] 处理词汇集 ${wordsetId}:`, wordset.分类title);
                        allWordsets.set(wordsetId, wordset);
                        filteredWordsets.set(wordsetId, wordset);
                    });

                    console.log(`[LOAD] 最终加载了 ${allWordsets.size} 个词汇集`);

                    // --- 新增：收集标签并更新下拉框 ---
                    collectUniqueTags();
                    updateTagFilterOptions();

                    // 渲染词汇集列表
                    renderFilteredWordsets();

                })
                .catch((error) => {
                    console.error('[LOAD] 加载词汇集错误:', error);
                    console.error('[LOAD] 错误详情:', error.message, error.stack);
                    wordsetsList.innerHTML = '<div style="padding: 20px; text-align: center; color: #ef4444;">加载词汇集失败</div>';
                });
        }

        // 添加词汇集到列表
        function addWordsetToList(wordsetId, wordset) {
            const wordsetItem = document.createElement('div');
            wordsetItem.className = 'wordset-item';
            wordsetItem.dataset.id = wordsetId;

            const classificationInfo = getClassificationInfo(wordset.classification);

            wordsetItem.innerHTML = `
                <div class="wordset-item-main">
                    <div class="wordset-name">${wordset.分类title || '未命名词汇集'}</div>
                    <div class="wordset-meta">
                        <span>${classificationInfo.level}</span>
                        <span>${classificationInfo.scenario}</span>
                    </div>
                </div>
                <div class="wordset-actions">
                    <button class="view">查看</button>
                    <button class="delete">删除</button>
                </div>
            `;

            // 绑定查看事件
            wordsetItem.querySelector('.view').addEventListener('click', (e) => {
                e.stopPropagation();
                showWordsetDetail(wordsetId, wordset);
            });

            // 绑定删除事件
            wordsetItem.querySelector('.delete').addEventListener('click', (e) => {
                e.stopPropagation();
                deleteWordset(wordsetId);
            });

            wordsetsList.appendChild(wordsetItem);
        }

        // 显示词汇集详情
        function showWordsetDetail(wordsetId, wordset) {
            currentWordsetId = wordsetId;
            currentWordsetData = wordset;

            // 更新UI
            document.getElementById('wordset-title').textContent = wordset.分类title || '未命名词汇集';
            document.getElementById('idCopyWordSetKey').textContent = wordsetId;

            // 更新分类编辑器
            updateClassificationEditor(wordset);

            // --- 新增：更新标签显示 ---
            updateTagsDisplay(wordset.tags || []);

            // 填充词汇卡片
            renderWordCards(wordset);

            // 显示详情视图
            hideWordsetForm();
            initialMessage.style.display = 'none';
            wordsetDetailView.style.display = 'block';

            // 高亮选中的词汇集
            document.querySelectorAll('.wordset-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.wordset-item[data-id="${wordsetId}"]`).classList.add('active');
        }

        // 更新分类编辑器
        function updateClassificationEditor(wordset) {
            const classificationInfo = getClassificationInfo(wordset.classification);

            // 设置当前级别
            currentLevelSelect.value = classificationInfo.level;

            // 更新场景选项
            updateScenarioOptions();

            // 设置当前场景
            if (wordset.classification && classifications.has(wordset.classification)) {
                currentScenarioSelect.value = wordset.classification;
            } else {
                currentScenarioSelect.value = '';
            }
        }

        // 更新词汇集分类
        function updateWordsetClassification() {
            const selectedLevel = currentLevelSelect.value;
            const selectedScenarioId = currentScenarioSelect.value;

            if (!selectedLevel || !selectedScenarioId) {
                showStatus('请选择级别和场景', 'error');
                return;
            }

            // 更新数据库
            database.ref(`thaiWordList/${currentWordsetId}/classification`).set(selectedScenarioId)
                .then(() => {
                    showStatus('分类更新成功', 'success');

                    // 更新本地缓存
                    if (allWordsets.has(currentWordsetId)) {
                        allWordsets.get(currentWordsetId).classification = selectedScenarioId;
                    }
                    if (filteredWordsets.has(currentWordsetId)) {
                        filteredWordsets.get(currentWordsetId).classification = selectedScenarioId;
                    }

                    // 更新UI显示
                    const wordsetItem = document.querySelector(`.wordset-item[data-id="${currentWordsetId}"]`);
                    if (wordsetItem) {
                        const classificationInfo = getClassificationInfo(selectedScenarioId);
                        const metaElements = wordsetItem.querySelectorAll('.wordset-meta span');
                        if (metaElements.length >= 2) {
                            metaElements[0].textContent = classificationInfo.level;
                            metaElements[1].textContent = classificationInfo.scenario;
                        }
                    }
                })
                .catch((error) => {
                    console.error('更新分类错误:', error);
                    showStatus('更新失败: ' + error.message, 'error');
                });
        }


        // 渲染词汇卡片
        // 渲染词汇卡片 (已更新：包含删除按钮)
        function renderWordCards(wordset) {
            wordCardsContainer.innerHTML = '';

            if (wordset.words && Array.isArray(wordset.words) && wordset.words.length > 0) {
                wordset.words.forEach((word, index) => {
                    const wordCard = document.createElement('div');
                    wordCard.className = 'word-card';

                    wordCard.innerHTML = `
                <div class="word-index">${index + 1}</div>
                <div class="word-card-header">
                    <div class="word-thai">${word}</div>
                    <div class="word-card-actions">
                        <button class="lookup-btn" title="查看释义" data-word="${word}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="11" cy="11" r="8"></circle>
                                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
                            </svg>
                        </button>
                        <button class="delete-word-btn" title="从列表中移除" data-index="${index}">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            `;

                    // 绑定字典查询事件
                    wordCard.querySelector('.lookup-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        showDictionaryDefinition(word);
                    });

                    // 绑定删除单词事件
                    wordCard.querySelector('.delete-word-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        deleteWordFromSet(index, word);
                    });

                    wordCardsContainer.appendChild(wordCard);
                });
            } else {
                wordCardsContainer.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: var(--text-light); padding: 40px;">暂无词汇，请在上方添加。</div>';
            }
        }

        // 从当前词汇集中删除单词
        function deleteWordFromSet(index, word) {
            if (!currentWordsetId || !currentWordsetData) return;

            if (confirm(`确定要从列表中移除单词 "${word}" 吗？`)) {
                // 创建新的单词数组副本
                const updatedWords = [...currentWordsetData.words];
                // 移除指定索引的单词
                updatedWords.splice(index, 1);

                // 更新 Firebase
                database.ref(`thaiWordList/${currentWordsetId}/words`).set(updatedWords)
                    .then(() => {
                        // 更新本地缓存
                        currentWordsetData.words = updatedWords;
                        if (allWordsets.has(currentWordsetId)) {
                            allWordsets.get(currentWordsetId).words = updatedWords;
                        }

                        showStatus(`已移除单词 "${word}"`, 'success');
                        // 重新渲染卡片
                        renderWordCards(currentWordsetData);
                    })
                    .catch((error) => {
                        console.error('删除单词失败:', error);
                        showStatus('删除失败: ' + error.message, 'error');
                    });
            }
        }

        // 向当前词汇集添加新单词
        async function addWordsToSet() {
            if (!currentWordsetId || !currentWordsetData) return;

            const input = document.getElementById('add-new-words-input');
            const btn = document.getElementById('submit-new-words-btn');
            const btnText = document.getElementById('add-btn-text');
            const wordsText = input.value;

            // 处理输入
            const newWordsRaw = wordsText.split('\n')
                .map(word => word.trim())
                .filter(word => word.length > 0);

            if (newWordsRaw.length === 0) {
                showStatus('请输入至少一个单词', 'error');
                return;
            }

            // 过滤掉已经在集合中的单词
            const existingWordsSet = new Set(currentWordsetData.words || []);
            const uniqueNewWords = newWordsRaw.filter(word => !existingWordsSet.has(word));

            if (uniqueNewWords.length === 0) {
                showStatus('所有输入的单词已存在于当前列表中', 'info');
                return;
            }

            // UI 进入加载状态
            input.disabled = true;
            btn.disabled = true;
            const originalBtnText = btnText.textContent;
            btnText.innerHTML = '<div class="loader" style="width: 14px; height: 14px; border-width: 2px;"></div> 处理中...';

            // 显示进度条容器
            showStatus(`正在处理 ${uniqueNewWords.length} 个新单词...`, 'info');
            const progressContainer = document.createElement('div');
            progressContainer.className = 'progress-container';
            const progressBar = document.createElement('div');
            progressBar.className = 'progress-bar';
            progressContainer.appendChild(progressBar);
            statusMessage.appendChild(progressContainer);

            let missingWords = 0;
            let processedWords = 0;

            try {
                // 1. 检查字典定义 (复用现有逻辑)
                for (const word of uniqueNewWords) {
                    console.log(`[ADD] 检查单词: "${word}"`);
                    const result = await checkAndFetchWordDefinition(word);

                    if (!result.exists && !result.error) {
                        missingWords++;
                    }

                    processedWords++;
                    const progress = (processedWords / uniqueNewWords.length) * 100;
                    progressBar.style.width = `${progress}%`;

                    // 小延迟避免请求过载
                    await new Promise(resolve => setTimeout(resolve, 100));
                }

                // 2. 合并旧单词和新单词
                const currentWords = currentWordsetData.words || [];
                const finalWords = [...currentWords, ...uniqueNewWords];

                // 3. 更新 Firebase
                await database.ref(`thaiWordList/${currentWordsetId}/words`).set(finalWords);

                // 4. 更新本地数据
                currentWordsetData.words = finalWords;
                if (allWordsets.has(currentWordsetId)) {
                    allWordsets.get(currentWordsetId).words = finalWords;
                }

                // 5. 成功反馈
                let msg = `成功添加 ${uniqueNewWords.length} 个单词！`;
                if (missingWords > 0) {
                    msg += ` (${missingWords} 个新词已触发AI查询)`;
                }
                showStatus(msg, 'success');

                // 清空输入框并重新渲染
                input.value = '';
                renderWordCards(currentWordsetData);

            } catch (error) {
                console.error('添加单词失败:', error);
                showStatus('添加失败: ' + error.message, 'error');
            } finally {
                // 恢复 UI 状态
                input.disabled = false;
                btn.disabled = false;
                btnText.textContent = originalBtnText;
            }
        }

        // 显示字典定义
        // 标题编辑相关函数
        function enterTitleEditMode() {
            if (!currentWordsetId) return;
            wordsetTitle.style.display = 'none';
            wordsetTitleEditInput.style.display = 'block';
            wordsetTitleEditInput.value = wordsetTitle.textContent;
            wordsetTitleEditInput.focus();
            wordsetTitleEditInput.select();
        }

        function cancelTitleEdit() {
            wordsetTitle.style.display = 'block';
            wordsetTitleEditInput.style.display = 'none';
        }

        function handleTitleEditKeydown(e) {
            if (e.key === 'Enter') {
                saveTitleUpdate();
            } else if (e.key === 'Escape') {
                cancelTitleEdit();
            }
        }

        function saveTitleUpdate() {
            const newTitle = wordsetTitleEditInput.value.trim();
            if (!newTitle) {
                showStatus('标题不能为空', 'error');
                return;
            }

            if (newTitle === wordsetTitle.textContent) {
                cancelTitleEdit();
                return;
            }

            database.ref(`thaiWordList/${currentWordsetId}/分类title`).set(newTitle)
                .then(() => {
                    wordsetTitle.textContent = newTitle;
                    if (allWordsets.has(currentWordsetId)) {
                        allWordsets.get(currentWordsetId).分类title = newTitle;
                    }
                    // 更新左侧列表中的标题
                    const wordsetItemContent = document.querySelector(`.wordset-item[data-id="${currentWordsetId}"] .wordset-name`);
                    if (wordsetItemContent) {
                        wordsetItemContent.textContent = newTitle;
                    }
                    cancelTitleEdit();
                    showStatus('标题更新成功', 'success');
                })
                .catch((error) => {
                    console.error('更新标题错误:', error);
                    showStatus('更新标题失败', 'error');
                });
        }

        function showDictionaryDefinition(word) {
            // 设置模态对话框标题
            dictionaryModalTitle.textContent = `"${word}" 的释义`;

            // 显示加载状态
            dictionaryModalBody.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="loader"></div> 加载中...</div>';

            // 显示模态对话框
            dictionaryModal.style.display = 'flex';

            // 查询单词定义
            if (dictionaryCache.has(word)) {
                const definition = dictionaryCache.get(word);
                renderDictionaryDefinition(definition);
            } else {
                // 如果不在缓存中，尝试从Firebase查询
                database.ref(`thaiDictionary/${word}`).once('value')
                    .then((snapshot) => {
                        if (snapshot.exists()) {
                            const definition = snapshot.val();
                            // 更新缓存
                            dictionaryCache.set(word, definition);
                            renderDictionaryDefinition(definition);
                        } else {
                            dictionaryModalBody.innerHTML = `
                                <div style="text-align: center; padding: 20px; color: var(--text-light);">
                                    <p>未找到单词 "${word}" 的释义</p>
                                    <p style="margin-top: 10px; font-size: 14px;">该单词可能尚未添加到字典中</p>
                                </div>
                            `;
                        }
                    })
                    .catch((error) => {
                        console.error('查询字典定义错误:', error);
                        dictionaryModalBody.innerHTML = `
                            <div style="text-align: center; padding: 20px; color: #ef4444;">
                                <p>查询单词释义时出错</p>
                                <p style="margin-top: 10px; font-size: 14px;">${error.message}</p>
                            </div>
                        `;
                    });
            }
        }

        // 渲染字典定义
        function renderDictionaryDefinition(definition) {
            let html = '';

            // 基本信息
            if (definition.thai) {
                html += `
                    <div class="definition-section">
                        <h3>基本信息</h3>
                        <div class="definition-item"><strong>单词:</strong> ${definition.thai.word || 'N/A'}</div>
                        <div class="definition-item"><strong>发音:</strong> ${definition.thai.pronunciation || 'N/A'}</div>
                        <div class="definition-item"><strong>拼写分解:</strong> ${definition.thai.spelling_breakdown || 'N/A'}</div>
                    </div>
                `;
            }

            // 词性
            if (definition.pos) {
                html += `
                    <div class="definition-section">
                        <h3>词性</h3>
                        <div class="definition-item">${definition.pos}</div>
                    </div>
                `;
            }

            // 定义
            if (definition.definitions && definition.definitions.length > 0) {
                html += `
                    <div class="definition-section">
                        <h3>定义</h3>
                        ${definition.definitions.map(def =>
                    `<div class="definition-item"><strong>${def.en || ''}</strong> - ${def.zh || ''}</div>`
                ).join('')}
                    </div>
                `;
            }

            // 同义词
            if (definition.synonyms && definition.synonyms.length > 0) {
                html += `
                    <div class="definition-section">
                        <h3>同义词</h3>
                        <div class="definition-item">${definition.synonyms.join(', ')}</div>
                    </div>
                `;
            }

            // 反义词
            if (definition.antonyms && definition.antonyms.length > 0) {
                html += `
                    <div class="definition-section">
                        <h3>反义词</h3>
                        <div class="definition-item">${definition.antonyms.join(', ')}</div>
                    </div>
                `;
            }

            // 常用短语
            if (definition.common_phrases && definition.common_phrases.length > 0) {
                html += `
                    <div class="definition-section">
                        <h3>常用短语</h3>
                        ${definition.common_phrases.map(phrase =>
                    `<div class="definition-item"><strong>${phrase.phrase || ''}</strong> - ${phrase.translation || ''}</div>`
                ).join('')}
                    </div>
                `;
            }

            // 语法说明
            if (definition.grammar_notes) {
                html += `
                    <div class="definition-section">
                        <h3>语法说明</h3>
                        <div class="definition-item">${definition.grammar_notes}</div>
                    </div>
                `;
            }

            // 级别和标签
            if (definition.level || definition.tags) {
                html += `
                    <div class="definition-section">
                        <h3>其他信息</h3>
                        ${definition.level ? `<div class="definition-item"><strong>级别:</strong> ${definition.level}</div>` : ''}
                        ${definition.tags ? `<div class="definition-item"><strong>标签:</strong> ${definition.tags.join(', ')}</div>` : ''}
                    </div>
                `;
            }

            dictionaryModalBody.innerHTML = html || '<div style="text-align: center; padding: 20px; color: var(--text-light);">暂无可用释义</div>';
        }

        // 关闭字典模态对话框
        function closeDictionaryModal() {
            dictionaryModal.style.display = 'none';
        }

        // 隐藏词汇集详情
        function hideWordsetDetail() {
            wordsetDetailView.style.display = 'none';
            document.querySelectorAll('.wordset-item').forEach(item => {
                item.classList.remove('active');
            });
            currentWordsetId = null;
            currentWordsetData = null;
        }

        // 显示词汇集表单
        function showWordsetForm() {
            hideWordsetDetail();
            initialMessage.style.display = 'none';
            wordsetFormView.style.display = 'block';
            wordsetForm.reset();
            // 确保标签输入框也被重置（虽然reset()通常会处理，但为了保险）
            if (document.getElementById('wordset-tags-input')) {
                document.getElementById('wordset-tags-input').value = '';
            }
            wordsetScenarioSelect.innerHTML = '<option value="">请先选择级别</option>';
        }

        // 隐藏词汇集表单
        function hideWordsetForm() {
            wordsetFormView.style.display = 'none';
            initialMessage.style.display = 'block';
        }

        // 保存词汇集
        async function saveWordset(e) {
            e.preventDefault();
            console.log('[WORDSAVE] 开始保存词汇集...');

            // 获取表单数据
            const title = document.getElementById('wordset-title-input').value;
            const level = document.getElementById('wordset-level-select').value;
            const scenarioId = document.getElementById('wordset-scenario-select').value;
            // --- 新增：获取标签数据 ---
            const tagsRaw = document.getElementById('wordset-tags-input').value;
            // --- 新增：处理标签数据 ---
            const tags = parseTagsInput(tagsRaw);

            const wordsText = document.getElementById('wordset-words-textarea').value;

            console.log(`[WORDSAVE] 表单数据 - 标题: "${title}", 级别: "${level}", 场景ID: "${scenarioId}"`);
            console.log(`[WORDSAVE] 词汇文本: "${wordsText.substring(0, 100)}..."`);

            // 处理词汇列表
            const words = wordsText.split('\n')
                .map(word => word.trim())
                .filter(word => word.length > 0);

            console.log(`[WORDSAVE] 处理后的词汇列表:`, words);

            if (words.length === 0) {
                console.warn('[WORDSAVE] 错误: 没有有效的词汇');
                showStatus('请输入至少一个词汇', 'error');
                return;
            }

            if (!level || !scenarioId) {
                console.warn('[WORDSAVE] 错误: 级别或场景未选择');
                showStatus('请选择级别和场景', 'error');
                return;
            }

            // 显示保存进度
            showStatus(`正在检查 ${words.length} 个单词的字典定义...`, 'info');

            // 创建进度条
            const progressContainer = document.createElement('div');
            progressContainer.className = 'progress-container';
            const progressBar = document.createElement('div');
            progressBar.className = 'progress-bar';
            progressContainer.appendChild(progressBar);
            statusMessage.appendChild(progressContainer);

            // 检查每个单词的字典定义
            let missingWords = 0;
            let processedWords = 0;

            console.log(`[WORDSAVE] 开始检查 ${words.length} 个单词的字典定义`);

            for (const word of words) {
                console.log(`[WORDSAVE] 检查单词 ${processedWords + 1}/${words.length}: "${word}"`);
                const result = await checkAndFetchWordDefinition(word);

                if (!result.exists && !result.error) {
                    missingWords++;
                    console.log(`[WORDSAVE] 单词 "${word}" 是新单词，已提交查询`);
                } else if (result.exists) {
                    console.log(`[WORDSAVE] 单词 "${word}" 已在字典中`);
                } else if (result.error) {
                    console.warn(`[WORDSAVE] 单词 "${word}" 查询失败:`, result.error);
                }

                processedWords++;
                const progress = (processedWords / words.length) * 100;
                progressBar.style.width = `${progress}%`;

                // 添加小延迟避免请求过于频繁
                await new Promise(resolve => setTimeout(resolve, 100));
            }

            console.log(`[WORDSAVE] 单词检查完成: 总计 ${words.length}, 新单词 ${missingWords}`);

            // 生成UUID
            const wordsetId = generateUUID();
            console.log(`[WORDSAVE] 生成的词汇集ID: ${wordsetId}`);

            // 创建词汇集对象
            const wordset = {
                "分类title": title,
                "classification": scenarioId,
                "words": words,
                "tags": tags, // --- 新增：保存标签字段 ---
                "createdAt": new Date().toISOString().split('T')[0] // YYYY-MM-DD格式
            };

            console.log('[WORDSAVE] 准备保存的词汇集对象:', wordset);

            try {
                console.log(`[WORDSAVE] 开始保存到Firebase路径: thaiWordList/${wordsetId}`);

                // 保存到Firebase
                await database.ref(`thaiWordList/${wordsetId}`).set(wordset);

                console.log('[WORDSAVE] Firebase保存成功');

                let message = '词汇集保存成功!';
                if (missingWords > 0) {
                    message += ` ${missingWords} 个新单词已提交AI查询。`;
                }

                console.log(`[WORDSAVE] 显示成功消息: ${message}`);
                showStatus(message, 'success');

                // 隐藏表单并刷新列表
                hideWordsetForm();
                console.log('[WORDSAVE] 隐藏表单，开始刷新词汇集列表...');
                loadWordsets();

            } catch (error) {
                console.error('[WORDSAVE] 保存词汇集错误:', error);
                console.error('[WORDSAVE] 错误详情:', error.message, error.stack);
                showStatus('保存失败: ' + error.message, 'error');
            }
        }

        // 删除词汇集
        function deleteWordset(wordsetId) {
            if (confirm('确定要删除这个词汇集吗？此操作不可撤销。')) {
                database.ref(`thaiWordList/${wordsetId}`).remove()
                    .then(() => {
                        showStatus('词汇集已删除', 'success');

                        // 从缓存中移除
                        allWordsets.delete(wordsetId);
                        filteredWordsets.delete(wordsetId);

                        // 如果当前显示的是被删除的词汇集，则隐藏详情
                        if (currentWordsetId === wordsetId) {
                            hideWordsetDetail();
                            initialMessage.style.display = 'block';
                        }

                        // 重新渲染列表
                        renderFilteredWordsets();

                        // 如果列表为空，显示提示
                        if (filteredWordsets.size === 0) {
                            wordsetsList.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-light);">暂无词汇集</div>';
                        }
                    })
                    .catch((error) => {
                        console.error('删除词汇集错误:', error);
                        showStatus('删除失败: ' + error.message, 'error');
                    });
            }
        }

        // 导出为Anki
        function exportToAnki() {
            showStatus('导出为Anki功能开发中...', 'info');
            // TODO: 实现导出为Anki的功能
        }

        // 创建Quiz
        function createQuiz() {
            if (!currentWordsetId || !currentWordsetData) {
                showStatus('请先选择一个词汇集', 'error');
                return;
            }

            if (!currentWordsetData.words || currentWordsetData.words.length === 0) {
                showStatus('该词汇集没有词汇，无法创建Quiz', 'error');
                return;
            }

            // 显示Quiz创建模态对话框
            showQuizModal();
        }

        // 显示Quiz创建模态对话框
        function showQuizModal() {
            quizModalTitle.textContent = '创建Quiz';

            // 将单词数组转换为逗号分隔的字符串
            const wordsString = currentWordsetData.words.join(', ');

            // 限制预览显示的长度
            const previewText = wordsString.length > 200 ?
                wordsString.substring(0, 200) + '...' :
                wordsString;

            quizModalBody.innerHTML = `
                <div class="quiz-info">
                    <h4>准备创建Quiz</h4>
                    <p><strong>词汇集:</strong> ${currentWordsetData.分类title || '未命名'}</p>
                    <p><strong>词汇数量:</strong> ${currentWordsetData.words.length}</p>
                </div>
                
                <div class="quiz-words-preview">
                    <strong>词汇列表预览:</strong><br>
                    ${previewText}
                </div>
                
                <div class="form-actions">
                    <button class="secondary" id="cancel-quiz-btn">取消</button>
                    <button class="primary" id="confirm-quiz-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;">
                            <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                            <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
                        </svg>
                        复制词汇并创建Quiz
                    </button>
                </div>
            `;

            // 绑定按钮事件
            document.getElementById('cancel-quiz-btn').addEventListener('click', closeQuizModal);
            document.getElementById('confirm-quiz-btn').addEventListener('click', copyWordsAndCreateQuiz);

            quizModal.style.display = 'flex';
        }

        // 复制词汇并创建Quiz
        async function copyWordsAndCreateQuiz() {
            const wordsString = currentWordsetData.words.join(', ');

            try {
                // 复制到剪贴板
                await navigator.clipboard.writeText(wordsString);

                // 显示成功状态
                showCopySuccess();

                // 延迟一下再打开新页面，让用户看到成功提示
                setTimeout(() => {
                    // 打开Quiz创建页面
                    window.open('promptAnywhereV2.html', '_blank');

                    // 关闭模态对话框
                    closeQuizModal();

                    // 显示成功状态消息
                    showStatus(`已复制 ${currentWordsetData.words.length} 个词汇到剪贴板，正在打开Quiz创建页面...`, 'success');
                }, 1000);

            } catch (error) {
                console.error('复制到剪贴板失败:', error);

                // 如果Clipboard API失败，使用备用方法
                if (copyToClipboardFallback(wordsString)) {
                    showCopySuccess();

                    setTimeout(() => {
                        window.open('/promptAnywhereV2.html', '_blank');
                        closeQuizModal();
                        showStatus(`已复制 ${currentWordsetData.words.length} 个词汇到剪贴板，正在打开Quiz创建页面...`, 'success');
                    }, 1000);
                } else {
                    showStatus('复制失败，请手动复制词汇: ' + wordsString, 'error');
                }
            }
        }

        // 显示复制成功状态
        function showCopySuccess() {
            const confirmBtn = document.getElementById('confirm-quiz-btn');
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 8px;">
                    <path d="M20 6L9 17l-5-5"></path>
                </svg>
                已复制，正在打开页面...
            `;

            // 在模态对话框中显示成功消息
            const successMessage = document.createElement('div');
            successMessage.className = 'copy-success';
            successMessage.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 6L9 17l-5-5"></path>
                </svg>
                成功复制 ${currentWordsetData.words.length} 个词汇到剪贴板
            `;

            const quizInfo = document.querySelector('.quiz-info');
            quizInfo.parentNode.insertBefore(successMessage, quizInfo.nextSibling);
        }

        // 备用复制方法（兼容旧浏览器）
        function copyToClipboardFallback(text) {
            try {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.left = '-999999px';
                textArea.style.top = '-999999px';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();

                const successful = document.execCommand('copy');
                document.body.removeChild(textArea);
                return successful;
            } catch (error) {
                console.error('备用复制方法失败:', error);
                return false;
            }
        }

        // 关闭Quiz模态对话框
        function closeQuizModal() {
            quizModal.style.display = 'none';
        }

        // 打印输出
        function printOutput() {
            showStatus('打印输出功能开发中...', 'info');
            // TODO: 实现打印输出的功能
        }

        // 导出为Excel
        function exportToExcel() {
            if (!currentWordsetId || !currentWordsetData) {
                showStatus('请先选择一个词汇集', 'error');
                return;
            }

            if (!currentWordsetData.words || currentWordsetData.words.length === 0) {
                showStatus('该词汇集没有词汇，无法导出Excel', 'error');
                return;
            }

            // 显示Excel导出配置模态对话框
            showExcelExportModal();
        }

        // 显示Excel导出配置模态对话框
        function showExcelExportModal() {
            excelExportModalTitle.textContent = '导出为Excel';

            // 计算预览信息
            const totalWords = currentWordsetData.words.length;
            const defaultGroupsPerPage = 2; // 默认每页2组
            const defaultDataRows = 33;

            // 计算每页可以容纳的单词数量
            const wordsPerPage = defaultGroupsPerPage * defaultDataRows;

            excelExportModalBody.innerHTML = `
        <div class="excel-preview">
            <h4>词汇集信息</h4>
            <div class="excel-preview-info">
                <div><strong>标题:</strong> ${currentWordsetData.分类title || '未命名'}</div>
                <div><strong>词汇数量:</strong> ${totalWords}</div>
                <div><strong>预计页数:</strong> ${Math.ceil(totalWords / wordsPerPage)}</div>
                <div><strong>每页单词:</strong> ${wordsPerPage}</div>
                <div><strong>每页布局:</strong> ${defaultGroupsPerPage}组 × ${defaultDataRows}行</div>
                <div><strong>填充方式:</strong> 列优先（先填满左边列）</div>
            </div>
        </div>
        
        <div class="excel-form">
            <div class="form-group">
                <label for="groups-per-page">每页组数</label>
                <input type="number" id="groups-per-page" min="1" max="10" value="${defaultGroupsPerPage}">
                <small style="color: var(--text-light);">每组包含泰语和英语两列</small>
            </div>
            
            <div class="form-group">
                <label for="data-rows">每组数据行数</label>
                <input type="number" id="data-rows" min="5" max="50" value="${defaultDataRows}">
                <small style="color: var(--text-light);">每组最多显示的行数（单词数量）</small>
            </div>
            
            <div class="form-group">
                <label for="include-definitions">包含英语释义</label>
                <input type="checkbox" id="include-definitions" checked>
                <small style="color: var(--text-light);">如果不勾选，英语列将为空</small>
            </div>
        </div>
        
        <div class="form-actions">
            <button class="secondary" id="cancel-excel-export-btn">取消</button>
            <button class="primary" id="generate-excel-btn">生成Excel</button>
        </div>
    `;

            // 使用事件委托来绑定按钮事件
            excelExportModalBody.addEventListener('click', function (e) {
                if (e.target.id === 'cancel-excel-export-btn') {
                    closeExcelExportModal();
                } else if (e.target.id === 'generate-excel-btn') {
                    generateExcel();
                }
            });

            // 绑定输入变化事件来更新预览
            const updateInputs = () => {
                const inputs = ['groups-per-page', 'data-rows'];
                inputs.forEach(inputId => {
                    const input = document.getElementById(inputId);
                    if (input) {
                        input.addEventListener('input', updateExcelPreview);
                    }
                });
            };

            // 使用setTimeout确保DOM已经更新
            setTimeout(updateInputs, 0);

            // 初始更新预览
            setTimeout(updateExcelPreview, 10);

            excelExportModal.style.display = 'flex';
        }

        /*
        // 更新Excel预览信息
        function updateExcelPreview() {
            const groupsPerPage = parseInt(document.getElementById('groups-per-page').value) || 5;
            const headerRows = parseInt(document.getElementById('header-rows').value) || 1;
            const dataRows = parseInt(document.getElementById('data-rows').value) || 10;
            
            const totalWords = currentWordsetData.words.length;
            const wordsPerPage = groupsPerPage * 2 * dataRows;
            const totalPages = Math.ceil(totalWords / wordsPerPage);
            
            const previewInfo = document.querySelector('.excel-preview-info');
            if (previewInfo) {
                previewInfo.innerHTML = `
                    <div><strong>标题:</strong> ${currentWordsetData.分类title || '未命名'}</div>
                    <div><strong>词汇数量:</strong> ${totalWords}</div>
                    <div><strong>预计页数:</strong> ${totalPages}</div>
                    <div><strong>每页单词:</strong> ${wordsPerPage}</div>
                `;
            }
        }
        */

        // 更新Excel预览信息
        function updateExcelPreview() {
            const groupsPerPage = parseInt(document.getElementById('groups-per-page')?.value) || 2;
            const dataRows = parseInt(document.getElementById('data-rows')?.value) || 33;

            const totalWords = currentWordsetData.words.length;
            const wordsPerPage = groupsPerPage * dataRows;
            const totalPages = Math.ceil(totalWords / wordsPerPage);

            const previewInfo = document.querySelector('.excel-preview-info');
            if (previewInfo) {
                previewInfo.innerHTML = `
            <div><strong>标题:</strong> ${currentWordsetData.分类title || '未命名'}</div>
            <div><strong>词汇数量:</strong> ${totalWords}</div>
            <div><strong>预计页数:</strong> ${totalPages}</div>
            <div><strong>每页单词:</strong> ${wordsPerPage}</div>
            <div><strong>每页布局:</strong> ${groupsPerPage}组 × ${dataRows}行</div>
            <div><strong>填充方式:</strong> 列优先（先填满左边列）</div>
        `;
            }
        }


        /*
        // 生成Excel文件
        async function generateExcel() {
            const groupsPerPage = parseInt(document.getElementById('groups-per-page').value) || 5;
            const headerRows = parseInt(document.getElementById('header-rows').value) || 1;
            const dataRows = parseInt(document.getElementById('data-rows').value) || 10;
            const includeDefinitions = document.getElementById('include-definitions').checked;
            
            // 显示生成状态
            const generateBtn = document.getElementById('generate-excel-btn');
            const originalText = generateBtn.textContent;
            generateBtn.innerHTML = '<div class="loader" style="width: 16px; height: 16px; margin-right: 8px;"></div>生成中...';
            generateBtn.disabled = true;
            
            try {
                // 创建工作簿
                const workbook = new ExcelJS.Workbook();
                workbook.creator = '泰语词汇集管理工具';
                workbook.created = new Date();
                
                const totalWords = currentWordsetData.words.length;
                const wordsPerPage = groupsPerPage * 2 * dataRows;
                const totalPages = Math.ceil(totalWords / wordsPerPage);
                
                // 逐页创建工作表
                for (let page = 0; page < totalPages; page++) {
                    const worksheet = workbook.addWorksheet(`词汇表_${page + 1}`);
                    
                    // 计算当前页的单词范围
                    const startIndex = page * wordsPerPage;
                    const endIndex = Math.min(startIndex + wordsPerPage, totalWords);
                    const pageWords = currentWordsetData.words.slice(startIndex, endIndex);
                    
                    // 设置列宽
                    for (let i = 0; i < groupsPerPage * 2; i++) {
                        worksheet.getColumn(i + 1).width = 20;
                    }
                    
                    // 添加表头
                    for (let group = 0; group < groupsPerPage; group++) {
                        const thaiCol = group * 2 + 1;
                        const englishCol = group * 2 + 2;
                        
                        // 泰语表头
                        const thaiHeaderCell = worksheet.getCell(1, thaiCol);
                        thaiHeaderCell.value = '泰语';
                        thaiHeaderCell.font = { bold: true };
                        thaiHeaderCell.fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: 'FFE6E6FA' }
                        };
                        thaiHeaderCell.border = {
                            top: { style: 'thin' },
                            left: { style: 'thin' },
                            bottom: { style: 'thin' },
                            right: { style: 'thin' }
                        };
                        
                        // 英语表头
                        const englishHeaderCell = worksheet.getCell(1, englishCol);
                        englishHeaderCell.value = '英语';
                        englishHeaderCell.font = { bold: true };
                        englishHeaderCell.fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: 'FFE6E6FA' }
                        };
                        englishHeaderCell.border = {
                            top: { style: 'thin' },
                            left: { style: 'thin' },
                            bottom: { style: 'thin' },
                            right: { style: 'thin' }
                        };
                    }
                    
                    // 添加数据行
                    for (let row = 0; row < dataRows; row++) {
                        const dataRow = row + 2; // 表头在第1行，数据从第2行开始
                        
                        for (let group = 0; group < groupsPerPage; group++) {
                            const wordIndex = row * groupsPerPage + group;
                            const absoluteIndex = startIndex + wordIndex;
                            
                            if (absoluteIndex < endIndex) {
                                const word = pageWords[wordIndex];
                                const thaiCol = group * 2 + 1;
                                const englishCol = group * 2 + 2;
                                
                                // 泰语单词
                                const thaiCell = worksheet.getCell(dataRow, thaiCol);
                                thaiCell.value = word;
                                thaiCell.border = {
                                    top: { style: 'thin' },
                                    left: { style: 'thin' },
                                    bottom: { style: 'thin' },
                                    right: { style: 'thin' }
                                };
                                
                                // 英语释义
                                const englishCell = worksheet.getCell(dataRow, englishCol);
                                if (includeDefinitions) {
                                    // 尝试从字典缓存获取英语释义
                                    let englishDefinition = '';
                                    if (dictionaryCache.has(word)) {
                                        const definition = dictionaryCache.get(word);
                                        if (definition.definitions && definition.definitions.length > 0) {
                                            englishDefinition = definition.definitions[0].en || '';
                                        }
                                    }
                                    englishCell.value = englishDefinition;
                                }
                                englishCell.border = {
                                    top: { style: 'thin' },
                                    left: { style: 'thin' },
                                    bottom: { style: 'thin' },
                                    right: { style: 'thin' }
                                };
                            }
                        }
                    }
                }
                
                // 生成Excel文件并下载
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${currentWordsetData.分类title || '泰语词汇'}_${new Date().toISOString().split('T')[0]}.xlsx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showStatus('Excel文件生成成功！', 'success');
                closeExcelExportModal();
                
            } catch (error) {
                console.error('生成Excel错误:', error);
                showStatus('生成Excel失败: ' + error.message, 'error');
            } finally {
                // 恢复按钮状态
                generateBtn.textContent = originalText;
                generateBtn.disabled = false;
            }
        }
        */
        // 生成Excel文件
        async function generateExcel() {
            const groupsPerPage = parseInt(document.getElementById('groups-per-page')?.value) || 2;
            const dataRows = parseInt(document.getElementById('data-rows')?.value) || 33;
            const includeDefinitions = document.getElementById('include-definitions')?.checked;

            console.log(`Excel生成设置: 包含英语释义 = ${includeDefinitions}`);

            // 显示生成状态
            const generateBtn = document.getElementById('generate-excel-btn');
            if (generateBtn) {
                const originalText = generateBtn.textContent;
                generateBtn.innerHTML = '<div class="loader" style="width: 16px; height: 16px; margin-right: 8px;"></div>生成中...';
                generateBtn.disabled = true;
            }

            try {
                // 创建工作簿
                const workbook = new ExcelJS.Workbook();
                workbook.creator = '泰语词汇集管理工具';
                workbook.created = new Date();

                const totalWords = currentWordsetData.words.length;
                const wordsPerPage = groupsPerPage * dataRows;
                const totalPages = Math.ceil(totalWords / wordsPerPage);

                console.log(`Excel生成参数: 每页${groupsPerPage}组, 每组${dataRows}行, 每页${wordsPerPage}个单词, 共${totalPages}页`);

                // 逐页创建工作表
                for (let page = 0; page < totalPages; page++) {
                    const worksheet = workbook.addWorksheet(`词汇表_${page + 1}`);

                    // 计算当前页的单词范围
                    const startIndex = page * wordsPerPage;
                    const endIndex = Math.min(startIndex + wordsPerPage, totalWords);
                    const pageWords = currentWordsetData.words.slice(startIndex, endIndex);

                    console.log(`第${page + 1}页: 单词${startIndex + 1}-${endIndex}, 共${pageWords.length}个单词`);

                    // 设置列宽
                    for (let i = 0; i < groupsPerPage * 2; i++) {
                        worksheet.getColumn(i + 1).width = 20;
                    }

                    // 添加表头（每页都有表头）- 无论是否包含英语释义都要显示表头
                    for (let group = 0; group < groupsPerPage; group++) {
                        const thaiCol = group * 2 + 1;
                        const englishCol = group * 2 + 2;

                        // 泰语表头
                        const thaiHeaderCell = worksheet.getCell(1, thaiCol);
                        thaiHeaderCell.value = '泰语';
                        thaiHeaderCell.font = { bold: true };
                        thaiHeaderCell.fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: 'FFE6E6FA' }
                        };
                        thaiHeaderCell.border = {
                            top: { style: 'thin' },
                            left: { style: 'thin' },
                            bottom: { style: 'thin' },
                            right: { style: 'thin' }
                        };
                        thaiHeaderCell.alignment = { horizontal: 'center' };

                        // 英语表头 - 无论是否包含英语释义都要显示，但内容可以留空
                        const englishHeaderCell = worksheet.getCell(1, englishCol);
                        englishHeaderCell.value = includeDefinitions ? '英语' : ''; // 如果不包含英语释义，表头留空
                        englishHeaderCell.font = { bold: true };
                        englishHeaderCell.fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: 'FFE6E6FA' }
                        };
                        englishHeaderCell.border = {
                            top: { style: 'thin' },
                            left: { style: 'thin' },
                            bottom: { style: 'thin' },
                            right: { style: 'thin' }
                        };
                        englishHeaderCell.alignment = { horizontal: 'center' };
                    }

                    // 按列优先填充数据
                    for (let group = 0; group < groupsPerPage; group++) {
                        const thaiCol = group * 2 + 1;
                        const englishCol = group * 2 + 2;

                        // 对于当前组，计算应该填充的单词
                        for (let row = 0; row < dataRows; row++) {
                            const dataRow = row + 2; // 表头在第1行，数据从第2行开始

                            // 计算单词索引：列优先，即先填满第一列，再填第二列
                            const wordIndex = row * groupsPerPage + group;

                            if (wordIndex < pageWords.length) {
                                const word = pageWords[wordIndex];

                                // 泰语单词
                                const thaiCell = worksheet.getCell(dataRow, thaiCol);
                                thaiCell.value = word;
                                thaiCell.border = {
                                    top: { style: 'thin' },
                                    left: { style: 'thin' },
                                    bottom: { style: 'thin' },
                                    right: { style: 'thin' }
                                };

                                // 英语单元格 - 无论是否包含英语释义都要创建，保持格子结构
                                const englishCell = worksheet.getCell(dataRow, englishCol);
                                if (includeDefinitions) {
                                    // 如果包含英语释义，填充内容
                                    let englishDefinition = '';
                                    if (dictionaryCache.has(word)) {
                                        const definition = dictionaryCache.get(word);
                                        if (definition.definitions && definition.definitions.length > 0) {
                                            englishDefinition = definition.definitions[0].en || '';
                                        }
                                    }
                                    englishCell.value = englishDefinition;
                                } else {
                                    // 如果不包含英语释义，单元格留空，但保留边框作为书写格子
                                    englishCell.value = '';
                                }
                                // 始终保持边框
                                englishCell.border = {
                                    top: { style: 'thin' },
                                    left: { style: 'thin' },
                                    bottom: { style: 'thin' },
                                    right: { style: 'thin' }
                                };
                            } else {
                                // 对于超出单词数量的空单元格，也要创建边框
                                const thaiCell = worksheet.getCell(dataRow, thaiCol);
                                thaiCell.value = '';
                                thaiCell.border = {
                                    top: { style: 'thin' },
                                    left: { style: 'thin' },
                                    bottom: { style: 'thin' },
                                    right: { style: 'thin' }
                                };

                                const englishCell = worksheet.getCell(dataRow, englishCol);
                                englishCell.value = '';
                                englishCell.border = {
                                    top: { style: 'thin' },
                                    left: { style: 'thin' },
                                    bottom: { style: 'thin' },
                                    right: { style: 'thin' }
                                };
                            }
                        }
                    }

                    console.log(`第${page + 1}页完成`);
                }

                // 生成Excel文件并下载
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;

                // 根据是否包含英语释义来设置文件名
                const fileNameSuffix = includeDefinitions ? '' : '_仅泰语';
                a.download = `${currentWordsetData.分类title || '泰语词汇'}${fileNameSuffix}_${new Date().toISOString().split('T')[0]}.xlsx`;

                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showStatus('Excel文件生成成功！', 'success');
                closeExcelExportModal();

            } catch (error) {
                console.error('生成Excel错误:', error);
                showStatus('生成Excel失败: ' + error.message, 'error');
            } finally {
                // 恢复按钮状态
                const generateBtn = document.getElementById('generate-excel-btn');
                if (generateBtn) {
                    generateBtn.textContent = '生成Excel';
                    generateBtn.disabled = false;
                }
            }
        }


        // 关闭Excel导出模态对话框
        function closeExcelExportModal() {
            excelExportModal.style.display = 'none';
        }

        // 初始化手风琴效果


        // 导出为Anki
        function exportToAnki() {
            if (!currentWordsetId || !currentWordsetData) {
                showStatus('请先选择一个词汇集', 'error');
                return;
            }

            // 检查是否已经发布过
            if (currentWordsetData.reviewSetID) {
                showAlreadyPublishedModal();
                return;
            }

            // 显示发布模态对话框
            showAnkiExportModal();
        }

        // 显示已发布提示模态对话框
        function showAlreadyPublishedModal() {
            ankiExportModalTitle.textContent = '词汇集已发布';

            const reviewSetURL = `https://outpost-dictionary-116208.asia-southeast1.firebasedatabase.app/thaiAnki/reviewSets/${currentWordsetData.reviewSetID}.json`;

            ankiExportModalBody.innerHTML = `
                <div class="already-published">
                    <h4>此词汇集已发布到Anki</h4>
                    <p>该词汇集已经发布过，无需重复发布。</p>
                    <p><strong>Review Set ID:</strong> ${currentWordsetData.reviewSetID}</p>
                    <a href="${reviewSetURL}" target="_blank" class="review-set-link">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                            <polyline points="15 3 21 3 21 9"></polyline>
                            <line x1="10" y1="14" x2="21" y2="3"></line>
                        </svg>
                        查看Review Set数据
                    </a>
                </div>
                <div class="form-actions">
                    <button class="secondary" id="close-already-published-btn">关闭</button>
                </div>
            `;

            // 绑定关闭按钮事件
            document.getElementById('close-already-published-btn').addEventListener('click', closeAnkiExportModal);

            ankiExportModal.style.display = 'flex';
        }

        // 显示Anki导出模态对话框
        function showAnkiExportModal() {
            ankiExportModalTitle.textContent = '发布到Anki';

            // 获取默认日期（今天）
            const today = new Date();
            const defaultDate = formatDateForAnki(today);
            const minDate = formatDateForInput(today);

            // 计算默认的下次复习日期（7天后）
            const nextReviewDate = new Date(today);
            nextReviewDate.setDate(today.getDate() + 7);
            const defaultNextReview = formatDateForInput(nextReviewDate);

            ankiExportModalBody.innerHTML = `
                <div class="anki-form">
                    <div class="form-group">
                        <label for="anki-title-input">Review Set 标题</label>
                        <input type="text" id="anki-title-input" value="${currentWordsetData.分类title || '未命名'} - ${formatDateForAnki(today)}" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="anki-next-review-input">下次复习日期</label>
                        <input type="date" id="anki-next-review-input" value="${defaultNextReview}" min="${minDate}" required>
                    </div>
                    
                    <div class="form-group">
                        <label>词汇集信息</label>
                        <div style="background-color: var(--hover-color); padding: 12px; border-radius: var(--radius); font-size: 14px;">
                            <p><strong>标题:</strong> ${currentWordsetData.分类title || '未命名'}</p>
                            <p><strong>词汇数量:</strong> ${currentWordsetData.words ? currentWordsetData.words.length : 0}</p>
                            <p><strong>创建日期:</strong> ${currentWordsetData.createdAt || '未知'}</p>
                        </div>
                    </div>
                </div>
                <div class="form-actions">
                    <button class="secondary" id="cancel-anki-export-btn">取消</button>
                    <button class="primary" id="confirm-anki-export-btn">发布到Anki</button>
                </div>
            `;

            // 绑定按钮事件
            document.getElementById('cancel-anki-export-btn').addEventListener('click', closeAnkiExportModal);
            document.getElementById('confirm-anki-export-btn').addEventListener('click', createReviewSet);

            ankiExportModal.style.display = 'flex';
        }

        // 创建Review Set
        async function createReviewSet() {
            const titleInput = document.getElementById('anki-title-input');
            const nextReviewInput = document.getElementById('anki-next-review-input');

            const title = titleInput.value.trim();
            const nextReviewDate = nextReviewInput.value;

            if (!title) {
                showStatus('请输入Review Set标题', 'error');
                titleInput.focus();
                return;
            }

            if (!nextReviewDate) {
                showStatus('请选择下次复习日期', 'error');
                nextReviewInput.focus();
                return;
            }

            // 生成short UUID
            const reviewSetId = generateShortUUID();

            // 格式化日期
            const today = new Date();
            const createdAt = formatDateForAnki(today);
            const nextReview = formatDateForAnki(new Date(nextReviewDate));

            // 构建wordSetURL
            const wordSetURL = `https://outpost-dictionary-116208.asia-southeast1.firebasedatabase.app/thaiWordList/${currentWordsetId}.json`;

            // 创建reviewSet数据
            const reviewSet = {
                createdAt: createdAt,
                nextReview: nextReview,
                title: title,
                wordSetID: currentWordsetId,
                wordSetURL: wordSetURL
            };

            try {
                // 显示加载状态
                const confirmBtn = document.getElementById('confirm-anki-export-btn');
                const originalText = confirmBtn.textContent;
                confirmBtn.innerHTML = '<div class="loader" style="width: 16px; height: 16px; margin-right: 8px;"></div>发布中...';
                confirmBtn.disabled = true;

                // 保存reviewSet到数据库
                await database.ref(`thaiAnki/reviewSets/${reviewSetId}`).set(reviewSet);

                // 更新wordSet的reviewSetID字段
                await database.ref(`thaiWordList/${currentWordsetId}/reviewSetID`).set(reviewSetId);

                // 更新本地缓存
                if (allWordsets.has(currentWordsetId)) {
                    allWordsets.get(currentWordsetId).reviewSetID = reviewSetId;
                }
                if (filteredWordsets.has(currentWordsetId)) {
                    filteredWordsets.get(currentWordsetId).reviewSetID = reviewSetId;
                }
                currentWordsetData.reviewSetID = reviewSetId;

                // 显示成功消息
                showAnkiExportSuccessModal(reviewSetId, reviewSet);

            } catch (error) {
                console.error('创建Review Set错误:', error);
                showStatus('发布失败: ' + error.message, 'error');

                // 恢复按钮状态
                const confirmBtn = document.getElementById('confirm-anki-export-btn');
                confirmBtn.textContent = originalText;
                confirmBtn.disabled = false;
            }
        }

        // 显示Anki导出成功模态对话框
        function showAnkiExportSuccessModal(reviewSetId, reviewSet) {
            ankiExportModalTitle.textContent = '发布成功';

            const reviewSetURL = `https://outpost-dictionary-116208.asia-southeast1.firebasedatabase.app/thaiAnki/reviewSets/${reviewSetId}.json`;

            ankiExportModalBody.innerHTML = `
                <div class="already-published" style="background-color: #f0fdf4; border-color: #bbf7d0;">
                    <h4 style="color: #166534;">发布成功！</h4>
                    <p>词汇集已成功发布到Anki系统。</p>
                    <p><strong>Review Set ID:</strong> ${reviewSetId}</p>
                    <p><strong>标题:</strong> ${reviewSet.title}</p>
                    <p><strong>创建时间:</strong> ${reviewSet.createdAt}</p>
                    <p><strong>下次复习:</strong> ${reviewSet.nextReview}</p>
                    <a href="${reviewSetURL}" target="_blank" class="review-set-link">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                            <polyline points="15 3 21 3 21 9"></polyline>
                            <line x1="10" y1="14" x2="21" y2="3"></line>
                        </svg>
                        查看Review Set数据
                    </a>
                </div>
                <div class="form-actions">
                    <button class="primary" id="close-success-btn">完成</button>
                </div>
            `;

            // 绑定关闭按钮事件
            document.getElementById('close-success-btn').addEventListener('click', closeAnkiExportModal);
        }

        // 关闭Anki导出模态对话框
        function closeAnkiExportModal() {
            ankiExportModal.style.display = 'none';
        }

        // --- 新增功能函数 ---

        // 1. 解析标签输入字符串 (支持中英文逗号)
        function parseTagsInput(inputString) {
            if (!inputString) return [];
            return inputString
                .split(/[,，]/) // 同时支持英文逗号和中文逗号
                .map(tag => tag.trim()) // 去除首尾空格
                .filter(tag => tag.length > 0); // 去除空标签
        }

        // 2. 在详情页显示和填充标签
        function updateTagsDisplay(tags) {
            // 填充输入框
            if (currentTagsInput) {
                currentTagsInput.value = tags.join(', ');
            }

            // 渲染标签 Chip
            if (tagsPreviewContainer) {
                tagsPreviewContainer.innerHTML = '';
                if (tags && tags.length > 0) {
                    tags.forEach(tag => {
                        const chip = document.createElement('span');
                        chip.className = 'tag-chip';
                        chip.textContent = tag;
                        tagsPreviewContainer.appendChild(chip);
                    });
                } else {
                    tagsPreviewContainer.innerHTML = '<span style="color: var(--text-light); font-size: 13px;">暂无标签</span>';
                }
            }
        }

        // 3. 更新当前词汇集的标签 (保存到 Firebase)
        function updateWordsetTags() {
            if (!currentWordsetId || !currentWordsetData) return;

            const tagsRaw = currentTagsInput.value;
            const newTags = parseTagsInput(tagsRaw);

            // 更新按钮状态显示加载中
            const originalBtnText = updateTagsBtn.textContent;
            updateTagsBtn.disabled = true;
            updateTagsBtn.textContent = '保存中...';

            database.ref(`thaiWordList/${currentWordsetId}/tags`).set(newTags)
                .then(() => {
                    showStatus('标签更新成功', 'success');

                    // 更新本地缓存
                    currentWordsetData.tags = newTags;
                    if (allWordsets.has(currentWordsetId)) {
                        allWordsets.get(currentWordsetId).tags = newTags;
                    }
                    if (filteredWordsets.has(currentWordsetId)) {
                        filteredWordsets.get(currentWordsetId).tags = newTags;
                    }

                    // 重新渲染显示
                    updateTagsDisplay(newTags);

                    // --- 新增：更新全局标签缓存并刷新左侧筛选器 ---
                    collectUniqueTags();
                    updateTagFilterOptions();
                })
                .catch((error) => {
                    console.error('更新标签错误:', error);
                    showStatus('更新标签失败: ' + error.message, 'error');
                })
                .finally(() => {
                    // 恢复按钮状态
                    updateTagsBtn.disabled = false;
                    updateTagsBtn.textContent = originalBtnText;
                });
        }

        // --- 新增：标签筛选辅助函数 ---

        // 1. 遍历所有词汇集收集唯一标签
        function collectUniqueTags() {
            allUniqueTags.clear();
            for (const [id, wordset] of allWordsets) {
                if (wordset.tags && Array.isArray(wordset.tags)) {
                    wordset.tags.forEach(tag => {
                        if (tag && tag.trim()) {
                            allUniqueTags.add(tag.trim());
                        }
                    });
                }
            }
        }

        // 2. 更新标签过滤下拉框选项
        function updateTagFilterOptions() {
            const currentSelection = filterTagSelect.value;

            // 保留默认选项
            filterTagSelect.innerHTML = '<option value="">所有标签</option>';

            // 排序并添加选项
            const sortedTags = Array.from(allUniqueTags).sort((a, b) => a.localeCompare(b, 'zh-CN'));

            sortedTags.forEach(tag => {
                const option = document.createElement('option');
                option.value = tag;
                option.textContent = tag;
                filterTagSelect.appendChild(option);
            });

            // 尝试恢复之前的选择（如果该标签还存在）
            if (allUniqueTags.has(currentSelection)) {
                filterTagSelect.value = currentSelection;
            }
        }

        // 生成short UUID（8位）
        function generateShortUUID() {
            return Math.random().toString(36).substring(2, 10);
        }

        // 格式化日期为Anki格式（例如："Fri Nov 14 2025"）
        function formatDateForAnki(date) {
            const options = {
                weekday: 'short',
                month: 'short',
                day: '2-digit',
                year: 'numeric'
            };
            return date.toLocaleDateString('en-US', options);
        }

        // 格式化日期为input[type="date"]格式（YYYY-MM-DD）
        function formatDateForInput(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // 显示状态消息
        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `status-message ${type}`;

            // 移除可能存在的进度条
            const progressContainer = statusMessage.querySelector('.progress-container');
            if (progressContainer) {
                progressContainer.remove();
            }

            // 5秒后自动隐藏（如果是info类型则延长显示时间）
            const timeout = type === 'info' ? 10000 : 5000;
            setTimeout(() => {
                statusMessage.className = 'status-message';
            }, timeout);
        }

        // 生成UUID
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
    </script>
</body>

</html>
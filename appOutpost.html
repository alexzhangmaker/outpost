<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8"/>
    <!-- Updated viewport for better mobile notch support -->
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" name="viewport"/>
    <title>我的任务 - PWA</title>
    
    <!-- PWA Theme Colors -->
    <meta name="theme-color" content="#f6f7f8" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#101922" media="(prefers-color-scheme: dark)">

    <!-- iOS Support -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="我的任务">
    <!-- Links for Manifest and Icon (will be populated by JS) -->
    <link rel="manifest" id="manifest-placeholder">
    <link rel="apple-touch-icon" id="apple-icon-placeholder">
    <link rel="icon" id="favicon-placeholder">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet"/>
    
    <script id="tailwind-config">
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              "primary": "#2b8cee",
              "background-light": "#f6f7f8",
              "background-dark": "#101922",
            },
            fontFamily: {
              "display": ["Inter", "sans-serif"]
            },
            borderRadius: {"DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px"},
          },
        },
      }
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        /* Hide scrollbar for mobile feel */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Simple Spinner */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #2b8cee;
            width: 24px;
            height: 24px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Safe area padding for iPhones with notches */
        body {
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }
        /* Fix for status bar overlap when using black-translucent */
        #app-container {
            min-height: 100vh;
        }
    </style>
</head>
<body class="font-display bg-background-light dark:bg-background-dark overflow-hidden select-none">

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-white dark:bg-background-dark">
        <div class="loader"></div>
    </div>

    <!-- Login Screen (Hidden by default) -->
    <div id="login-screen" class="hidden fixed inset-0 z-40 flex flex-col items-center justify-center bg-white dark:bg-background-dark px-4">
        <div class="w-full max-w-sm space-y-8 text-center">
            <div>
                <div class="mx-auto flex h-16 w-16 items-center justify-center rounded-full bg-blue-100 dark:bg-blue-900/30">
                    <span class="material-symbols-outlined text-primary !text-4xl">check_circle</span>
                </div>
                <h2 class="mt-6 text-3xl font-bold tracking-tight text-slate-900 dark:text-white">
                    我的任务
                </h2>
                <p class="mt-2 text-sm text-slate-600 dark:text-slate-400">
                    登录以同步您的所有任务
                </p>
            </div>
            <button id="login-btn" class="flex w-full items-center justify-center gap-3 rounded-lg bg-white px-4 py-3 text-slate-700 shadow-sm ring-1 ring-slate-200 transition-all hover:bg-slate-50 hover:shadow-md dark:bg-slate-800 dark:text-white dark:ring-slate-700 dark:hover:bg-slate-700">
                <img src="https://www.google.com/favicon.ico" alt="Google" class="h-5 w-5" />
                <span class="font-medium">使用 Google 账号登录</span>
            </button>
        </div>
    </div>

    <!-- Main App (Hidden by default) -->
    <div id="app-container" class="hidden relative flex h-screen w-full flex-col mx-auto max-w-lg shadow-2xl bg-background-light dark:bg-background-dark">
        
        <!-- Header -->
        <header class="flex-shrink-0 flex items-center justify-between whitespace-nowrap border-b border-solid border-slate-200 dark:border-slate-800 px-4 py-2 bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-sm z-10">
            <div class="relative w-full flex items-center gap-2">
                <div class="relative w-full">
                    <input id="new-todo-input" class="w-full h-10 pl-9 pr-3 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-primary/50 transition-shadow placeholder:text-slate-400 text-sm" placeholder="(A) 任务内容 @标签 +项目 due:2024-12-31" type="text"/>
                    <button id="add-todo-btn" class="absolute left-0 top-0 bottom-0 px-2.5 flex items-center justify-center text-slate-400 hover:text-primary transition-colors">
                        <span class="material-symbols-outlined !text-xl">add_circle</span>
                    </button>
                </div>
                <button id="logout-btn" class="p-1.5 text-slate-400 hover:text-red-500 transition-colors" title="退出登录">
                    <span class="material-symbols-outlined !text-xl">logout</span>
                </button>
            </div>
        </header>

        <!-- Main List -->
        <main id="todo-list" class="flex-1 overflow-y-auto px-4 pt-3 pb-20 space-y-2 scrollbar-hide">
            <!-- Todos will be injected here via JS -->
            <div class="text-center py-20 text-slate-400">
                <p>加载中...</p>
            </div>
        </main>

        <!-- Bottom Navigation -->
        <nav class="absolute bottom-0 left-0 right-0 z-20 mx-auto max-w-lg border-t border-slate-200 bg-white/80 backdrop-blur-sm dark:border-slate-800 dark:bg-background-dark/80 pb-[env(safe-area-inset-bottom)]">
            <div class="flex h-16 justify-around"> <!-- Reduced height from h-16 to h-14 -->
                <a class="flex flex-1 flex-col items-center justify-center gap-0.5 text-primary" href="#">
                    <span class="material-symbols-outlined !text-xl">home</span>
                    <span class="text-[10px] font-medium">主页</span>
                </a>
                <a class="flex flex-1 flex-col items-center justify-center gap-0.5 text-slate-500 hover:text-primary dark:text-slate-400 dark:hover:text-primary" href="#">
                    <span class="material-symbols-outlined !text-xl">calendar_month</span>
                    <span class="text-[10px] font-medium">日历</span>
                </a>
                <div class="flex flex-1 flex-col items-center justify-center" id="fab-add">
                    <div class="flex h-10 w-10 -translate-y-3 items-center justify-center rounded-full bg-primary text-white shadow-lg transition-transform active:scale-95 cursor-pointer">
                        <span class="material-symbols-outlined !text-2xl">add</span>
                    </div>
                </div>
                <a class="flex flex-1 flex-col items-center justify-center gap-0.5 text-slate-500 hover:text-primary dark:text-slate-400 dark:hover:text-primary" href="#">
                    <span class="material-symbols-outlined !text-xl">analytics</span>
                    <span class="text-[10px] font-medium">统计</span>
                </a>
                <a class="flex flex-1 flex-col items-center justify-center gap-0.5 text-slate-500 hover:text-primary dark:text-slate-400 dark:hover:text-primary" href="#">
                    <span class="material-symbols-outlined !text-xl">settings</span>
                    <span class="text-[10px] font-medium">设置</span>
                </a>
            </div>
        </nav>
    </div>

    <!-- Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, where, orderBy, onSnapshot, setDoc, doc, serverTimestamp, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 0. PWA Manifest & Icons Injection ---
        // Dynamically create a Manifest and Icon blob to support PWA installation without external files
        (function injectPWAAssets() {
            // Simple Blue SVG Icon
            const iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512"><rect width="512" height="512" rx="100" fill="#2b8cee"/><path d="M192 360l-96-96-32 32 128 128 288-288-32-32z" fill="white" transform="translate(32, 32)"/></svg>`;
            const iconBlob = new Blob([iconSvg], { type: 'image/svg+xml' });
            const iconUrl = URL.createObjectURL(iconBlob);

            // Set Icons in DOM
            document.getElementById('apple-icon-placeholder').href = iconUrl;
            document.getElementById('favicon-placeholder').href = iconUrl;

            // Generate Manifest JSON
            const manifest = {
                "name": "我的任务",
                "short_name": "任务",
                "start_url": ".",
                "display": "standalone",
                "background_color": "#f6f7f8",
                "theme_color": "#2b8cee",
                "icons": [
                    {
                        "src": iconUrl,
                        "sizes": "512x512",
                        "type": "image/svg+xml",
                        "purpose": "any maskable"
                    }
                ]
            };
            
            const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
            const manifestUrl = URL.createObjectURL(manifestBlob);
            document.getElementById('manifest-placeholder').href = manifestUrl;
        })();

        // --- 1. Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyA6MZ_p5lVuy8TMAqiuV6IRx9fggV44lQs",
            authDomain: "outpost-8d74e.firebaseapp.com",
            databaseURL: "https://outpost-8d74e-985fa-schedule.asia-southeast1.firebasedatabase.app/",
            projectId: "outpost-8d74e",
            storageBucket: "outpost-8d74e.firebasestorage.app",
            messagingSenderId: "724993324937",
            appId: "1:724993324937:web:ce6c7e6b06489331c79358",
            measurementId: "G-QPHWRTH6BH"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- 2. State & References ---
        let currentUser = null;
        let unsubscribeTodos = null;
        
        const els = {
            loading: document.getElementById('loading-screen'),
            login: document.getElementById('login-screen'),
            app: document.getElementById('app-container'),
            loginBtn: document.getElementById('login-btn'),
            logoutBtn: document.getElementById('logout-btn'),
            todoList: document.getElementById('todo-list'),
            input: document.getElementById('new-todo-input'),
            addBtn: document.getElementById('add-todo-btn'),
            fab: document.getElementById('fab-add')
        };

        // --- 3. Utilities ---
        const generateShortId = () => Math.random().toString(36).substring(2, 10);
        
        const formatDate = (date) => {
            if (!date) return '';
            const d = date.toDate ? date.toDate() : new Date(date);
            return d.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
        };

        const getPriorityColor = (priority) => {
            switch (priority) {
                case 'high': return 'bg-rose-100 text-rose-800 dark:bg-rose-900/50 dark:text-rose-300';
                case 'medium': return 'bg-amber-100 text-amber-800 dark:bg-amber-900/50 dark:text-amber-300';
                case 'low': return 'bg-emerald-100 text-emerald-800 dark:bg-emerald-900/50 dark:text-emerald-300';
                default: return 'bg-slate-100 text-slate-800 dark:bg-slate-800 dark:text-slate-300';
            }
        };

        // --- Todo.txt Parser ---
        const parseTodoTxt = (rawText) => {
            let content = rawText;
            let priority = 'medium';
            let dueOn = null;
            let tags = [];

            // 1. Priority: (A), (B), (C)...
            const priorityMatch = content.match(/^\(([A-Z])\)\s+/);
            if (priorityMatch) {
                const pChar = priorityMatch[1];
                if (pChar === 'A') priority = 'high';
                else if (pChar === 'B') priority = 'medium';
                else if (pChar === 'C') priority = 'low';
                else priority = 'low'; // Default for other letters
                content = content.replace(priorityMatch[0], ''); // Remove priority from text
            }

            // 2. Due Date: due:YYYY-MM-DD
            const dueMatch = content.match(/\bdue:(\d{4}-\d{2}-\d{2})\b/);
            if (dueMatch) {
                dueOn = new Date(dueMatch[1]);
                content = content.replace(dueMatch[0], '');
            } else {
                // Default: Tomorrow
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                dueOn = tomorrow;
            }

            // 3. Projects (+Project) -> Tags
            const projects = [...content.matchAll(/\+(\w+)/g)].map(m => m[1]);
            tags.push(...projects);
            content = content.replace(/\+(\w+)/g, '');

            // 4. Contexts (@Context) -> Tags
            const contexts = [...content.matchAll(/@(\w+)/g)].map(m => m[1]);
            tags.push(...contexts);
            content = content.replace(/@(\w+)/g, '');

            // 5. Cleanup
            content = content.replace(/\s+/g, ' ').trim();
            if (tags.length === 0) tags = ['一般'];

            return { content, priority, dueOn, tags };
        };

        // --- 4. Render Logic ---
        const renderTodos = (todos) => {
            if (todos.length === 0) {
                els.todoList.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-20 text-slate-400">
                        <span class="material-symbols-outlined !text-5xl opacity-50 mb-4">calendar_today</span>
                        <p>暂无任务，开始添加吧！</p>
                    </div>
                `;
                return;
            }

            els.todoList.innerHTML = todos.map(todo => {
                const isCompleted = todo.status === 'completed';
                const opacityClass = isCompleted ? 'opacity-60 bg-slate-50 dark:bg-slate-900/40' : 'bg-white dark:bg-emerald-950/40';
                const textDecoration = isCompleted ? 'line-through text-slate-500' : 'text-slate-800 dark:text-slate-100';
                const icon = isCompleted ? 'check_circle' : 'radio_button_unchecked';
                const iconColor = isCompleted ? 'text-emerald-500' : 'text-slate-300 hover:text-primary';
                const priorityLabel = todo.priority === 'high' ? '高' : (todo.priority === 'low' ? '低' : '中'); // Simplified label

                return `
                <div class="flex flex-col gap-1.5 rounded-lg p-3 border border-slate-200/80 dark:border-slate-800 shadow-sm transition-all hover:shadow-md ${opacityClass}" id="todo-${todo.id}">
                    <div class="flex items-start gap-2">
                        <button onclick="window.appActions.toggleStatus('${todo.id}', '${todo.status}')" class="mt-0.5 flex-shrink-0 transition-colors ${iconColor}">
                            <span class="material-symbols-outlined !text-[20px]">${icon}</span>
                        </button>
                        <div class="flex-1 min-w-0" onclick="window.appActions.toggleStatus('${todo.id}', '${todo.status}')">
                            <p class="font-medium text-base leading-tight break-words ${textDecoration}">${todo.content}</p>
                        </div>
                        <button onclick="window.appActions.deleteTodo('${todo.id}')" class="text-slate-300 hover:text-red-400 p-0.5 -mr-1">
                            <span class="material-symbols-outlined !text-[18px]">delete</span>
                        </button>
                    </div>

                    <div class="flex flex-wrap items-center gap-2 pl-7 text-xs text-slate-500 dark:text-slate-400">
                        ${todo.dueOn ? `
                        <div class="flex items-center gap-1">
                            <span class="material-symbols-outlined !text-[14px]">calendar_today</span>
                            <span>${formatDate(todo.dueOn)}</span>
                        </div>
                        <span class="text-slate-300">|</span>
                        ` : ''}
                        
                        <span class="inline-block px-1.5 py-0.5 text-[10px] font-medium rounded-full ${getPriorityColor(todo.priority)}">${priorityLabel}</span>
                        
                        ${(todo.tags || []).map(tag => `
                            <span class="inline-block px-1.5 py-0.5 text-[10px] font-medium rounded-full bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-slate-300">#${tag}</span>
                        `).join('')}
                    </div>
                </div>`;
            }).join('');
        };

        // --- 5. Data Actions ---
        // We attach these to window so HTML onclick strings can find them
        window.appActions = {
            toggleStatus: async (id, currentStatus) => {
                const newStatus = currentStatus === 'completed' ? 'pending' : 'completed';
                try {
                    await updateDoc(doc(db, 'todos', id), { status: newStatus });
                } catch (e) { console.error(e); }
            },
            deleteTodo: async (id) => {
                if (confirm('确定要删除这个任务吗?')) {
                    try {
                        await deleteDoc(doc(db, 'todos', id));
                    } catch (e) { console.error(e); }
                }
            }
        };

        const handleAddTodo = async () => {
            const rawText = els.input.value.trim();
            if (!rawText || !currentUser) return;

            els.input.value = ''; // Clear early
            els.input.focus();

            // PARSE TODO.TXT
            const parsed = parseTodoTxt(rawText);
            const shortId = generateShortId();

            try {
                await setDoc(doc(db, 'todos', shortId), {
                    content: parsed.content,
                    owner: currentUser.uid,
                    dueOn: parsed.dueOn,
                    tags: parsed.tags,
                    priority: parsed.priority,
                    status: 'pending',
                    createdAt: serverTimestamp(),
                });
            } catch (error) {
                console.error("Error adding:", error);
                alert("添加失败");
            }
        };

        // --- 6. Auth Flow ---
        const handleLogin = async () => {
            try {
                await signInWithPopup(auth, new GoogleAuthProvider());
            } catch (error) {
                console.error(error);
                alert("登录失败");
            }
        };

        const handleLogout = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            els.loading.classList.add('hidden'); // Hide loader

            if (user) {
                els.login.classList.add('hidden');
                els.app.classList.remove('hidden');
                
                // Start Listener with Simple Query (Fix for missing Index)
                const q = query(
                    collection(db, 'todos'),
                    where('owner', '==', user.uid)
                    // REMOVED orderBy() to prevent failed-precondition error
                );
                
                if (unsubscribeTodos) unsubscribeTodos();
                
                unsubscribeTodos = onSnapshot(q, (snapshot) => {
                    let todos = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    
                    // Client-side Sorting (Desc)
                    todos.sort((a, b) => {
                        // Handle potential null createdAt (e.g. immediate local write)
                        const tA = a.createdAt?.toMillis ? a.createdAt.toMillis() : Date.now();
                        const tB = b.createdAt?.toMillis ? b.createdAt.toMillis() : Date.now();
                        return tB - tA; 
                    });

                    renderTodos(todos);
                }, (error) => {
                    console.error("Fetch error:", error);
                    if (error.code === 'failed-precondition') {
                        console.warn("Firestore index missing. Sorting handled in client now.");
                    }
                });

            } else {
                els.app.classList.add('hidden');
                els.login.classList.remove('hidden');
                if (unsubscribeTodos) unsubscribeTodos();
                renderTodos([]);
            }
        });

        // --- 7. Event Listeners ---
        els.loginBtn.addEventListener('click', handleLogin);
        els.logoutBtn.addEventListener('click', handleLogout);
        els.addBtn.addEventListener('click', handleAddTodo);
        els.input.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleAddTodo();
        });
        els.fab.addEventListener('click', () => els.input.focus());

        // --- 8. Service Worker Registration (Blob) ---
        if ('serviceWorker' in navigator) {
            const swCode = `
                const CACHE_NAME = 'outpost-todo-native-v1';
                const urlsToCache = [
                    '/',
                    'https://cdn.tailwindcss.com?plugins=forms,container-queries',
                    'https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap',
                    'https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200'
                ];
                self.addEventListener('install', event => {
                    event.waitUntil(caches.open(CACHE_NAME).then(cache => cache.addAll(urlsToCache)));
                });
                self.addEventListener('fetch', event => {
                    event.respondWith(
                        caches.match(event.request).then(cached => {
                            return cached || fetch(event.request).then(response => {
                                // Cache generic http requests (not firebase/data)
                                if (event.request.url.startsWith('http') && !event.request.url.includes('firestore')) {
                                     caches.open(CACHE_NAME).then(cache => cache.put(event.request, response.clone()));
                                }
                                return response;
                            });
                        })
                    );
                });
            `;
            const blob = new Blob([swCode], { type: 'application/javascript' });
            navigator.serviceWorker.register(URL.createObjectURL(blob))
                .then(() => console.log('SW Registered'))
                .catch(err => console.log('SW Fail', err));
        }
    </script>
</body>
</html>
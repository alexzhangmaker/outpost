<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"
        name="viewport" />
    <title>我的任务 - PWA</title>

    <meta name="theme-color" content="#f6f7f8" media="(prefers-color-scheme: light)">
    <meta name="theme-color" content="#101922" media="(prefers-color-scheme: dark)">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="我的任务">
    <link rel="manifest" id="manifest-placeholder">
    <link rel="apple-touch-icon" id="apple-icon-placeholder">
    <link rel="icon" id="favicon-placeholder">

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
        rel="stylesheet" />

    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#2b8cee",
                        "background-light": "#f6f7f8",
                        "background-dark": "#101922",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: { "DEFAULT": "0.25rem", "lg": "0.5rem", "xl": "0.75rem", "full": "9999px" },
                },
            },
        }
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        /* Hide scrollbar for mobile feel */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Simple Spinner */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #2b8cee;
            width: 24px;
            height: 24px;
            -webkit-animation: spin 1s linear infinite;
            /* Safari */
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Safe area padding for iPhones with notches */
        body {
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* Fix for status bar overlap when using black-translucent */
        #app-container {
            min-height: 100vh;
        }
    </style>
</head>

<body class="font-display bg-background-light dark:bg-background-dark overflow-hidden select-none">

    <div id="loading-screen"
        class="fixed inset-0 z-50 flex items-center justify-center bg-white dark:bg-background-dark">
        <div class="loader"></div>
    </div>

    <div id="login-screen"
        class="hidden fixed inset-0 z-40 flex flex-col items-center justify-center bg-white dark:bg-background-dark px-4">
        <div class="w-full max-w-sm space-y-8 text-center">
            <div>
                <div
                    class="mx-auto flex h-16 w-16 items-center justify-center rounded-full bg-blue-100 dark:bg-blue-900/30">
                    <span class="material-symbols-outlined text-primary !text-4xl">check_circle</span>
                </div>
                <h2 class="mt-6 text-3xl font-bold tracking-tight text-slate-900 dark:text-white">
                    我的任务
                </h2>
                <p class="mt-2 text-sm text-slate-600 dark:text-slate-400">
                    登录以同步您的所有任务
                </p>
            </div>
            <button id="login-btn"
                class="flex w-full items-center justify-center gap-3 rounded-lg bg-white px-4 py-3 text-slate-700 shadow-sm ring-1 ring-slate-200 transition-all hover:bg-slate-50 hover:shadow-md dark:bg-slate-800 dark:text-white dark:ring-slate-700 dark:hover:bg-slate-700">
                <img src="https://www.google.com/favicon.ico" alt="Google" class="h-5 w-5" />
                <span class="font-medium">使用 Google 账号登录</span>
            </button>
        </div>
    </div>

    <div id="app-container"
        class="hidden relative flex h-screen w-full flex-col mx-auto max-w-lg shadow-2xl bg-background-light dark:bg-background-dark">

        <header
            class="flex-shrink-0 flex items-center justify-between whitespace-nowrap border-b border-solid border-slate-200 dark:border-slate-800 px-4 py-2 bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-sm z-10">
            <div class="relative w-full flex items-center gap-2">
                <div class="relative w-full">
                    <input id="new-todo-input"
                        class="w-full h-10 pl-9 pr-3 rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-800 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-primary/50 transition-shadow placeholder:text-slate-400 text-base"
                        placeholder="(A) 任务内容 @标签 +项目 due:2024-12-31" type="text" />
                    <button id="add-todo-btn"
                        class="absolute left-0 top-0 bottom-0 px-2.5 flex items-center justify-center text-slate-400 hover:text-primary transition-colors">
                        <span class="material-symbols-outlined !text-xl">add_circle</span>
                    </button>
                </div>
                <button id="logout-btn" class="p-1.5 text-slate-400 hover:text-red-500 transition-colors" title="退出登录">
                    <span class="material-symbols-outlined !text-xl">logout</span>
                </button>
            </div>
        </header>

        <main id="todo-list" class="flex-1 overflow-y-auto px-4 pt-3 pb-20 space-y-2 scrollbar-hide">
            <div class="text-center py-20 text-slate-400">
                <p>加载中...</p>
            </div>
        </main>

        <nav
            class="absolute bottom-0 left-0 right-0 z-20 mx-auto max-w-lg border-t border-slate-200 bg-white/80 backdrop-blur-sm dark:border-slate-800 dark:bg-background-dark/80 pb-[env(safe-area-inset-bottom)]">
            <div class="flex h-20 items-stretch justify-around">
                <a class="nav-item flex flex-1 flex-col items-center justify-center gap-1 text-primary" href="#"
                    data-view="home">
                    <span class="material-symbols-outlined !text-3xl">home</span>
                    <span class="text-[11px] font-semibold">主页</span>
                </a>
                <a class="nav-item flex flex-1 flex-col items-center justify-center gap-1 text-slate-500 hover:text-primary dark:text-slate-400 dark:hover:text-primary"
                    href="#" data-view="calendar">
                    <span class="material-symbols-outlined !text-3xl">calendar_month</span>
                    <span class="text-[11px] font-semibold">日历</span>
                </a>
                <div class="flex flex-1 flex-col items-center justify-center" id="fab-add">
                    <div
                        class="flex h-14 w-14 -translate-y-5 items-center justify-center rounded-full bg-primary text-white shadow-xl transition-transform active:scale-90 cursor-pointer">
                        <span class="material-symbols-outlined !text-3xl">add</span>
                    </div>
                </div>
                <a class="nav-item flex flex-1 flex-col items-center justify-center gap-1 text-slate-500 hover:text-primary dark:text-slate-400 dark:hover:text-primary"
                    href="#" data-view="analytics">
                    <span class="material-symbols-outlined !text-3xl">analytics</span>
                    <span class="text-[11px] font-semibold">统计</span>
                </a>
                <a class="nav-item flex flex-1 flex-col items-center justify-center gap-1 text-slate-500 hover:text-primary dark:text-slate-400 dark:hover:text-primary"
                    href="#" data-view="settings">
                    <span class="material-symbols-outlined !text-3xl">settings</span>
                    <span class="text-[11px] font-semibold">设置</span>
                </a>
            </div>
        </nav>

        <!-- Settings View -->
        <div id="settings-view"
            class="hidden absolute inset-0 z-20 bg-background-light dark:bg-background-dark px-4 pt-4 pb-24 overflow-y-auto overflow-x-hidden">
            <h2 class="text-2xl font-bold text-slate-900 dark:text-white mb-6">设置</h2>
            <div class="space-y-6">
                <div
                    class="bg-white dark:bg-slate-800 rounded-xl p-4 shadow-sm border border-slate-200 dark:border-slate-700">
                    <h3 class="text-sm font-semibold text-slate-500 dark:text-slate-400 mb-4 px-1">显示设置</h3>
                    <div class="space-y-4">
                        <div class="flex items-center justify-between">
                            <span class="text-slate-700 dark:text-slate-200 font-medium">字体大小</span>
                            <select id="setting-font-size"
                                class="rounded-lg border-slate-300 dark:border-slate-700 dark:bg-slate-900 dark:text-white focus:ring-primary">
                                <option value="small">较小</option>
                                <option value="medium">默认</option>
                                <option value="large">较大</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div
                    class="bg-white dark:bg-slate-800 rounded-xl p-4 shadow-sm border border-slate-200 dark:border-slate-700">
                    <h3 class="text-sm font-semibold text-slate-500 dark:text-slate-400 mb-4 px-1">账户</h3>
                    <button id="settings-logout-btn"
                        class="w-full flex items-center justify-center gap-2 py-3 px-4 rounded-lg text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 border border-red-200 dark:border-red-900/30 transition-colors">
                        <span class="material-symbols-outlined !text-xl">logout</span>
                        <span class="font-medium">退出登录</span>
                    </button>
                </div>
            </div>
        </div>

        <div id="share-modal"
            class="hidden fixed inset-0 z-30 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm transition-opacity duration-300">
            <div
                class="w-full max-w-md rounded-xl bg-white dark:bg-slate-800 p-6 shadow-2xl transform scale-95 transition-transform duration-300">
                <h3
                    class="flex items-center gap-2 text-xl font-bold text-slate-900 dark:text-white mb-4 border-b border-slate-200 dark:border-slate-700 pb-2">
                    <span class="material-symbols-outlined text-primary !text-2xl">share</span>
                    接收到共享内容
                </h3>
                <p class="text-sm text-slate-600 dark:text-slate-300 mb-3">共享标题:</p>
                <p id="shared-title"
                    class="p-2 bg-slate-100 dark:bg-slate-700 rounded-lg text-slate-800 dark:text-white font-medium mb-4 break-words">
                    无</p>

                <p class="text-sm text-slate-600 dark:text-slate-300 mb-3">共享内容 (可编辑):</p>
                <textarea id="shared-content-textarea" rows="4"
                    class="w-full p-2 bg-slate-100 dark:bg-slate-700 rounded-lg text-slate-800 dark:text-white text-sm focus:ring-primary focus:border-primary border-transparent resize-none mb-4"></textarea>

                <div class="flex justify-end gap-3">
                    <button id="modal-close-btn"
                        class="px-4 py-2 rounded-lg text-slate-600 hover:text-slate-800 dark:text-slate-400 dark:hover:text-slate-200 transition-colors">取消</button>
                    <button id="modal-add-btn"
                        class="px-4 py-2 rounded-lg bg-primary text-white hover:bg-blue-700 transition-colors">添加到任务</button>
                </div>
            </div>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- 0. PWA Manifest & Icons Injection ---
        (function injectPWAAssets() {
            const iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512"><rect width="512" height="512" rx="100" fill="#2b8cee"/><path d="M192 360l-96-96-32 32 128 128 288-288-32-32z" fill="white" transform="translate(32, 32)"/></svg>`;
            const iconBlob = new Blob([iconSvg], { type: 'image/svg+xml' });
            const iconUrl = URL.createObjectURL(iconBlob);
            document.getElementById('apple-icon-placeholder').href = iconUrl;
            document.getElementById('favicon-placeholder').href = iconUrl;

            // Use absolute URLs for manifest start_url and share_target to work with Blob URLs on GitHub Pages
            const baseUrl = window.location.origin + window.location.pathname.substring(0, window.location.pathname.lastIndexOf('/') + 1);

            const manifest = {
                "name": "我的任务 V2",
                "short_name": "任务 V2",
                "start_url": baseUrl + "appOutpostV2.html",
                "display": "standalone",
                "background_color": "#f6f7f8",
                "theme_color": "#2b8cee",
                "icons": [{ "src": iconUrl, "sizes": "512x512", "type": "image/svg+xml", "purpose": "any maskable" }],
                "share_target": {
                    "action": baseUrl + "appOutpostV2.html?share=true",
                    "method": "GET",
                    "enctype": "application/x-www-form-urlencoded",
                    "params": { "title": "share_title", "text": "share_text", "url": "share_url" }
                }
            };
            const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
            const manifestUrl = URL.createObjectURL(manifestBlob);
            document.getElementById('manifest-placeholder').href = manifestUrl;
        })();

        // --- 1. Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyA6MZ_p5lVuy8TMAqiuV6IRx9fggV44lQs",
            authDomain: "outpost-8d74e.firebaseapp.com",
            databaseURL: "https://outpost-8d74e-985fa-schedule.asia-southeast1.firebasedatabase.app/",
            projectId: "outpost-8d74e",
            storageBucket: "outpost-8d74e.firebasestorage.app",
            messagingSenderId: "724993324937",
            appId: "1:724993324937:web:ce6c7e6b06489331c79358",
            measurementId: "G-QPHWRTH6BH"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // --- 2. State & References ---
        let currentUser = null;
        let db;
        const STORE_NAME = 'todos';

        const els = {
            loading: document.getElementById('loading-screen'),
            login: document.getElementById('login-screen'),
            app: document.getElementById('app-container'),
            loginBtn: document.getElementById('login-btn'),
            logoutBtn: document.getElementById('logout-btn'),
            todoList: document.getElementById('todo-list'),
            input: document.getElementById('new-todo-input'),
            addBtn: document.getElementById('add-todo-btn'),
            fab: document.getElementById('fab-add'),
            shareModal: document.getElementById('share-modal'),
            sharedTitle: document.getElementById('shared-title'),
            sharedContentTextarea: document.getElementById('shared-content-textarea'),
            modalCloseBtn: document.getElementById('modal-close-btn'),
            modalAddBtn: document.getElementById('modal-add-btn'),
            settingsView: document.getElementById('settings-view'),
            todoListContainer: document.getElementById('todo-list'),
            navItems: document.querySelectorAll('.nav-item'),
            settingFontSize: document.getElementById('setting-font-size'),
            settingsLogoutBtn: document.getElementById('settings-logout-btn')
        };

        // --- 3. IndexedDB Layer ---
        const initDB = () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('OutpostDB', 2);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('todos')) {
                        db.createObjectStore('todos', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('settings')) {
                        db.createObjectStore('settings', { keyPath: 'id' });
                    }
                };
                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                };
                request.onerror = (event) => reject(event.target.error);
            });
        };

        const getAllTodos = () => {
            return new Promise((resolve, reject) => {
                if (!db) {
                    resolve([]);
                    return;
                }
                const tx = db.transaction(STORE_NAME, 'readonly');
                const store = tx.objectStore(STORE_NAME);
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        };

        // --- 4. Utilities ---
        const generateShortId = () => Math.random().toString(36).substring(2, 10);

        const formatDate = (date) => {
            if (!date) return '';
            const d = (date.seconds !== undefined) ? new Date(date.seconds * 1000) : new Date(date);
            return d.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
        };

        const getPriorityColor = (priority) => {
            switch (priority) {
                case 'high': return 'bg-rose-100 text-rose-800 dark:bg-rose-900/50 dark:text-rose-300';
                case 'medium': return 'bg-amber-100 text-amber-800 dark:bg-amber-900/50 dark:text-amber-300';
                case 'low': return 'bg-emerald-100 text-emerald-800 dark:bg-emerald-900/50 dark:text-emerald-300';
                default: return 'bg-slate-100 text-slate-800 dark:bg-slate-800 dark:text-slate-300';
            }
        };

        const parseTodoTxt = (rawText) => {
            let content = rawText;
            let priority = 'medium';
            let dueOn = null;
            let tags = [];

            const priorityMatch = content.match(/^\(([A-Z])\)\s+/);
            if (priorityMatch) {
                const pChar = priorityMatch[1];
                if (pChar === 'A') priority = 'high';
                else if (pChar === 'B') priority = 'medium';
                else if (pChar === 'C') priority = 'low';
                content = content.replace(priorityMatch[0], '');
            }

            const dueMatch = content.match(/\bdue:(\d{4}-\d{2}-\d{2})\b/);
            if (dueMatch) {
                dueOn = new Date(dueMatch[1]);
                content = content.replace(dueMatch[0], '');
            } else {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                dueOn = tomorrow;
            }

            const projects = [...content.matchAll(/\+(\w+)/g)].map(m => m[1]);
            tags.push(...projects);
            content = content.replace(/\+(\w+)/g, '');

            const contexts = [...content.matchAll(/@(\w+)/g)].map(m => m[1]);
            tags.push(...contexts);
            content = content.replace(/@(\w+)/g, '');

            content = content.replace(/\s+/g, ' ').trim();
            if (tags.length === 0) tags = ['一般'];

            return { content, priority, dueOn, tags };
        };

        // --- 5. Render Logic ---
        const renderTodos = async () => {
            const todos = await getAllTodos();

            // Sort locally (Desc by createdAt)
            todos.sort((a, b) => {
                const tA = a.createdAt?.seconds ? a.createdAt.seconds * 1000 : (a.createdAt || Date.now());
                const tB = b.createdAt?.seconds ? b.createdAt.seconds * 1000 : (b.createdAt || Date.now());
                return tB - tA;
            });

            if (todos.length === 0) {
                els.todoList.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-20 text-slate-400">
                        <span class="material-symbols-outlined !text-5xl opacity-50 mb-4">calendar_today</span>
                        <p>暂无任务，开始添加吧！</p>
                    </div>
                `;
                return;
            }

            els.todoList.innerHTML = todos.map(todo => {
                const isCompleted = todo.status === 'completed';
                const opacityClass = isCompleted ? 'opacity-60 bg-slate-50 dark:bg-slate-900/40' : 'bg-white dark:bg-emerald-950/40';
                const textDecoration = isCompleted ? 'line-through text-slate-500' : 'text-slate-800 dark:text-slate-100';
                const icon = isCompleted ? 'check_circle' : 'radio_button_unchecked';
                const iconColor = isCompleted ? 'text-emerald-500' : 'text-slate-300 hover:text-primary';
                const priorityLabel = todo.priority === 'high' ? '高' : (todo.priority === 'low' ? '低' : '中');

                return `
                <div class="flex flex-col gap-1.5 rounded-lg p-3 border border-slate-200/80 dark:border-slate-800 shadow-sm transition-all hover:shadow-md ${opacityClass}" id="todo-${todo.id}">
                    <div class="flex items-start gap-2">
                        <button onclick="window.appActions.toggleStatus('${todo.id}', '${todo.status}')" class="mt-0.5 flex-shrink-0 transition-colors ${iconColor}">
                            <span class="material-symbols-outlined !text-[20px]">${icon}</span>
                        </button>
                        <div class="flex-1 min-w-0" onclick="window.appActions.toggleStatus('${todo.id}', '${todo.status}')">
                            <p class="font-medium text-base leading-tight break-words ${textDecoration}">${todo.content}</p>
                        </div>
                        <button onclick="window.appActions.deleteTodo('${todo.id}')" class="text-slate-300 hover:text-red-400 p-0.5 -mr-1">
                            <span class="material-symbols-outlined !text-[18px]">delete</span>
                        </button>
                    </div>
                    <div class="flex flex-wrap items-center gap-2 pl-7 text-xs text-slate-500 dark:text-slate-400">
                        ${todo.dueOn ? `
                        <div class="flex items-center gap-1">
                            <span class="material-symbols-outlined !text-[14px]">calendar_today</span>
                            <span>${formatDate(todo.dueOn)}</span>
                        </div>
                        <span class="text-slate-300">|</span>
                        ` : ''}
                        <span class="inline-block px-1.5 py-0.5 text-[10px] font-medium rounded-full ${getPriorityColor(todo.priority)}">${priorityLabel}</span>
                        ${(todo.tags || []).map(tag => `
                            <span class="inline-block px-1.5 py-0.5 text-[10px] font-medium rounded-full bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-slate-300">#${tag}</span>
                        `).join('')}
                    </div>
                </div>`;
            }).join('');
        };

        // --- 6. Data Actions & SW Communication ---
        const sendToSW = (type, payload) => {
            if (navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({ type, payload });
            }
        };

        window.appActions = {
            toggleStatus: async (id, currentStatus) => {
                const newStatus = currentStatus === 'completed' ? 'pending' : 'completed';
                // Optimistic Local Update
                const tx = db.transaction(STORE_NAME, 'readwrite');
                const store = tx.objectStore(STORE_NAME);
                const todoRequest = store.get(id);
                todoRequest.onsuccess = () => {
                    const todo = todoRequest.result;
                    todo.status = newStatus;
                    store.put(todo);
                    renderTodos();
                    sendToSW('UPDATE_TODO', { id, data: { status: newStatus } });
                };
            },
            deleteTodo: async (id) => {
                if (confirm('确定要删除这个任务吗?')) {
                    const tx = db.transaction(STORE_NAME, 'readwrite');
                    tx.objectStore(STORE_NAME).delete(id);
                    renderTodos();
                    sendToSW('DELETE_TODO', { id });
                }
            },
            addTodoFromText: async (rawText) => {
                if (!rawText || !currentUser) return;
                const parsed = parseTodoTxt(rawText);
                const id = generateShortId();
                const newTodo = {
                    id,
                    content: parsed.content,
                    owner: currentUser.uid,
                    dueOn: parsed.dueOn,
                    tags: parsed.tags,
                    priority: parsed.priority,
                    status: 'pending',
                    createdAt: Date.now()
                };

                // Optimistic Local Update
                const tx = db.transaction(STORE_NAME, 'readwrite');
                tx.objectStore(STORE_NAME).put(newTodo);
                renderTodos();
                sendToSW('ADD_TODO', { id, data: newTodo });
            }
        };

        const handleAddTodo = () => {
            const rawText = els.input.value.trim();
            els.input.value = '';
            els.input.focus();
            window.appActions.addTodoFromText(rawText);
        };

        // --- 7. Auth Flow ---
        const handleLogin = async () => {
            try {
                await signInWithPopup(auth, new GoogleAuthProvider());
            } catch (error) {
                console.error(error);
                alert("登录失败");
            }
        };

        const handleLogout = () => signOut(auth);

        onAuthStateChanged(auth, async (user) => {
            if (!db) await initDB();
            currentUser = user;
            els.loading.classList.add('hidden');

            if (user) {
                els.login.classList.add('hidden');
                els.app.classList.remove('hidden');

                sendToSW('SET_USER', { userId: user.uid });
                await loadSettings();
                renderTodos();
                checkSharedContent();
            } else {
                els.app.classList.add('hidden');
                els.login.classList.remove('hidden');
                sendToSW('SET_USER', { userId: null });
                // Clear local data if needed or just show empty
                if (db) {
                    const tx = db.transaction('todos', 'readwrite');
                    tx.objectStore('todos').clear();
                }
                renderTodos();
            }
        });

        // --- 8. Share Target Logic ---
        const checkSharedContent = () => {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('share') && urlParams.get('share') === 'true') {
                const title = urlParams.get('share_title') || '';
                const text = urlParams.get('share_text') || '';
                const url = urlParams.get('share_url') || '';
                if (title || text || url) {
                    let fullContent = text;
                    if (url) fullContent += (fullContent ? '\n' : '') + url;
                    if (!fullContent && title) fullContent = title;
                    else if (title && !fullContent.includes(title)) fullContent = title + '\n' + fullContent;

                    els.sharedTitle.textContent = title || '无标题';
                    els.sharedContentTextarea.value = fullContent.trim();
                    els.shareModal.classList.remove('hidden');
                }
            }
        };

        // --- 8. Settings & UI Logic ---
        const applySettings = (settings) => {
            if (!settings) return;
            const sizeMap = { 'small': '0.875rem', 'medium': '1rem', 'large': '1.125rem' };
            document.documentElement.style.fontSize = sizeMap[settings.fontSize] || '1rem';
            if (els.settingFontSize) els.settingFontSize.value = settings.fontSize || 'medium';
        };

        const saveSetting = async (key, value) => {
            if (!db) await initDB();
            const tx = db.transaction('settings', 'readwrite');
            const store = tx.objectStore('settings');
            const settings = await new Promise(r => {
                const req = store.get('current');
                req.onsuccess = () => r(req.result || { id: 'current' });
            });
            settings[key] = value;
            store.put(settings);
            applySettings(settings);
        };

        const loadSettings = async () => {
            if (!db) await initDB();
            const tx = db.transaction('settings', 'readonly');
            const store = tx.objectStore('settings');
            const req = store.get('current');
            req.onsuccess = () => {
                if (req.result) applySettings(req.result);
            };
        };

        const switchView = (viewName) => {
            els.navItems.forEach(item => {
                if (item.dataset.view === viewName) {
                    item.classList.add('text-primary');
                    item.classList.remove('text-slate-500', 'dark:text-slate-400');
                } else {
                    item.classList.remove('text-primary');
                    item.classList.add('text-slate-500', 'dark:text-slate-400');
                }
            });

            if (viewName === 'settings') {
                els.settingsView.classList.remove('hidden');
                els.todoListContainer.classList.add('hidden');
            } else if (viewName === 'home') {
                els.settingsView.classList.add('hidden');
                els.todoListContainer.classList.remove('hidden');
                renderTodos();
            }
        };

        // --- 9. Event Listeners ---
        els.loginBtn.addEventListener('click', handleLogin);
        els.logoutBtn.addEventListener('click', handleLogout);
        els.addBtn.addEventListener('click', handleAddTodo);
        els.input.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleAddTodo(); });
        els.fab.addEventListener('click', () => els.input.focus());
        els.navItems.forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                switchView(item.dataset.view);
            });
        });
        els.settingFontSize.addEventListener('change', (e) => saveSetting('fontSize', e.target.value));
        els.settingsLogoutBtn.addEventListener('click', handleLogout);
        els.modalAddBtn.addEventListener('click', () => {
            window.appActions.addTodoFromText(els.sharedContentTextarea.value.trim());
            els.shareModal.classList.add('hidden');
        });
        els.modalCloseBtn.addEventListener('click', () => els.shareModal.classList.add('hidden'));

        // --- 10. SW & DB Initialization ---
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./swOutpostV2.js', { type: 'module' })
                .then(async (registration) => {
                    console.log('SW Registered');
                    await initDB();
                    if (navigator.serviceWorker.controller) {
                        sendToSW('INIT_FIREBASE', { config: firebaseConfig });
                    } else {
                        navigator.serviceWorker.oncontrollerchange = () => {
                            sendToSW('INIT_FIREBASE', { config: firebaseConfig });
                        };
                    }
                })
                .catch(err => console.log('SW Fail', err));

            navigator.serviceWorker.addEventListener('message', (event) => {
                if (event.data.type === 'SYNC_COMPLETE') {
                    renderTodos();
                }
            });
        }
    </script>
</body>

</html>
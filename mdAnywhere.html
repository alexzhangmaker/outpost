<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>outpost.Memo</title>
  <link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css">
  <link rel="stylesheet" href="https://unpkg.com/gridjs/dist/theme/mermaid.min.css">

  <!-- Tailwind CSS for styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- MathJax for LaTeX rendering -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-MML-AM_CHTML"></script>
  <script>
    // Configure MathJax
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        processEscapes: true
      },
      CommonHTML: { linebreaks: { automatic: true } }
    });
  </script>
  <style>
    #tableModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    #tableModal.show {
      display: flex;
    }

    #gridContainer {
      width: 80%;
      max-width: 800px;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    #editor {
      margin-top: 1rem;
    }
  </style>
</head>

<body class="bg-gray-100">
  <div class="container mx-auto p-4">
    <h1 class="text-2xl font-bold mb-4">mdAnywhere</h1>
    <div class="mb-4 flex space-x-2">
      <input id="docTitle" type="text" placeholder="Document Title" class="border p-2 rounded flex-grow">
      <button id="saveButton" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Save</button>
      <button id="loadButton" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Load Latest</button>
    </div>

    <div id="editor"></div>
  </div>

  <!-- Modal for Grid.js table editor -->
  <div id="tableModal">
    <div id="gridContainer">
      <div id="grid"></div>
      <div class="mt-4 flex justify-end space-x-2">
        <button id="saveTable" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Save Table</button>
        <button id="closeModal" class="bg-gray-300 text-black px-4 py-2 rounded hover:bg-gray-400">Cancel</button>
      </div>
    </div>
  </div>

  <script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
  <script src="https://unpkg.com/gridjs/dist/gridjs.umd.js"></script>
  <script>
    // Supabase configuration
    const USER_ID = 'alexszhang@gmail.com'; //`4ebe5f02-8473-4051-8ed9-9bdd9ec8dbb8`;//'alexszhang@gmail.com'; // Hardcoded for testing
    const SUPABASE_URL = 'https://yfftwweuxxkrzlvqilvc.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlmZnR3d2V1eHhrcnpsdnFpbHZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIzMjYxMTEsImV4cCI6MjA2NzkwMjExMX0.7rcV3RBrH5kY3KLqD-NHLMhMyc62wIxxYG9VfW-i1tk';
    const SUPABASE_TABLE = 'documents';
    
    // Initialize Toast UI Editor
    const { Editor } = toastui;
    const editor = new Editor({
      el: document.querySelector('#editor'),
      height: '500px',
      initialEditType: 'markdown',
      previewStyle: 'vertical',
      initialValue: '# Welcome to the Markdown Editor\n\nType `$E=mc^2$` for LaTeX formulas.\n\nClick the table button (ðŸ“Š) to create/edit tables with Grid.js.',
      addons: ['math'],
      toolbarItems: [
        ['heading', 'bold', 'italic', 'strike'],
        ['hr', 'quote'],
        ['ul', 'ol', 'task', 'indent', 'outdent'],
        ['table', 'image', 'link'],
        ['code', 'codeblock'],
        [{
          name: 'gridTable',
          tooltip: 'Insert/Edit Table with Grid.js',
          command: 'openGridJsTable',
          text: 'ðŸ“Š',
          className: 'grid-table-button'
        }]
      ],
      hooks: {
        afterPreviewRender: () => {
          console.log('Rendering MathJax in preview');
          MathJax.Hub.Queue(['Typeset', MathJax.Hub, document.querySelector('.toastui-editor-contents')]);
        }
      }
    });

    // Initialize Grid.js in modal
    let grid;
    const gridData = [
      ['Header 1', 'Header 2', 'Header 3'],
      ['Row 1 Col 1', 'Row 1 Col 2', 'Row 1 Col 3'],
      ['Row 2 Col 1', 'Row 2 Col 2', 'Row 2 Col 3']
    ] ;
    function initializeGrid(data) {
      grid = new gridjs.Grid({
        columns: data[0].map((header, index) => ({
          name: header,
          attributes: { contenteditable: true }
        })),
        data: data.slice(1),
        style: {
          table: { width: '100%' },
          th: { padding: '8px', textAlign: 'left' },
          td: { padding: '8px' }
        }
      }).render(document.getElementById('grid'));
    }

    //initializeGrid(gridData) ;


    // Convert Grid.js data to Markdown table
    function gridToMarkdownTable(gridData) {
      const headers = gridData[0];
      const rows = gridData.slice(1);
      let markdown = `| ${headers.join(' | ')} |\n`;
      markdown += `| ${headers.map(() => '---').join(' | ')} |\n`;
      rows.forEach(row => {
        markdown += `| ${row.join(' | ')} |\n`;
      });
      return markdown;
    }

    // Open Grid.js table editor
    editor.addCommand('markdown', 'openGridJsTable', () => {
      document.getElementById('tableModal').classList.add('show');
      initializeGrid(gridData);
    });

    // Save table to editor
    document.getElementById('saveTable').addEventListener('click', () => {
      const gridData = [
        grid.config.columns.map(col => col.name),
        ...grid.config.data
      ];
      const markdownTable = gridToMarkdownTable(gridData);
      editor.insertText(markdownTable);
      document.getElementById('tableModal').classList.remove('show');
      grid.destroy();
    });

    // Close modal
    document.getElementById('closeModal').addEventListener('click', () => {
      document.getElementById('tableModal').classList.remove('show');
      grid.destroy();
    });
    // Save document to Supabase
    
    async function API_PlusMDMemo_Supabase(title, content) {
        console.log('Saving document:', { title, content, user_id: USER_ID });
        let jsonMemo = {
            title: title,
            content: content,
            user_id: USER_ID
        };
        let cURL = `${SUPABASE_URL}/rest/v1/${SUPABASE_TABLE}`;
        try {
            const response = await fetch(cURL, {
                method: 'POST',
                headers: {
                'Content-Type': 'application/json',
                'apikey': SUPABASE_ANON_KEY,
                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                'Prefer': 'resolution=merge-duplicates,return=representation'
                },
                body: JSON.stringify([jsonMemo])
            });
            const result = await response.json();
            if (response.ok) {
                alert('Document saved successfully!');
            } else {
                console.error('Error saving document:', result);
                alert('Error saving document: ' + (result.message || result.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Network error:', error);
            alert('Network error: ' + error.message);
        }
    }

    // Load latest document from Supabase
    async function API_LoadLatestMemo_Supabase() {
        try {
            const response = await fetch(
                `${SUPABASE_URL}/rest/v1/${SUPABASE_TABLE}?select=title,content&user_id=eq.${USER_ID}&order=created_at.desc&limit=1`,
                {
                    method: 'GET',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                }
            );
            const data = await response.json();
            if (response.ok && data.length) {
                document.getElementById('docTitle').value = data[0].title;
                editor.setMarkdown(data[0].content);
                alert('Document loaded successfully!');
            } else if (response.ok) {
                alert('No documents found.');
            } else {
                console.error('Error loading document:', data);
                alert('Error loading document: ' + (data.message || data.error || 'Unknown error'));
            }
        } catch (error) {
            console.error('Network error:', error);
            alert('Network error: ' + error.message);
        }
    }

    // Event listeners
    document.getElementById('saveButton').addEventListener('click', async () => {
        const title = document.getElementById('docTitle').value || 'Untitled';
        const content = editor.getMarkdown();
        await API_PlusMDMemo_Supabase(title, content);
    });

    document.getElementById('loadButton').addEventListener('click', async () => {
        await API_LoadLatestMemo_Supabase();
    });
  </script>
</body>
</html>
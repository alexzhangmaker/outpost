<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SharedWorker 异步通信</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: #333;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }
        
        h1 {
            color: #1a2a6c;
            margin-bottom: 15px;
            font-size: 2.5rem;
        }
        
        .subtitle {
            color: #666;
            font-size: 1.2rem;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        }
        
        .card h2 {
            color: #1a2a6c;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        
        .card h2 i {
            margin-right: 10px;
            color: #b21f1f;
        }
        
        .card p {
            margin-bottom: 15px;
            color: #444;
        }
        
        .card ul {
            padding-left: 20px;
            margin-bottom: 15px;
        }
        
        .card li {
            margin-bottom: 8px;
        }
        
        .highlight {
            background: linear-gradient(120deg, #fdbb2d33, #b21f1f33);
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }
        
        .warning {
            color: #b21f1f;
            font-weight: 600;
        }
        
        .success {
            color: #4CAF50;
            font-weight: 600;
        }
        
        .info {
            color: #1a2a6c;
            font-weight: 600;
        }
        
        .demo-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 40px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .demo-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .demo-container {
                grid-template-columns: 1fr;
            }
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #1a2a6c;
        }
        
        .input-group input, .input-group select, .input-group button {
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            width: 100%;
            font-size: 16px;
        }
        
        .input-group input {
            background: #f9f9f9;
        }
        
        .btn {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: opacity 0.3s ease;
            margin-top: 10px;
            display: inline-block;
            width: auto;
            padding: 10px 20px;
        }
        
        .btn:hover {
            opacity: 0.9;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #666, #999);
        }
        
        .btn-tertiary {
            background: linear-gradient(135deg, #1a2a6c, #2a3c9c);
        }
        
        .result-box {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 20px;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .result-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .result-item:last-child {
            border-bottom: none;
        }
        
        .faq-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .faq-item {
            margin-bottom: 20px;
        }
        
        .faq-question {
            font-weight: 700;
            color: #1a2a6c;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }
        
        .faq-question i {
            margin-right: 10px;
            color: #b21f1f;
        }
        
        footer {
            text-align: center;
            margin-top: 40px;
            color: white;
            padding: 20px;
            font-size: 0.9rem;
        }
        
        .code-block {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 15px 0;
            font-family: 'Fira Code', monospace;
            font-size: 14px;
        }
        
        .tab-container {
            margin-top: 20px;
        }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid #1a2a6c;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 10px 20px;
            background: #e0e0e0;
            cursor: pointer;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            margin-bottom: 5px;
        }
        
        .tab.active {
            background: #1a2a6c;
            color: white;
        }
        
        .tab-content {
            display: none;
            padding: 20px;
            background: white;
            border-radius: 0 0 5px 5px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        .comparison-table th, .comparison-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        
        .comparison-table th {
            background-color: #1a2a6c;
            color: white;
        }
        
        .comparison-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        .browser-support {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .browser {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .browser i {
            font-size: 2rem;
            margin-bottom: 10px;
            color: #1a2a6c;
        }
        
        .supported {
            color: #4CAF50;
            font-weight: bold;
        }
        
        .not-supported {
            color: #b21f1f;
            font-weight: bold;
        }
        
        .partial-supported {
            color: #FF9800;
            font-weight: bold;
        }
        
        .async-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 40px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }
        
        .request-status {
            margin: 15px 0;
            padding: 10px;
            border-radius: 8px;
            background: #f9f9f9;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>SharedWorker 异步通信</h1>
            <p class="subtitle">使用async/await实现与SharedWorker的请求-响应模式通信</p>
        </header>
        
        <div class="cards-container">
            <div class="card">
                <h2><i class="fas fa-info-circle"></i> 异步请求-响应模式</h2>
                <p>通过为每个请求生成唯一ID，我们可以实现SharedWorker的请求-响应模式：</p>
                <ul>
                    <li><span class="highlight">唯一请求ID</span>：为每个请求生成唯一标识符</li>
                    <li><span class="highlight">Promise封装</span>：使用Promise管理异步响应</li>
                    <li><span class="highlight">超时处理</span>：防止请求永远挂起</li>
                    <li><span class="highlight">响应匹配</span>：根据请求ID匹配响应</li>
                </ul>
                <p>这种方法允许我们使用async/await语法与SharedWorker交互。</p>
            </div>
            
            <div class="card">
                <h2><i class="fas fa-cogs"></i> 实现机制</h2>
                <p>异步请求-响应模式的实现需要：</p>
                <ul>
                    <li>在客户端维护待处理请求的映射表</li>
                    <li>SharedWorker能够识别请求并返回响应</li>
                    <li>使用消息类型区分不同种类的请求</li>
                    <li>处理可能的错误和超时情况</li>
                </ul>
                <p>这种方法使得SharedWorker可以像普通API一样被调用。</p>
            </div>
            
            <div class="card">
                <h2><i class="fas fa-lightbulb"></i> 使用场景</h2>
                <ul>
                    <li>从共享存储中读取数据</li>
                    <li>执行需要结果的复杂计算</li>
                    <li>获取多标签页的共享状态</li>
                    <li>需要等待结果的任何操作</li>
                </ul>
                <p>异步请求-响应模式使SharedWorker更加灵活和强大。</p>
            </div>
        </div>
        
        <section class="async-section">
            <h2><i class="fas fa-exchange-alt"></i> 异步请求演示</h2>
            <p>使用async函数从SharedWorker读取数据：</p>
            
            <div class="demo-container">
                <div class="input-section">
                    <div class="input-group">
                        <label for="dataKey">要读取的数据键</label>
                        <input type="text" id="dataKey" placeholder="输入数据键" value="userData">
                    </div>
                    
                    <button id="readDataBtn" class="btn">发送读取请求</button>
                    <button id="setDataBtn" class="btn btn-tertiary">设置测试数据</button>
                    
                    <div class="input-group">
                        <label>请求状态</label>
                        <div class="request-status" id="requestStatus">等待操作...</div>
                    </div>
                </div>
                
                <div class="result-section">
                    <h3>读取结果</h3>
                    <div class="result-box" id="readResult">
                        <div class="result-item">这里将显示读取的数据</div>
                    </div>
                </div>
            </div>
            
            <div class="code-block">
// Async函数示例 - 从SharedWorker读取数据
async function readDataFromSharedWorker(key) {
    // 生成唯一请求ID
    const requestId = generateUniqueId();
    
    return new Promise((resolve, reject) => {
        // 设置超时
        const timeoutId = setTimeout(() => {
            delete pendingRequests[requestId];
            reject(new Error('请求超时'));
        }, 5000); // 5秒超时
        
        // 存储待处理请求
        pendingRequests[requestId] = { resolve, reject, timeoutId };
        
        // 发送请求到SharedWorker
        sharedWorker.port.postMessage({
            type: 'read',
            key: key,
            requestId: requestId
        });
    });
}

// 使用示例
try {
    const data = await readDataFromSharedWorker('userData');
    console.log('读取的数据:', data);
} catch (error) {
    console.error('读取失败:', error);
}
            </div>
        </section>
        
        <section class="demo-section">
            <h2><i class="fas fa-vial"></i> SharedWorker 演示</h2>
            <p>打开多个此页面实例（标签页），观察SharedWorker如何同步数据：</p>
            
            <div class="demo-container">
                <div class="input-section">
                    <div class="input-group">
                        <label for="messageInput">发送消息到SharedWorker</label>
                        <input type="text" id="messageInput" placeholder="输入消息内容">
                    </div>
                    
                    <button id="sendMessageBtn" class="btn">发送消息</button>
                    <button id="clearMessagesBtn" class="btn btn-secondary">清空消息</button>
                    
                    <div class="input-group">
                        <label>连接状态</label>
                        <div id="connectionStatus">未连接</div>
                    </div>
                    
                    <div class="input-group">
                        <label>活动标签页数量</label>
                        <div id="tabCount">0</div>
                    </div>
                </div>
                
                <div class="result-section">
                    <h3>来自SharedWorker的消息</h3>
                    <div class="result-box" id="messageOutput">
                        <div class="result-item">等待消息...</div>
                    </div>
                </div>
            </div>
        </section>
        
        <section class="faq-section">
            <h2><i class="fas fa-code"></i> 代码实现</h2>
            
            <div class="tab-container">
                <div class="tabs">
                    <div class="tab active" data-tab="client">客户端代码</div>
                    <div class="tab" data-tab="worker">SharedWorker代码</div>
                    <div class="tab" data-tab="usage">使用示例</div>
                </div>
                
                <div class="tab-content active" id="client-tab">
                    <h3>客户端异步请求实现</h3>
                    <p>在客户端实现async/await风格的SharedWorker调用：</p>
                    <div class="code-block">
// 存储待处理的请求
const pendingRequests = {};

// 生成唯一ID
function generateUniqueId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
}

// 从SharedWorker读取数据的async函数
async function readDataFromSharedWorker(key) {
    const requestId = generateUniqueId();
    
    return new Promise((resolve, reject) => {
        // 设置超时
        const timeoutId = setTimeout(() => {
            delete pendingRequests[requestId];
            reject(new Error('请求超时'));
        }, 5000);
        
        // 存储待处理请求
        pendingRequests[requestId] = { resolve, reject, timeoutId };
        
        // 发送请求到SharedWorker
        sharedWorker.port.postMessage({
            type: 'read',
            key: key,
            requestId: requestId
        });
    });
}

// 处理来自SharedWorker的响应
sharedWorker.port.onmessage = function(e) {
    const data = e.data;
    
    // 检查是否是响应消息
    if (data.type === 'response' && data.requestId) {
        const request = pendingRequests[data.requestId];
        
        if (request) {
            // 清除超时
            clearTimeout(request.timeoutId);
            delete pendingRequests[data.requestId];
            
            // 处理响应
            if (data.success) {
                request.resolve(data.value);
            } else {
                request.reject(new Error(data.error));
            }
        }
    }
    
    // 处理其他类型的消息...
};
                    </div>
                </div>
                
                <div class="tab-content" id="worker-tab">
                    <h3>SharedWorker中的请求处理</h3>
                    <p>在SharedWorker中处理请求并返回响应：</p>
                    <div class="code-block">
// SharedWorker中存储的数据
const storage = {};

self.addEventListener('connect', function(e) {
    const port = e.ports[0];
    ports.push(port);
    
    port.addEventListener('message', function(e) {
        const data = e.data;
        
        // 处理读取请求
        if (data.type === 'read') {
            const value = storage[data.key];
            
            // 发送响应
            port.postMessage({
                type: 'response',
                requestId: data.requestId,
                success: true,
                value: value
            });
        }
        
        // 处理写入请求
        else if (data.type === 'write') {
            storage[data.key] = data.value;
            
            // 发送响应
            port.postMessage({
                type: 'response',
                requestId: data.requestId,
                success: true
            });
        }
        
        // 处理其他类型的消息...
    });
    
    port.start();
});
                    </div>
                </div>
                
                <div class="tab-content" id="usage-tab">
                    <h3>使用async/await调用SharedWorker</h3>
                    <p>使用async函数与SharedWorker交互的示例：</p>
                    <div class="code-block">
// 设置数据到SharedWorker
async function setDataToSharedWorker(key, value) {
    const requestId = generateUniqueId();
    
    return new Promise((resolve, reject) => {
        const timeoutId = setTimeout(() => {
            delete pendingRequests[requestId];
            reject(new Error('请求超时'));
        }, 5000);
        
        pendingRequests[requestId] = { resolve, reject, timeoutId };
        
        sharedWorker.port.postMessage({
            type: 'write',
            key: key,
            value: value,
            requestId: requestId
        });
    });
}

// 使用示例
async function demonstrateAsyncUsage() {
    try {
        // 设置数据
        await setDataToSharedWorker('userSettings', { theme: 'dark', language: 'zh' });
        console.log('数据设置成功');
        
        // 读取数据
        const settings = await readDataFromSharedWorker('userSettings');
        console.log('读取的设置:', settings);
        
        // 执行其他操作...
        
    } catch (error) {
        console.error('操作失败:', error);
    }
}

// 调用演示函数
demonstrateAsyncUsage();
                    </div>
                </div>
            </div>
        </section>
        
        <footer>
            <p>© 2023 Web Workers指南 | SharedWorker异步通信</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 标签切换功能
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // 移除所有active类
                    tabs.forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
                    
                    // 添加active类到当前标签和对应内容
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab + '-tab').classList.add('active');
                });
            });
            
            // SharedWorker演示代码
            let sharedWorker;
            const messageInput = document.getElementById('messageInput');
            const sendMessageBtn = document.getElementById('sendMessageBtn');
            const clearMessagesBtn = document.getElementById('clearMessagesBtn');
            const messageOutput = document.getElementById('messageOutput');
            const connectionStatus = document.getElementById('connectionStatus');
            const tabCount = document.getElementById('tabCount');
            
            const readDataBtn = document.getElementById('readDataBtn');
            const setDataBtn = document.getElementById('setDataBtn');
            const dataKey = document.getElementById('dataKey');
            const requestStatus = document.getElementById('requestStatus');
            const readResult = document.getElementById('readResult');
            
            // 存储待处理的请求
            const pendingRequests = {};
            
            // 生成唯一ID
            function generateUniqueId() {
                return Date.now().toString(36) + Math.random().toString(36).substr(2);
            }
            
            // 检查浏览器支持
            if (!window.SharedWorker) {
                connectionStatus.innerHTML = '<span class="warning">您的浏览器不支持SharedWorker</span>';
                requestStatus.innerHTML = '<span class="warning">您的浏览器不支持SharedWorker</span>';
                sendMessageBtn.disabled = true;
                readDataBtn.disabled = true;
                setDataBtn.disabled = true;
                return;
            }
            
            try {
                // 创建SharedWorker
                sharedWorker = new SharedWorker('shared-worker.js');
                
                // 处理来自SharedWorker的消息
                sharedWorker.port.onmessage = function(e) {
                    const data = e.data;
                    
                    if (data.type === 'connection') {
                        connectionStatus.innerHTML = '<span class="success">已连接</span>';
                        tabCount.textContent = data.count;
                    } 
                    else if (data.type === 'message') {
                        const messageElement = document.createElement('div');
                        messageElement.className = 'result-item';
                        messageElement.innerHTML = `
                            <strong>${data.timestamp}</strong>: 
                            ${data.content} <span class="info">(消息#${data.count})</span>
                        `;
                        messageOutput.appendChild(messageElement);
                        
                        // 滚动到底部
                        messageOutput.scrollTop = messageOutput.scrollHeight;
                    }
                    // 处理响应消息
                    else if (data.type === 'response' && data.requestId) {
                        const request = pendingRequests[data.requestId];
                        
                        if (request) {
                            // 清除超时
                            clearTimeout(request.timeoutId);
                            delete pendingRequests[data.requestId];
                            
                            // 处理响应
                            if (data.success) {
                                request.resolve(data.value);
                            } else {
                                request.reject(new Error(data.error || '未知错误'));
                            }
                        }
                    }
                };
                
                // 启动端口
                sharedWorker.port.start();
                
                // 发送消息
                sendMessageBtn.addEventListener('click', function() {
                    const message = messageInput.value.trim();
                    if (message) {
                        sharedWorker.port.postMessage({
                            type: 'message',
                            content: message
                        });
                        messageInput.value = '';
                    }
                });
                
                // 清空消息
                clearMessagesBtn.addEventListener('click', function() {
                    messageOutput.innerHTML = '<div class="result-item">消息已清空</div>';
                });
                
                // 从SharedWorker读取数据的async函数
                async function readDataFromSharedWorker(key) {
                    const requestId = generateUniqueId();
                    
                    return new Promise((resolve, reject) => {
                        // 设置超时
                        const timeoutId = setTimeout(() => {
                            delete pendingRequests[requestId];
                            reject(new Error('请求超时'));
                        }, 5000);
                        
                        // 存储待处理请求
                        pendingRequests[requestId] = { resolve, reject, timeoutId };
                        
                        // 发送请求到SharedWorker
                        sharedWorker.port.postMessage({
                            type: 'read',
                            key: key,
                            requestId: requestId
                        });
                    });
                }
                
                // 设置数据到SharedWorker的async函数
                async function setDataToSharedWorker(key, value) {
                    const requestId = generateUniqueId();
                    
                    return new Promise((resolve, reject) => {
                        const timeoutId = setTimeout(() => {
                            delete pendingRequests[requestId];
                            reject(new Error('请求超时'));
                        }, 5000);
                        
                        pendingRequests[requestId] = { resolve, reject, timeoutId };
                        
                        sharedWorker.port.postMessage({
                            type: 'write',
                            key: key,
                            value: value,
                            requestId: requestId
                        });
                    });
                }
                
                // 读取数据按钮点击事件
                readDataBtn.addEventListener('click', async function() {
                    const key = dataKey.value.trim() || 'defaultKey';
                    
                    requestStatus.innerHTML = '<span class="info">发送读取请求...</span>';
                    
                    try {
                        const result = await readDataFromSharedWorker(key);
                        requestStatus.innerHTML = '<span class="success">读取成功!</span>';
                        readResult.innerHTML = `
                            <div class="result-item">
                                <strong>键:</strong> ${key}<br>
                                <strong>值:</strong> ${JSON.stringify(result)}
                            </div>
                        `;
                    } catch (error) {
                        requestStatus.innerHTML = `<span class="warning">读取失败: ${error.message}</span>`;
                        readResult.innerHTML = `
                            <div class="result-item">
                                <strong>错误:</strong> ${error.message}
                            </div>
                        `;
                    }
                });
                
                // 设置测试数据
                setDataBtn.addEventListener('click', async function() {
                    const key = dataKey.value.trim() || 'defaultKey';
                    const testData = {
                        message: 'Hello from SharedWorker!',
                        timestamp: new Date().toISOString(),
                        random: Math.random()
                    };
                    
                    requestStatus.innerHTML = '<span class="info">设置测试数据...</span>';
                    
                    try {
                        await setDataToSharedWorker(key, testData);
                        requestStatus.innerHTML = '<span class="success">测试数据设置成功!</span>';
                        readResult.innerHTML = `
                            <div class="result-item">
                                <strong>已设置键:</strong> ${key}<br>
                                <strong>值:</strong> ${JSON.stringify(testData)}
                            </div>
                        `;
                    } catch (error) {
                        requestStatus.innerHTML = `<span class="warning">设置失败: ${error.message}</span>`;
                    }
                });
                
                // 处理错误
                sharedWorker.port.onerror = function(error) {
                    connectionStatus.innerHTML = '<span class="warning">连接错误</span>';
                    console.error('SharedWorker错误:', error);
                };
                
            } catch (error) {
                connectionStatus.innerHTML = '<span class="warning">初始化失败</span>';
                requestStatus.innerHTML = '<span class="warning">初始化失败</span>';
                console.error('SharedWorker初始化错误:', error);
            }
        });
    </script>
</body>
</html>